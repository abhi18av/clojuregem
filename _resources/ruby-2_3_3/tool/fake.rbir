s(:begin,
  s(:class,
    s(:const, nil, :File), nil,
    s(:begin,
      s(:lvasgn, :sep,
        s(:begin,
          s(:if,
            s(:send,
              s(:const, nil, :RUBY_PLATFORM), :=~,
              s(:regexp,
                s(:str, "mswin|bccwin|mingw"),
                s(:regopt))),
            s(:str, "\\"), nil))),
      s(:if,
        s(:send,
          s(:lvar, :sep), :!=,
          s(:const, nil, :ALT_SEPARATOR)),
        s(:begin,
          s(:send, nil, :remove_const,
            s(:sym, :ALT_SEPARATOR)),
          s(:casgn, nil, :ALT_SEPARATOR,
            s(:lvar, :sep))), nil))),
  s(:lvasgn, :static,
    s(:send,
      s(:send,
        s(:begin,
          s(:and,
            s(:defined?,
              s(:gvar, :$static)),
            s(:gvar, :$static))), :!), :!)),
  s(:send,
    s(:gvar, :$:), :unshift,
    s(:send, nil, :builddir)),
  s(:lvasgn, :posthook,
    s(:block,
      s(:send, nil, :proc),
      s(:args),
      s(:begin,
        s(:lvasgn, :config,
          s(:const,
            s(:const, nil, :RbConfig), :CONFIG)),
        s(:lvasgn, :mkconfig,
          s(:const,
            s(:const, nil, :RbConfig), :MAKEFILE_CONFIG)),
        s(:lvasgn, :extout,
          s(:send,
            s(:const, nil, :File), :expand_path,
            s(:send,
              s(:lvar, :mkconfig), :[],
              s(:str, "EXTOUT")),
            s(:send, nil, :builddir))),
        s(:block,
          s(:send,
            s(:array,
              s(:array,
                s(:str, "top_srcdir"),
                s(:gvar, :$top_srcdir)),
              s(:array,
                s(:str, "topdir"),
                s(:gvar, :$topdir))), :each),
          s(:args,
            s(:arg, :var),
            s(:arg, :val)),
          s(:begin,
            s(:if,
              s(:lvar, :val), nil,
              s(:next)),
            s(:send,
              s(:lvar, :mkconfig), :[]=,
              s(:lvar, :var),
              s(:send,
                s(:lvar, :config), :[]=,
                s(:lvar, :var),
                s(:lvar, :val))),
            s(:lvasgn, :t,
              s(:regexp,
                s(:str, "\\A"),
                s(:begin,
                  s(:send,
                    s(:const, nil, :Regexp), :quote,
                    s(:lvar, :val))),
                s(:str, "(?=/)"),
                s(:regopt))),
            s(:block,
              s(:send,
                s(:gvar, :$hdrdir), :sub!,
                s(:lvar, :t)),
              s(:args),
              s(:dstr,
                s(:str, "$("),
                s(:begin,
                  s(:lvar, :var)),
                s(:str, ")"))),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :mkconfig), :keys), :grep,
                s(:regexp,
                  s(:str, "dir\\z"),
                  s(:regopt))),
              s(:args,
                s(:arg, :k)),
              s(:if,
                s(:send,
                  s(:lvar, :t), :=~,
                  s(:send,
                    s(:lvar, :mkconfig), :[],
                    s(:lvar, :k))),
                s(:send,
                  s(:lvar, :mkconfig), :[]=,
                  s(:lvar, :k),
                  s(:dstr,
                    s(:str, "$("),
                    s(:begin,
                      s(:lvar, :var)),
                    s(:str, ")"),
                    s(:back_ref, :$'))), nil)))),
        s(:if,
          s(:gvar, :$extmk),
          s(:gvasgn, :$ruby,
            s(:str, "$(topdir)/miniruby -I'$(topdir)' -I'$(top_srcdir)/lib' -I'$(extout)/$(arch)' -I'$(extout)/common'")),
          s(:gvasgn, :$ruby,
            s(:send, nil, :baseruby))),
        s(:gvasgn, :$static,
          s(:lvar, :static)),
        s(:send, nil, :untrace_var,
          s(:sym, :$ruby),
          s(:lvar, :posthook))))),
  s(:lvasgn, :prehook,
    s(:block,
      s(:send, nil, :proc),
      s(:args,
        s(:arg, :extmk)),
      s(:begin,
        s(:lvasgn, :pat,
          s(:regexp,
            s(:str, "(?:\\A(?:\\w:|//[^/]+)|\\G)/[^/]*"),
            s(:regopt))),
        s(:lvasgn, :dir,
          s(:send,
            s(:send, nil, :builddir), :scan,
            s(:lvar, :pat))),
        s(:lvasgn, :pwd,
          s(:send,
            s(:send,
              s(:const, nil, :Dir), :pwd), :scan,
            s(:lvar, :pat))),
        s(:if,
          s(:send,
            s(:send,
              s(:lvar, :dir), :[],
              s(:int, 0)), :==,
            s(:send,
              s(:lvar, :pwd), :[],
              s(:int, 0))),
          s(:begin,
            s(:while,
              s(:and,
                s(:send,
                  s(:lvar, :dir), :[],
                  s(:int, 0)),
                s(:send,
                  s(:send,
                    s(:lvar, :dir), :[],
                    s(:int, 0)), :==,
                  s(:send,
                    s(:lvar, :pwd), :[],
                    s(:int, 0)))),
              s(:begin,
                s(:send,
                  s(:lvar, :dir), :shift),
                s(:send,
                  s(:lvar, :pwd), :shift))),
            s(:lvasgn, :builddir,
              s(:send,
                s(:const, nil, :File), :join,
                s(:send,
                  s(:begin,
                    s(:if,
                      s(:send,
                        s(:lvar, :pwd), :empty?),
                      s(:array,
                        s(:str, ".")),
                      s(:send,
                        s(:array,
                          s(:str, "..")), :*,
                        s(:send,
                          s(:lvar, :pwd), :size)))), :+,
                  s(:lvar, :dir)))),
            s(:if,
              s(:send,
                s(:lvar, :builddir), :empty?),
              s(:lvasgn, :builddir,
                s(:str, ".")), nil)), nil),
        s(:lvasgn, :join,
          s(:block,
            s(:send, nil, :proc),
            s(:args,
              s(:restarg, :args)),
            s(:send,
              s(:send,
                s(:const, nil, :File), :join,
                s(:splat,
                  s(:lvar, :args))), :sub!,
              s(:regexp,
                s(:str, "\\A(?:\\./)*"),
                s(:regopt)),
              s(:str, "")))),
        s(:or_asgn,
          s(:gvasgn, :$topdir),
          s(:lvar, :builddir)),
        s(:or_asgn,
          s(:gvasgn, :$top_srcdir),
          s(:begin,
            s(:if,
              s(:send,
                s(:const, nil, :File), :identical?,
                s(:send, nil, :top_srcdir),
                s(:lvasgn, :dir,
                  s(:send,
                    s(:lvar, :join), :[],
                    s(:gvar, :$topdir),
                    s(:send, nil, :srcdir)))),
              s(:lvar, :dir),
              s(:send, nil, :top_srcdir)))),
        s(:gvasgn, :$extout,
          s(:str, "$(topdir)/.ext")),
        s(:gvasgn, :$extout_prefix,
          s(:str, "$(extout)$(target_prefix)/")),
        s(:lvasgn, :config,
          s(:const,
            s(:const, nil, :RbConfig), :CONFIG)),
        s(:lvasgn, :mkconfig,
          s(:const,
            s(:const, nil, :RbConfig), :MAKEFILE_CONFIG)),
        s(:send,
          s(:lvar, :mkconfig), :[]=,
          s(:str, "builddir"),
          s(:send,
            s(:lvar, :config), :[]=,
            s(:str, "builddir"),
            s(:lvar, :builddir))),
        s(:if,
          s(:gvar, :$top_srcdir),
          s(:send,
            s(:lvar, :mkconfig), :[]=,
            s(:str, "top_srcdir"),
            s(:gvar, :$top_srcdir)), nil),
        s(:send,
          s(:lvar, :config), :[]=,
          s(:str, "top_srcdir"),
          s(:send,
            s(:const, nil, :File), :expand_path,
            s(:or_asgn,
              s(:gvasgn, :$top_srcdir),
              s(:send, nil, :top_srcdir)))),
        s(:send,
          s(:lvar, :config), :[]=,
          s(:str, "rubyhdrdir"),
          s(:send,
            s(:lvar, :join), :[],
            s(:gvar, :$top_srcdir),
            s(:str, "include"))),
        s(:send,
          s(:lvar, :config), :[]=,
          s(:str, "rubyarchhdrdir"),
          s(:send,
            s(:lvar, :join), :[],
            s(:lvar, :builddir),
            s(:send,
              s(:lvar, :config), :[],
              s(:str, "EXTOUT")),
            s(:str, "include"),
            s(:send,
              s(:lvar, :config), :[],
              s(:str, "arch")))),
        s(:send,
          s(:lvar, :mkconfig), :[]=,
          s(:str, "libdirname"),
          s(:str, "builddir")),
        s(:send, nil, :trace_var,
          s(:sym, :$ruby),
          s(:lvar, :posthook)),
        s(:send, nil, :untrace_var,
          s(:sym, :$extmk),
          s(:lvar, :prehook))))),
  s(:send, nil, :trace_var,
    s(:sym, :$extmk),
    s(:lvar, :prehook)))
