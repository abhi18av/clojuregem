s(:begin,
  s(:send, nil, :require,
    s(:str, "fileutils")),
  s(:send, nil, :require,
    s(:str, "digest")),
  s(:send, nil, :require_relative,
    s(:str, "downloader")),
  s(:lvasgn, :cache_dir,
    s(:str, ".downloaded-cache")),
  s(:send,
    s(:const, nil, :FileUtils), :mkdir_p,
    s(:lvar, :cache_dir)),
  s(:def, :do_download,
    s(:args,
      s(:arg, :url),
      s(:arg, :base),
      s(:arg, :cache_dir)),
    s(:send,
      s(:const, nil, :Downloader), :download,
      s(:lvar, :url),
      s(:lvar, :base),
      s(:lvar, :cache_dir),
      s(:nil))),
  s(:def, :do_checksum,
    s(:args,
      s(:arg, :cache),
      s(:arg, :chksums)),
    s(:block,
      s(:send,
        s(:lvar, :chksums), :each),
      s(:args,
        s(:arg, :sum)),
      s(:begin,
        s(:masgn,
          s(:mlhs,
            s(:lvasgn, :name),
            s(:lvasgn, :sum)),
          s(:send,
            s(:lvar, :sum), :split,
            s(:regexp,
              s(:str, ":"),
              s(:regopt)))),
        s(:if,
          s(:gvar, :$VERBOSE),
          s(:begin,
            s(:send,
              s(:gvar, :$stdout), :print,
              s(:dstr,
                s(:str, "checking "),
                s(:begin,
                  s(:lvar, :name)),
                s(:str, " of "),
                s(:begin,
                  s(:lvar, :cache)),
                s(:str, " ..."))),
            s(:send,
              s(:gvar, :$stdout), :flush)), nil),
        s(:lvasgn, :hd,
          s(:send,
            s(:send,
              s(:send, nil, :Digest,
                s(:send,
                  s(:lvar, :name), :upcase)), :file,
              s(:lvar, :cache)), :hexdigest)),
        s(:if,
          s(:send,
            s(:lvar, :hd), :==,
            s(:lvar, :sum)),
          s(:if,
            s(:gvar, :$VERBOSE),
            s(:begin,
              s(:send,
                s(:gvar, :$stdout), :puts,
                s(:str, " OK")),
              s(:send,
                s(:gvar, :$stdout), :flush)), nil),
          s(:begin,
            s(:if,
              s(:gvar, :$VERBOSE),
              s(:begin,
                s(:send,
                  s(:gvar, :$stdout), :puts,
                  s(:str, " NG")),
                s(:send,
                  s(:gvar, :$stdout), :flush)), nil),
            s(:send, nil, :raise,
              s(:dstr,
                s(:str, "checksum mismatch: "),
                s(:begin,
                  s(:lvar, :cache)),
                s(:str, ", "),
                s(:begin,
                  s(:lvar, :name)),
                s(:str, ":"),
                s(:begin,
                  s(:lvar, :hd)),
                s(:str, ", expected "),
                s(:begin,
                  s(:lvar, :sum))))))))),
  s(:def, :do_extract,
    s(:args,
      s(:arg, :cache),
      s(:arg, :dir)),
    s(:begin,
      s(:if,
        s(:gvar, :$VERBOSE),
        s(:begin,
          s(:send,
            s(:gvar, :$stdout), :puts,
            s(:dstr,
              s(:str, "extracting "),
              s(:begin,
                s(:lvar, :cache)),
              s(:str, " into "),
              s(:begin,
                s(:lvar, :dir)))),
          s(:send,
            s(:gvar, :$stdout), :flush)), nil),
      s(:lvasgn, :ext,
        s(:send,
          s(:const, nil, :File), :extname,
          s(:lvar, :cache))),
      s(:case,
        s(:lvar, :ext),
        s(:when,
          s(:str, ".gz"),
          s(:str, ".tgz"),
          s(:begin,
            s(:lvasgn, :f,
              s(:send,
                s(:const, nil, :IO), :popen,
                s(:array,
                  s(:str, "gzip"),
                  s(:str, "-dc"),
                  s(:lvar, :cache)))),
            s(:lvasgn, :cache,
              s(:send,
                s(:lvar, :cache), :chomp,
                s(:str, ".gz"))))),
        s(:when,
          s(:str, ".bz2"),
          s(:str, ".tbz"),
          s(:begin,
            s(:lvasgn, :f,
              s(:send,
                s(:const, nil, :IO), :popen,
                s(:array,
                  s(:str, "bzip2"),
                  s(:str, "-dc"),
                  s(:lvar, :cache)))),
            s(:lvasgn, :cache,
              s(:send,
                s(:lvar, :cache), :chomp,
                s(:str, ".bz2"))))),
        s(:when,
          s(:str, ".xz"),
          s(:str, ".txz"),
          s(:begin,
            s(:lvasgn, :f,
              s(:send,
                s(:const, nil, :IO), :popen,
                s(:array,
                  s(:str, "xz"),
                  s(:str, "-dc"),
                  s(:lvar, :cache)))),
            s(:lvasgn, :cache,
              s(:send,
                s(:lvar, :cache), :chomp,
                s(:str, ".xz"))))),
        s(:lvasgn, :inp,
          s(:lvar, :cache))),
      s(:or_asgn,
        s(:lvasgn, :inp),
        s(:send,
          s(:lvar, :f), :binmode)),
      s(:lvasgn, :ext,
        s(:send,
          s(:const, nil, :File), :extname,
          s(:lvar, :cache))),
      s(:case,
        s(:lvar, :ext),
        s(:when,
          s(:str, ".tar"),
          s(:regexp,
            s(:str, "\\A\\.t[gbx]z\\z"),
            s(:regopt)),
          s(:lvasgn, :pid,
            s(:send,
              s(:const, nil, :Process), :spawn,
              s(:str, "tar"),
              s(:str, "xpf"),
              s(:str, "-"),
              s(:hash,
                s(:pair,
                  s(:sym, :in),
                  s(:lvar, :inp)),
                s(:pair,
                  s(:sym, :chdir),
                  s(:lvar, :dir)))))),
        s(:when,
          s(:str, ".zip"),
          s(:lvasgn, :pid,
            s(:send,
              s(:const, nil, :Process), :spawn,
              s(:str, "unzip"),
              s(:lvar, :inp),
              s(:str, "-d"),
              s(:lvar, :dir)))), nil),
      s(:if,
        s(:lvar, :f),
        s(:send,
          s(:lvar, :f), :close), nil),
      s(:send,
        s(:const, nil, :Process), :wait,
        s(:lvar, :pid)),
      s(:or,
        s(:send,
          s(:gvar, :$?), :success?),
        s(:send, nil, :raise,
          s(:dstr,
            s(:str, "failed to extract "),
            s(:begin,
              s(:lvar, :cache))))))),
  s(:def, :do_patch,
    s(:args,
      s(:arg, :dest),
      s(:arg, :patch),
      s(:arg, :args)),
    s(:begin,
      s(:if,
        s(:gvar, :$VERBOSE),
        s(:begin,
          s(:send,
            s(:gvar, :$stdout), :puts,
            s(:dstr,
              s(:str, "applying "),
              s(:begin,
                s(:lvar, :patch)),
              s(:str, " under "),
              s(:begin,
                s(:lvar, :dest)))),
          s(:send,
            s(:gvar, :$stdout), :flush)), nil),
      s(:send,
        s(:const, nil, :Process), :wait,
        s(:send,
          s(:const, nil, :Process), :spawn,
          s(:str, "patch"),
          s(:str, "-d"),
          s(:lvar, :dest),
          s(:str, "-i"),
          s(:lvar, :patch),
          s(:splat,
            s(:lvar, :args)))),
      s(:or,
        s(:send,
          s(:gvar, :$?), :success?),
        s(:send, nil, :raise,
          s(:dstr,
            s(:str, "failed to patch "),
            s(:begin,
              s(:lvar, :patch))))))),
  s(:case,
    s(:send,
      s(:const, nil, :ARGV), :[],
      s(:int, 0)),
    s(:when,
      s(:str, "--download"),
      s(:begin,
        s(:lvasgn, :mode,
          s(:sym, :download)),
        s(:send,
          s(:const, nil, :ARGV), :shift))),
    s(:when,
      s(:str, "--extract"),
      s(:begin,
        s(:lvasgn, :mode,
          s(:sym, :extract)),
        s(:send,
          s(:const, nil, :ARGV), :shift))),
    s(:when,
      s(:str, "--patch"),
      s(:begin,
        s(:lvasgn, :mode,
          s(:sym, :patch)),
        s(:send,
          s(:const, nil, :ARGV), :shift))),
    s(:when,
      s(:str, "--all"),
      s(:begin,
        s(:lvasgn, :mode,
          s(:sym, :all)),
        s(:send,
          s(:const, nil, :ARGV), :shift))),
    s(:lvasgn, :mode,
      s(:sym, :all))),
  s(:lvasgn, :success,
    s(:true)),
  s(:block,
    s(:send,
      s(:const, nil, :ARGV), :each),
    s(:args,
      s(:arg, :dir)),
    s(:block,
      s(:send,
        s(:const, nil, :Dir), :glob,
        s(:dstr,
          s(:begin,
            s(:lvar, :dir)),
          s(:str, "/**/extlibs"))),
      s(:args,
        s(:arg, :list)),
      s(:begin,
        s(:if,
          s(:gvar, :$VERBOSE),
          s(:begin,
            s(:send,
              s(:gvar, :$stdout), :puts,
              s(:dstr,
                s(:str, "downloading for "),
                s(:begin,
                  s(:lvar, :list)))),
            s(:send,
              s(:gvar, :$stdout), :flush)), nil),
        s(:lvasgn, :extracted,
          s(:false)),
        s(:lvasgn, :dest,
          s(:send,
            s(:const, nil, :File), :dirname,
            s(:lvar, :list))),
        s(:block,
          s(:send,
            s(:const, nil, :IO), :foreach,
            s(:lvar, :list)),
          s(:args,
            s(:arg, :line)),
          s(:begin,
            s(:send,
              s(:lvar, :line), :sub!,
              s(:regexp,
                s(:str, "\\s*#.*"),
                s(:regopt)),
              s(:str, "")),
            s(:if,
              s(:match_with_lvasgn,
                s(:regexp,
                  s(:str, "^\\t"),
                  s(:regopt)),
                s(:lvar, :line)),
              s(:begin,
                s(:if,
                  s(:and,
                    s(:lvar, :extracted),
                    s(:begin,
                      s(:or,
                        s(:send,
                          s(:lvar, :mode), :==,
                          s(:sym, :all)),
                        s(:send,
                          s(:lvar, :mode), :==,
                          s(:sym, :patch))))),
                  s(:begin,
                    s(:masgn,
                      s(:mlhs,
                        s(:lvasgn, :patch),
                        s(:splat,
                          s(:lvasgn, :args))),
                      s(:send,
                        s(:lvar, :line), :split)),
                    s(:send, nil, :do_patch,
                      s(:lvar, :dest),
                      s(:lvar, :patch),
                      s(:lvar, :args))), nil),
                s(:next)), nil),
            s(:masgn,
              s(:mlhs,
                s(:lvasgn, :url),
                s(:splat,
                  s(:lvasgn, :chksums))),
              s(:send,
                s(:lvar, :line), :split,
                s(:str, " "))),
            s(:if,
              s(:lvar, :url), nil,
              s(:next)),
            s(:lvasgn, :extracted,
              s(:false)),
            s(:lvasgn, :base,
              s(:send,
                s(:const, nil, :File), :basename,
                s(:lvar, :url))),
            s(:lvasgn, :cache,
              s(:send,
                s(:const, nil, :File), :join,
                s(:lvar, :cache_dir),
                s(:lvar, :base))),
            s(:lvasgn, :target,
              s(:send,
                s(:const, nil, :File), :join,
                s(:lvar, :dest),
                s(:send,
                  s(:lvar, :base), :[],
                  s(:regexp,
                    s(:str, ".*(?=\\.tar(?:\\.\\w+)?\\z)"),
                    s(:regopt))))),
            s(:kwbegin,
              s(:rescue,
                s(:case,
                  s(:lvar, :mode),
                  s(:when,
                    s(:sym, :download),
                    s(:begin,
                      s(:send, nil, :do_download,
                        s(:lvar, :url),
                        s(:lvar, :base),
                        s(:lvar, :cache_dir)),
                      s(:send, nil, :do_checksum,
                        s(:lvar, :cache),
                        s(:lvar, :chksums)))),
                  s(:when,
                    s(:sym, :extract),
                    s(:if,
                      s(:send,
                        s(:const, nil, :File), :directory?,
                        s(:lvar, :target)), nil,
                      s(:begin,
                        s(:send, nil, :do_checksum,
                          s(:lvar, :cache),
                          s(:lvar, :chksums)),
                        s(:lvasgn, :extracted,
                          s(:send, nil, :do_extract,
                            s(:lvar, :cache),
                            s(:lvar, :dest)))))),
                  s(:when,
                    s(:sym, :all),
                    s(:begin,
                      s(:send, nil, :do_download,
                        s(:lvar, :url),
                        s(:lvar, :base),
                        s(:lvar, :cache_dir)),
                      s(:if,
                        s(:send,
                          s(:const, nil, :File), :directory?,
                          s(:lvar, :target)), nil,
                        s(:begin,
                          s(:send, nil, :do_checksum,
                            s(:lvar, :cache),
                            s(:lvar, :chksums)),
                          s(:lvasgn, :extracted,
                            s(:send, nil, :do_extract,
                              s(:lvar, :cache),
                              s(:lvar, :dest))))))), nil),
                s(:resbody, nil,
                  s(:lvasgn, :e),
                  s(:begin,
                    s(:send, nil, :warn,
                      s(:send,
                        s(:lvar, :e), :inspect)),
                    s(:lvasgn, :success,
                      s(:false)))), nil))))))),
  s(:send, nil, :exit,
    s(:lvar, :success)))
