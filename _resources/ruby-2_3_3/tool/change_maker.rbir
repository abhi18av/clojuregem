s(:begin,
  s(:def, :diff2index,
    s(:args,
      s(:arg, :cmd),
      s(:restarg, :argv)),
    s(:begin,
      s(:lvasgn, :lines,
        s(:array)),
      s(:lvasgn, :path,
        s(:nil)),
      s(:lvasgn, :output,
        s(:xstr,
          s(:begin,
            s(:lvar, :cmd)),
          s(:str, " "),
          s(:begin,
            s(:send,
              s(:lvar, :argv), :join,
              s(:str, " "))))),
      s(:if,
        s(:defined?,
          s(:const,
            s(:const, nil, :Encoding), :BINARY)),
        s(:send,
          s(:lvar, :output), :force_encoding,
          s(:const,
            s(:const, nil, :Encoding), :BINARY)), nil),
      s(:block,
        s(:send,
          s(:lvar, :output), :each_line),
        s(:args,
          s(:arg, :line)),
        s(:case,
          s(:lvar, :line),
          s(:when,
            s(:regexp,
              s(:str, "^Index: (\\S*)"),
              s(:regopt)),
            s(:regexp,
              s(:str, "^diff --git [a-z]/(\\S*) [a-z]/\\1"),
              s(:regopt)),
            s(:lvasgn, :path,
              s(:nth_ref, 1))),
          s(:when,
            s(:regexp,
              s(:str, "^@@\\s*-[,\\d]+ +\\+(\\d+)[,\\d]*\\s*@@(?: +([A-Za-z_][A-Za-z_0-9 ]*[A-Za-z_0-9]))?"),
              s(:regopt)),
            s(:begin,
              s(:lvasgn, :line,
                s(:send,
                  s(:nth_ref, 1), :to_i)),
              s(:lvasgn, :ent,
                s(:dstr,
                  s(:str, "\t* "),
                  s(:begin,
                    s(:lvar, :path)))),
              s(:if,
                s(:nth_ref, 2),
                s(:send,
                  s(:lvar, :ent), :<<,
                  s(:dstr,
                    s(:str, " ("),
                    s(:begin,
                      s(:nth_ref, 2)),
                    s(:str, ")"))), nil),
              s(:send,
                s(:lvar, :lines), :<<,
                s(:dstr,
                  s(:begin,
                    s(:lvar, :ent)),
                  s(:str, ":"))))), nil)),
      s(:send,
        s(:lvar, :lines), :uniq!),
      s(:if,
        s(:send,
          s(:lvar, :lines), :empty?),
        s(:nil),
        s(:lvar, :lines)))),
  s(:if,
    s(:send,
      s(:xstr,
        s(:str, "svnversion")), :=~,
      s(:regexp,
        s(:str, "^\\d+"),
        s(:regopt))),
    s(:begin,
      s(:lvasgn, :cmd,
        s(:str, "svn diff --diff-cmd=diff -x-pU0")),
      s(:lvasgn, :change,
        s(:send, nil, :diff2index,
          s(:lvar, :cmd),
          s(:const, nil, :ARGV)))),
    s(:if,
      s(:send,
        s(:const, nil, :File), :directory?,
        s(:str, ".git")),
      s(:begin,
        s(:lvasgn, :cmd,
          s(:str, "git diff -U0")),
        s(:lvasgn, :change,
          s(:or,
            s(:send, nil, :diff2index,
              s(:lvar, :cmd),
              s(:const, nil, :ARGV)),
            s(:send, nil, :diff2index,
              s(:lvar, :cmd),
              s(:str, "--cached"),
              s(:const, nil, :ARGV))))),
      s(:send, nil, :abort,
        s(:str, "does not seem to be under a vcs")))),
  s(:if,
    s(:lvar, :change),
    s(:send, nil, :puts,
      s(:lvar, :change)), nil))
