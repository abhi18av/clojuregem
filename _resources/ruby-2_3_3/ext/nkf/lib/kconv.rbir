s(:begin,
  s(:send, nil, :require,
    s(:str, "nkf")),
  s(:module,
    s(:const, nil, :Kconv),
    s(:begin,
      s(:casgn, nil, :AUTO,
        s(:const,
          s(:const, nil, :NKF), :AUTO)),
      s(:casgn, nil, :JIS,
        s(:const,
          s(:const, nil, :NKF), :JIS)),
      s(:casgn, nil, :EUC,
        s(:const,
          s(:const, nil, :NKF), :EUC)),
      s(:casgn, nil, :SJIS,
        s(:const,
          s(:const, nil, :NKF), :SJIS)),
      s(:casgn, nil, :BINARY,
        s(:const,
          s(:const, nil, :NKF), :BINARY)),
      s(:casgn, nil, :NOCONV,
        s(:const,
          s(:const, nil, :NKF), :NOCONV)),
      s(:casgn, nil, :ASCII,
        s(:const,
          s(:const, nil, :NKF), :ASCII)),
      s(:casgn, nil, :UTF8,
        s(:const,
          s(:const, nil, :NKF), :UTF8)),
      s(:casgn, nil, :UTF16,
        s(:const,
          s(:const, nil, :NKF), :UTF16)),
      s(:casgn, nil, :UTF32,
        s(:const,
          s(:const, nil, :NKF), :UTF32)),
      s(:casgn, nil, :UNKNOWN,
        s(:const,
          s(:const, nil, :NKF), :UNKNOWN)),
      s(:def, :kconv,
        s(:args,
          s(:arg, :str),
          s(:arg, :to_enc),
          s(:optarg, :from_enc,
            s(:nil))),
        s(:begin,
          s(:lvasgn, :opt,
            s(:str, "")),
          s(:if,
            s(:lvar, :from_enc),
            s(:op_asgn,
              s(:lvasgn, :opt), :+,
              s(:send,
                s(:str, " --ic="), :+,
                s(:send,
                  s(:lvar, :from_enc), :to_s))), nil),
          s(:if,
            s(:lvar, :to_enc),
            s(:op_asgn,
              s(:lvasgn, :opt), :+,
              s(:send,
                s(:str, " --oc="), :+,
                s(:send,
                  s(:lvar, :to_enc), :to_s))), nil),
          s(:send,
            s(:const,
              s(:cbase), :NKF), :nkf,
            s(:lvar, :opt),
            s(:lvar, :str)))),
      s(:send, nil, :module_function,
        s(:sym, :kconv)),
      s(:def, :tojis,
        s(:args,
          s(:arg, :str)),
        s(:send, nil, :kconv,
          s(:lvar, :str),
          s(:const, nil, :JIS))),
      s(:send, nil, :module_function,
        s(:sym, :tojis)),
      s(:def, :toeuc,
        s(:args,
          s(:arg, :str)),
        s(:send, nil, :kconv,
          s(:lvar, :str),
          s(:const, nil, :EUC))),
      s(:send, nil, :module_function,
        s(:sym, :toeuc)),
      s(:def, :tosjis,
        s(:args,
          s(:arg, :str)),
        s(:send, nil, :kconv,
          s(:lvar, :str),
          s(:const, nil, :SJIS))),
      s(:send, nil, :module_function,
        s(:sym, :tosjis)),
      s(:def, :toutf8,
        s(:args,
          s(:arg, :str)),
        s(:send, nil, :kconv,
          s(:lvar, :str),
          s(:const, nil, :UTF8))),
      s(:send, nil, :module_function,
        s(:sym, :toutf8)),
      s(:def, :toutf16,
        s(:args,
          s(:arg, :str)),
        s(:send, nil, :kconv,
          s(:lvar, :str),
          s(:const, nil, :UTF16))),
      s(:send, nil, :module_function,
        s(:sym, :toutf16)),
      s(:def, :toutf32,
        s(:args,
          s(:arg, :str)),
        s(:send, nil, :kconv,
          s(:lvar, :str),
          s(:const, nil, :UTF32))),
      s(:send, nil, :module_function,
        s(:sym, :toutf32)),
      s(:def, :tolocale,
        s(:args,
          s(:arg, :str)),
        s(:send, nil, :kconv,
          s(:lvar, :str),
          s(:send,
            s(:const, nil, :Encoding), :locale_charmap))),
      s(:send, nil, :module_function,
        s(:sym, :tolocale)),
      s(:def, :guess,
        s(:args,
          s(:arg, :str)),
        s(:send,
          s(:const,
            s(:cbase), :NKF), :guess,
          s(:lvar, :str))),
      s(:send, nil, :module_function,
        s(:sym, :guess)),
      s(:def, :iseuc,
        s(:args,
          s(:arg, :str)),
        s(:send,
          s(:send,
            s(:send,
              s(:lvar, :str), :dup), :force_encoding,
            s(:const, nil, :EUC)), :valid_encoding?)),
      s(:send, nil, :module_function,
        s(:sym, :iseuc)),
      s(:def, :issjis,
        s(:args,
          s(:arg, :str)),
        s(:send,
          s(:send,
            s(:send,
              s(:lvar, :str), :dup), :force_encoding,
            s(:const, nil, :SJIS)), :valid_encoding?)),
      s(:send, nil, :module_function,
        s(:sym, :issjis)),
      s(:def, :isjis,
        s(:args,
          s(:arg, :str)),
        s(:if,
          s(:match_with_lvasgn,
            s(:regexp,
              s(:str, "\\A [\\t\\n\\r\\x20-\\x7E]*\n"),
              s(:str, "      (?:\n"),
              s(:str, "        (?:\\x1b \\x28 I      [\\x21-\\x7E]*\n"),
              s(:str, "          |\\x1b \\x28 J      [\\x21-\\x7E]*\n"),
              s(:str, "          |\\x1b \\x24 @      (?:[\\x21-\\x7E]{2})*\n"),
              s(:str, "          |\\x1b \\x24 B      (?:[\\x21-\\x7E]{2})*\n"),
              s(:str, "          |\\x1b \\x24 \\x28 D (?:[\\x21-\\x7E]{2})*\n"),
              s(:str, "        )*\n"),
              s(:str, "        \\x1b \\x28 B [\\t\\n\\r\\x20-\\x7E]*\n"),
              s(:str, "      )*\n"),
              s(:str, "     \\z"),
              s(:regopt, :n, :o, :x)),
            s(:send,
              s(:send,
                s(:lvar, :str), :dup), :force_encoding,
              s(:str, "BINARY"))),
          s(:true),
          s(:false))),
      s(:send, nil, :module_function,
        s(:sym, :isjis)),
      s(:def, :isutf8,
        s(:args,
          s(:arg, :str)),
        s(:send,
          s(:send,
            s(:send,
              s(:lvar, :str), :dup), :force_encoding,
            s(:const, nil, :UTF8)), :valid_encoding?)),
      s(:send, nil, :module_function,
        s(:sym, :isutf8)))),
  s(:class,
    s(:const, nil, :String), nil,
    s(:begin,
      s(:def, :kconv,
        s(:args,
          s(:arg, :to_enc),
          s(:optarg, :from_enc,
            s(:nil))),
        s(:begin,
          s(:if,
            s(:and,
              s(:send,
                s(:lvar, :from_enc), :!),
              s(:send,
                s(:send,
                  s(:self), :encoding), :!=,
                s(:send,
                  s(:send,
                    s(:const, nil, :Encoding), :list), :[],
                  s(:int, 0)))),
            s(:lvasgn, :from_enc,
              s(:send,
                s(:self), :encoding)), nil),
          s(:send,
            s(:const, nil, :Kconv), :kconv,
            s(:self),
            s(:lvar, :to_enc),
            s(:lvar, :from_enc)))),
      s(:def, :tojis,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :tojis,
          s(:self))),
      s(:def, :toeuc,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :toeuc,
          s(:self))),
      s(:def, :tosjis,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :tosjis,
          s(:self))),
      s(:def, :toutf8,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :toutf8,
          s(:self))),
      s(:def, :toutf16,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :toutf16,
          s(:self))),
      s(:def, :toutf32,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :toutf32,
          s(:self))),
      s(:def, :tolocale,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :tolocale,
          s(:self))),
      s(:def, :iseuc,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :iseuc,
          s(:self))),
      s(:def, :issjis,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :issjis,
          s(:self))),
      s(:def, :isjis,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :isjis,
          s(:self))),
      s(:def, :isutf8,
        s(:args),
        s(:send,
          s(:const, nil, :Kconv), :isutf8,
          s(:self))))))
