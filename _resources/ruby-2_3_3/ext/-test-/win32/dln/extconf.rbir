s(:if,
  s(:or,
    s(:gvar, :$mingw),
    s(:gvar, :$mswin)),
  s(:begin,
    s(:lvasgn, :dlntestlib,
      s(:dstr,
        s(:str, "dlntest."),
        s(:begin,
          s(:gvar, :$LIBEXT)))),
    s(:send,
      s(:gvar, :$LOCAL_LIBS), :<<,
      s(:dstr,
        s(:str, " "),
        s(:begin,
          s(:lvar, :dlntestlib)))),
    s(:gvasgn, :$srcs,
      s(:array,
        s(:str, "dlntest.c"))),
    s(:gvasgn, :$objs,
      s(:array,
        s(:str, "dlntest.o"))),
    s(:lvasgn, :testdll,
      s(:str, "$(topdir)/dlntest.dll")),
    s(:send,
      s(:gvar, :$cleanfiles), :<<,
      s(:lvar, :testdll)),
    s(:send,
      s(:gvar, :$cleanfiles), :<<,
      s(:dstr,
        s(:str, "dlntest."),
        s(:begin,
          s(:gvar, :$LIBEXT)))),
    s(:block,
      s(:send, nil, :config_string,
        s(:str, "cleanobjs")),
      s(:args,
        s(:arg, :t)),
      s(:send,
        s(:gvar, :$cleanfiles), :concat,
        s(:send,
          s(:send,
            s(:lvar, :t), :gsub,
            s(:regexp,
              s(:str, "\\$\\*"),
              s(:regopt)),
            s(:str, "dlntest")), :split))),
    s(:block,
      s(:send, nil, :create_makefile,
        s(:str, "-test-/win32/dln")),
      s(:args,
        s(:arg, :m)),
      s(:begin,
        s(:send,
          s(:lvar, :m), :<<,
          s(:dstr,
            s(:str, "\n"),
            s(:dstr,
              s(:str, "DLNTESTLIB = "),
              s(:begin,
                s(:lvar, :dlntestlib)),
              s(:str, "\n")))),
        s(:if,
          s(:gvar, :$mingw),
          s(:begin,
            s(:send,
              s(:lvar, :m), :<<,
              s(:str, "\n")),
            s(:send,
              s(:lvar, :m), :<<,
              s(:str, "$(topdir)/dlntest.dll: DEFFILE := $(srcdir)/libdlntest.def\n")),
            s(:send,
              s(:lvar, :m), :<<,
              s(:str, "$(topdir)/dlntest.dll: DLDFLAGS += -Wl,--out-implib,$(DLNTESTLIB)\n"))), nil),
        s(:lvar, :m))),
    s(:lvasgn, :m,
      s(:send,
        s(:const, nil, :File), :read,
        s(:str, "Makefile"))),
    s(:and,
      s(:block,
        s(:send,
          s(:lvar, :m), :sub!,
          s(:regexp,
            s(:str, "(.*)\\$\\(DLNTEST_LDSHARED\\)$"),
            s(:regopt))),
        s(:args),
        s(:begin,
          s(:lvasgn, :pre,
            s(:nth_ref, 1)),
          s(:lvasgn, :link_so,
            s(:block,
              s(:send,
                s(:const, nil, :LINK_SO), :gsub,
                s(:regexp,
                  s(:str, "^"),
                  s(:regopt))),
              s(:args),
              s(:lvar, :pre))),
          s(:send,
            s(:lvar, :link_so), :sub!,
            s(:regexp,
              s(:str, "\\$\\(LOCAL_LIBS\\)"),
              s(:regopt)),
            s(:str, "")),
          s(:send,
            s(:lvar, :link_so), :gsub!,
            s(:regexp,
              s(:str, "-\\$\\(arch\\)"),
              s(:regopt)),
            s(:str, "")),
          s(:send,
            s(:lvar, :link_so), :gsub!,
            s(:regexp,
              s(:str, ":.so="),
              s(:regopt)),
            s(:str, ":.dll=")),
          s(:send,
            s(:lvar, :link_so), :sub!,
            s(:regexp,
              s(:str, "\\$\\(OBJS\\)"),
              s(:regopt)),
            s(:dstr,
              s(:str, "libdlntest."),
              s(:begin,
                s(:gvar, :$OBJEXT)))),
          s(:send,
            s(:lvar, :link_so), :sub!,
            s(:regexp,
              s(:str, "\\$\\(DEFFILE\\)"),
              s(:regopt)),
            s(:str, "$(srcdir)/libdlntest.def")),
          s(:lvar, :link_so))),
      s(:send,
        s(:const, nil, :File), :binwrite,
        s(:str, "Makefile"),
        s(:lvar, :m))),
    s(:send,
      s(:const, nil, :FileUtils), :rm_f,
      s(:send,
        s(:const, nil, :RbConfig), :expand,
        s(:send,
          s(:lvar, :testdll), :dup)))), nil)
