s(:begin,
  s(:send, nil, :require,
    s(:str, "digest.so")),
  s(:module,
    s(:const, nil, :Digest),
    s(:begin,
      s(:casgn, nil, :REQUIRE_MUTEX,
        s(:send,
          s(:const, nil, :Mutex), :new)),
      s(:defs,
        s(:self), :const_missing,
        s(:args,
          s(:arg, :name)),
        s(:begin,
          s(:case,
            s(:lvar, :name),
            s(:when,
              s(:sym, :SHA256),
              s(:sym, :SHA384),
              s(:sym, :SHA512),
              s(:lvasgn, :lib,
                s(:str, "digest/sha2.so"))),
            s(:lvasgn, :lib,
              s(:send,
                s(:const, nil, :File), :join,
                s(:str, "digest"),
                s(:send,
                  s(:send,
                    s(:lvar, :name), :to_s), :downcase)))),
          s(:kwbegin,
            s(:rescue,
              s(:send, nil, :require,
                s(:lvar, :lib)),
              s(:resbody,
                s(:array,
                  s(:const, nil, :LoadError)), nil,
                s(:send, nil, :raise,
                  s(:const, nil, :LoadError),
                  s(:dstr,
                    s(:str, "library not found for class Digest::"),
                    s(:begin,
                      s(:lvar, :name)),
                    s(:str, " -- "),
                    s(:begin,
                      s(:lvar, :lib))),
                  s(:send, nil, :caller,
                    s(:int, 1)))), nil)),
          s(:if,
            s(:send,
              s(:const, nil, :Digest), :const_defined?,
              s(:lvar, :name)), nil,
            s(:send, nil, :raise,
              s(:const, nil, :NameError),
              s(:dstr,
                s(:str, "uninitialized constant Digest::"),
                s(:begin,
                  s(:lvar, :name))),
              s(:send, nil, :caller,
                s(:int, 1)))),
          s(:send,
            s(:const, nil, :Digest), :const_get,
            s(:lvar, :name)))),
      s(:class,
        s(:const,
          s(:const,
            s(:cbase), :Digest), :Class), nil,
        s(:begin,
          s(:defs,
            s(:self), :file,
            s(:args,
              s(:arg, :name),
              s(:restarg, :args)),
            s(:send,
              s(:send, nil, :new,
                s(:splat,
                  s(:lvar, :args))), :file,
              s(:lvar, :name))),
          s(:defs,
            s(:self), :base64digest,
            s(:args,
              s(:arg, :str),
              s(:restarg, :args)),
            s(:send,
              s(:array,
                s(:send, nil, :digest,
                  s(:lvar, :str),
                  s(:splat,
                    s(:lvar, :args)))), :pack,
              s(:str, "m0"))))),
      s(:module,
        s(:const, nil, :Instance),
        s(:begin,
          s(:def, :file,
            s(:args,
              s(:arg, :name)),
            s(:begin,
              s(:block,
                s(:send,
                  s(:const, nil, :File), :open,
                  s(:lvar, :name),
                  s(:str, "rb")),
                s(:args,
                  s(:arg, :f)),
                s(:begin,
                  s(:lvasgn, :buf,
                    s(:str, "")),
                  s(:while,
                    s(:send,
                      s(:lvar, :f), :read,
                      s(:int, 16384),
                      s(:lvar, :buf)),
                    s(:send, nil, :update,
                      s(:lvar, :buf))))),
              s(:self))),
          s(:def, :base64digest,
            s(:args,
              s(:optarg, :str,
                s(:nil))),
            s(:send,
              s(:array,
                s(:if,
                  s(:lvar, :str),
                  s(:send, nil, :digest,
                    s(:lvar, :str)),
                  s(:send, nil, :digest))), :pack,
              s(:str, "m0"))),
          s(:def, :base64digest!,
            s(:args),
            s(:send,
              s(:array,
                s(:send, nil, :digest!)), :pack,
              s(:str, "m0"))))))),
  s(:def, :Digest,
    s(:args,
      s(:arg, :name)),
    s(:rescue,
      s(:begin,
        s(:lvasgn, :const,
          s(:send,
            s(:lvar, :name), :to_sym)),
        s(:block,
          s(:send,
            s(:const,
              s(:const, nil, :Digest), :REQUIRE_MUTEX), :synchronize),
          s(:args),
          s(:send,
            s(:const, nil, :Digest), :const_missing,
            s(:lvar, :const)))),
      s(:resbody,
        s(:array,
          s(:const, nil, :LoadError)), nil,
        s(:if,
          s(:send,
            s(:const, nil, :Digest), :const_defined?,
            s(:lvar, :const)),
          s(:send,
            s(:const, nil, :Digest), :const_get,
            s(:lvar, :const)),
          s(:send, nil, :raise))), nil)))
