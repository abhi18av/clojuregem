s(:begin,
  s(:send, nil, :require,
    s(:str, "mkmf")),
  s(:lvasgn, :target,
    s(:str, "io/wait")),
  s(:if,
    s(:send, nil, :macro_defined?,
      s(:str, "DOSISH"),
      s(:str, "#include <ruby.h>")),
    s(:if,
      s(:send, nil, :have_func,
        s(:str, "rb_w32_ioctlsocket"),
        s(:str, "ruby.h")),
      s(:begin,
        s(:send, nil, :have_func,
          s(:str, "rb_w32_is_socket"),
          s(:str, "ruby.h")),
        s(:send, nil, :create_makefile,
          s(:lvar, :target))), nil),
    s(:begin,
      s(:or,
        s(:send, nil, :have_header,
          s(:lvasgn, :ioctl_h,
            s(:str, "sys/ioctl.h"))),
        s(:lvasgn, :ioctl_h,
          s(:nil))),
      s(:lvasgn, :fionread,
        s(:block,
          s(:send,
            s(:array,
              s(:str, "sys/ioctl.h"),
              s(:str, "sys/filio.h"),
              s(:str, "sys/socket.h")), :find),
          s(:args,
            s(:arg, :h)),
          s(:send, nil, :have_macro,
            s(:str, "FIONREAD"),
            s(:send,
              s(:array,
                s(:lvar, :h),
                s(:lvar, :ioctl_h)), :compact)))),
      s(:if,
        s(:lvar, :fionread),
        s(:begin,
          s(:send,
            s(:gvar, :$defs), :<<,
            s(:dstr,
              s(:str, "-DFIONREAD_HEADER=\"<"),
              s(:begin,
                s(:lvar, :fionread)),
              s(:str, ">\""))),
          s(:send, nil, :create_makefile,
            s(:lvar, :target))), nil))))
