s(:begin,
  s(:send, nil, :require,
    s(:str, "mkmf")),
  s(:case,
    s(:const, nil, :RUBY_PLATFORM),
    s(:when,
      s(:regexp,
        s(:str, "cygwin"),
        s(:regopt)),
      s(:begin,
        s(:lvasgn, :inc,
          s(:nil)),
        s(:lvasgn, :lib,
          s(:str, "/usr/lib/w32api")))), nil),
  s(:send, nil, :dir_config,
    s(:str, "win32"),
    s(:lvar, :inc),
    s(:lvar, :lib)),
  s(:def, :create_win32ole_makefile,
    s(:args),
    s(:if,
      s(:and,
        s(:and,
          s(:and,
            s(:and,
              s(:and,
                s(:and,
                  s(:send, nil, :have_library,
                    s(:str, "ole32")),
                  s(:send, nil, :have_library,
                    s(:str, "oleaut32"))),
                s(:send, nil, :have_library,
                  s(:str, "uuid"),
                  s(:str, "&CLSID_CMultiLanguage"),
                  s(:str, "mlang.h"))),
              s(:send, nil, :have_library,
                s(:str, "user32"))),
            s(:send, nil, :have_library,
              s(:str, "kernel32"))),
          s(:send, nil, :have_library,
            s(:str, "advapi32"))),
        s(:send, nil, :have_header,
          s(:str, "windows.h"))),
      s(:begin,
        s(:if,
          s(:send, nil, :have_type,
            s(:str, "IMultiLanguage2"),
            s(:str, "mlang.h")), nil,
          s(:send, nil, :have_type,
            s(:str, "IMultiLanguage"),
            s(:str, "mlang.h"))),
        s(:lvasgn, :spec,
          s(:nil)),
        s(:block,
          s(:send, nil, :checking_for,
            s(:str, "thread_specific"),
            s(:str, "%s")),
          s(:args),
          s(:begin,
            s(:lvasgn, :spec,
              s(:block,
                s(:send,
                  s(:array,
                    s(:str, "__declspec(thread)"),
                    s(:str, "__thread")), :find),
                s(:args,
                  s(:arg, :th)),
                s(:send, nil, :try_compile,
                  s(:dstr,
                    s(:begin,
                      s(:lvar, :th)),
                    s(:str, " int foo;")),
                  s(:str, ""),
                  s(:hash,
                    s(:pair,
                      s(:sym, :werror),
                      s(:true)))))),
            s(:or,
              s(:lvar, :spec),
              s(:str, "no")))),
        s(:if,
          s(:lvar, :spec),
          s(:send,
            s(:gvar, :$defs), :<<,
            s(:dstr,
              s(:str, "-DRB_THREAD_SPECIFIC="),
              s(:begin,
                s(:lvar, :spec)))), nil),
        s(:send, nil, :create_makefile,
          s(:str, "win32ole"))), nil)),
  s(:case,
    s(:const, nil, :RUBY_PLATFORM),
    s(:when,
      s(:regexp,
        s(:str, "mswin"),
        s(:regopt)),
      s(:or,
        s(:send,
          s(:gvar, :$CFLAGS), :sub!,
          s(:regexp,
            s(:str, "((?:\\A|\\s)[-/])W\\d(?=\\z|\\s)"),
            s(:regopt)),
          s(:str, "\\1W3")),
        s(:op_asgn,
          s(:gvasgn, :$CFLAGS), :+,
          s(:str, " -W3")))), nil),
  s(:send, nil, :create_win32ole_makefile))
