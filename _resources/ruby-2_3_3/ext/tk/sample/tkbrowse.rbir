s(:begin,
  s(:send, nil, :require,
    s(:str, "tkscrollbox")),
  s(:gvasgn, :$dirlist,
    s(:hash)),
  s(:def, :browsedir,
    s(:args,
      s(:arg, :dir)),
    s(:if,
      s(:send,
        s(:gvar, :$dirlist), :key?,
        s(:lvar, :dir)),
      s(:send,
        s(:gvar, :$dirlist), :[],
        s(:lvar, :dir)),
      s(:begin,
        s(:lvasgn, :top,
          s(:if,
            s(:send,
              s(:send,
                s(:gvar, :$dirlist), :size), :>,
              s(:int, 0)),
            s(:send,
              s(:const, nil, :TkToplevel), :new),
            s(:nil))),
        s(:lvasgn, :list,
          s(:block,
            s(:send,
              s(:const, nil, :TkScrollbox), :new,
              s(:lvar, :top)),
            s(:args),
            s(:begin,
              s(:send, nil, :relief,
                s(:str, "raised")),
              s(:send, nil, :width,
                s(:int, 20)),
              s(:send, nil, :height,
                s(:int, 20)),
              s(:send, nil, :setgrid,
                s(:str, "yes")),
              s(:send, nil, :pack)))),
        s(:send,
          s(:lvar, :list), :insert,
          s(:str, "end"),
          s(:splat,
            s(:send,
              s(:xstr,
                s(:str, "ls "),
                s(:begin,
                  s(:lvar, :dir))), :split))),
        s(:send,
          s(:lvar, :list), :focus),
        s(:send,
          s(:lvar, :list), :bind,
          s(:str, "Control-q"),
          s(:block,
            s(:send, nil, :proc),
            s(:args),
            s(:send, nil, :exit))),
        s(:send,
          s(:lvar, :list), :bind,
          s(:str, "Control-c"),
          s(:block,
            s(:send, nil, :proc),
            s(:args),
            s(:send, nil, :exit))),
        s(:send,
          s(:lvar, :list), :bind,
          s(:str, "Control-p"),
          s(:block,
            s(:send, nil, :proc),
            s(:args),
            s(:send, nil, :print,
              s(:str, "selection <"),
              s(:send,
                s(:const, nil, :TkSelection), :get),
              s(:str, ">\n")))),
        s(:send,
          s(:lvar, :list), :bind,
          s(:str, "Double-Button-1"),
          s(:block,
            s(:send, nil, :proc),
            s(:args),
            s(:for,
              s(:lvasgn, :i),
              s(:send,
                s(:send,
                  s(:const, nil, :TkSelection), :get), :split),
              s(:begin,
                s(:send, nil, :print,
                  s(:str, "clicked "),
                  s(:lvar, :i),
                  s(:str, "\n")),
                s(:send, nil, :browse,
                  s(:lvar, :dir),
                  s(:lvar, :i)))))),
        s(:send,
          s(:gvar, :$dirlist), :[]=,
          s(:lvar, :dir),
          s(:lvar, :list))))),
  s(:def, :browse,
    s(:args,
      s(:arg, :dir),
      s(:arg, :file)),
    s(:begin,
      s(:lvasgn, :file,
        s(:dstr,
          s(:begin,
            s(:lvar, :dir)),
          s(:str, "/"),
          s(:begin,
            s(:lvar, :file)))),
      s(:if,
        s(:send,
          s(:const, nil, :File), :directory?,
          s(:lvar, :file)),
        s(:send, nil, :browsedir,
          s(:lvar, :file)),
        s(:if,
          s(:send,
            s(:const, nil, :File), :file?,
            s(:lvar, :file)),
          s(:if,
            s(:send,
              s(:const, nil, :ENV), :[],
              s(:str, "EDITOR")),
            s(:send, nil, :system,
              s(:send, nil, :format,
                s(:str, "%s %s&"),
                s(:send,
                  s(:const, nil, :ENV), :[],
                  s(:str, "EDITOR")),
                s(:lvar, :file))),
            s(:send, nil, :system,
              s(:dstr,
                s(:str, "xedit "),
                s(:begin,
                  s(:lvar, :file)),
                s(:str, "&")))),
          s(:send,
            s(:const, nil, :STDERR), :print,
            s(:dstr,
              s(:str, "\""),
              s(:begin,
                s(:lvar, :file)),
              s(:str, "\" isn't a directory or regular file"))))))),
  s(:if,
    s(:send,
      s(:send,
        s(:const, nil, :ARGV), :length), :>,
      s(:int, 0)),
    s(:lvasgn, :dir,
      s(:send,
        s(:const, nil, :ARGV), :[],
        s(:int, 0))),
    s(:lvasgn, :dir,
      s(:str, "."))),
  s(:send, nil, :browsedir,
    s(:lvar, :dir)),
  s(:send,
    s(:const, nil, :Tk), :mainloop))
