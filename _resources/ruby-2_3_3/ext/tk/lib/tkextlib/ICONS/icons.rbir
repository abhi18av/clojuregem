s(:begin,
  s(:send, nil, :require,
    s(:str, "tk")),
  s(:send, nil, :require,
    s(:str, "tkextlib/setup.rb")),
  s(:send, nil, :require,
    s(:str, "tkextlib/ICONS/setup.rb")),
  s(:send,
    s(:const, nil, :TkPackage), :require,
    s(:str, "icons")),
  s(:module,
    s(:const, nil, :Tk),
    s(:class,
      s(:const, nil, :ICONS),
      s(:const, nil, :TkImage),
      s(:begin,
        s(:send, nil, :extend,
          s(:const, nil, :Tk)),
        s(:casgn, nil, :PACKAGE_NAME,
          s(:send,
            s(:str, "icons"), :freeze)),
        s(:defs,
          s(:self), :package_name,
          s(:args),
          s(:const, nil, :PACKAGE_NAME)),
        s(:defs,
          s(:self), :package_version,
          s(:args),
          s(:kwbegin,
            s(:rescue,
              s(:send,
                s(:const, nil, :TkPackage), :require,
                s(:str, "icons")),
              s(:resbody, nil, nil,
                s(:str, "")), nil))),
        s(:defs,
          s(:self), :create,
          s(:args,
            s(:restarg, :args)),
          s(:begin,
            s(:if,
              s(:send,
                s(:send,
                  s(:lvar, :args), :[],
                  s(:int, -1)), :kind_of?,
                s(:const, nil, :Hash)),
              s(:begin,
                s(:lvasgn, :keys,
                  s(:send,
                    s(:lvar, :args), :pop)),
                s(:lvasgn, :icons,
                  s(:send, nil, :simplelist,
                    s(:send, nil, :tk_call,
                      s(:str, "::icons::icons"),
                      s(:str, "create"),
                      s(:splat,
                        s(:begin,
                          s(:send,
                            s(:send, nil, :hash_kv,
                              s(:lvar, :keys)), :<<,
                            s(:begin,
                              s(:send,
                                s(:lvar, :args), :flatten))))))))),
              s(:lvasgn, :icons,
                s(:send, nil, :simplelist,
                  s(:send, nil, :tk_call,
                    s(:str, "::icons::icons"),
                    s(:str, "create"),
                    s(:send,
                      s(:lvar, :args), :flatten))))),
            s(:block,
              s(:send,
                s(:lvar, :icons), :collect),
              s(:args,
                s(:arg, :icon)),
              s(:send,
                s(:self), :new,
                s(:lvar, :icon),
                s(:hash,
                  s(:pair,
                    s(:sym, :without_creating),
                    s(:true))))))),
        s(:defs,
          s(:self), :delete,
          s(:args,
            s(:restarg, :icons)),
          s(:begin,
            s(:lvasgn, :icons,
              s(:send,
                s(:lvar, :icons), :flatten)),
            s(:if,
              s(:send,
                s(:lvar, :icons), :empty?),
              s(:return), nil),
            s(:block,
              s(:send,
                s(:lvar, :icons), :map!),
              s(:args,
                s(:arg, :icon)),
              s(:if,
                s(:send,
                  s(:lvar, :icon), :kind_of?,
                  s(:const,
                    s(:const, nil, :Tk), :ICONS)),
                s(:begin,
                  s(:send,
                    s(:const, nil, :Tk_IMGTBL), :delete,
                    s(:send,
                      s(:lvar, :icon), :path)),
                  s(:send,
                    s(:lvar, :icon), :name)),
                s(:if,
                  s(:send,
                    s(:send,
                      s(:lvar, :icon), :to_s), :=~,
                    s(:regexp,
                      s(:str, "^::icon::(.*)"),
                      s(:regopt))),
                  s(:begin,
                    s(:lvasgn, :name,
                      s(:nth_ref, 1)),
                    s(:send,
                      s(:const, nil, :Tk_IMGTBL), :delete,
                      s(:lvar, :icon)),
                    s(:lvar, :name)),
                  s(:begin,
                    s(:send,
                      s(:const, nil, :Tk_IMGTBL), :delete,
                      s(:dstr,
                        s(:str, "::icon::"),
                        s(:begin,
                          s(:lvar, :icon)))),
                    s(:lvar, :icon))))),
            s(:send, nil, :tk_call,
              s(:str, "::icons::icons"),
              s(:str, "delete"),
              s(:lvar, :icons)))),
        s(:defs,
          s(:self), :query,
          s(:args,
            s(:restarg, :args)),
          s(:block,
            s(:send,
              s(:if,
                s(:send,
                  s(:send,
                    s(:lvar, :args), :[],
                    s(:int, -1)), :kind_of?,
                  s(:const, nil, :Hash)),
                s(:begin,
                  s(:lvasgn, :keys,
                    s(:send,
                      s(:lvar, :args), :pop)),
                  s(:send, nil, :simplelist,
                    s(:send, nil, :tk_call,
                      s(:str, "::icons::icons"),
                      s(:str, "query"),
                      s(:splat,
                        s(:begin,
                          s(:send,
                            s(:send, nil, :hash_kv,
                              s(:lvar, :keys)), :<<,
                            s(:begin,
                              s(:send,
                                s(:lvar, :args), :flatten)))))))),
                s(:send, nil, :simplelist,
                  s(:send, nil, :tk_call,
                    s(:str, "::icons::icons"),
                    s(:str, "query"),
                    s(:send,
                      s(:lvar, :args), :flatten)))), :map),
            s(:args,
              s(:arg, :inf)),
            s(:send, nil, :list,
              s(:lvar, :inf)))),
        s(:sclass,
          s(:self),
          s(:begin,
            s(:alias,
              s(:sym, :_new),
              s(:sym, :new)),
            s(:def, :new,
              s(:args,
                s(:arg, :name),
                s(:optarg, :keys,
                  s(:nil))),
              s(:begin,
                s(:if,
                  s(:lvasgn, :obj,
                    s(:send,
                      s(:const, nil, :Tk_IMGTBL), :[],
                      s(:dstr,
                        s(:str, "::icon::"),
                        s(:begin,
                          s(:lvar, :name))))),
                  s(:if,
                    s(:lvar, :keys),
                    s(:begin,
                      s(:lvasgn, :keys,
                        s(:send, nil, :_symbolkey2str,
                          s(:lvar, :keys))),
                      s(:if,
                        s(:send,
                          s(:lvar, :keys), :delete,
                          s(:str, "without_creating")), nil,
                        s(:send, nil, :tk_call,
                          s(:str, "::icons::icons"),
                          s(:str, "create"),
                          s(:splat,
                            s(:begin,
                              s(:send,
                                s(:send, nil, :hash_kv,
                                  s(:lvar, :keys)), :<<,
                                s(:send,
                                  s(:lvar, :obj), :name))))))), nil),
                  s(:lvasgn, :obj,
                    s(:send, nil, :_new,
                      s(:lvar, :name),
                      s(:lvar, :keys)))),
                s(:lvar, :obj))))),
        s(:def, :initialize,
          s(:args,
            s(:arg, :name),
            s(:optarg, :keys,
              s(:nil))),
          s(:begin,
            s(:if,
              s(:and,
                s(:send,
                  s(:lvar, :name), :kind_of?,
                  s(:const, nil, :String)),
                s(:send,
                  s(:lvar, :name), :=~,
                  s(:regexp,
                    s(:str, "^::icon::(.+)$"),
                    s(:regopt)))),
              s(:begin,
                s(:ivasgn, :@name,
                  s(:nth_ref, 1)),
                s(:ivasgn, :@path,
                  s(:lvar, :name))),
              s(:begin,
                s(:ivasgn, :@name,
                  s(:send,
                    s(:lvar, :name), :to_s)),
                s(:ivasgn, :@path,
                  s(:dstr,
                    s(:str, "::icon::"),
                    s(:begin,
                      s(:ivar, :@name)))))),
            s(:lvasgn, :keys,
              s(:send, nil, :_symbolkey2str,
                s(:lvar, :keys))),
            s(:if,
              s(:send,
                s(:lvar, :keys), :delete,
                s(:str, "without_creating")), nil,
              s(:send, nil, :tk_call,
                s(:str, "::icons::icons"),
                s(:str, "create"),
                s(:splat,
                  s(:begin,
                    s(:send,
                      s(:send, nil, :hash_kv,
                        s(:lvar, :keys)), :<<,
                      s(:ivar, :@name)))))),
            s(:send,
              s(:const, nil, :Tk_IMGTBL), :[]=,
              s(:ivar, :@path),
              s(:self)))),
        s(:def, :name,
          s(:args),
          s(:ivar, :@name)),
        s(:def, :delete,
          s(:args),
          s(:begin,
            s(:send,
              s(:const, nil, :Tk_IMGTBL), :delete,
              s(:ivar, :@path)),
            s(:send, nil, :tk_call,
              s(:str, "::icons::icons"),
              s(:str, "delete"),
              s(:ivar, :@name)),
            s(:self))),
        s(:def, :query,
          s(:args,
            s(:optarg, :keys,
              s(:hash))),
          s(:send, nil, :list,
            s(:send,
              s(:send, nil, :simplelist,
                s(:send, nil, :tk_call,
                  s(:str, "::icons::icons"),
                  s(:str, "query"),
                  s(:splat,
                    s(:begin,
                      s(:send,
                        s(:send, nil, :hash_kv,
                          s(:lvar, :keys)), :<<,
                        s(:ivar, :@name)))))), :[],
              s(:int, 0))))))))
