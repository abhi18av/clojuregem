s(:module,
  s(:const, nil, :Psych),
  s(:module,
    s(:const, nil, :Visitors),
    s(:class,
      s(:const, nil, :Visitor), nil,
      s(:begin,
        s(:def, :accept,
          s(:args,
            s(:arg, :target)),
          s(:send, nil, :visit,
            s(:lvar, :target))),
        s(:send, nil, :private),
        s(:casgn, nil, :DISPATCH,
          s(:block,
            s(:send,
              s(:const, nil, :Hash), :new),
            s(:args,
              s(:arg, :hash),
              s(:arg, :klass)),
            s(:send,
              s(:lvar, :hash), :[]=,
              s(:lvar, :klass),
              s(:dstr,
                s(:str, "visit_"),
                s(:begin,
                  s(:send,
                    s(:send,
                      s(:lvar, :klass), :name), :gsub,
                    s(:str, "::"),
                    s(:str, "_"))))))),
        s(:def, :visit,
          s(:args,
            s(:arg, :target)),
          s(:send, nil, :send,
            s(:send,
              s(:const, nil, :DISPATCH), :[],
              s(:send,
                s(:lvar, :target), :class)),
            s(:lvar, :target)))))))
