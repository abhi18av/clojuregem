s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/test_case")),
  s(:send, nil, :require,
    s(:str, "rubygems/local_remote_options")),
  s(:send, nil, :require,
    s(:str, "rubygems/command")),
  s(:class,
    s(:const, nil, :TestGemLocalRemoteOptions),
    s(:const,
      s(:const, nil, :Gem), :TestCase),
    s(:begin,
      s(:def, :setup,
        s(:args),
        s(:begin,
          s(:zsuper),
          s(:ivasgn, :@cmd,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Command), :new,
              s(:str, "dummy"),
              s(:str, "dummy"))),
          s(:send,
            s(:ivar, :@cmd), :extend,
            s(:const,
              s(:const, nil, :Gem), :LocalRemoteOptions)))),
      s(:def, :test_add_local_remote_options,
        s(:args),
        s(:begin,
          s(:send,
            s(:ivar, :@cmd), :add_local_remote_options),
          s(:lvasgn, :args,
            s(:array,
              s(:str, "-l"),
              s(:str, "-r"),
              s(:str, "-b"),
              s(:str, "-B"),
              s(:str, "10"),
              s(:str, "--source"),
              s(:str, "http://gems.example.com"),
              s(:str, "-p"),
              s(:str, "--update-sources"))),
          s(:send, nil, :assert,
            s(:send,
              s(:ivar, :@cmd), :handles?,
              s(:lvar, :args))))),
      s(:def, :test_both_eh,
        s(:args),
        s(:begin,
          s(:send, nil, :assert_equal,
            s(:false),
            s(:send,
              s(:ivar, :@cmd), :both?)),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :domain),
            s(:sym, :local)),
          s(:send, nil, :assert_equal,
            s(:false),
            s(:send,
              s(:ivar, :@cmd), :both?)),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :domain),
            s(:sym, :both)),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:send,
              s(:ivar, :@cmd), :both?)))),
      s(:def, :test_clear_sources_option,
        s(:args),
        s(:begin,
          s(:send,
            s(:ivar, :@cmd), :add_local_remote_options),
          s(:lvasgn, :s,
            s(:send,
              s(:const, nil, :URI), :parse,
              s(:str, "http://only-gems.example.com/"))),
          s(:send,
            s(:ivar, :@cmd), :handle_options,
            s(:array,
              s(:str, "--clear-sources"),
              s(:str, "--source"),
              s(:dstr,
                s(:begin,
                  s(:lvar, :s))))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:send,
                s(:lvar, :s), :to_s)),
            s(:send,
              s(:const, nil, :Gem), :sources)))),
      s(:def, :test_clear_sources_option_idiot_proof,
        s(:args),
        s(:begin,
          s(:send, nil, :spec_fetcher),
          s(:send,
            s(:ivar, :@cmd), :add_local_remote_options),
          s(:send,
            s(:ivar, :@cmd), :handle_options,
            s(:array,
              s(:str, "--clear-sources"))),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:const, nil, :Gem), :default_sources),
            s(:send,
              s(:const, nil, :Gem), :sources)))),
      s(:def, :test_local_eh,
        s(:args),
        s(:begin,
          s(:send, nil, :assert_equal,
            s(:false),
            s(:send,
              s(:ivar, :@cmd), :local?)),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :domain),
            s(:sym, :local)),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:send,
              s(:ivar, :@cmd), :local?)),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :domain),
            s(:sym, :both)),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:send,
              s(:ivar, :@cmd), :local?)))),
      s(:def, :test_remote_eh,
        s(:args),
        s(:begin,
          s(:send, nil, :assert_equal,
            s(:false),
            s(:send,
              s(:ivar, :@cmd), :remote?)),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :domain),
            s(:sym, :remote)),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:send,
              s(:ivar, :@cmd), :remote?)),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :domain),
            s(:sym, :both)),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:send,
              s(:ivar, :@cmd), :remote?)))),
      s(:def, :test_source_option,
        s(:args),
        s(:begin,
          s(:send,
            s(:ivar, :@cmd), :add_source_option),
          s(:lvasgn, :s1,
            s(:send,
              s(:const, nil, :URI), :parse,
              s(:str, "http://more-gems.example.com/"))),
          s(:lvasgn, :s2,
            s(:send,
              s(:const, nil, :URI), :parse,
              s(:str, "http://even-more-gems.example.com/"))),
          s(:lvasgn, :s3,
            s(:send,
              s(:const, nil, :URI), :parse,
              s(:str, "http://other-gems.example.com/some_subdir"))),
          s(:lvasgn, :s4,
            s(:send,
              s(:const, nil, :URI), :parse,
              s(:str, "http://more-gems.example.com/"))),
          s(:lvasgn, :original_sources,
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :sources), :dup)),
          s(:send,
            s(:ivar, :@cmd), :handle_options,
            s(:array,
              s(:str, "--source"),
              s(:dstr,
                s(:begin,
                  s(:lvar, :s1))),
              s(:str, "--source"),
              s(:dstr,
                s(:begin,
                  s(:lvar, :s2))),
              s(:str, "--source"),
              s(:dstr,
                s(:begin,
                  s(:lvar, :s3))),
              s(:str, "--source"),
              s(:dstr,
                s(:begin,
                  s(:lvar, :s4))))),
          s(:send,
            s(:lvar, :original_sources), :<<,
            s(:send,
              s(:lvar, :s1), :to_s)),
          s(:send,
            s(:lvar, :original_sources), :<<,
            s(:send,
              s(:lvar, :s2), :to_s)),
          s(:send,
            s(:lvar, :original_sources), :<<,
            s(:dstr,
              s(:begin,
                s(:lvar, :s3)),
              s(:str, "/"))),
          s(:send, nil, :assert_equal,
            s(:lvar, :original_sources),
            s(:send,
              s(:const, nil, :Gem), :sources)))),
      s(:def, :test_short_source_option,
        s(:args),
        s(:begin,
          s(:send,
            s(:ivar, :@cmd), :add_source_option),
          s(:lvasgn, :original_sources,
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :sources), :dup)),
          s(:lvasgn, :source,
            s(:send,
              s(:const, nil, :URI), :parse,
              s(:str, "http://more-gems.example.com/"))),
          s(:send,
            s(:ivar, :@cmd), :handle_options,
            s(:array,
              s(:str, "-s"),
              s(:dstr,
                s(:begin,
                  s(:lvar, :source))))),
          s(:send,
            s(:lvar, :original_sources), :<<,
            s(:lvar, :source)),
          s(:send, nil, :assert_equal,
            s(:lvar, :original_sources),
            s(:send,
              s(:const, nil, :Gem), :sources)))),
      s(:def, :test_update_sources_option,
        s(:args),
        s(:begin,
          s(:send,
            s(:ivar, :@cmd), :add_update_sources_option),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :configuration), :update_sources=,
            s(:false)),
          s(:send,
            s(:ivar, :@cmd), :handle_options,
            s(:array,
              s(:str, "--update-sources"))),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :configuration), :update_sources)),
          s(:send,
            s(:ivar, :@cmd), :handle_options,
            s(:array,
              s(:str, "--no-update-sources"))),
          s(:send, nil, :assert_equal,
            s(:false),
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :configuration), :update_sources)))),
      s(:def, :test_source_option_bad,
        s(:args),
        s(:begin,
          s(:send,
            s(:ivar, :@cmd), :add_source_option),
          s(:lvasgn, :s1,
            s(:str, "htp://more-gems.example.com")),
          s(:block,
            s(:send, nil, :assert_raises,
              s(:const,
                s(:const, nil, :OptionParser), :InvalidArgument)),
            s(:args),
            s(:send,
              s(:ivar, :@cmd), :handle_options,
              s(:array,
                s(:str, "--source"),
                s(:dstr,
                  s(:begin,
                    s(:lvar, :s1)))))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:ivar, :@gem_repo)),
            s(:send,
              s(:const, nil, :Gem), :sources)))))))
