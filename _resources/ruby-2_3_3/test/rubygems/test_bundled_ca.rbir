s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/test_case")),
  s(:send, nil, :require,
    s(:str, "net/https")),
  s(:send, nil, :require,
    s(:str, "rubygems/request")),
  s(:if,
    s(:or,
      s(:send,
        s(:const, nil, :ENV), :[],
        s(:str, "TRAVIS")),
      s(:send,
        s(:const, nil, :ENV), :[],
        s(:str, "TEST_SSL"))),
    s(:class,
      s(:const, nil, :TestBundledCA),
      s(:const,
        s(:const, nil, :Gem), :TestCase),
      s(:begin,
        s(:casgn, nil, :THIS_FILE,
          s(:send,
            s(:const, nil, :File), :expand_path,
            s(:str, "(string)"))),
        s(:def, :bundled_certificate_store,
          s(:args),
          s(:begin,
            s(:lvasgn, :store,
              s(:send,
                s(:const,
                  s(:const,
                    s(:const, nil, :OpenSSL), :X509), :Store), :new)),
            s(:lvasgn, :ssl_cert_glob,
              s(:send,
                s(:const, nil, :File), :expand_path,
                s(:str, "../../../lib/rubygems/ssl_certs/*.pem"),
                s(:const, nil, :THIS_FILE))),
            s(:block,
              s(:send,
                s(:send,
                  s(:const, nil, :Dir), :[],
                  s(:lvar, :ssl_cert_glob)), :each),
              s(:args,
                s(:arg, :ssl_cert)),
              s(:send,
                s(:lvar, :store), :add_file,
                s(:lvar, :ssl_cert))),
            s(:lvar, :store))),
        s(:def, :assert_https,
          s(:args,
            s(:arg, :host)),
          s(:rescue,
            s(:begin,
              s(:if,
                s(:send,
                  s(:self), :respond_to?,
                  s(:sym, :_assertions)),
                s(:op_asgn,
                  s(:send,
                    s(:self), :_assertions), :+,
                  s(:int, 1)),
                s(:op_asgn,
                  s(:send,
                    s(:self), :assertions), :+,
                  s(:int, 1))),
              s(:lvasgn, :http,
                s(:send,
                  s(:const,
                    s(:const, nil, :Net), :HTTP), :new,
                  s(:lvar, :host),
                  s(:int, 443))),
              s(:send,
                s(:lvar, :http), :use_ssl=,
                s(:true)),
              s(:send,
                s(:lvar, :http), :verify_mode=,
                s(:const,
                  s(:const,
                    s(:const, nil, :OpenSSL), :SSL), :VERIFY_PEER)),
              s(:send,
                s(:lvar, :http), :cert_store=,
                s(:send, nil, :bundled_certificate_store)),
              s(:send,
                s(:lvar, :http), :get,
                s(:str, "/"))),
            s(:resbody,
              s(:array,
                s(:const,
                  s(:const, nil, :Errno), :ENOENT),
                s(:const,
                  s(:const, nil, :Errno), :ETIMEDOUT)), nil,
              s(:send, nil, :skip,
                s(:dstr,
                  s(:begin,
                    s(:lvar, :host)),
                  s(:str, " seems offline, I can't tell whether ssl would work.")))),
            s(:resbody,
              s(:array,
                s(:const,
                  s(:const,
                    s(:const, nil, :OpenSSL), :SSL), :SSLError)),
              s(:lvasgn, :e),
              s(:begin,
                s(:if,
                  s(:send,
                    s(:send,
                      s(:lvar, :e), :message), :=~,
                    s(:regexp,
                      s(:str, "certificate verify failed"),
                      s(:regopt))),
                  s(:send, nil, :flunk,
                    s(:dstr,
                      s(:begin,
                        s(:lvar, :host)),
                      s(:str, " is not verifiable using the included certificates. Error was: "),
                      s(:begin,
                        s(:send,
                          s(:lvar, :e), :message)))), nil),
                s(:send, nil, :raise))), nil)),
        s(:def, :test_accessing_rubygems,
          s(:args),
          s(:send, nil, :assert_https,
            s(:str, "rubygems.org"))),
        s(:def, :test_accessing_fastly,
          s(:args),
          s(:send, nil, :assert_https,
            s(:str, "rubygems.global.ssl.fastly.net"))))), nil))
