s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/test_case")),
  s(:send, nil, :require,
    s(:str, "rubygems/commands/build_command")),
  s(:send, nil, :require,
    s(:str, "rubygems/package")),
  s(:class,
    s(:const, nil, :TestGemCommandsBuildCommand),
    s(:const,
      s(:const, nil, :Gem), :TestCase),
    s(:begin,
      s(:def, :setup,
        s(:args),
        s(:begin,
          s(:zsuper),
          s(:ivasgn, :@gem,
            s(:block,
              s(:send, nil, :util_spec,
                s(:str, "some_gem")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :rubyforge_project=,
                s(:str, "example")))),
          s(:ivasgn, :@cmd,
            s(:send,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :Commands), :BuildCommand), :new)))),
      s(:def, :test_execute,
        s(:args),
        s(:begin,
          s(:lvasgn, :gemspec_file,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:send,
                s(:ivar, :@gem), :spec_name))),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:lvar, :gemspec_file),
              s(:str, "w")),
            s(:args,
              s(:arg, :gs)),
            s(:send,
              s(:lvar, :gs), :write,
              s(:send,
                s(:ivar, :@gem), :to_ruby))),
          s(:send, nil, :util_test_build_gem,
            s(:ivar, :@gem),
            s(:lvar, :gemspec_file)))),
      s(:def, :test_execute_bad_spec,
        s(:args),
        s(:begin,
          s(:send,
            s(:ivar, :@gem), :date=,
            s(:str, "2010-11-08")),
          s(:lvasgn, :gemspec_file,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:send,
                s(:ivar, :@gem), :spec_name))),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:lvar, :gemspec_file),
              s(:str, "w")),
            s(:args,
              s(:arg, :gs)),
            s(:send,
              s(:lvar, :gs), :write,
              s(:send,
                s(:send,
                  s(:ivar, :@gem), :to_ruby), :sub,
                s(:regexp,
                  s(:str, "11-08"),
                  s(:regopt)),
                s(:str, "11-8")))),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :args),
            s(:array,
              s(:lvar, :gemspec_file))),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :out),
              s(:lvasgn, :err)),
            s(:block,
              s(:send, nil, :use_ui,
                s(:ivar, :@ui)),
              s(:args),
              s(:block,
                s(:send, nil, :capture_io),
                s(:args),
                s(:block,
                  s(:send, nil, :assert_raises,
                    s(:const,
                      s(:const,
                        s(:const, nil, :Gem), :MockGemUi), :TermError)),
                  s(:args),
                  s(:send,
                    s(:ivar, :@cmd), :execute))))),
          s(:send, nil, :assert_equal,
            s(:str, ""),
            s(:lvar, :out)),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "invalid date format in specification"),
              s(:regopt)),
            s(:lvar, :err)),
          s(:send, nil, :assert_equal,
            s(:str, ""),
            s(:send,
              s(:ivar, :@ui), :output)),
          s(:send, nil, :assert_equal,
            s(:str, "ERROR:  Error loading gemspec. Aborting.\n"),
            s(:send,
              s(:ivar, :@ui), :error)))),
      s(:def, :test_execute_missing_file,
        s(:args),
        s(:begin,
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :args),
            s(:array,
              s(:str, "some_gem"))),
          s(:block,
            s(:send, nil, :use_ui,
              s(:ivar, :@ui)),
            s(:args),
            s(:block,
              s(:send, nil, :assert_raises,
                s(:const,
                  s(:const,
                    s(:const, nil, :Gem), :MockGemUi), :TermError)),
              s(:args),
              s(:send,
                s(:ivar, :@cmd), :execute))),
          s(:send, nil, :assert_equal,
            s(:str, ""),
            s(:send,
              s(:ivar, :@ui), :output)),
          s(:send, nil, :assert_equal,
            s(:str, "ERROR:  Gemspec file not found: some_gem\n"),
            s(:send,
              s(:ivar, :@ui), :error)))),
      s(:def, :test_can_find_gemspecs_without_dot_gemspec,
        s(:args),
        s(:begin,
          s(:lvasgn, :gemspec_file,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:send,
                s(:ivar, :@gem), :spec_name))),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:send,
                s(:lvar, :gemspec_file), :+,
                s(:str, ".gemspec")),
              s(:str, "w")),
            s(:args,
              s(:arg, :gs)),
            s(:send,
              s(:lvar, :gs), :write,
              s(:send,
                s(:ivar, :@gem), :to_ruby))),
          s(:send, nil, :util_test_build_gem,
            s(:ivar, :@gem),
            s(:lvar, :gemspec_file)))),
      s(:def, :util_test_build_gem,
        s(:args,
          s(:arg, :gem),
          s(:arg, :gemspec_file),
          s(:optarg, :check_licenses,
            s(:true))),
        s(:begin,
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :args),
            s(:array,
              s(:lvar, :gemspec_file))),
          s(:block,
            s(:send, nil, :use_ui,
              s(:ivar, :@ui)),
            s(:args),
            s(:block,
              s(:send,
                s(:const, nil, :Dir), :chdir,
                s(:ivar, :@tempdir)),
              s(:args),
              s(:send,
                s(:ivar, :@cmd), :execute))),
          s(:lvasgn, :output,
            s(:send,
              s(:send,
                s(:ivar, :@ui), :output), :split,
              s(:str, "\n"))),
          s(:send, nil, :assert_equal,
            s(:str, "  Successfully built RubyGem"),
            s(:send,
              s(:lvar, :output), :shift)),
          s(:send, nil, :assert_equal,
            s(:str, "  Name: some_gem"),
            s(:send,
              s(:lvar, :output), :shift)),
          s(:send, nil, :assert_equal,
            s(:str, "  Version: 2"),
            s(:send,
              s(:lvar, :output), :shift)),
          s(:send, nil, :assert_equal,
            s(:str, "  File: some_gem-2.gem"),
            s(:send,
              s(:lvar, :output), :shift)),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:lvar, :output)),
          s(:if,
            s(:lvar, :check_licenses),
            s(:send, nil, :assert_match,
              s(:str, "WARNING:  licenses is empty"),
              s(:send,
                s(:ivar, :@ui), :error)), nil),
          s(:lvasgn, :gem_file,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:send,
                s(:const, nil, :File), :basename,
                s(:send,
                  s(:lvar, :gem), :cache_file)))),
          s(:send, nil, :assert,
            s(:send,
              s(:const, nil, :File), :exist?,
              s(:lvar, :gem_file))),
          s(:lvasgn, :spec,
            s(:send,
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Package), :new,
                s(:lvar, :gem_file)), :spec)),
          s(:send, nil, :assert_equal,
            s(:str, "some_gem"),
            s(:send,
              s(:lvar, :spec), :name)),
          s(:send, nil, :assert_equal,
            s(:str, "this is a summary"),
            s(:send,
              s(:lvar, :spec), :summary)))),
      s(:def, :test_execute_force,
        s(:args),
        s(:begin,
          s(:lvasgn, :gemspec_file,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:send,
                s(:ivar, :@gem), :spec_name))),
          s(:send,
            s(:ivar, :@gem), :send,
            s(:sym, :remove_instance_variable),
            s(:sym, :@rubygems_version)),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:lvar, :gemspec_file),
              s(:str, "w")),
            s(:args,
              s(:arg, :gs)),
            s(:send,
              s(:lvar, :gs), :write,
              s(:send,
                s(:ivar, :@gem), :to_ruby))),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :args),
            s(:array,
              s(:lvar, :gemspec_file))),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :force),
            s(:true)),
          s(:send, nil, :util_test_build_gem,
            s(:ivar, :@gem),
            s(:lvar, :gemspec_file),
            s(:false)))))))
