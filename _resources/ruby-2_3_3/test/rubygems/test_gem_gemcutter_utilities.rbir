s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/test_case")),
  s(:send, nil, :require,
    s(:str, "rubygems")),
  s(:send, nil, :require,
    s(:str, "rubygems/command")),
  s(:send, nil, :require,
    s(:str, "rubygems/gemcutter_utilities")),
  s(:class,
    s(:const, nil, :TestGemGemcutterUtilities),
    s(:const,
      s(:const, nil, :Gem), :TestCase),
    s(:begin,
      s(:def, :setup,
        s(:args),
        s(:begin,
          s(:zsuper),
          s(:send,
            s(:const, nil, :ENV), :[]=,
            s(:str, "RUBYGEMS_HOST"),
            s(:nil)),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :configuration), :rubygems_api_key=,
            s(:nil)),
          s(:ivasgn, :@cmd,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Command), :new,
              s(:str, ""),
              s(:str, "summary"))),
          s(:send,
            s(:ivar, :@cmd), :extend,
            s(:const,
              s(:const, nil, :Gem), :GemcutterUtilities)))),
      s(:def, :teardown,
        s(:args),
        s(:begin,
          s(:send,
            s(:const, nil, :ENV), :[]=,
            s(:str, "RUBYGEMS_HOST"),
            s(:nil)),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :configuration), :rubygems_api_key=,
            s(:nil)),
          s(:zsuper))),
      s(:def, :test_alternate_key_alternate_host,
        s(:args),
        s(:begin,
          s(:lvasgn, :keys,
            s(:hash,
              s(:pair,
                s(:sym, :rubygems_api_key),
                s(:str, "KEY")),
              s(:pair,
                s(:str, "http://rubygems.engineyard.com"),
                s(:str, "EYKEY")))),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir_p,
            s(:send,
              s(:const, nil, :File), :dirname,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:block,
            s(:send, nil, :open,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path),
              s(:str, "w")),
            s(:args,
              s(:arg, :f)),
            s(:send,
              s(:lvar, :f), :write,
              s(:send,
                s(:lvar, :keys), :to_yaml))),
          s(:send,
            s(:const, nil, :ENV), :[]=,
            s(:str, "RUBYGEMS_HOST"),
            s(:str, "http://rubygems.engineyard.com")),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :configuration), :load_api_keys),
          s(:send, nil, :assert_equal,
            s(:str, "EYKEY"),
            s(:send,
              s(:ivar, :@cmd), :api_key)))),
      s(:def, :test_api_key,
        s(:args),
        s(:begin,
          s(:lvasgn, :keys,
            s(:hash,
              s(:pair,
                s(:sym, :rubygems_api_key),
                s(:str, "KEY")))),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir_p,
            s(:send,
              s(:const, nil, :File), :dirname,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:block,
            s(:send, nil, :open,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path),
              s(:str, "w")),
            s(:args,
              s(:arg, :f)),
            s(:send,
              s(:lvar, :f), :write,
              s(:send,
                s(:lvar, :keys), :to_yaml))),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :configuration), :load_api_keys),
          s(:send, nil, :assert_equal,
            s(:str, "KEY"),
            s(:send,
              s(:ivar, :@cmd), :api_key)))),
      s(:def, :test_api_key_override,
        s(:args),
        s(:begin,
          s(:lvasgn, :keys,
            s(:hash,
              s(:pair,
                s(:sym, :rubygems_api_key),
                s(:str, "KEY")),
              s(:pair,
                s(:sym, :other),
                s(:str, "OTHER")))),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir_p,
            s(:send,
              s(:const, nil, :File), :dirname,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:block,
            s(:send, nil, :open,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path),
              s(:str, "w")),
            s(:args,
              s(:arg, :f)),
            s(:send,
              s(:lvar, :f), :write,
              s(:send,
                s(:lvar, :keys), :to_yaml))),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :configuration), :load_api_keys),
          s(:send,
            s(:ivar, :@cmd), :add_key_option),
          s(:send,
            s(:ivar, :@cmd), :handle_options,
            s(:array,
              s(:str, "--key"),
              s(:str, "other"))),
          s(:send, nil, :assert_equal,
            s(:str, "OTHER"),
            s(:send,
              s(:ivar, :@cmd), :api_key)))),
      s(:def, :test_host,
        s(:args),
        s(:send, nil, :assert_equal,
          s(:str, "https://rubygems.org"),
          s(:send,
            s(:ivar, :@cmd), :host))),
      s(:def, :test_host_RUBYGEMS_HOST,
        s(:args),
        s(:begin,
          s(:send,
            s(:const, nil, :ENV), :[]=,
            s(:str, "RUBYGEMS_HOST"),
            s(:str, "https://other.example")),
          s(:send, nil, :assert_equal,
            s(:str, "https://other.example"),
            s(:send,
              s(:ivar, :@cmd), :host)))),
      s(:def, :test_host_RUBYGEMS_HOST_empty,
        s(:args),
        s(:begin,
          s(:send,
            s(:const, nil, :ENV), :[]=,
            s(:str, "RUBYGEMS_HOST"),
            s(:str, "")),
          s(:send, nil, :assert_equal,
            s(:str, "https://rubygems.org"),
            s(:send,
              s(:ivar, :@cmd), :host)))),
      s(:def, :test_sign_in,
        s(:args),
        s(:begin,
          s(:lvasgn, :api_key,
            s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903")),
          s(:send, nil, :util_sign_in,
            s(:array,
              s(:lvar, :api_key),
              s(:int, 200),
              s(:str, "OK"))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Enter your RubyGems.org credentials."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:send, nil, :assert,
            s(:send,
              s(:send,
                s(:ivar, :@fetcher), :last_request), :[],
              s(:str, "authorization"))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Signed in."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:lvasgn, :credentials,
            s(:send,
              s(:const, nil, :YAML), :load_file,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:send, nil, :assert_equal,
            s(:lvar, :api_key),
            s(:send,
              s(:lvar, :credentials), :[],
              s(:sym, :rubygems_api_key))))),
      s(:def, :test_sign_in_with_host,
        s(:args),
        s(:begin,
          s(:lvasgn, :api_key,
            s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903")),
          s(:send, nil, :util_sign_in,
            s(:array,
              s(:lvar, :api_key),
              s(:int, 200),
              s(:str, "OK")),
            s(:str, "http://example.com"),
            s(:array,
              s(:str, "http://example.com"))),
          s(:send, nil, :assert_match,
            s(:str, "Enter your http://example.com credentials."),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:send, nil, :assert,
            s(:send,
              s(:send,
                s(:ivar, :@fetcher), :last_request), :[],
              s(:str, "authorization"))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Signed in."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:lvasgn, :credentials,
            s(:send,
              s(:const, nil, :YAML), :load_file,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:send, nil, :assert_equal,
            s(:lvar, :api_key),
            s(:send,
              s(:lvar, :credentials), :[],
              s(:sym, :rubygems_api_key))))),
      s(:def, :test_sign_in_with_host_nil,
        s(:args),
        s(:begin,
          s(:lvasgn, :api_key,
            s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903")),
          s(:send, nil, :util_sign_in,
            s(:array,
              s(:lvar, :api_key),
              s(:int, 200),
              s(:str, "OK")),
            s(:nil),
            s(:array,
              s(:nil))),
          s(:send, nil, :assert_match,
            s(:str, "Enter your RubyGems.org credentials."),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:send, nil, :assert,
            s(:send,
              s(:send,
                s(:ivar, :@fetcher), :last_request), :[],
              s(:str, "authorization"))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Signed in."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:lvasgn, :credentials,
            s(:send,
              s(:const, nil, :YAML), :load_file,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:send, nil, :assert_equal,
            s(:lvar, :api_key),
            s(:send,
              s(:lvar, :credentials), :[],
              s(:sym, :rubygems_api_key))))),
      s(:def, :test_sign_in_with_host_ENV,
        s(:args),
        s(:begin,
          s(:lvasgn, :api_key,
            s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903")),
          s(:send, nil, :util_sign_in,
            s(:array,
              s(:lvar, :api_key),
              s(:int, 200),
              s(:str, "OK")),
            s(:str, "http://example.com")),
          s(:send, nil, :assert_match,
            s(:str, "Enter your http://example.com credentials."),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:send, nil, :assert,
            s(:send,
              s(:send,
                s(:ivar, :@fetcher), :last_request), :[],
              s(:str, "authorization"))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Signed in."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:lvasgn, :credentials,
            s(:send,
              s(:const, nil, :YAML), :load_file,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:send, nil, :assert_equal,
            s(:lvar, :api_key),
            s(:send,
              s(:lvar, :credentials), :[],
              s(:sym, :rubygems_api_key))))),
      s(:def, :test_sign_in_skips_with_existing_credentials,
        s(:args),
        s(:begin,
          s(:lvasgn, :api_key,
            s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903")),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :configuration), :rubygems_api_key=,
            s(:lvar, :api_key)),
          s(:send, nil, :util_sign_in,
            s(:array,
              s(:lvar, :api_key),
              s(:int, 200),
              s(:str, "OK"))),
          s(:send, nil, :assert_equal,
            s(:str, ""),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)))),
      s(:def, :test_sign_in_skips_with_key_override,
        s(:args),
        s(:begin,
          s(:lvasgn, :api_key,
            s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903")),
          s(:send,
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :configuration), :api_keys), :[]=,
            s(:sym, :KEY),
            s(:str, "other")),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :key),
            s(:sym, :KEY)),
          s(:send, nil, :util_sign_in,
            s(:array,
              s(:lvar, :api_key),
              s(:int, 200),
              s(:str, "OK"))),
          s(:send, nil, :assert_equal,
            s(:str, ""),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)))),
      s(:def, :test_sign_in_with_other_credentials_doesnt_overwrite_other_keys,
        s(:args),
        s(:begin,
          s(:lvasgn, :api_key,
            s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903")),
          s(:lvasgn, :other_api_key,
            s(:str, "f46dbb18bb6a9c97cdc61b5b85c186a17403cdcbf")),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir_p,
            s(:send,
              s(:const, nil, :File), :dirname,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:block,
            s(:send, nil, :open,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path),
              s(:str, "w")),
            s(:args,
              s(:arg, :f)),
            s(:send,
              s(:lvar, :f), :write,
              s(:send,
                s(:send,
                  s(:const, nil, :Hash), :[],
                  s(:sym, :other_api_key),
                  s(:lvar, :other_api_key)), :to_yaml))),
          s(:send, nil, :util_sign_in,
            s(:array,
              s(:lvar, :api_key),
              s(:int, 200),
              s(:str, "OK"))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Enter your RubyGems.org credentials."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Signed in."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:lvasgn, :credentials,
            s(:send,
              s(:const, nil, :YAML), :load_file,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:send, nil, :assert_equal,
            s(:lvar, :api_key),
            s(:send,
              s(:lvar, :credentials), :[],
              s(:sym, :rubygems_api_key))),
          s(:send, nil, :assert_equal,
            s(:lvar, :other_api_key),
            s(:send,
              s(:lvar, :credentials), :[],
              s(:sym, :other_api_key))))),
      s(:def, :test_sign_in_with_bad_credentials,
        s(:args),
        s(:begin,
          s(:if,
            s(:send,
              s(:const, nil, :Gem), :win_platform?),
            s(:send, nil, :skip,
              s(:str, "Always uses $stdin on windows")), nil),
          s(:block,
            s(:send, nil, :assert_raises,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :MockGemUi), :TermError)),
            s(:args),
            s(:send, nil, :util_sign_in,
              s(:array,
                s(:str, "Access Denied."),
                s(:int, 403),
                s(:str, "Forbidden")))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Enter your RubyGems.org credentials."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Access Denied."),
              s(:regopt)),
            s(:send,
              s(:ivar, :@sign_in_ui), :output)))),
      s(:def, :util_sign_in,
        s(:args,
          s(:arg, :response),
          s(:optarg, :host,
            s(:nil)),
          s(:optarg, :args,
            s(:array))),
        s(:begin,
          s(:if,
            s(:send,
              s(:const, nil, :Gem), :win_platform?),
            s(:send, nil, :skip,
              s(:str, "Always uses $stdin on windows")), nil),
          s(:lvasgn, :email,
            s(:str, "you@example.com")),
          s(:lvasgn, :password,
            s(:str, "secret")),
          s(:if,
            s(:lvar, :host),
            s(:send,
              s(:const, nil, :ENV), :[]=,
              s(:str, "RUBYGEMS_HOST"),
              s(:lvar, :host)),
            s(:lvasgn, :host,
              s(:send,
                s(:const, nil, :Gem), :host))),
          s(:ivasgn, :@fetcher,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :FakeFetcher), :new)),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:dstr,
              s(:begin,
                s(:lvar, :host)),
              s(:str, "/api/v1/api_key")),
            s(:lvar, :response)),
          s(:send,
            s(:const,
              s(:const, nil, :Gem), :RemoteFetcher), :fetcher=,
            s(:ivar, :@fetcher)),
          s(:ivasgn, :@sign_in_ui,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :MockGemUi), :new,
              s(:dstr,
                s(:begin,
                  s(:lvar, :email)),
                s(:str, "\n"),
                s(:begin,
                  s(:lvar, :password)),
                s(:str, "\n")))),
          s(:block,
            s(:send, nil, :use_ui,
              s(:ivar, :@sign_in_ui)),
            s(:args),
            s(:if,
              s(:send,
                s(:send,
                  s(:lvar, :args), :length), :>,
                s(:int, 0)),
              s(:send,
                s(:ivar, :@cmd), :sign_in,
                s(:splat,
                  s(:lvar, :args))),
              s(:send,
                s(:ivar, :@cmd), :sign_in))))),
      s(:def, :test_verify_api_key,
        s(:args),
        s(:begin,
          s(:lvasgn, :keys,
            s(:hash,
              s(:pair,
                s(:sym, :other),
                s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903")))),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir_p,
            s(:send,
              s(:const, nil, :File), :dirname,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path))),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:send,
                s(:send,
                  s(:const, nil, :Gem), :configuration), :credentials_path),
              s(:str, "w")),
            s(:args,
              s(:arg, :f)),
            s(:send,
              s(:lvar, :f), :write,
              s(:send,
                s(:lvar, :keys), :to_yaml))),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :configuration), :load_api_keys),
          s(:send, nil, :assert_equal,
            s(:str, "a5fdbb6ba150cbb83aad2bb2fede64cf040453903"),
            s(:send,
              s(:ivar, :@cmd), :verify_api_key,
              s(:sym, :other))))),
      s(:def, :test_verify_missing_api_key,
        s(:args),
        s(:block,
          s(:send, nil, :assert_raises,
            s(:const,
              s(:const,
                s(:const, nil, :Gem), :MockGemUi), :TermError)),
          s(:args),
          s(:send,
            s(:ivar, :@cmd), :verify_api_key,
            s(:sym, :missing)))))))
