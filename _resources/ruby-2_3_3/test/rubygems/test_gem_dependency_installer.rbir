s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/test_case")),
  s(:send, nil, :require,
    s(:str, "rubygems/dependency_installer")),
  s(:send, nil, :require,
    s(:str, "rubygems/security")),
  s(:class,
    s(:const, nil, :TestGemDependencyInstaller),
    s(:const,
      s(:const, nil, :Gem), :TestCase),
    s(:begin,
      s(:def, :setup,
        s(:args),
        s(:begin,
          s(:zsuper),
          s(:send, nil, :common_installer_setup),
          s(:ivasgn, :@gems_dir,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:str, "gems"))),
          s(:ivasgn, :@cache_dir,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@gemhome),
              s(:str, "cache"))),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir,
            s(:ivar, :@gems_dir)),
          s(:send,
            s(:const,
              s(:const, nil, :Gem), :RemoteFetcher), :fetcher=,
            s(:ivasgn, :@fetcher,
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :FakeFetcher), :new))),
          s(:ivasgn, :@original_platforms,
            s(:send,
              s(:const, nil, :Gem), :platforms)),
          s(:send,
            s(:const, nil, :Gem), :platforms=,
            s(:array)))),
      s(:def, :teardown,
        s(:args),
        s(:begin,
          s(:send,
            s(:const, nil, :Gem), :platforms=,
            s(:ivar, :@original_platforms)),
          s(:zsuper))),
      s(:def, :util_setup_gems,
        s(:args),
        s(:begin,
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@a1),
              s(:ivasgn, :@a1_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "a"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:send,
                  s(:lvar, :s), :executables), :<<,
                s(:str, "a_bin")))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@a1_pre),
              s(:ivasgn, :@a1_pre_gem)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "1.a"))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@b1),
              s(:ivasgn, :@b1_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "b"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:begin,
                s(:send,
                  s(:lvar, :s), :add_dependency,
                  s(:str, "a")),
                s(:send,
                  s(:lvar, :s), :add_development_dependency,
                  s(:str, "aa"))))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@c1),
              s(:ivasgn, :@c1_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "c"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :add_development_dependency,
                s(:str, "b")))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@d1),
              s(:ivasgn, :@d1_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "d"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :add_development_dependency,
                s(:str, "c")))),
          s(:send, nil, :util_clear_gems),
          s(:send, nil, :util_reset_gems))),
      s(:def, :test_available_set_for_name,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :p1a)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "10.a"))),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:lvar, :p1a),
            s(:ivar, :@a1),
            s(:ivar, :@a1_pre)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :available,
            s(:send,
              s(:lvar, :inst), :available_set_for,
              s(:str, "a"),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Requirement), :default))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :available), :set), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:send,
                  s(:lvar, :s), :spec), :full_name))))),
      s(:def, :test_available_set_for_name_prerelease,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :p1a)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "10.a"))),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:lvar, :p1a),
            s(:ivar, :@a1),
            s(:ivar, :@a1_pre)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :prerelease),
                  s(:true))))),
          s(:lvasgn, :available,
            s(:send,
              s(:lvar, :inst), :available_set_for,
              s(:str, "a"),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Requirement), :default))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-10.a")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :available), :sorted), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:send,
                  s(:lvar, :s), :spec), :full_name))))),
      s(:def, :test_available_set_for_dep,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :p1a)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "10.a"))),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:lvar, :p1a),
            s(:ivar, :@a1),
            s(:ivar, :@a1_pre)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Requirement), :default))),
          s(:lvasgn, :available,
            s(:send,
              s(:lvar, :inst), :available_set_for,
              s(:lvar, :dep),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Requirement), :default))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :available), :set), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:send,
                  s(:lvar, :s), :spec), :full_name))))),
      s(:def, :test_available_set_for_dep_prerelease,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :p1a)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "10.a"))),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:lvar, :p1a),
            s(:ivar, :@a1),
            s(:ivar, :@a1_pre)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :prerelease),
                  s(:true))))),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Requirement), :default))),
          s(:send,
            s(:lvar, :dep), :prerelease=,
            s(:true)),
          s(:lvasgn, :available,
            s(:send,
              s(:lvar, :inst), :available_set_for,
              s(:lvar, :dep),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Requirement), :default))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-10.a")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :available), :sorted), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:send,
                  s(:lvar, :s), :spec), :full_name))))),
      s(:def, :test_install,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "a")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :map,
              s(:block_pass,
                s(:sym, :full_name)))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:ivar, :@a1)),
            s(:send,
              s(:lvar, :inst), :installed_gems)))),
      s(:def, :test_install_prerelease,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :p1a),
              s(:lvasgn, :gem)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "10.a"))),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:lvar, :p1a),
            s(:ivar, :@a1),
            s(:ivar, :@a1_pre)),
          s(:send, nil, :util_clear_gems),
          s(:lvasgn, :p1a_data,
            s(:send,
              s(:const, nil, :Gem), :read_binary,
              s(:lvar, :gem))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/a-10.a.gem"),
            s(:lvar, :p1a_data)),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"))),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :prerelease),
                  s(:true))))),
          s(:send,
            s(:lvar, :inst), :install,
            s(:lvar, :dep)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-10.a")),
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :map,
              s(:block_pass,
                s(:sym, :full_name)))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:lvar, :p1a)),
            s(:send,
              s(:lvar, :inst), :installed_gems)))),
      s(:def, :test_install_prerelease_bug_990,
        s(:args),
        s(:begin,
          s(:block,
            s(:send, nil, :spec_fetcher),
            s(:args,
              s(:arg, :fetcher)),
            s(:begin,
              s(:block,
                s(:send,
                  s(:lvar, :fetcher), :gem,
                  s(:str, "a"),
                  s(:str, "1.b")),
                s(:args,
                  s(:arg, :s)),
                s(:send,
                  s(:lvar, :s), :add_dependency,
                  s(:str, "b"),
                  s(:str, "~> 1.a"))),
              s(:block,
                s(:send,
                  s(:lvar, :fetcher), :gem,
                  s(:str, "b"),
                  s(:str, "1.b")),
                s(:args,
                  s(:arg, :s)),
                s(:send,
                  s(:lvar, :s), :add_dependency,
                  s(:str, "c"),
                  s(:str, ">= 1"))),
              s(:send,
                s(:lvar, :fetcher), :gem,
                s(:str, "c"),
                s(:str, "1.1.b")))),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"))),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :prerelease),
                  s(:true))))),
          s(:send,
            s(:lvar, :inst), :install,
            s(:lvar, :dep)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1.b"),
              s(:str, "b-1.b"),
              s(:str, "c-1.1.b")),
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :map,
              s(:block_pass,
                s(:sym, :full_name)))))),
      s(:def, :test_install_when_only_prerelease,
        s(:args),
        s(:begin,
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :p1a),
              s(:lvasgn, :gem)),
            s(:send, nil, :util_gem,
              s(:str, "p"),
              s(:str, "1.a"))),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:lvar, :p1a)),
          s(:send, nil, :util_clear_gems),
          s(:lvasgn, :p1a_data,
            s(:send,
              s(:const, nil, :Gem), :read_binary,
              s(:lvar, :gem))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/p-1.a.gem"),
            s(:lvar, :p1a_data)),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "p"))),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:block,
            s(:send, nil, :assert_raises,
              s(:const,
                s(:const, nil, :Gem), :UnsatisfiableDependencyError)),
            s(:args),
            s(:send,
              s(:lvar, :inst), :install,
              s(:lvar, :dep))),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :map,
              s(:block_pass,
                s(:sym, :full_name)))),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:send,
              s(:lvar, :inst), :installed_gems)))),
      s(:def, :test_install_prerelease_skipped_when_normal_ver,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:ivar, :@a1),
            s(:ivar, :@a1_pre)),
          s(:send, nil, :util_clear_gems),
          s(:lvasgn, :p1a_data,
            s(:send,
              s(:const, nil, :Gem), :read_binary,
              s(:ivar, :@a1_gem))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/a-1.gem"),
            s(:lvar, :p1a_data)),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"))),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :prerelease),
                  s(:true))))),
          s(:send,
            s(:lvar, :inst), :install,
            s(:lvar, :dep)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :map,
              s(:block_pass,
                s(:sym, :full_name)))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:ivar, :@a1)),
            s(:send,
              s(:lvar, :inst), :installed_gems)))),
      s(:def, :test_install_all_dependencies,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :_),
              s(:lvasgn, :e1_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "e"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :add_dependency,
                s(:str, "b")))),
          s(:send, nil, :util_clear_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :e1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :ignore_dependencies),
                      s(:true))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name)),
            s(:str, "sanity check")),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "e")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "e-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_cache_dir,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :dir,
            s(:str, "dir")),
          s(:send,
            s(:const, nil, :Dir), :mkdir,
            s(:lvar, :dir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:lvar, :dir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:lvar, :dir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:lvar, :dir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :cache_dir),
                      s(:ivar, :@tempdir))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))),
          s(:send, nil, :assert,
            s(:send,
              s(:const, nil, :File), :exist?,
              s(:send,
                s(:const, nil, :File), :join,
                s(:ivar, :@gemhome),
                s(:str, "cache"),
                s(:send,
                  s(:ivar, :@a1), :file_name)))),
          s(:send, nil, :assert,
            s(:send,
              s(:const, nil, :File), :exist?,
              s(:send,
                s(:const, nil, :File), :join,
                s(:ivar, :@gemhome),
                s(:str, "cache"),
                s(:send,
                  s(:ivar, :@b1), :file_name)))))),
      s(:def, :test_install_dependencies_satisfied,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :a2),
              s(:lvasgn, :a2_gem)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "2"))),
          s(:send,
            s(:const, nil, :FileUtils), :rm_rf,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@gemhome),
              s(:str, "gems"))),
          s(:send,
            s(:const,
              s(:const, nil, :Gem), :Specification), :reset),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :a2_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "a"),
                s(:send, nil, :req,
                  s(:str, "= 2"))))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-2")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name)),
            s(:str, "sanity check")),
          s(:send,
            s(:const, nil, :FileUtils), :rm,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:send,
                s(:lvar, :a2), :file_name))),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-2"),
              s(:str, "b-1")),
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :map,
              s(:block_pass,
                s(:sym, :full_name)))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_doesnt_upgrade_installed_dependencies,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :a2),
              s(:lvasgn, :a2_gem)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "2"))),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :a3),
              s(:lvasgn, :a3_gem)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "3"))),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:ivar, :@a1),
            s(:lvar, :a3),
            s(:ivar, :@b1)),
          s(:send,
            s(:const, nil, :FileUtils), :rm_rf,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@gemhome),
              s(:str, "gems"))),
          s(:send,
            s(:const,
              s(:const, nil, :Gem), :Specification), :reset),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :a2_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :a3_gem),
            s(:ivar, :@tempdir)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:send,
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :DependencyInstaller), :new), :install,
              s(:str, "a"),
              s(:send, nil, :req,
                s(:str, "= 2")))),
          s(:send,
            s(:const, nil, :FileUtils), :rm,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:send,
                s(:lvar, :a2), :file_name))),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-2"),
              s(:str, "b-1")),
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :map,
              s(:block_pass,
                s(:sym, :full_name)))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_dependency,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :done_installing_ran,
            s(:false)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Gem), :done_installing),
            s(:args,
              s(:arg, :installer),
              s(:arg, :specs)),
            s(:begin,
              s(:lvasgn, :done_installing_ran,
                s(:true)),
              s(:send, nil, :refute_nil,
                s(:lvar, :installer)),
              s(:send, nil, :assert_equal,
                s(:array,
                  s(:ivar, :@a1),
                  s(:ivar, :@b1)),
                s(:lvar, :specs)))),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :build_docs_in_background),
                      s(:false))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))),
          s(:send, nil, :assert,
            s(:lvar, :done_installing_ran),
            s(:str, "post installs hook was not run")))),
      s(:def, :test_install_dependency_development,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@aa1),
              s(:ivasgn, :@aa1_gem)),
            s(:send, nil, :util_gem,
              s(:str, "aa"),
              s(:str, "1"))),
          s(:send, nil, :util_reset_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@aa1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :development),
                      s(:true))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "aa-1"),
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_dependency_development_deep,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@aa1),
              s(:ivasgn, :@aa1_gem)),
            s(:send, nil, :util_gem,
              s(:str, "aa"),
              s(:str, "1"))),
          s(:send, nil, :util_reset_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@aa1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@c1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@d1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :development),
                      s(:true))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "d")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "aa-1"),
              s(:str, "b-1"),
              s(:str, "c-1"),
              s(:str, "d-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_dependency_development_shallow,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@aa1),
              s(:ivasgn, :@aa1_gem)),
            s(:send, nil, :util_gem,
              s(:str, "aa"),
              s(:str, "1"))),
          s(:send, nil, :util_reset_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@aa1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@c1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@d1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :development),
                      s(:true)),
                    s(:pair,
                      s(:sym, :dev_shallow),
                      s(:true))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "d")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "c-1"),
              s(:str, "d-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_dependency_existing,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Installer), :at,
              s(:ivar, :@a1_gem)), :install),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_dependency_existing_extension,
        s(:args),
        s(:begin,
          s(:lvasgn, :extconf_rb,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@gemhome),
              s(:str, "gems"),
              s(:str, "e-1"),
              s(:str, "extconf.rb"))),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir_p,
            s(:send,
              s(:const, nil, :File), :dirname,
              s(:lvar, :extconf_rb))),
          s(:block,
            s(:send, nil, :open,
              s(:lvar, :extconf_rb),
              s(:str, "w")),
            s(:args,
              s(:arg, :io)),
            s(:send,
              s(:lvar, :io), :write,
              s(:dstr,
                s(:str, "        require 'mkmf'\n"),
                s(:str, "        create_makefile 'e'\n")))),
          s(:lvasgn, :e1,
            s(:block,
              s(:send, nil, :new_spec,
                s(:str, "e"),
                s(:str, "1"),
                s(:nil),
                s(:str, "extconf.rb")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:send,
                  s(:lvar, :s), :extensions), :<<,
                s(:str, "extconf.rb")))),
          s(:lvasgn, :e1_gem,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:str, "gems"),
              s(:dstr,
                s(:begin,
                  s(:send,
                    s(:lvar, :e1), :full_name)),
                s(:str, ".gem")))),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :_),
              s(:lvasgn, :f1_gem)),
            s(:send, nil, :util_gem,
              s(:str, "f"),
              s(:str, "1"),
              s(:hash,
                s(:pair,
                  s(:str, "e"),
                  s(:nil))))),
          s(:send,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Installer), :at,
              s(:lvar, :e1_gem)), :install),
          s(:send,
            s(:const, nil, :FileUtils), :rm_r,
            s(:send,
              s(:lvar, :e1), :extension_dir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :e1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :f1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "f")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "f-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))),
          s(:send, nil, :assert_path_exists,
            s(:send,
              s(:lvar, :e1), :extension_dir)))),
      s(:def, :test_install_dependency_old,
        s(:args),
        s(:begin,
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :_),
              s(:lvasgn, :e1_gem)),
            s(:send, nil, :util_gem,
              s(:str, "e"),
              s(:str, "1"))),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :_),
              s(:lvasgn, :f1_gem)),
            s(:send, nil, :util_gem,
              s(:str, "f"),
              s(:str, "1"),
              s(:hash,
                s(:pair,
                  s(:str, "e"),
                  s(:nil))))),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :_),
              s(:lvasgn, :f2_gem)),
            s(:send, nil, :util_gem,
              s(:str, "f"),
              s(:str, "2"))),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :e1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :f1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :f2_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "f")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "f-2")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_local,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :domain),
                      s(:sym, :local))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "a-1.gem")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_local_prerelease,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_pre_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :domain),
                      s(:sym, :local))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "a-1.a.gem")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1.a")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_local_dependency,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :domain),
                      s(:sym, :local))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b-1.gem")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_local_dependency_installed,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:send,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Installer), :at,
                  s(:str, "a-1.gem")), :install),
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :domain),
                      s(:sym, :local))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b-1.gem")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_local_subdir,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :domain),
                      s(:sym, :local))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "gems/a-1.gem")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_minimal_deps,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :_),
              s(:lvasgn, :e1_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "e"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :add_dependency,
                s(:str, "b")))),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :_),
              s(:lvasgn, :b2_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "b"),
                s(:str, "2")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :add_dependency,
                s(:str, "a")))),
          s(:send, nil, :util_clear_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :b2_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:lvar, :e1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :ignore_dependencies),
                      s(:true))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b"),
                s(:send, nil, :req,
                  s(:str, "= 1"))))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name)),
            s(:str, "sanity check")),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :minimal_deps),
                      s(:true))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "e")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "e-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_no_document,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :done_installing_called,
            s(:false)),
          s(:block,
            s(:send,
              s(:const, nil, :Gem), :done_installing),
            s(:args,
              s(:arg, :dep_installer),
              s(:arg, :specs)),
            s(:begin,
              s(:lvasgn, :done_installing_called,
                s(:true)),
              s(:send, nil, :assert_empty,
                s(:send,
                  s(:lvar, :dep_installer), :document)))),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :domain),
                  s(:sym, :local)),
                s(:pair,
                  s(:sym, :document),
                  s(:array))))),
          s(:send,
            s(:lvar, :inst), :install,
            s(:ivar, :@a1_gem)),
          s(:send, nil, :assert,
            s(:lvar, :done_installing_called)))),
      s(:def, :test_install_env_shebang,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :env_shebang),
                      s(:true)),
                    s(:pair,
                      s(:sym, :wrappers),
                      s(:true)),
                    s(:pair,
                      s(:sym, :format_executable),
                      s(:false))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "a")))),
          s(:if,
            s(:send,
              s(:const, nil, :Gem), :win_platform?), nil,
            s(:lvasgn, :env,
              s(:str, "/\\S+/env"))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "\\A#!"),
              s(:begin,
                s(:lvar, :env)),
              s(:str, " "),
              s(:begin,
                s(:send,
                  s(:const,
                    s(:const, nil, :RbConfig), :CONFIG), :[],
                  s(:str, "ruby_install_name"))),
              s(:str, "\\n"),
              s(:regopt)),
            s(:send,
              s(:const, nil, :File), :read,
              s(:send,
                s(:const, nil, :File), :join,
                s(:ivar, :@gemhome),
                s(:str, "bin"),
                s(:str, "a_bin")))))),
      s(:def, :test_install_force,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :si,
            s(:send, nil, :util_setup_spec_fetcher,
              s(:ivar, :@b1))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/yaml"),
            s(:send,
              s(:lvar, :si), :to_yaml)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :force),
                      s(:true))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_build_args,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:lvasgn, :build_args,
            s(:array,
              s(:str, "--a"),
              s(:str, "--b=\"c\""))),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :build_args),
                      s(:lvar, :build_args))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "a")))),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:lvar, :build_args), :join,
              s(:str, "\n")),
            s(:send,
              s(:send,
                s(:const, nil, :File), :read,
                s(:send,
                  s(:send,
                    s(:send,
                      s(:lvar, :inst), :installed_gems), :first), :build_info_file)), :strip)))),
      s(:def, :test_install_ignore_dependencies,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :ignore_dependencies),
                      s(:true))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_install_dir,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Installer), :at,
              s(:send,
                s(:ivar, :@a1), :file_name))),
          s(:send,
            s(:lvar, :inst), :install),
          s(:lvasgn, :gemhome2,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:str, "gemhome2"))),
          s(:send,
            s(:const, nil, :Dir), :mkdir,
            s(:lvar, :gemhome2)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :install_dir),
                      s(:lvar, :gemhome2))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))),
          s(:send, nil, :assert,
            s(:send,
              s(:const, nil, :File), :exist?,
              s(:send,
                s(:const, nil, :File), :join,
                s(:lvar, :gemhome2),
                s(:str, "specifications"),
                s(:send,
                  s(:ivar, :@a1), :spec_name)))),
          s(:send, nil, :assert,
            s(:send,
              s(:const, nil, :File), :exist?,
              s(:send,
                s(:const, nil, :File), :join,
                s(:lvar, :gemhome2),
                s(:str, "cache"),
                s(:send,
                  s(:ivar, :@a1), :file_name)))))),
      s(:def, :test_install_domain_both,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :a1_data,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:ivar, :@a1_gem),
              s(:str, "rb")),
            s(:args,
              s(:arg, :fp)),
            s(:lvasgn, :a1_data,
              s(:send,
                s(:lvar, :fp), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/a-1.gem"),
            s(:lvar, :a1_data)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :domain),
                      s(:sym, :both))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :a1),
              s(:lvasgn, :b1)),
            s(:send,
              s(:lvar, :inst), :installed_gems)),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:lvar, :a1), :spec_file),
            s(:send,
              s(:lvar, :a1), :loaded_from)),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:lvar, :b1), :spec_file),
            s(:send,
              s(:lvar, :b1), :loaded_from)))),
      s(:def, :test_install_domain_both_no_network,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:dstr,
              s(:str, "http://gems.example.com/gems/Marshal."),
              s(:begin,
                s(:ivar, :@marshal_version))),
            s(:block,
              s(:send, nil, :proc),
              s(:args),
              s(:send, nil, :raise,
                s(:const,
                  s(:const,
                    s(:const, nil, :Gem), :RemoteFetcher), :FetchError)))),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :domain),
                      s(:sym, :both))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_domain_local,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :e,
                s(:block,
                  s(:send, nil, :assert_raises,
                    s(:const,
                      s(:const, nil, :Gem), :UnsatisfiableDependencyError)),
                  s(:args),
                  s(:begin,
                    s(:lvasgn, :inst,
                      s(:send,
                        s(:const,
                          s(:const, nil, :Gem), :DependencyInstaller), :new,
                        s(:hash,
                          s(:pair,
                            s(:sym, :domain),
                            s(:sym, :local))))),
                    s(:send,
                      s(:lvar, :inst), :install,
                      s(:str, "b"))))),
              s(:lvasgn, :expected,
                s(:str, "Unable to resolve dependency: 'b (>= 0)' requires 'a (>= 0)'")),
              s(:send, nil, :assert_equal,
                s(:lvar, :expected),
                s(:send,
                  s(:lvar, :e), :message)))),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_domain_remote,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :a1_data,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:ivar, :@a1_gem),
              s(:str, "rb")),
            s(:args,
              s(:arg, :fp)),
            s(:lvasgn, :a1_data,
              s(:send,
                s(:lvar, :fp), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/a-1.gem"),
            s(:lvar, :a1_data)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :domain),
                  s(:sym, :remote))))),
          s(:send,
            s(:lvar, :inst), :install,
            s(:str, "a")),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_dual_repository,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:lvasgn, :gemhome2,
            s(:dstr,
              s(:begin,
                s(:ivar, :@gemhome)),
              s(:str, "2"))),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new,
                  s(:hash,
                    s(:pair,
                      s(:sym, :install_dir),
                      s(:lvar, :gemhome2))))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "a")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name)),
            s(:str, "sanity check")),
          s(:send,
            s(:const, nil, :ENV), :[]=,
            s(:str, "GEM_HOME"),
            s(:ivar, :@gemhome)),
          s(:send,
            s(:const, nil, :ENV), :[]=,
            s(:str, "GEM_PATH"),
            s(:send,
              s(:array,
                s(:ivar, :@gemhome),
                s(:lvar, :gemhome2)), :join,
              s(:const,
                s(:const, nil, :File), :PATH_SEPARATOR))),
          s(:send,
            s(:const, nil, :Gem), :clear_paths),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "b")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_reinstall,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Installer), :at,
              s(:ivar, :@a1_gem)), :install),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :inst,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :DependencyInstaller), :new)),
              s(:send,
                s(:lvar, :inst), :install,
                s(:str, "a")))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :map,
              s(:block_pass,
                s(:sym, :full_name)))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:send,
              s(:send,
                s(:lvar, :inst), :installed_gems), :map,
              s(:block_pass,
                s(:sym, :full_name)))))),
      s(:def, :test_install_remote,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :a1_data,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:ivar, :@a1_gem),
              s(:str, "rb")),
            s(:args,
              s(:arg, :fp)),
            s(:lvasgn, :a1_data,
              s(:send,
                s(:lvar, :fp), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/a-1.gem"),
            s(:lvar, :a1_data)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:send,
              s(:lvar, :inst), :install,
              s(:str, "a"))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_remote_dep,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :a1_data,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:ivar, :@a1_gem),
              s(:str, "rb")),
            s(:args,
              s(:arg, :fp)),
            s(:lvasgn, :a1_data,
              s(:send,
                s(:lvar, :fp), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/a-1.gem"),
            s(:lvar, :a1_data)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:begin,
              s(:lvasgn, :dep,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Dependency), :new,
                  s(:send,
                    s(:ivar, :@a1), :name),
                  s(:send,
                    s(:ivar, :@a1), :version))),
              s(:send,
                s(:lvar, :inst), :install,
                s(:lvar, :dep)))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_remote_platform_newer,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :a2_o),
              s(:lvasgn, :a2_o_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "a"),
                s(:str, "2")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :platform=,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Platform), :new,
                  s(:array,
                    s(:str, "cpu"),
                    s(:str, "other_platform"),
                    s(:str, "1")))))),
          s(:lvasgn, :si,
            s(:send, nil, :util_setup_spec_fetcher,
              s(:ivar, :@a1),
              s(:lvar, :a2_o))),
          s(:send, nil, :util_clear_gems),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/yaml"),
            s(:send,
              s(:lvar, :si), :to_yaml)),
          s(:lvasgn, :a1_data,
            s(:nil)),
          s(:lvasgn, :a2_o_data,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:ivar, :@a1_gem),
              s(:str, "rb")),
            s(:args,
              s(:arg, :fp)),
            s(:lvasgn, :a1_data,
              s(:send,
                s(:lvar, :fp), :read))),
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:lvar, :a2_o_gem),
              s(:str, "rb")),
            s(:args,
              s(:arg, :fp)),
            s(:lvasgn, :a2_o_data,
              s(:send,
                s(:lvar, :fp), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:dstr,
              s(:str, "http://gems.example.com/gems/"),
              s(:begin,
                s(:send,
                  s(:ivar, :@a1), :file_name))),
            s(:lvar, :a1_data)),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:dstr,
              s(:str, "http://gems.example.com/gems/"),
              s(:begin,
                s(:send,
                  s(:lvar, :a2_o), :file_name))),
            s(:lvar, :a2_o_data)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :domain),
                  s(:sym, :remote))))),
          s(:send,
            s(:lvar, :inst), :install,
            s(:str, "a")),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_platform_is_ignored_when_a_file_is_specified,
        s(:args),
        s(:begin,
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :_),
              s(:lvasgn, :a_gem)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "a"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :platform=,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Platform), :new,
                  s(:array,
                    s(:str, "cpu"),
                    s(:str, "other_platform"),
                    s(:str, "1")))))),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :domain),
                  s(:sym, :local))))),
          s(:send,
            s(:lvar, :inst), :install,
            s(:lvar, :a_gem)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1-cpu-other_platform-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:if,
        s(:defined?,
          s(:const, nil, :OpenSSL)),
        s(:def, :test_install_security_policy,
          s(:args),
          s(:begin,
            s(:send, nil, :util_setup_gems),
            s(:lvasgn, :data,
              s(:block,
                s(:send,
                  s(:const, nil, :File), :open,
                  s(:ivar, :@a1_gem),
                  s(:str, "rb")),
                s(:args,
                  s(:arg, :f)),
                s(:send,
                  s(:lvar, :f), :read))),
            s(:send,
              s(:send,
                s(:ivar, :@fetcher), :data), :[]=,
              s(:str, "http://gems.example.com/gems/a-1.gem"),
              s(:lvar, :data)),
            s(:lvasgn, :data,
              s(:block,
                s(:send,
                  s(:const, nil, :File), :open,
                  s(:ivar, :@b1_gem),
                  s(:str, "rb")),
                s(:args,
                  s(:arg, :f)),
                s(:send,
                  s(:lvar, :f), :read))),
            s(:send,
              s(:send,
                s(:ivar, :@fetcher), :data), :[]=,
              s(:str, "http://gems.example.com/gems/b-1.gem"),
              s(:lvar, :data)),
            s(:lvasgn, :policy,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :Security), :HighSecurity)),
            s(:lvasgn, :inst,
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :DependencyInstaller), :new,
                s(:hash,
                  s(:pair,
                    s(:sym, :security_policy),
                    s(:lvar, :policy))))),
            s(:lvasgn, :e,
              s(:block,
                s(:send, nil, :assert_raises,
                  s(:const,
                    s(:const,
                      s(:const, nil, :Gem), :Security), :Exception)),
                s(:args),
                s(:send,
                  s(:lvar, :inst), :install,
                  s(:str, "b")))),
            s(:send, nil, :assert_equal,
              s(:str, "unsigned gems are not allowed by the High Security policy"),
              s(:send,
                s(:lvar, :e), :message)),
            s(:send, nil, :assert_equal,
              s(:array),
              s(:block,
                s(:send,
                  s(:send,
                    s(:lvar, :inst), :installed_gems), :map),
                s(:args,
                  s(:arg, :s)),
                s(:send,
                  s(:lvar, :s), :full_name))))), nil),
      s(:if,
        s(:send, nil, :win_platform?), nil,
        s(:def, :test_install_no_wrappers,
          s(:args),
          s(:begin,
            s(:send, nil, :util_setup_gems),
            s(:send,
              s(:send,
                s(:ivar, :@fetcher), :data), :[]=,
              s(:str, "http://gems.example.com/gems/a-1.gem"),
              s(:send, nil, :read_binary,
                s(:ivar, :@a1_gem))),
            s(:lvasgn, :inst,
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :DependencyInstaller), :new,
                s(:hash,
                  s(:pair,
                    s(:sym, :wrappers),
                    s(:false)),
                  s(:pair,
                    s(:sym, :format_executable),
                    s(:false))))),
            s(:send,
              s(:lvar, :inst), :install,
              s(:str, "a")),
            s(:send, nil, :refute_match,
              s(:regexp,
                s(:str, "This file was generated by RubyGems."),
                s(:regopt)),
              s(:send,
                s(:const, nil, :File), :read,
                s(:send,
                  s(:const, nil, :File), :join,
                  s(:ivar, :@gemhome),
                  s(:str, "bin"),
                  s(:str, "a_bin"))))))),
      s(:def, :test_install_version,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_d),
          s(:lvasgn, :data,
            s(:block,
              s(:send,
                s(:const, nil, :File), :open,
                s(:ivar, :@d2_gem),
                s(:str, "rb")),
              s(:args,
                s(:arg, :f)),
              s(:send,
                s(:lvar, :f), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/d-2.gem"),
            s(:lvar, :data)),
          s(:lvasgn, :data,
            s(:block,
              s(:send,
                s(:const, nil, :File), :open,
                s(:ivar, :@d1_gem),
                s(:str, "rb")),
              s(:args,
                s(:arg, :f)),
              s(:send,
                s(:lvar, :f), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/d-1.gem"),
            s(:lvar, :data)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:send,
            s(:lvar, :inst), :install,
            s(:str, "d"),
            s(:str, "= 1")),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "d-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_install_version_default,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_d),
          s(:lvasgn, :data,
            s(:block,
              s(:send,
                s(:const, nil, :File), :open,
                s(:ivar, :@d2_gem),
                s(:str, "rb")),
              s(:args,
                s(:arg, :f)),
              s(:send,
                s(:lvar, :f), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/d-2.gem"),
            s(:lvar, :data)),
          s(:lvasgn, :data,
            s(:block,
              s(:send,
                s(:const, nil, :File), :open,
                s(:ivar, :@d1_gem),
                s(:str, "rb")),
              s(:args,
                s(:arg, :f)),
              s(:send,
                s(:lvar, :f), :read))),
          s(:send,
            s(:send,
              s(:ivar, :@fetcher), :data), :[]=,
            s(:str, "http://gems.example.com/gems/d-1.gem"),
            s(:lvar, :data)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:send,
            s(:lvar, :inst), :install,
            s(:str, "d")),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "d-2")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :inst), :installed_gems), :map),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :full_name))))),
      s(:def, :test_find_gems_gems_with_sources,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "b"),
              s(:str, ">= 0"))),
          s(:send,
            s(:const,
              s(:const, nil, :Gem), :Specification), :reset),
          s(:lvasgn, :set,
            s(:send,
              s(:lvar, :inst), :find_gems_with_sources,
              s(:lvar, :dep))),
          s(:send, nil, :assert_kind_of,
            s(:const,
              s(:const, nil, :Gem), :AvailableSet),
            s(:lvar, :set)),
          s(:lvasgn, :s,
            s(:send,
              s(:send,
                s(:lvar, :set), :set), :first)),
          s(:send, nil, :assert_equal,
            s(:ivar, :@b1),
            s(:send,
              s(:lvar, :s), :spec)),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Source), :new,
              s(:ivar, :@gem_repo)),
            s(:send,
              s(:lvar, :s), :source)))),
      s(:def, :test_find_spec_by_name_and_version_wildcard,
        s(:args),
        s(:begin,
          s(:send, nil, :util_gem,
            s(:str, "a"),
            s(:int, 1)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:str, "gems/a-1.gem"),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :touch,
            s(:str, "rdoc.gem")),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :available,
            s(:send,
              s(:lvar, :inst), :find_spec_by_name_and_version,
              s(:str, "*.gem"))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :available), :each_spec), :map),
              s(:args,
                s(:arg, :spec)),
              s(:send,
                s(:lvar, :spec), :full_name))))),
      s(:def, :test_find_spec_by_name_and_version_wildcard_bad_gem,
        s(:args),
        s(:begin,
          s(:send,
            s(:const, nil, :FileUtils), :touch,
            s(:str, "rdoc.gem")),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:block,
            s(:send, nil, :assert_raises,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :Package), :FormatError)),
            s(:args),
            s(:send,
              s(:lvar, :inst), :find_spec_by_name_and_version,
              s(:str, "*.gem"))))),
      s(:def, :test_find_spec_by_name_and_version_bad_gem,
        s(:args),
        s(:begin,
          s(:send,
            s(:const, nil, :FileUtils), :touch,
            s(:str, "rdoc.gem")),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :e,
            s(:block,
              s(:send, nil, :assert_raises,
                s(:const,
                  s(:const,
                    s(:const, nil, :Gem), :Package), :FormatError)),
              s(:args),
              s(:send,
                s(:lvar, :inst), :find_spec_by_name_and_version,
                s(:str, "rdoc.gem")))),
          s(:lvasgn, :full_path,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:str, "rdoc.gem"))),
          s(:send, nil, :assert_equal,
            s(:dstr,
              s(:str, "package metadata is missing in "),
              s(:begin,
                s(:lvar, :full_path))),
            s(:send,
              s(:lvar, :e), :message)))),
      s(:def, :test_find_spec_by_name_and_version_directory,
        s(:args),
        s(:begin,
          s(:send,
            s(:const, nil, :Dir), :mkdir,
            s(:str, "rdoc")),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :e,
            s(:block,
              s(:send, nil, :assert_raises,
                s(:const,
                  s(:const, nil, :Gem), :SpecificGemNotFoundException)),
              s(:args),
              s(:send,
                s(:lvar, :inst), :find_spec_by_name_and_version,
                s(:str, "rdoc")))),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:str, "Could not find a valid gem 'rdoc' (>= 0) "), :+,
              s(:str, "locally or in a repository")),
            s(:send,
              s(:lvar, :e), :message)))),
      s(:def, :test_find_spec_by_name_and_version_file,
        s(:args),
        s(:begin,
          s(:send,
            s(:const, nil, :FileUtils), :touch,
            s(:str, "rdoc")),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :e,
            s(:block,
              s(:send, nil, :assert_raises,
                s(:const,
                  s(:const, nil, :Gem), :SpecificGemNotFoundException)),
              s(:args),
              s(:send,
                s(:lvar, :inst), :find_spec_by_name_and_version,
                s(:str, "rdoc")))),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:str, "Could not find a valid gem 'rdoc' (>= 0) "), :+,
              s(:str, "locally or in a repository")),
            s(:send,
              s(:lvar, :e), :message)))),
      s(:def, :test_find_gems_with_sources_local,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"),
              s(:str, ">= 0"))),
          s(:lvasgn, :set,
            s(:nil)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@tempdir)),
            s(:args),
            s(:lvasgn, :set,
              s(:send,
                s(:lvar, :inst), :find_gems_with_sources,
                s(:lvar, :dep)))),
          s(:lvasgn, :gems,
            s(:send,
              s(:lvar, :set), :sorted)),
          s(:send, nil, :assert_equal,
            s(:int, 2),
            s(:send,
              s(:lvar, :gems), :length)),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :remote),
              s(:lvasgn, :local)),
            s(:lvar, :gems)),
          s(:send, nil, :assert_equal,
            s(:str, "a-1"),
            s(:send,
              s(:send,
                s(:lvar, :local), :spec), :full_name),
            s(:str, "local spec")),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:send,
                s(:ivar, :@a1), :file_name)),
            s(:send,
              s(:send,
                s(:lvar, :local), :source), :download,
              s(:send,
                s(:lvar, :local), :spec)),
            s(:str, "local path")),
          s(:send, nil, :assert_equal,
            s(:str, "a-1"),
            s(:send,
              s(:send,
                s(:lvar, :remote), :spec), :full_name),
            s(:str, "remote spec")),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Source), :new,
              s(:ivar, :@gem_repo)),
            s(:send,
              s(:lvar, :remote), :source),
            s(:str, "remote path")))),
      s(:def, :test_find_gems_with_sources_prerelease,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:lvasgn, :installer,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :dependency,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Requirement), :default))),
          s(:lvasgn, :releases,
            s(:send,
              s(:send,
                s(:lvar, :installer), :find_gems_with_sources,
                s(:lvar, :dependency)), :all_specs)),
          s(:send, nil, :assert,
            s(:block,
              s(:send,
                s(:lvar, :releases), :any?),
              s(:args,
                s(:arg, :s)),
              s(:and,
                s(:send,
                  s(:send,
                    s(:lvar, :s), :name), :==,
                  s(:str, "a")),
                s(:send,
                  s(:send,
                    s(:send,
                      s(:lvar, :s), :version), :to_s), :==,
                  s(:str, "1"))))),
          s(:send, nil, :refute,
            s(:block,
              s(:send,
                s(:lvar, :releases), :any?),
              s(:args,
                s(:arg, :s)),
              s(:and,
                s(:send,
                  s(:send,
                    s(:lvar, :s), :name), :==,
                  s(:str, "a")),
                s(:send,
                  s(:send,
                    s(:send,
                      s(:lvar, :s), :version), :to_s), :==,
                  s(:str, "1.a"))))),
          s(:send,
            s(:lvar, :dependency), :prerelease=,
            s(:true)),
          s(:lvasgn, :prereleases,
            s(:send,
              s(:send,
                s(:lvar, :installer), :find_gems_with_sources,
                s(:lvar, :dependency)), :all_specs)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:ivar, :@a1_pre),
              s(:ivar, :@a1)),
            s(:lvar, :prereleases)))),
      s(:def, :test_find_gems_with_sources_with_best_only_and_platform,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :a1_x86_mingw32)),
            s(:block,
              s(:send, nil, :util_gem,
                s(:str, "a"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :platform=,
                s(:str, "x86-mingw32")))),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:ivar, :@a1),
            s(:lvar, :a1_x86_mingw32)),
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :platforms), :<<,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Platform), :new,
              s(:str, "x86-mingw32"))),
          s(:lvasgn, :installer,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :dependency,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Requirement), :default))),
          s(:lvasgn, :releases,
            s(:send,
              s(:send,
                s(:lvar, :installer), :find_gems_with_sources,
                s(:lvar, :dependency),
                s(:true)), :all_specs)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:lvar, :a1_x86_mingw32)),
            s(:lvar, :releases)))),
      s(:def, :test_find_gems_with_sources_with_bad_source,
        s(:args),
        s(:begin,
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :sources), :replace,
            s(:array,
              s(:str, "http://not-there.nothing"))),
          s(:lvasgn, :installer,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :dep,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Dependency), :new,
              s(:str, "a"))),
          s(:lvasgn, :out,
            s(:send,
              s(:lvar, :installer), :find_gems_with_sources,
              s(:lvar, :dep))),
          s(:send, nil, :assert,
            s(:send,
              s(:lvar, :out), :empty?)),
          s(:send, nil, :assert_kind_of,
            s(:const,
              s(:const, nil, :Gem), :SourceFetchProblem),
            s(:send,
              s(:send,
                s(:lvar, :installer), :errors), :first)))),
      s(:def, :test_resolve_dependencies,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :request_set,
            s(:send,
              s(:lvar, :inst), :resolve_dependencies,
              s(:str, "b"),
              s(:send, nil, :req,
                s(:str, ">= 0")))),
          s(:lvasgn, :requests,
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :request_set), :sorted_requests), :map),
              s(:args,
                s(:arg, :req)),
              s(:send,
                s(:lvar, :req), :full_name))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1"),
              s(:str, "b-1")),
            s(:lvar, :requests)))),
      s(:def, :test_resolve_dependencies_ignore_dependencies,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@b1_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new,
              s(:hash,
                s(:pair,
                  s(:sym, :ignore_dependencies),
                  s(:true))))),
          s(:lvasgn, :request_set,
            s(:send,
              s(:lvar, :inst), :resolve_dependencies,
              s(:str, "b"),
              s(:send, nil, :req,
                s(:str, ">= 0")))),
          s(:lvasgn, :requests,
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :request_set), :sorted_requests), :map),
              s(:args,
                s(:arg, :req)),
              s(:send,
                s(:lvar, :req), :full_name))),
          s(:send, nil, :assert,
            s(:send,
              s(:lvar, :request_set), :ignore_dependencies)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "b-1")),
            s(:lvar, :requests)))),
      s(:def, :test_resolve_dependencies_local,
        s(:args),
        s(:begin,
          s(:send, nil, :util_setup_gems),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@a2),
              s(:ivasgn, :@a2_gem)),
            s(:send, nil, :util_gem,
              s(:str, "a"),
              s(:str, "2"))),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a1_gem),
            s(:ivar, :@tempdir)),
          s(:send,
            s(:const, nil, :FileUtils), :mv,
            s(:ivar, :@a2_gem),
            s(:ivar, :@tempdir)),
          s(:lvasgn, :inst,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :DependencyInstaller), :new)),
          s(:lvasgn, :request_set,
            s(:send,
              s(:lvar, :inst), :resolve_dependencies,
              s(:str, "a-1.gem"),
              s(:send, nil, :req,
                s(:str, ">= 0")))),
          s(:lvasgn, :requests,
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :request_set), :sorted_requests), :map),
              s(:args,
                s(:arg, :req)),
              s(:send,
                s(:lvar, :req), :full_name))),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "a-1")),
            s(:lvar, :requests)))),
      s(:def, :util_write_a1_bin,
        s(:args),
        s(:block,
          s(:send, nil, :write_file,
            s(:send,
              s(:const, nil, :File), :join,
              s(:str, "gems"),
              s(:str, "a-1"),
              s(:str, "bin"),
              s(:str, "a_bin"))),
          s(:args,
            s(:arg, :fp)),
          s(:send,
            s(:lvar, :fp), :puts,
            s(:str, "#!/usr/bin/ruby")))),
      s(:def, :util_setup_c1_pre,
        s(:args),
        s(:begin,
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@c1_pre),
              s(:ivasgn, :@c1_pre_gem)),
            s(:block,
              s(:send, nil, :util_spec,
                s(:str, "c"),
                s(:str, "1.a")),
              s(:args,
                s(:arg, :s)),
              s(:begin,
                s(:send,
                  s(:lvar, :s), :add_dependency,
                  s(:str, "a"),
                  s(:str, "1.a")),
                s(:send,
                  s(:lvar, :s), :add_dependency,
                  s(:str, "b"),
                  s(:str, "1"))))),
          s(:send, nil, :util_reset_gems))),
      s(:def, :util_setup_d,
        s(:args),
        s(:begin,
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@d1),
              s(:ivasgn, :@d1_gem)),
            s(:send, nil, :util_gem,
              s(:str, "d"),
              s(:str, "1"))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@d2),
              s(:ivasgn, :@d2_gem)),
            s(:send, nil, :util_gem,
              s(:str, "d"),
              s(:str, "2"))),
          s(:send, nil, :util_reset_gems))),
      s(:def, :util_setup_wxyz,
        s(:args),
        s(:begin,
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@x1_m),
              s(:ivasgn, :@x1_m_gem)),
            s(:block,
              s(:send, nil, :util_spec,
                s(:str, "x"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :platform=,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Platform), :new,
                  s(:array,
                    s(:str, "cpu"),
                    s(:str, "my_platform"),
                    s(:str, "1")))))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@x1_o),
              s(:ivasgn, :@x1_o_gem)),
            s(:block,
              s(:send, nil, :util_spec,
                s(:str, "x"),
                s(:str, "1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :platform=,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Platform), :new,
                  s(:array,
                    s(:str, "cpu"),
                    s(:str, "other_platform"),
                    s(:str, "1")))))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@w1),
              s(:ivasgn, :@w1_gem)),
            s(:send, nil, :util_spec,
              s(:str, "w"),
              s(:str, "1"),
              s(:hash,
                s(:pair,
                  s(:str, "x"),
                  s(:nil))))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@y1),
              s(:ivasgn, :@y1_gem)),
            s(:send, nil, :util_spec,
              s(:str, "y"),
              s(:str, "1"))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@y1_1_p),
              s(:ivasgn, :@y1_1_p_gem)),
            s(:block,
              s(:send, nil, :util_spec,
                s(:str, "y"),
                s(:str, "1.1")),
              s(:args,
                s(:arg, :s)),
              s(:send,
                s(:lvar, :s), :platform=,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Platform), :new,
                  s(:array,
                    s(:str, "cpu"),
                    s(:str, "my_platform"),
                    s(:str, "1")))))),
          s(:masgn,
            s(:mlhs,
              s(:ivasgn, :@z1),
              s(:ivasgn, :@z1_gem)),
            s(:send, nil, :util_spec,
              s(:str, "z"),
              s(:str, "1"),
              s(:hash,
                s(:pair,
                  s(:str, "y"),
                  s(:nil))))),
          s(:send, nil, :util_reset_gems))),
      s(:def, :util_reset_gems,
        s(:args),
        s(:begin,
          s(:or_asgn,
            s(:ivasgn, :@a1),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@b1),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@a1_pre),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@c1_pre),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@d1),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@d2),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@w1),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@x1_m),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@x1_o),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@y1),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@y1_1_p),
            s(:nil)),
          s(:or_asgn,
            s(:ivasgn, :@z1),
            s(:nil)),
          s(:send, nil, :util_setup_spec_fetcher,
            s(:splat,
              s(:send,
                s(:array,
                  s(:ivar, :@a1),
                  s(:ivar, :@a1_pre),
                  s(:ivar, :@b1),
                  s(:ivar, :@c1_pre),
                  s(:ivar, :@d1),
                  s(:ivar, :@d2),
                  s(:ivar, :@x1_m),
                  s(:ivar, :@x1_o),
                  s(:ivar, :@w1),
                  s(:ivar, :@y1),
                  s(:ivar, :@y1_1_p),
                  s(:ivar, :@z1)), :compact))),
          s(:send, nil, :util_clear_gems))))))
