s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/test_case")),
  s(:send, nil, :require,
    s(:str, "rubygems/commands/open_command")),
  s(:class,
    s(:const, nil, :TestGemCommandsOpenCommand),
    s(:const,
      s(:const, nil, :Gem), :TestCase),
    s(:begin,
      s(:def, :setup,
        s(:args),
        s(:begin,
          s(:zsuper),
          s(:ivasgn, :@cmd,
            s(:send,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :Commands), :OpenCommand), :new)))),
      s(:def, :gem,
        s(:args,
          s(:arg, :name)),
        s(:begin,
          s(:lvasgn, :spec,
            s(:block,
              s(:send, nil, :quick_gem,
                s(:lvar, :name)),
              s(:args,
                s(:arg, :gem)),
              s(:send,
                s(:lvar, :gem), :files=,
                s(:array,
                  s(:dstr,
                    s(:str, "lib/"),
                    s(:begin,
                      s(:lvar, :name)),
                    s(:str, ".rb")),
                  s(:str, "Rakefile"))))),
          s(:send, nil, :write_file,
            s(:send,
              s(:const, nil, :File), :join,
              s(:splat,
                s(:array,
                  s(:str, "gems"),
                  s(:dstr,
                    s(:begin,
                      s(:send,
                        s(:lvar, :spec), :full_name))),
                  s(:str, "lib"),
                  s(:dstr,
                    s(:begin,
                      s(:lvar, :name)),
                    s(:str, ".rb")))))),
          s(:send, nil, :write_file,
            s(:send,
              s(:const, nil, :File), :join,
              s(:splat,
                s(:array,
                  s(:str, "gems"),
                  s(:dstr,
                    s(:begin,
                      s(:send,
                        s(:lvar, :spec), :full_name))),
                  s(:str, "Rakefile"))))),
          s(:lvar, :spec))),
      s(:def, :test_execute,
        s(:args),
        s(:begin,
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :args),
            s(:array,
              s(:str, "foo"))),
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :editor),
            s(:dstr,
              s(:begin,
                s(:send,
                  s(:const, nil, :Gem), :ruby)),
              s(:str, " -e0 --"))),
          s(:lvasgn, :spec,
            s(:send, nil, :gem,
              s(:str, "foo"))),
          s(:lvasgn, :mock,
            s(:send,
              s(:const,
                s(:const, nil, :MiniTest), :Mock), :new)),
          s(:send,
            s(:lvar, :mock), :expect,
            s(:sym, :call),
            s(:true),
            s(:array,
              s(:send,
                s(:lvar, :spec), :full_gem_path))),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :stub,
              s(:sym, :chdir),
              s(:lvar, :mock)),
            s(:args),
            s(:block,
              s(:send, nil, :use_ui,
                s(:ivar, :@ui)),
              s(:args),
              s(:send,
                s(:ivar, :@cmd), :execute))),
          s(:send, nil, :assert,
            s(:send,
              s(:lvar, :mock), :verify)),
          s(:send, nil, :assert_equal,
            s(:str, ""),
            s(:send,
              s(:ivar, :@ui), :error)))),
      s(:def, :test_execute_bad_gem,
        s(:args),
        s(:begin,
          s(:send,
            s(:send,
              s(:ivar, :@cmd), :options), :[]=,
            s(:sym, :args),
            s(:array,
              s(:str, "foo"))),
          s(:block,
            s(:send, nil, :assert_raises,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :MockGemUi), :TermError)),
            s(:args),
            s(:block,
              s(:send, nil, :use_ui,
                s(:ivar, :@ui)),
              s(:args),
              s(:send,
                s(:ivar, :@cmd), :execute))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "Unable to find gem 'foo'"),
              s(:regopt)),
            s(:send,
              s(:ivar, :@ui), :output)),
          s(:send, nil, :assert_equal,
            s(:str, ""),
            s(:send,
              s(:ivar, :@ui), :error)))))))
