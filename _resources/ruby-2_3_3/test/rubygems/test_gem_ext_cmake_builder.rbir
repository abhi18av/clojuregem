s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/test_case")),
  s(:send, nil, :require,
    s(:str, "rubygems/ext")),
  s(:class,
    s(:const, nil, :TestGemExtCmakeBuilder),
    s(:const,
      s(:const, nil, :Gem), :TestCase),
    s(:begin,
      s(:def, :setup,
        s(:args),
        s(:begin,
          s(:zsuper),
          s(:xstr,
            s(:str, "cmake "),
            s(:begin,
              s(:send,
                s(:const,
                  s(:const,
                    s(:const, nil, :Gem), :Ext), :Builder), :redirector))),
          s(:if,
            s(:send,
              s(:gvar, :$?), :success?), nil,
            s(:send, nil, :skip,
              s(:str, "cmake not present"))),
          s(:ivasgn, :@ext,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:str, "ext"))),
          s(:ivasgn, :@dest_path,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@tempdir),
              s(:str, "prefix"))),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir_p,
            s(:ivar, :@ext)),
          s(:send,
            s(:const, nil, :FileUtils), :mkdir_p,
            s(:ivar, :@dest_path)))),
      s(:def, :test_self_build,
        s(:args),
        s(:begin,
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:send,
                s(:const, nil, :File), :join,
                s(:ivar, :@ext),
                s(:str, "CMakeLists.txt")),
              s(:str, "w")),
            s(:args,
              s(:arg, :cmakelists)),
            s(:send,
              s(:lvar, :cmakelists), :write,
              s(:dstr,
                s(:str, "cmake_minimum_required(VERSION 2.6)\n"),
                s(:str, "install (FILES test.txt DESTINATION bin)\n")))),
          s(:send,
            s(:const, nil, :FileUtils), :touch,
            s(:send,
              s(:const, nil, :File), :join,
              s(:ivar, :@ext),
              s(:str, "test.txt"))),
          s(:lvasgn, :output,
            s(:array)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@ext)),
            s(:args),
            s(:send,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :Ext), :CmakeBuilder), :build,
              s(:nil),
              s(:nil),
              s(:ivar, :@dest_path),
              s(:lvar, :output))),
          s(:lvasgn, :output,
            s(:send,
              s(:lvar, :output), :join,
              s(:str, "\n"))),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "^cmake \\. -DCMAKE_INSTALL_PREFIX="),
              s(:begin,
                s(:send,
                  s(:const, nil, :Regexp), :escape,
                  s(:ivar, :@dest_path))),
              s(:regopt)),
            s(:lvar, :output)),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:begin,
                s(:send,
                  s(:const, nil, :Regexp), :escape,
                  s(:ivar, :@ext))),
              s(:regopt)),
            s(:lvar, :output)),
          s(:send, nil, :assert_contains_make_command,
            s(:str, ""),
            s(:lvar, :output)),
          s(:send, nil, :assert_contains_make_command,
            s(:str, "install"),
            s(:lvar, :output)),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "test\\.txt"),
              s(:regopt)),
            s(:lvar, :output)))),
      s(:def, :test_self_build_fail,
        s(:args),
        s(:begin,
          s(:lvasgn, :output,
            s(:array)),
          s(:lvasgn, :error,
            s(:block,
              s(:send, nil, :assert_raises,
                s(:const,
                  s(:const, nil, :Gem), :InstallError)),
              s(:args),
              s(:block,
                s(:send,
                  s(:const, nil, :Dir), :chdir,
                  s(:ivar, :@ext)),
                s(:args),
                s(:send,
                  s(:const,
                    s(:const,
                      s(:const, nil, :Gem), :Ext), :CmakeBuilder), :build,
                  s(:nil),
                  s(:nil),
                  s(:ivar, :@dest_path),
                  s(:lvar, :output))))),
          s(:lvasgn, :output,
            s(:send,
              s(:lvar, :output), :join,
              s(:str, "\n"))),
          s(:lvasgn, :shell_error_msg,
            s(:regexp,
              s(:str, "(CMake Error: .*)"),
              s(:regopt))),
          s(:lvasgn, :sh_prefix_cmake,
            s(:str, "cmake . -DCMAKE_INSTALL_PREFIX=")),
          s(:send, nil, :assert_match,
            s(:str, "cmake failed"),
            s(:send,
              s(:lvar, :error), :message)),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:str, "^"),
              s(:begin,
                s(:lvar, :sh_prefix_cmake)),
              s(:begin,
                s(:send,
                  s(:const, nil, :Regexp), :escape,
                  s(:ivar, :@dest_path))),
              s(:regopt)),
            s(:lvar, :output)),
          s(:send, nil, :assert_match,
            s(:regexp,
              s(:begin,
                s(:lvar, :shell_error_msg)),
              s(:regopt)),
            s(:lvar, :output)))),
      s(:def, :test_self_build_has_makefile,
        s(:args),
        s(:begin,
          s(:block,
            s(:send,
              s(:const, nil, :File), :open,
              s(:send,
                s(:const, nil, :File), :join,
                s(:ivar, :@ext),
                s(:str, "Makefile")),
              s(:str, "w")),
            s(:args,
              s(:arg, :makefile)),
            s(:send,
              s(:lvar, :makefile), :puts,
              s(:str, "all:\n\t@echo ok\ninstall:\n\t@echo ok"))),
          s(:lvasgn, :output,
            s(:array)),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :chdir,
              s(:ivar, :@ext)),
            s(:args),
            s(:send,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :Ext), :CmakeBuilder), :build,
              s(:nil),
              s(:nil),
              s(:ivar, :@dest_path),
              s(:lvar, :output))),
          s(:lvasgn, :output,
            s(:send,
              s(:lvar, :output), :join,
              s(:str, "\n"))),
          s(:send, nil, :assert_contains_make_command,
            s(:str, ""),
            s(:lvar, :output)),
          s(:send, nil, :assert_contains_make_command,
            s(:str, "install"),
            s(:lvar, :output)))))))
