s(:begin,
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:send, nil, :require,
    s(:str, "tmpdir")),
  s(:class,
    s(:const, nil, :TestTracer),
    s(:const,
      s(:const,
        s(:const, nil, :Test), :Unit), :TestCase),
    s(:begin,
      s(:send, nil, :include,
        s(:const, nil, :EnvUtil)),
      s(:def, :test_tracer_with_option_r,
        s(:args),
        s(:block,
          s(:send, nil, :assert_in_out_err,
            s(:array,
              s(:str, "-rtracer"),
              s(:str, "-e"),
              s(:str, "1"))),
          s(:args,
            s(:mlhs,
              s(:restarg, :lines))),
          s(:begin,
            s(:case,
              s(:send,
                s(:lvar, :lines), :size),
              s(:when,
                s(:int, 1), nil),
              s(:send, nil, :assert_match,
                s(:regexp,
                  s(:str, "rubygems/core_ext/kernel_require\\.rb:\\d+:Kernel:<:"),
                  s(:regopt)),
                s(:send,
                  s(:lvar, :lines), :[],
                  s(:int, 0)))),
            s(:send, nil, :assert_equal,
              s(:str, "#0:-e:1::-: 1"),
              s(:send,
                s(:lvar, :lines), :last))))),
      s(:def, :test_tracer_with_option_r_without_gems,
        s(:args),
        s(:block,
          s(:send, nil, :assert_in_out_err,
            s(:array,
              s(:str, "--disable-gems"),
              s(:str, "-rtracer"),
              s(:str, "-e"),
              s(:str, "1"))),
          s(:args,
            s(:mlhs,
              s(:restarg, :lines))),
          s(:begin,
            s(:send, nil, :assert_equal,
              s(:int, 1),
              s(:send,
                s(:lvar, :lines), :size),
              s(:str, "unexpected output from `ruby --disable-gems -rtracer -e 1`")),
            s(:send, nil, :assert_equal,
              s(:str, "#0:-e:1::-: 1"),
              s(:send,
                s(:lvar, :lines), :last))))),
      s(:def, :test_tracer_with_require,
        s(:args),
        s(:block,
          s(:send,
            s(:const, nil, :Dir), :mktmpdir,
            s(:str, "test_ruby_tracer")),
          s(:args,
            s(:arg, :dir)),
          s(:begin,
            s(:lvasgn, :script,
              s(:send,
                s(:const, nil, :File), :join,
                s(:lvar, :dir),
                s(:str, "require_tracer.rb"))),
            s(:block,
              s(:send, nil, :open,
                s(:lvar, :script),
                s(:str, "w")),
              s(:args,
                s(:arg, :f)),
              s(:send,
                s(:lvar, :f), :print,
                s(:dstr,
                  s(:str, "require 'tracer'\n"),
                  s(:str, "1\n")))),
            s(:block,
              s(:send, nil, :assert_in_out_err,
                s(:array,
                  s(:lvar, :script))),
              s(:args,
                s(:mlhs,
                  s(:restarg, :lines))),
              s(:send, nil, :assert_empty,
                s(:lvar, :lines)))))),
      s(:def, :test_tracer_with_require_without_gems,
        s(:args),
        s(:block,
          s(:send,
            s(:const, nil, :Dir), :mktmpdir,
            s(:str, "test_ruby_tracer")),
          s(:args,
            s(:arg, :dir)),
          s(:begin,
            s(:lvasgn, :script,
              s(:send,
                s(:const, nil, :File), :join,
                s(:lvar, :dir),
                s(:str, "require_tracer.rb"))),
            s(:block,
              s(:send, nil, :open,
                s(:lvar, :script),
                s(:str, "w")),
              s(:args,
                s(:arg, :f)),
              s(:send,
                s(:lvar, :f), :print,
                s(:dstr,
                  s(:str, "require 'tracer'\n"),
                  s(:str, "1\n")))),
            s(:block,
              s(:send, nil, :assert_in_out_err,
                s(:array,
                  s(:str, "--disable-gems"),
                  s(:lvar, :script))),
              s(:args,
                s(:mlhs,
                  s(:restarg, :lines))),
              s(:send, nil, :assert_empty,
                s(:lvar, :lines)))))))))
