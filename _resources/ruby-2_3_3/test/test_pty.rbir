s(:begin,
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:send, nil, :require,
    s(:str, "shellwords")),
  s(:send, nil, :require,
    s(:str, "tmpdir")),
  s(:kwbegin,
    s(:rescue,
      s(:send, nil, :require,
        s(:str, "pty")),
      s(:resbody,
        s(:array,
          s(:const, nil, :LoadError)), nil, nil), nil)),
  s(:if,
    s(:defined?,
      s(:const, nil, :PTY)),
    s(:class,
      s(:const, nil, :TestPTY),
      s(:const,
        s(:const,
          s(:const, nil, :Test), :Unit), :TestCase),
      s(:begin,
        s(:casgn, nil, :RUBY,
          s(:send,
            s(:const, nil, :EnvUtil), :rubybin)),
        s(:def, :test_spawn_without_block,
          s(:args),
          s(:ensure,
            s(:rescue,
              s(:masgn,
                s(:mlhs,
                  s(:lvasgn, :r),
                  s(:lvasgn, :w),
                  s(:lvasgn, :pid)),
                s(:send,
                  s(:const, nil, :PTY), :spawn,
                  s(:const, nil, :RUBY),
                  s(:str, "-e"),
                  s(:str, "puts \"a\""))),
              s(:resbody,
                s(:array,
                  s(:const, nil, :RuntimeError)), nil,
                s(:send, nil, :skip,
                  s(:gvar, :$!))),
              s(:send, nil, :assert_equal,
                s(:str, "a\r\n"),
                s(:send,
                  s(:lvar, :r), :gets))),
            s(:begin,
              s(:if,
                s(:lvar, :r),
                s(:send,
                  s(:lvar, :r), :close), nil),
              s(:if,
                s(:lvar, :w),
                s(:send,
                  s(:lvar, :w), :close), nil),
              s(:if,
                s(:lvar, :pid),
                s(:send,
                  s(:const, nil, :Process), :wait,
                  s(:lvar, :pid)), nil)))),
        s(:def, :test_spawn_with_block,
          s(:args),
          s(:rescue,
            s(:block,
              s(:send,
                s(:const, nil, :PTY), :spawn,
                s(:const, nil, :RUBY),
                s(:str, "-e"),
                s(:str, "puts \"b\"")),
              s(:args,
                s(:arg, :r),
                s(:arg, :w),
                s(:arg, :pid)),
              s(:kwbegin,
                s(:ensure,
                  s(:send, nil, :assert_equal,
                    s(:str, "b\r\n"),
                    s(:send,
                      s(:lvar, :r), :gets)),
                  s(:begin,
                    s(:send,
                      s(:lvar, :r), :close),
                    s(:send,
                      s(:lvar, :w), :close),
                    s(:send,
                      s(:const, nil, :Process), :wait,
                      s(:lvar, :pid)))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))), nil)),
        s(:def, :test_commandline,
          s(:args),
          s(:rescue,
            s(:begin,
              s(:lvasgn, :commandline,
                s(:send,
                  s(:const, nil, :Shellwords), :join,
                  s(:array,
                    s(:const, nil, :RUBY),
                    s(:str, "-e"),
                    s(:str, "puts \"foo\"")))),
              s(:block,
                s(:send,
                  s(:const, nil, :PTY), :spawn,
                  s(:lvar, :commandline)),
                s(:args,
                  s(:arg, :r),
                  s(:arg, :w),
                  s(:arg, :pid)),
                s(:kwbegin,
                  s(:ensure,
                    s(:send, nil, :assert_equal,
                      s(:str, "foo\r\n"),
                      s(:send,
                        s(:lvar, :r), :gets)),
                    s(:begin,
                      s(:send,
                        s(:lvar, :r), :close),
                      s(:send,
                        s(:lvar, :w), :close),
                      s(:send,
                        s(:const, nil, :Process), :wait,
                        s(:lvar, :pid))))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))), nil)),
        s(:def, :test_argv0,
          s(:args),
          s(:rescue,
            s(:block,
              s(:send,
                s(:const, nil, :PTY), :spawn,
                s(:array,
                  s(:const, nil, :RUBY),
                  s(:str, "argv0")),
                s(:str, "-e"),
                s(:str, "puts \"bar\"")),
              s(:args,
                s(:arg, :r),
                s(:arg, :w),
                s(:arg, :pid)),
              s(:kwbegin,
                s(:ensure,
                  s(:send, nil, :assert_equal,
                    s(:str, "bar\r\n"),
                    s(:send,
                      s(:lvar, :r), :gets)),
                  s(:begin,
                    s(:send,
                      s(:lvar, :r), :close),
                    s(:send,
                      s(:lvar, :w), :close),
                    s(:send,
                      s(:const, nil, :Process), :wait,
                      s(:lvar, :pid)))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))), nil)),
        s(:def, :test_open_without_block,
          s(:args),
          s(:ensure,
            s(:rescue,
              s(:lvasgn, :ret,
                s(:send,
                  s(:const, nil, :PTY), :open)),
              s(:resbody,
                s(:array,
                  s(:const, nil, :RuntimeError)), nil,
                s(:send, nil, :skip,
                  s(:gvar, :$!))),
              s(:begin,
                s(:send, nil, :assert_kind_of,
                  s(:const, nil, :Array),
                  s(:lvar, :ret)),
                s(:send, nil, :assert_equal,
                  s(:int, 2),
                  s(:send,
                    s(:lvar, :ret), :length)),
                s(:send, nil, :assert_equal,
                  s(:const, nil, :IO),
                  s(:send,
                    s(:send,
                      s(:lvar, :ret), :[],
                      s(:int, 0)), :class)),
                s(:send, nil, :assert_equal,
                  s(:const, nil, :File),
                  s(:send,
                    s(:send,
                      s(:lvar, :ret), :[],
                      s(:int, 1)), :class)),
                s(:masgn,
                  s(:mlhs,
                    s(:lvasgn, :_),
                    s(:lvasgn, :slave)),
                  s(:lvar, :ret)),
                s(:send, nil, :assert,
                  s(:send,
                    s(:lvar, :slave), :tty?)),
                s(:send, nil, :assert,
                  s(:send,
                    s(:const, nil, :File), :chardev?,
                    s(:send,
                      s(:lvar, :slave), :path))))),
            s(:if,
              s(:lvar, :ret),
              s(:begin,
                s(:send,
                  s(:send,
                    s(:lvar, :ret), :[],
                    s(:int, 0)), :close),
                s(:send,
                  s(:send,
                    s(:lvar, :ret), :[],
                    s(:int, 1)), :close)), nil))),
        s(:def, :test_open_with_block,
          s(:args),
          s(:rescue,
            s(:begin,
              s(:lvasgn, :r,
                s(:nil)),
              s(:lvasgn, :x,
                s(:send,
                  s(:const, nil, :Object), :new)),
              s(:lvasgn, :y,
                s(:block,
                  s(:send,
                    s(:const, nil, :PTY), :open),
                  s(:args,
                    s(:arg, :ret)),
                  s(:begin,
                    s(:lvasgn, :r,
                      s(:lvar, :ret)),
                    s(:send, nil, :assert_kind_of,
                      s(:const, nil, :Array),
                      s(:lvar, :ret)),
                    s(:send, nil, :assert_equal,
                      s(:int, 2),
                      s(:send,
                        s(:lvar, :ret), :length)),
                    s(:send, nil, :assert_equal,
                      s(:const, nil, :IO),
                      s(:send,
                        s(:send,
                          s(:lvar, :ret), :[],
                          s(:int, 0)), :class)),
                    s(:send, nil, :assert_equal,
                      s(:const, nil, :File),
                      s(:send,
                        s(:send,
                          s(:lvar, :ret), :[],
                          s(:int, 1)), :class)),
                    s(:masgn,
                      s(:mlhs,
                        s(:lvasgn, :_),
                        s(:lvasgn, :slave)),
                      s(:lvar, :ret)),
                    s(:send, nil, :assert,
                      s(:send,
                        s(:lvar, :slave), :tty?)),
                    s(:send, nil, :assert,
                      s(:send,
                        s(:const, nil, :File), :chardev?,
                        s(:send,
                          s(:lvar, :slave), :path))),
                    s(:lvar, :x))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))),
            s(:begin,
              s(:send, nil, :assert,
                s(:send,
                  s(:send,
                    s(:lvar, :r), :[],
                    s(:int, 0)), :closed?)),
              s(:send, nil, :assert,
                s(:send,
                  s(:send,
                    s(:lvar, :r), :[],
                    s(:int, 1)), :closed?)),
              s(:send, nil, :assert_equal,
                s(:lvar, :y),
                s(:lvar, :x))))),
        s(:def, :test_close_in_block,
          s(:args),
          s(:rescue,
            s(:block,
              s(:send,
                s(:const, nil, :PTY), :open),
              s(:args,
                s(:arg, :master),
                s(:arg, :slave)),
              s(:begin,
                s(:send,
                  s(:lvar, :slave), :close),
                s(:send,
                  s(:lvar, :master), :close),
                s(:send, nil, :assert,
                  s(:send,
                    s(:lvar, :slave), :closed?)),
                s(:send, nil, :assert,
                  s(:send,
                    s(:lvar, :master), :closed?)))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))),
            s(:block,
              s(:send, nil, :assert_nothing_raised),
              s(:args),
              s(:block,
                s(:send,
                  s(:const, nil, :PTY), :open),
                s(:args,
                  s(:arg, :master),
                  s(:arg, :slave)),
                s(:begin,
                  s(:send,
                    s(:lvar, :slave), :close),
                  s(:send,
                    s(:lvar, :master), :close)))))),
        s(:def, :test_open,
          s(:args),
          s(:rescue,
            s(:block,
              s(:send,
                s(:const, nil, :PTY), :open),
              s(:args,
                s(:arg, :master),
                s(:arg, :slave)),
              s(:begin,
                s(:send,
                  s(:lvar, :slave), :puts,
                  s(:str, "foo")),
                s(:send, nil, :assert_equal,
                  s(:str, "foo"),
                  s(:send,
                    s(:send,
                      s(:lvar, :master), :gets), :chomp)),
                s(:send,
                  s(:lvar, :master), :puts,
                  s(:str, "bar")),
                s(:send, nil, :assert_equal,
                  s(:str, "bar"),
                  s(:send,
                    s(:send,
                      s(:lvar, :slave), :gets), :chomp)))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))), nil)),
        s(:def, :test_stat_slave,
          s(:args),
          s(:rescue,
            s(:block,
              s(:send,
                s(:const, nil, :PTY), :open),
              s(:args,
                s(:arg, :master),
                s(:arg, :slave)),
              s(:begin,
                s(:lvasgn, :s,
                  s(:send,
                    s(:const, nil, :File), :stat,
                    s(:send,
                      s(:lvar, :slave), :path))),
                s(:send, nil, :assert_equal,
                  s(:send,
                    s(:const, nil, :Process), :uid),
                  s(:send,
                    s(:lvar, :s), :uid)),
                s(:send, nil, :assert_equal,
                  s(:int, 384),
                  s(:send,
                    s(:send,
                      s(:lvar, :s), :mode), :&,
                    s(:int, 511))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))), nil)),
        s(:def, :test_close_master,
          s(:args),
          s(:rescue,
            s(:block,
              s(:send,
                s(:const, nil, :PTY), :open),
              s(:args,
                s(:arg, :master),
                s(:arg, :slave)),
              s(:begin,
                s(:send,
                  s(:lvar, :master), :close),
                s(:block,
                  s(:send, nil, :assert_raise,
                    s(:const, nil, :EOFError)),
                  s(:args),
                  s(:send,
                    s(:lvar, :slave), :readpartial,
                    s(:int, 10))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))), nil)),
        s(:def, :test_close_slave,
          s(:args),
          s(:rescue,
            s(:block,
              s(:send,
                s(:const, nil, :PTY), :open),
              s(:args,
                s(:arg, :master),
                s(:arg, :slave)),
              s(:begin,
                s(:send,
                  s(:lvar, :slave), :close),
                s(:block,
                  s(:send, nil, :assert_raise,
                    s(:const, nil, :EOFError),
                    s(:const,
                      s(:const, nil, :Errno), :EIO)),
                  s(:args),
                  s(:send,
                    s(:lvar, :master), :readpartial,
                    s(:int, 10))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))), nil)),
        s(:def, :test_getpty_nonexistent,
          s(:args),
          s(:begin,
            s(:lvasgn, :bug3672,
              s(:str, "[ruby-dev:41965]")),
            s(:block,
              s(:send,
                s(:const, nil, :Dir), :mktmpdir),
              s(:args,
                s(:arg, :tmpdir)),
              s(:block,
                s(:send, nil, :assert_raise,
                  s(:const,
                    s(:const, nil, :Errno), :ENOENT),
                  s(:lvar, :bug3672)),
                s(:args),
                s(:kwbegin,
                  s(:rescue,
                    s(:send,
                      s(:const, nil, :PTY), :getpty,
                      s(:send,
                        s(:const, nil, :File), :join,
                        s(:lvar, :tmpdir),
                        s(:str, "no-such-command"))),
                    s(:resbody,
                      s(:array,
                        s(:const, nil, :RuntimeError)), nil,
                      s(:send, nil, :skip,
                        s(:gvar, :$!))), nil)))))),
        s(:def, :test_pty_check_default,
          s(:args),
          s(:rescue,
            s(:begin,
              s(:lvasgn, :st1,
                s(:lvasgn, :st2,
                  s(:lvasgn, :pid,
                    s(:nil)))),
              s(:xstr,
                s(:str, "echo")),
              s(:block,
                s(:send,
                  s(:const, nil, :PTY), :spawn,
                  s(:str, "cat")),
                s(:args,
                  s(:arg, :r),
                  s(:arg, :w),
                  s(:arg, :id)),
                s(:begin,
                  s(:lvasgn, :pid,
                    s(:lvar, :id)),
                  s(:lvasgn, :st1,
                    s(:send,
                      s(:const, nil, :PTY), :check,
                      s(:lvar, :pid))),
                  s(:send,
                    s(:lvar, :w), :close),
                  s(:send,
                    s(:lvar, :r), :close),
                  s(:until_post,
                    s(:lvasgn, :st2,
                      s(:send,
                        s(:const, nil, :PTY), :check,
                        s(:lvar, :pid))),
                    s(:kwbegin,
                      s(:send, nil, :sleep,
                        s(:float, 0.1))))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))),
            s(:begin,
              s(:if,
                s(:lvar, :st1),
                s(:send, nil, :assert_equal,
                  s(:lvar, :pid),
                  s(:send,
                    s(:lvar, :st1), :pid)), nil),
              s(:send, nil, :assert_nil,
                s(:lvar, :st1)),
              s(:send, nil, :assert_equal,
                s(:lvar, :pid),
                s(:send,
                  s(:lvar, :st2), :pid))))),
        s(:def, :test_pty_check_raise,
          s(:args),
          s(:rescue,
            s(:begin,
              s(:lvasgn, :bug2642,
                s(:str, "[ruby-dev:44600]")),
              s(:lvasgn, :st1,
                s(:lvasgn, :st2,
                  s(:lvasgn, :pid,
                    s(:nil)))),
              s(:block,
                s(:send,
                  s(:const, nil, :PTY), :spawn,
                  s(:str, "cat")),
                s(:args,
                  s(:arg, :r),
                  s(:arg, :w),
                  s(:arg, :id)),
                s(:begin,
                  s(:lvasgn, :pid,
                    s(:lvar, :id)),
                  s(:block,
                    s(:send, nil, :assert_nothing_raised,
                      s(:const,
                        s(:const, nil, :PTY), :ChildExited),
                      s(:lvar, :bug2642)),
                    s(:args),
                    s(:lvasgn, :st1,
                      s(:send,
                        s(:const, nil, :PTY), :check,
                        s(:lvar, :pid),
                        s(:true)))),
                  s(:send,
                    s(:lvar, :w), :close),
                  s(:send,
                    s(:lvar, :r), :close),
                  s(:send, nil, :sleep,
                    s(:float, 0.1)),
                  s(:lvasgn, :st2,
                    s(:send,
                      s(:block,
                        s(:send, nil, :assert_raise,
                          s(:const,
                            s(:const, nil, :PTY), :ChildExited),
                          s(:lvar, :bug2642)),
                        s(:args),
                        s(:send,
                          s(:const, nil, :PTY), :check,
                          s(:lvar, :pid),
                          s(:true))), :status))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))),
            s(:begin,
              s(:if,
                s(:lvar, :st1),
                s(:send, nil, :assert_equal,
                  s(:lvar, :pid),
                  s(:send,
                    s(:lvar, :st1), :pid)), nil),
              s(:send, nil, :assert_nil,
                s(:lvar, :st1)),
              s(:send, nil, :assert_equal,
                s(:lvar, :pid),
                s(:send,
                  s(:lvar, :st2), :pid))))),
        s(:def, :test_cloexec,
          s(:args),
          s(:rescue,
            s(:begin,
              s(:block,
                s(:send,
                  s(:const, nil, :PTY), :open),
                s(:args,
                  s(:arg, :m),
                  s(:arg, :s)),
                s(:begin,
                  s(:send, nil, :assert,
                    s(:send,
                      s(:lvar, :m), :close_on_exec?)),
                  s(:send, nil, :assert,
                    s(:send,
                      s(:lvar, :s), :close_on_exec?)))),
              s(:block,
                s(:send,
                  s(:const, nil, :PTY), :spawn,
                  s(:const, nil, :RUBY),
                  s(:str, "-e"),
                  s(:str, "")),
                s(:args,
                  s(:arg, :r),
                  s(:arg, :w),
                  s(:arg, :pid)),
                s(:kwbegin,
                  s(:ensure,
                    s(:begin,
                      s(:send, nil, :assert,
                        s(:send,
                          s(:lvar, :r), :close_on_exec?)),
                      s(:send, nil, :assert,
                        s(:send,
                          s(:lvar, :w), :close_on_exec?))),
                    s(:begin,
                      s(:send,
                        s(:lvar, :r), :close),
                      s(:send,
                        s(:lvar, :w), :close),
                      s(:send,
                        s(:const, nil, :Process), :wait,
                        s(:lvar, :pid))))))),
            s(:resbody,
              s(:array,
                s(:const, nil, :RuntimeError)), nil,
              s(:send, nil, :skip,
                s(:gvar, :$!))), nil)))), nil))
