s(:begin,
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:send, nil, :require,
    s(:str, "tempfile")),
  s(:send, nil, :require,
    s(:str, "thread")),
  s(:class,
    s(:const, nil, :TestAutoload),
    s(:const,
      s(:const,
        s(:const, nil, :Test), :Unit), :TestCase),
    s(:begin,
      s(:def, :test_autoload_so,
        s(:args),
        s(:send, nil, :assert_in_out_err,
          s(:array),
          s(:dstr,
            s(:str, "    autoload :Date, \"date\"\n"),
            s(:str, "    begin Date; rescue LoadError; end\n")),
          s(:array),
          s(:array))),
      s(:def, :test_non_realpath_in_loadpath,
        s(:args),
        s(:ensure,
          s(:begin,
            s(:send, nil, :require,
              s(:str, "tmpdir")),
            s(:lvasgn, :tmpdir,
              s(:send,
                s(:const, nil, :Dir), :mktmpdir,
                s(:str, "autoload"))),
            s(:lvasgn, :tmpdirs,
              s(:array,
                s(:lvar, :tmpdir))),
            s(:send,
              s(:lvar, :tmpdirs), :unshift,
              s(:send,
                s(:lvar, :tmpdir), :+,
                s(:str, "/foo"))),
            s(:send,
              s(:const, nil, :Dir), :mkdir,
              s(:send,
                s(:lvar, :tmpdirs), :[],
                s(:int, 0))),
            s(:lvasgn, :tmpfiles,
              s(:array,
                s(:send,
                  s(:lvar, :tmpdir), :+,
                  s(:str, "/foo.rb")),
                s(:send,
                  s(:lvar, :tmpdir), :+,
                  s(:str, "/foo/bar.rb")))),
            s(:block,
              s(:send, nil, :open,
                s(:send,
                  s(:lvar, :tmpfiles), :[],
                  s(:int, 0)),
                s(:str, "w")),
              s(:args,
                s(:arg, :f)),
              s(:send,
                s(:lvar, :f), :puts,
                s(:dstr,
                  s(:str, "$:.unshift(File.expand_path('..', __FILE__)+'/./foo')\n"),
                  s(:str, "module Foo\n"),
                  s(:str, "  autoload :Bar, 'bar'\n"),
                  s(:str, "end\n"),
                  s(:str, "p Foo::Bar\n")))),
            s(:block,
              s(:send, nil, :open,
                s(:send,
                  s(:lvar, :tmpfiles), :[],
                  s(:int, 1)),
                s(:str, "w")),
              s(:args,
                s(:arg, :f)),
              s(:send,
                s(:lvar, :f), :puts,
                s(:str, "class Foo::Bar; end"))),
            s(:send, nil, :assert_in_out_err,
              s(:array,
                s(:send,
                  s(:lvar, :tmpfiles), :[],
                  s(:int, 0))),
              s(:str, ""),
              s(:array,
                s(:str, "Foo::Bar")),
              s(:array))),
          s(:begin,
            s(:if,
              s(:lvar, :tmpfiles),
              s(:rescue,
                s(:send,
                  s(:const, nil, :File), :unlink,
                  s(:splat,
                    s(:lvar, :tmpfiles))),
                s(:resbody, nil, nil,
                  s(:nil)), nil), nil),
            s(:block,
              s(:send,
                s(:lvar, :tmpdirs), :each),
              s(:args,
                s(:arg, :dir)),
              s(:send,
                s(:const, nil, :Dir), :rmdir,
                s(:lvar, :dir)))))),
      s(:def, :test_autoload_p,
        s(:args),
        s(:begin,
          s(:lvasgn, :bug4565,
            s(:str, "[ruby-core:35679]")),
          s(:send, nil, :require,
            s(:str, "tmpdir")),
          s(:block,
            s(:send,
              s(:const, nil, :Dir), :mktmpdir,
              s(:str, "autoload")),
            s(:args,
              s(:arg, :tmpdir)),
            s(:begin,
              s(:lvasgn, :tmpfile,
                s(:send,
                  s(:lvar, :tmpdir), :+,
                  s(:str, "/foo.rb"))),
              s(:lvasgn, :a,
                s(:block,
                  s(:send,
                    s(:const, nil, :Module), :new),
                  s(:args),
                  s(:send, nil, :autoload,
                    s(:sym, :X),
                    s(:lvar, :tmpfile)))),
              s(:lvasgn, :b,
                s(:block,
                  s(:send,
                    s(:const, nil, :Module), :new),
                  s(:args),
                  s(:send, nil, :include,
                    s(:lvar, :a)))),
              s(:send, nil, :assert_equal,
                s(:true),
                s(:send,
                  s(:lvar, :a), :const_defined?,
                  s(:sym, :X))),
              s(:send, nil, :assert_equal,
                s(:true),
                s(:send,
                  s(:lvar, :b), :const_defined?,
                  s(:sym, :X))),
              s(:send, nil, :assert_equal,
                s(:lvar, :tmpfile),
                s(:send,
                  s(:lvar, :a), :autoload?,
                  s(:sym, :X)),
                s(:lvar, :bug4565)),
              s(:send, nil, :assert_equal,
                s(:lvar, :tmpfile),
                s(:send,
                  s(:lvar, :b), :autoload?,
                  s(:sym, :X)),
                s(:lvar, :bug4565)))))),
      s(:def, :test_autoload_with_unqualified_file_name,
        s(:args),
        s(:ensure,
          s(:begin,
            s(:lvasgn, :lp,
              s(:send,
                s(:gvar, :$LOAD_PATH), :dup)),
            s(:lvasgn, :lf,
              s(:send,
                s(:gvar, :$LOADED_FEATURES), :dup)),
            s(:block,
              s(:send,
                s(:const, nil, :Dir), :mktmpdir,
                s(:str, "autoload")),
              s(:args,
                s(:arg, :tmpdir)),
              s(:begin,
                s(:send,
                  s(:gvar, :$LOAD_PATH), :<<,
                  s(:lvar, :tmpdir)),
                s(:block,
                  s(:send,
                    s(:const, nil, :Dir), :chdir,
                    s(:lvar, :tmpdir)),
                  s(:args),
                  s(:begin,
                    s(:send, nil, :eval,
                      s(:dstr,
                        s(:str, "          class ::Object\n"),
                        s(:str, "            module A\n"),
                        s(:str, "              autoload :C, 'b'\n"),
                        s(:str, "            end\n"),
                        s(:str, "          end\n"))),
                    s(:block,
                      s(:send,
                        s(:const, nil, :File), :open,
                        s(:str, "b.rb"),
                        s(:str, "w")),
                      s(:args,
                        s(:arg, :file)),
                      s(:send,
                        s(:lvar, :file), :puts,
                        s(:str, "module A; class C; end; end"))),
                    s(:send, nil, :assert_kind_of,
                      s(:const, nil, :Class),
                      s(:const,
                        s(:const,
                          s(:cbase), :A), :C))))))),
          s(:begin,
            s(:send,
              s(:gvar, :$LOAD_PATH), :replace,
              s(:lvar, :lp)),
            s(:send,
              s(:gvar, :$LOADED_FEATURES), :replace,
              s(:lvar, :lf)),
            s(:if,
              s(:send,
                s(:const, nil, :Object), :const_defined?,
                s(:sym, :A)),
              s(:send,
                s(:const, nil, :Object), :send,
                s(:sym, :remove_const),
                s(:sym, :A)), nil)))),
      s(:def, :test_require_explicit,
        s(:args),
        s(:block,
          s(:send,
            s(:const, nil, :Tempfile), :create,
            s(:array,
              s(:str, "autoload"),
              s(:str, ".rb"))),
          s(:args,
            s(:arg, :file)),
          s(:begin,
            s(:send,
              s(:lvar, :file), :puts,
              s(:str, "class Object; AutoloadTest = 1; end")),
            s(:send,
              s(:lvar, :file), :close),
            s(:send, nil, :add_autoload,
              s(:send,
                s(:lvar, :file), :path)),
            s(:kwbegin,
              s(:ensure,
                s(:block,
                  s(:send, nil, :assert_nothing_raised),
                  s(:args),
                  s(:begin,
                    s(:send, nil, :assert,
                      s(:send, nil, :require,
                        s(:send,
                          s(:lvar, :file), :path))),
                    s(:send, nil, :assert_equal,
                      s(:int, 1),
                      s(:const,
                        s(:cbase), :AutoloadTest)))),
                s(:send, nil, :remove_autoload_constant)))))),
      s(:def, :test_threaded_accessing_constant,
        s(:args),
        s(:block,
          s(:send,
            s(:const, nil, :EnvUtil), :default_warning),
          s(:args),
          s(:block,
            s(:send,
              s(:const, nil, :Tempfile), :create,
              s(:array,
                s(:str, "autoload"),
                s(:str, ".rb"))),
            s(:args,
              s(:arg, :file)),
            s(:begin,
              s(:send,
                s(:lvar, :file), :puts,
                s(:str, "sleep 0.5; class AutoloadTest; X = 1; end")),
              s(:send,
                s(:lvar, :file), :close),
              s(:send, nil, :add_autoload,
                s(:send,
                  s(:lvar, :file), :path)),
              s(:kwbegin,
                s(:ensure,
                  s(:block,
                    s(:send, nil, :assert_nothing_raised),
                    s(:args),
                    s(:begin,
                      s(:lvasgn, :t1,
                        s(:block,
                          s(:send,
                            s(:const, nil, :Thread), :new),
                          s(:args),
                          s(:const,
                            s(:const,
                              s(:cbase), :AutoloadTest), :X))),
                      s(:lvasgn, :t2,
                        s(:block,
                          s(:send,
                            s(:const, nil, :Thread), :new),
                          s(:args),
                          s(:const,
                            s(:const,
                              s(:cbase), :AutoloadTest), :X))),
                      s(:send,
                        s(:array,
                          s(:lvar, :t1),
                          s(:lvar, :t2)), :each,
                        s(:block_pass,
                          s(:sym, :join))))),
                  s(:send, nil, :remove_autoload_constant))))))),
      s(:def, :test_threaded_accessing_inner_constant,
        s(:args),
        s(:block,
          s(:send,
            s(:const, nil, :EnvUtil), :default_warning),
          s(:args),
          s(:block,
            s(:send,
              s(:const, nil, :Tempfile), :create,
              s(:array,
                s(:str, "autoload"),
                s(:str, ".rb"))),
            s(:args,
              s(:arg, :file)),
            s(:begin,
              s(:send,
                s(:lvar, :file), :puts,
                s(:str, "class AutoloadTest; sleep 0.5; X = 1; end")),
              s(:send,
                s(:lvar, :file), :close),
              s(:send, nil, :add_autoload,
                s(:send,
                  s(:lvar, :file), :path)),
              s(:kwbegin,
                s(:ensure,
                  s(:block,
                    s(:send, nil, :assert_nothing_raised),
                    s(:args),
                    s(:begin,
                      s(:lvasgn, :t1,
                        s(:block,
                          s(:send,
                            s(:const, nil, :Thread), :new),
                          s(:args),
                          s(:const,
                            s(:const,
                              s(:cbase), :AutoloadTest), :X))),
                      s(:lvasgn, :t2,
                        s(:block,
                          s(:send,
                            s(:const, nil, :Thread), :new),
                          s(:args),
                          s(:const,
                            s(:const,
                              s(:cbase), :AutoloadTest), :X))),
                      s(:send,
                        s(:array,
                          s(:lvar, :t1),
                          s(:lvar, :t2)), :each,
                        s(:block_pass,
                          s(:sym, :join))))),
                  s(:send, nil, :remove_autoload_constant))))))),
      s(:def, :test_nameerror_when_autoload_did_not_define_the_constant,
        s(:args),
        s(:block,
          s(:send,
            s(:const, nil, :Tempfile), :create,
            s(:array,
              s(:str, "autoload"),
              s(:str, ".rb"))),
          s(:args,
            s(:arg, :file)),
          s(:begin,
            s(:send,
              s(:lvar, :file), :puts,
              s(:str, "")),
            s(:send,
              s(:lvar, :file), :close),
            s(:send, nil, :add_autoload,
              s(:send,
                s(:lvar, :file), :path)),
            s(:kwbegin,
              s(:ensure,
                s(:block,
                  s(:send, nil, :assert_raise,
                    s(:const, nil, :NameError)),
                  s(:args),
                  s(:const, nil, :AutoloadTest)),
                s(:send, nil, :remove_autoload_constant)))))),
      s(:def, :test_override_autoload,
        s(:args),
        s(:block,
          s(:send,
            s(:const, nil, :Tempfile), :create,
            s(:array,
              s(:str, "autoload"),
              s(:str, ".rb"))),
          s(:args,
            s(:arg, :file)),
          s(:begin,
            s(:send,
              s(:lvar, :file), :puts,
              s(:str, "")),
            s(:send,
              s(:lvar, :file), :close),
            s(:send, nil, :add_autoload,
              s(:send,
                s(:lvar, :file), :path)),
            s(:kwbegin,
              s(:ensure,
                s(:begin,
                  s(:send, nil, :eval,
                    s(:str, "class AutoloadTest; end")),
                  s(:send, nil, :assert_equal,
                    s(:const, nil, :Class),
                    s(:send,
                      s(:const, nil, :AutoloadTest), :class))),
                s(:send, nil, :remove_autoload_constant)))))),
      s(:def, :test_override_while_autoloading,
        s(:args),
        s(:block,
          s(:send,
            s(:const, nil, :Tempfile), :create,
            s(:array,
              s(:str, "autoload"),
              s(:str, ".rb"))),
          s(:args,
            s(:arg, :file)),
          s(:begin,
            s(:send,
              s(:lvar, :file), :puts,
              s(:str, "class AutoloadTest; sleep 0.5; end")),
            s(:send,
              s(:lvar, :file), :close),
            s(:send, nil, :add_autoload,
              s(:send,
                s(:lvar, :file), :path)),
            s(:kwbegin,
              s(:ensure,
                s(:begin,
                  s(:lvasgn, :t,
                    s(:block,
                      s(:send,
                        s(:const, nil, :Thread), :new),
                      s(:args),
                      s(:const, nil, :AutoloadTest))),
                  s(:send, nil, :sleep,
                    s(:float, 0.1)),
                  s(:block,
                    s(:send,
                      s(:const, nil, :EnvUtil), :suppress_warning),
                    s(:args),
                    s(:send, nil, :eval,
                      s(:str, "AutoloadTest = 1"))),
                  s(:send,
                    s(:lvar, :t), :join),
                  s(:send, nil, :assert_equal,
                    s(:int, 1),
                    s(:const, nil, :AutoloadTest))),
                s(:send, nil, :remove_autoload_constant)))))),
      s(:def, :ruby_impl_require,
        s(:args),
        s(:ensure,
          s(:begin,
            s(:block,
              s(:send,
                s(:const, nil, :Kernel), :module_eval),
              s(:args),
              s(:alias,
                s(:sym, :old_require),
                s(:sym, :require))),
            s(:lvasgn, :called_with,
              s(:array)),
            s(:block,
              s(:send,
                s(:const, nil, :Kernel), :send,
                s(:sym, :define_method),
                s(:sym, :require)),
              s(:args,
                s(:arg, :path)),
              s(:begin,
                s(:send,
                  s(:lvar, :called_with), :<<,
                  s(:lvar, :path)),
                s(:send, nil, :old_require,
                  s(:lvar, :path)))),
            s(:yield,
              s(:lvar, :called_with))),
          s(:block,
            s(:send,
              s(:const, nil, :Kernel), :module_eval),
            s(:args),
            s(:begin,
              s(:alias,
                s(:sym, :require),
                s(:sym, :old_require)),
              s(:undef,
                s(:sym, :old_require)))))),
      s(:def, :test_require_implemented_in_ruby_is_called,
        s(:args),
        s(:block,
          s(:send, nil, :ruby_impl_require),
          s(:args,
            s(:arg, :called_with)),
          s(:block,
            s(:send,
              s(:const, nil, :Tempfile), :create,
              s(:array,
                s(:str, "autoload"),
                s(:str, ".rb"))),
            s(:args,
              s(:arg, :file)),
            s(:begin,
              s(:send,
                s(:lvar, :file), :puts,
                s(:str, "class AutoloadTest; end")),
              s(:send,
                s(:lvar, :file), :close),
              s(:send, nil, :add_autoload,
                s(:send,
                  s(:lvar, :file), :path)),
              s(:kwbegin,
                s(:ensure,
                  s(:send, nil, :assert,
                    s(:const,
                      s(:const, nil, :Object), :AutoloadTest)),
                  s(:send, nil, :remove_autoload_constant))),
              s(:send, nil, :assert_equal,
                s(:array,
                  s(:send,
                    s(:lvar, :file), :path)),
                s(:lvar, :called_with)))))),
      s(:def, :test_autoload_while_autoloading,
        s(:args),
        s(:block,
          s(:send, nil, :ruby_impl_require),
          s(:args,
            s(:arg, :called_with)),
          s(:block,
            s(:send,
              s(:const, nil, :Tempfile), :create,
              s(:array,
                s(:str, "a"),
                s(:str, ".rb"))),
            s(:args,
              s(:arg, :a)),
            s(:block,
              s(:send,
                s(:const, nil, :Tempfile), :create,
                s(:array,
                  s(:str, "b"),
                  s(:str, ".rb"))),
              s(:args,
                s(:arg, :b)),
              s(:begin,
                s(:send,
                  s(:lvar, :a), :puts,
                  s(:dstr,
                    s(:str, "require '"),
                    s(:begin,
                      s(:send,
                        s(:lvar, :b), :path)),
                    s(:str, "'; class AutoloadTest; end"))),
                s(:send,
                  s(:lvar, :b), :puts,
                  s(:str, "class AutoloadTest; module B; end; end")),
                s(:send,
                  s(:array,
                    s(:lvar, :a),
                    s(:lvar, :b)), :each,
                  s(:block_pass,
                    s(:sym, :flush))),
                s(:send, nil, :add_autoload,
                  s(:send,
                    s(:lvar, :a), :path)),
                s(:kwbegin,
                  s(:ensure,
                    s(:send, nil, :assert,
                      s(:const,
                        s(:const, nil, :Object), :AutoloadTest)),
                    s(:send, nil, :remove_autoload_constant))),
                s(:send, nil, :assert_equal,
                  s(:array,
                    s(:send,
                      s(:lvar, :a), :path),
                    s(:send,
                      s(:lvar, :b), :path)),
                  s(:lvar, :called_with))))))),
      s(:def, :add_autoload,
        s(:args,
          s(:arg, :path)),
        s(:begin,
          s(:send,
            s(:begin,
              s(:or_asgn,
                s(:ivasgn, :@autoload_paths),
                s(:array))), :<<,
            s(:lvar, :path)),
          s(:block,
            s(:send,
              s(:const,
                s(:cbase), :Object), :class_eval),
            s(:args),
            s(:send, nil, :autoload,
              s(:sym, :AutoloadTest),
              s(:lvar, :path))))),
      s(:def, :remove_autoload_constant,
        s(:args),
        s(:begin,
          s(:send,
            s(:gvar, :$"), :replace,
            s(:send,
              s(:gvar, :$"), :-,
              s(:ivar, :@autoload_paths))),
          s(:block,
            s(:send,
              s(:const,
                s(:cbase), :Object), :class_eval),
            s(:args),
            s(:send, nil, :remove_const,
              s(:sym, :AutoloadTest))))))))
