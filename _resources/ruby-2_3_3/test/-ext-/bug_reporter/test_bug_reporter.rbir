s(:begin,
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:send, nil, :require,
    s(:str, "tmpdir")),
  s(:class,
    s(:const, nil, :TestBugReporter),
    s(:const,
      s(:const,
        s(:const, nil, :Test), :Unit), :TestCase),
    s(:def, :test_bug_reporter_add,
      s(:args),
      s(:ensure,
        s(:begin,
          s(:lvasgn, :expected_stderr,
            s(:array,
              s(:sym, :*),
              s(:regexp,
                s(:str, "\\[BUG\\]\\sSegmentation\\sfault.*\\n"),
                s(:regopt)),
              s(:regexp,
                s(:begin,
                  s(:send,
                    s(:const, nil, :Regexp), :quote,
                    s(:const, nil, :RUBY_DESCRIPTION))),
                s(:str, "\\n\\n"),
                s(:regopt)),
              s(:sym, :*),
              s(:regexp,
                s(:str, "Sample bug reporter: 12345"),
                s(:regopt)),
              s(:sym, :*))),
          s(:lvasgn, :tmpdir,
            s(:send,
              s(:const, nil, :Dir), :mktmpdir)),
          s(:lvasgn, :args,
            s(:array,
              s(:str, "--disable-gems"),
              s(:str, "-r-test-/bug_reporter/bug_reporter"),
              s(:str, "-C"),
              s(:lvar, :tmpdir))),
          s(:lvasgn, :stdin,
            s(:str, "register_sample_bug_reporter(12345); Process.kill :SEGV, $$")),
          s(:send, nil, :assert_in_out_err,
            s(:lvar, :args),
            s(:lvar, :stdin),
            s(:array),
            s(:lvar, :expected_stderr),
            s(:hash,
              s(:pair,
                s(:sym, :encoding),
                s(:str, "ASCII-8BIT"))))),
        s(:if,
          s(:lvar, :tmpdir),
          s(:send,
            s(:const, nil, :FileUtils), :rm_rf,
            s(:lvar, :tmpdir)), nil)))))
