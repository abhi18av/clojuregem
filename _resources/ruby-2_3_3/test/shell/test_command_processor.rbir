s(:begin,
  s(:send, nil, :require,
    s(:str, "shell")),
  s(:send, nil, :require,
    s(:str, "tmpdir")),
  s(:class,
    s(:const, nil, :TestShell),
    s(:const,
      s(:const,
        s(:const, nil, :Test), :Unit), :TestCase), nil),
  s(:class,
    s(:const,
      s(:const, nil, :TestShell), :CommandProcessor),
    s(:const,
      s(:const,
        s(:const, nil, :Test), :Unit), :TestCase),
    s(:begin,
      s(:def, :setup,
        s(:args),
        s(:begin,
          s(:ivasgn, :@tmpdir,
            s(:send,
              s(:const, nil, :Dir), :mktmpdir,
              s(:str, "test_shell"))),
          s(:ivasgn, :@shell,
            s(:send,
              s(:const, nil, :Shell), :new)),
          s(:send,
            s(:ivar, :@shell), :system_path=,
            s(:array,
              s(:ivar, :@tmpdir))))),
      s(:def, :teardown,
        s(:args),
        s(:send,
          s(:const, nil, :Dir), :rmdir,
          s(:ivar, :@tmpdir))),
      s(:def, :catch_command_start,
        s(:args,
          s(:optarg, :tc,
            s(:send,
              s(:const, nil, :Object), :new))),
        s(:begin,
          s(:block,
            s(:send,
              s(:send,
                s(:send,
                  s(:ivar, :@shell), :process_controller), :singleton_class), :class_eval),
            s(:args),
            s(:block,
              s(:send, nil, :define_method,
                s(:sym, :add_schedule)),
              s(:args,
                s(:arg, :cmd)),
              s(:send, nil, :throw,
                s(:lvar, :tc),
                s(:lvar, :cmd)))),
          s(:lvar, :tc))),
      s(:def, :exeext,
        s(:args),
        s(:send,
          s(:send,
            s(:const,
              s(:const, nil, :RbConfig), :CONFIG), :[],
            s(:str, "EXECUTABLE_EXTS")), :[],
          s(:regexp,
            s(:str, "\\S+\\z"),
            s(:regopt)))),
      s(:def, :test_system_external,
        s(:args),
        s(:ensure,
          s(:begin,
            s(:lvasgn, :name,
              s(:dstr,
                s(:str, "foo"),
                s(:begin,
                  s(:send, nil, :exeext)))),
            s(:lvasgn, :path,
              s(:send,
                s(:const, nil, :File), :join,
                s(:ivar, :@tmpdir),
                s(:lvar, :name))),
            s(:block,
              s(:send, nil, :open,
                s(:lvar, :path),
                s(:str, "w"),
                s(:int, 493)),
              s(:args), nil),
            s(:lvasgn, :cmd,
              s(:block,
                s(:send, nil, :assert_throw,
                  s(:send, nil, :catch_command_start)),
                s(:args),
                s(:send,
                  s(:ivar, :@shell), :system,
                  s(:lvar, :name)))),
            s(:send, nil, :assert_equal,
              s(:lvar, :path),
              s(:send,
                s(:lvar, :cmd), :command))),
          s(:send,
            s(:const, nil, :File), :unlink,
            s(:lvar, :path)))),
      s(:def, :test_system_not_found,
        s(:args),
        s(:ensure,
          s(:begin,
            s(:lvasgn, :bug8918,
              s(:str, "[ruby-core:57235] [Bug #8918]")),
            s(:lvasgn, :name,
              s(:str, "foo")),
            s(:lvasgn, :path,
              s(:send,
                s(:const, nil, :File), :join,
                s(:ivar, :@tmpdir),
                s(:lvar, :name))),
            s(:block,
              s(:send, nil, :open,
                s(:lvar, :path),
                s(:str, "w"),
                s(:int, 420)),
              s(:args), nil),
            s(:block,
              s(:send, nil, :assert_raise,
                s(:const,
                  s(:const,
                    s(:const, nil, :Shell), :Error), :CommandNotFound),
                s(:lvar, :bug8918)),
              s(:args),
              s(:block,
                s(:send, nil, :catch,
                  s(:send, nil, :catch_command_start)),
                s(:args),
                s(:send,
                  s(:ivar, :@shell), :system,
                  s(:lvar, :name))))),
          s(:begin,
            s(:send,
              s(:const, nil, :Process), :waitall),
            s(:send,
              s(:const, nil, :File), :unlink,
              s(:lvar, :path))))),
      s(:def, :test_system_directory,
        s(:args),
        s(:ensure,
          s(:begin,
            s(:lvasgn, :bug8918,
              s(:str, "[ruby-core:57235] [Bug #8918]")),
            s(:lvasgn, :name,
              s(:dstr,
                s(:str, "foo"),
                s(:begin,
                  s(:send, nil, :exeext)))),
            s(:lvasgn, :path,
              s(:send,
                s(:const, nil, :File), :join,
                s(:ivar, :@tmpdir),
                s(:lvar, :name))),
            s(:send,
              s(:const, nil, :Dir), :mkdir,
              s(:lvar, :path)),
            s(:block,
              s(:send, nil, :assert_raise,
                s(:const,
                  s(:const,
                    s(:const, nil, :Shell), :Error), :CommandNotFound),
                s(:lvar, :bug8918)),
              s(:args),
              s(:block,
                s(:send, nil, :catch,
                  s(:send, nil, :catch_command_start)),
                s(:args),
                s(:send,
                  s(:ivar, :@shell), :system,
                  s(:lvar, :name))))),
          s(:begin,
            s(:send,
              s(:const, nil, :Process), :waitall),
            s(:send,
              s(:const, nil, :Dir), :rmdir,
              s(:lvar, :path))))))))
