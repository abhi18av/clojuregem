s(:begin,
  s(:send, nil, :require_relative,
    s(:str, "base")),
  s(:class,
    s(:const, nil, :TestMkmf), nil,
    s(:class,
      s(:const, nil, :TestConvertible),
      s(:const, nil, :TestMkmf),
      s(:begin,
        s(:def, :test_typeof_builtin,
          s(:args),
          s(:block,
            s(:send,
              s(:array,
                s(:str, ""),
                s(:array,
                  s(:str, "signed "),
                  s(:str, "")),
                s(:str, "unsigned ")), :each),
            s(:args,
              s(:arg, :signed),
              s(:arg, :prefix)),
            s(:block,
              s(:send,
                s(:array,
                  s(:str, "short"),
                  s(:str, "int"),
                  s(:str, "long")), :each),
              s(:args,
                s(:arg, :type)),
              s(:send, nil, :assert_equal,
                s(:send,
                  s(:begin,
                    s(:or,
                      s(:lvar, :prefix),
                      s(:lvar, :signed))), :+,
                  s(:lvar, :type)),
                s(:block,
                  s(:send, nil, :mkmf),
                  s(:args),
                  s(:send, nil, :convertible_int,
                    s(:send,
                      s(:lvar, :signed), :+,
                      s(:lvar, :type)))),
                s(:const, nil, :MKMFLOG))))),
        s(:def, :test_typeof_typedef,
          s(:args),
          s(:ensure,
            s(:block,
              s(:send,
                s(:array,
                  s(:str, ""),
                  s(:array,
                    s(:str, "signed "),
                    s(:str, "")),
                  s(:str, "unsigned ")), :each),
              s(:args,
                s(:arg, :signed),
                s(:arg, :prefix)),
              s(:block,
                s(:send,
                  s(:array,
                    s(:str, "short"),
                    s(:str, "int"),
                    s(:str, "long")), :each),
                s(:args,
                  s(:arg, :type)),
                s(:begin,
                  s(:block,
                    s(:send, nil, :open,
                      s(:str, "confdefs.h"),
                      s(:str, "w")),
                    s(:args,
                      s(:arg, :f)),
                    s(:send,
                      s(:lvar, :f), :puts,
                      s(:dstr,
                        s(:str, "typedef "),
                        s(:begin,
                          s(:lvar, :signed)),
                        s(:begin,
                          s(:lvar, :type)),
                        s(:str, " test1_t;")))),
                  s(:send,
                    s(:gvar, :$defs), :clear),
                  s(:send, nil, :assert_equal,
                    s(:send,
                      s(:begin,
                        s(:or,
                          s(:lvar, :prefix),
                          s(:lvar, :signed))), :+,
                      s(:lvar, :type)),
                    s(:block,
                      s(:send, nil, :mkmf),
                      s(:args),
                      s(:send, nil, :convertible_int,
                        s(:str, "test1_t"),
                        s(:str, "confdefs.h"))),
                    s(:const, nil, :MKMFLOG)),
                  s(:and,
                    s(:begin,
                      s(:lvasgn, :u,
                        s(:send,
                          s(:lvar, :signed), :[],
                          s(:regexp,
                            s(:str, "^u"),
                            s(:regopt))))),
                    s(:send,
                      s(:lvar, :u), :upcase!)),
                  s(:send, nil, :assert_include,
                    s(:gvar, :$defs),
                    s(:send,
                      s(:str, "-DTYPEOF_TEST1_T="), :+,
                      s(:send,
                        s(:dstr,
                          s(:begin,
                            s(:or,
                              s(:lvar, :prefix),
                              s(:lvar, :signed))),
                          s(:begin,
                            s(:lvar, :type))), :quote))),
                  s(:send, nil, :assert_include,
                    s(:gvar, :$defs),
                    s(:dstr,
                      s(:str, "-DPRI_TEST1T_PREFIX=PRI_"),
                      s(:begin,
                        s(:send,
                          s(:lvar, :type), :upcase)),
                      s(:str, "_PREFIX"))),
                  s(:send, nil, :assert_include,
                    s(:gvar, :$defs),
                    s(:dstr,
                      s(:str, "-DTEST1T2NUM="),
                      s(:begin,
                        s(:lvar, :u)),
                      s(:begin,
                        s(:send,
                          s(:lvar, :type), :upcase)),
                      s(:str, "2NUM"))),
                  s(:send, nil, :assert_include,
                    s(:gvar, :$defs),
                    s(:dstr,
                      s(:str, "-DNUM2TEST1T=NUM2"),
                      s(:begin,
                        s(:lvar, :u)),
                      s(:begin,
                        s(:send,
                          s(:lvar, :type), :upcase))))))),
            s(:send,
              s(:const, nil, :File), :unlink,
              s(:str, "confdefs.h"))))))))
