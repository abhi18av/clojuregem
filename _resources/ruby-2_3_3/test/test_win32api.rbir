s(:begin,
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:kwbegin,
    s(:rescue,
      s(:send, nil, :require,
        s(:str, "Win32API")),
      s(:resbody,
        s(:array,
          s(:const, nil, :LoadError)), nil, nil), nil)),
  s(:if,
    s(:defined?,
      s(:const, nil, :Win32API)),
    s(:class,
      s(:const, nil, :TestWin32API),
      s(:const,
        s(:const,
          s(:const, nil, :Test), :Unit), :TestCase),
      s(:begin,
        s(:def, :test_params_string,
          s(:args),
          s(:begin,
            s(:lvasgn, :m2w,
              s(:send,
                s(:const, nil, :Win32API), :new,
                s(:str, "kernel32"),
                s(:str, "MultiByteToWideChar"),
                s(:str, "ilpipi"),
                s(:str, "i"))),
            s(:lvasgn, :str,
              s(:send,
                s(:str, "utf-8 string"), :encode,
                s(:str, "utf-8"))),
            s(:lvasgn, :buf,
              s(:send,
                s(:str, "\u0000"), :*,
                s(:begin,
                  s(:send,
                    s(:send,
                      s(:lvar, :str), :size), :*,
                    s(:int, 2))))),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:lvar, :str), :size),
              s(:send,
                s(:lvar, :m2w), :call,
                s(:int, 65001),
                s(:int, 0),
                s(:lvar, :str),
                s(:send,
                  s(:lvar, :str), :bytesize),
                s(:lvar, :buf),
                s(:send,
                  s(:lvar, :str), :size))),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:lvar, :str), :encode,
                s(:str, "utf-16le")),
              s(:send,
                s(:lvar, :buf), :force_encoding,
                s(:str, "utf-16le"))))),
        s(:def, :test_params_array,
          s(:args),
          s(:begin,
            s(:lvasgn, :m2w,
              s(:send,
                s(:const, nil, :Win32API), :new,
                s(:str, "kernel32"),
                s(:str, "MultiByteToWideChar"),
                s(:array,
                  s(:str, "i"),
                  s(:str, "l"),
                  s(:str, "p"),
                  s(:str, "i"),
                  s(:str, "p"),
                  s(:str, "i")),
                s(:str, "i"))),
            s(:lvasgn, :str,
              s(:send,
                s(:str, "utf-8 string"), :encode,
                s(:str, "utf-8"))),
            s(:lvasgn, :buf,
              s(:send,
                s(:str, "\u0000"), :*,
                s(:begin,
                  s(:send,
                    s(:send,
                      s(:lvar, :str), :size), :*,
                    s(:int, 2))))),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:lvar, :str), :size),
              s(:send,
                s(:lvar, :m2w), :call,
                s(:int, 65001),
                s(:int, 0),
                s(:lvar, :str),
                s(:send,
                  s(:lvar, :str), :bytesize),
                s(:lvar, :buf),
                s(:send,
                  s(:lvar, :str), :size))),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:lvar, :str), :encode,
                s(:str, "utf-16le")),
              s(:send,
                s(:lvar, :buf), :force_encoding,
                s(:str, "utf-16le"))))))), nil))
