s(:begin,
  s(:send, nil, :require_relative,
    s(:str, "utils")),
  s(:if,
    s(:defined?,
      s(:const,
        s(:const, nil, :OpenSSL), :TestUtils)),
    s(:class,
      s(:const,
        s(:const, nil, :OpenSSL), :TestDigest),
      s(:const,
        s(:const,
          s(:const, nil, :Test), :Unit), :TestCase),
      s(:begin,
        s(:def, :setup,
          s(:args),
          s(:begin,
            s(:ivasgn, :@d1,
              s(:send,
                s(:const,
                  s(:const, nil, :OpenSSL), :Digest), :new,
                s(:str, "MD5"))),
            s(:ivasgn, :@d2,
              s(:send,
                s(:const,
                  s(:const,
                    s(:const, nil, :OpenSSL), :Digest), :MD5), :new)),
            s(:ivasgn, :@md,
              s(:send,
                s(:const,
                  s(:const, nil, :Digest), :MD5), :new)),
            s(:ivasgn, :@data,
              s(:str, "DATA")))),
        s(:def, :teardown,
          s(:args),
          s(:ivasgn, :@d1,
            s(:ivasgn, :@d2,
              s(:ivasgn, :@md,
                s(:nil))))),
        s(:def, :test_digest,
          s(:args),
          s(:begin,
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@md), :digest),
              s(:send,
                s(:ivar, :@d1), :digest)),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@md), :hexdigest),
              s(:send,
                s(:ivar, :@d1), :hexdigest)),
            s(:send,
              s(:ivar, :@d1), :<<,
              s(:ivar, :@data)),
            s(:send,
              s(:ivar, :@d2), :<<,
              s(:ivar, :@data)),
            s(:send,
              s(:ivar, :@md), :<<,
              s(:ivar, :@data)),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@md), :digest),
              s(:send,
                s(:ivar, :@d1), :digest)),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@md), :hexdigest),
              s(:send,
                s(:ivar, :@d1), :hexdigest)),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@d1), :digest),
              s(:send,
                s(:ivar, :@d2), :digest)),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@d1), :hexdigest),
              s(:send,
                s(:ivar, :@d2), :hexdigest)),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@md), :digest),
              s(:send,
                s(:const,
                  s(:const,
                    s(:const, nil, :OpenSSL), :Digest), :MD5), :digest,
                s(:ivar, :@data))),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@md), :hexdigest),
              s(:send,
                s(:const,
                  s(:const,
                    s(:const, nil, :OpenSSL), :Digest), :MD5), :hexdigest,
                s(:ivar, :@data))))),
        s(:def, :test_eql,
          s(:args),
          s(:begin,
            s(:send, nil, :assert,
              s(:send,
                s(:ivar, :@d1), :==,
                s(:ivar, :@d2)),
              s(:str, "==")),
            s(:lvasgn, :d,
              s(:send,
                s(:ivar, :@d1), :clone)),
            s(:send, nil, :assert,
              s(:send,
                s(:lvar, :d), :==,
                s(:ivar, :@d1)),
              s(:str, "clone")))),
        s(:def, :test_info,
          s(:args),
          s(:begin,
            s(:send, nil, :assert_equal,
              s(:str, "MD5"),
              s(:send,
                s(:ivar, :@d1), :name),
              s(:str, "name")),
            s(:send, nil, :assert_equal,
              s(:str, "MD5"),
              s(:send,
                s(:ivar, :@d2), :name),
              s(:str, "name")),
            s(:send, nil, :assert_equal,
              s(:int, 16),
              s(:send,
                s(:ivar, :@d1), :size),
              s(:str, "size")))),
        s(:def, :test_dup,
          s(:args),
          s(:begin,
            s(:send,
              s(:ivar, :@d1), :update,
              s(:ivar, :@data)),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@d1), :name),
              s(:send,
                s(:send,
                  s(:ivar, :@d1), :dup), :name),
              s(:str, "dup")),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@d1), :name),
              s(:send,
                s(:send,
                  s(:ivar, :@d1), :clone), :name),
              s(:str, "clone")),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:ivar, :@d1), :digest),
              s(:send,
                s(:send,
                  s(:ivar, :@d1), :clone), :digest),
              s(:str, "clone .digest")))),
        s(:def, :test_reset,
          s(:args),
          s(:begin,
            s(:send,
              s(:ivar, :@d1), :update,
              s(:ivar, :@data)),
            s(:lvasgn, :dig1,
              s(:send,
                s(:ivar, :@d1), :digest)),
            s(:send,
              s(:ivar, :@d1), :reset),
            s(:send,
              s(:ivar, :@d1), :update,
              s(:ivar, :@data)),
            s(:lvasgn, :dig2,
              s(:send,
                s(:ivar, :@d1), :digest)),
            s(:send, nil, :assert_equal,
              s(:lvar, :dig1),
              s(:lvar, :dig2),
              s(:str, "reset")))),
        s(:def, :test_digest_constants,
          s(:args),
          s(:begin,
            s(:lvasgn, :algs,
              s(:array,
                s(:str, "DSS1"),
                s(:str, "MD4"),
                s(:str, "MD5"),
                s(:str, "RIPEMD160"),
                s(:str, "SHA1"))),
            s(:if,
              s(:or,
                s(:send,
                  s(:send, nil, :libressl?), :!),
                s(:send,
                  s(:send, nil, :version_since,
                    s(:array,
                      s(:int, 2),
                      s(:int, 3))), :!)),
              s(:op_asgn,
                s(:lvasgn, :algs), :+,
                s(:array,
                  s(:str, "SHA"))), nil),
            s(:if,
              s(:send,
                s(:const,
                  s(:const, nil, :OpenSSL), :OPENSSL_VERSION_NUMBER), :>,
                s(:int, 9469952)),
              s(:op_asgn,
                s(:lvasgn, :algs), :+,
                s(:array,
                  s(:str, "SHA224"),
                  s(:str, "SHA256"),
                  s(:str, "SHA384"),
                  s(:str, "SHA512"))), nil),
            s(:block,
              s(:send,
                s(:lvar, :algs), :each),
              s(:args,
                s(:arg, :alg)),
              s(:begin,
                s(:send, nil, :assert_not_nil,
                  s(:send,
                    s(:const,
                      s(:const, nil, :OpenSSL), :Digest), :new,
                    s(:lvar, :alg))),
                s(:lvasgn, :klass,
                  s(:send,
                    s(:const,
                      s(:const, nil, :OpenSSL), :Digest), :const_get,
                    s(:lvar, :alg))),
                s(:send, nil, :assert_not_nil,
                  s(:send,
                    s(:lvar, :klass), :new)))))),
        s(:def, :test_digest_by_oid_and_name,
          s(:args),
          s(:begin,
            s(:send, nil, :check_digest,
              s(:send,
                s(:const,
                  s(:const,
                    s(:const, nil, :OpenSSL), :ASN1), :ObjectId), :new,
                s(:str, "MD5"))),
            s(:send, nil, :check_digest,
              s(:send,
                s(:const,
                  s(:const,
                    s(:const, nil, :OpenSSL), :ASN1), :ObjectId), :new,
                s(:str, "SHA1"))))),
        s(:if,
          s(:send,
            s(:const,
              s(:const, nil, :OpenSSL), :OPENSSL_VERSION_NUMBER), :>,
            s(:int, 9469952)),
          s(:begin,
            s(:def, :encode16,
              s(:args,
                s(:arg, :str)),
              s(:send,
                s(:send,
                  s(:lvar, :str), :unpack,
                  s(:str, "H*")), :first)),
            s(:def, :test_098_features,
              s(:args),
              s(:begin,
                s(:lvasgn, :sha224_a,
                  s(:str, "abd37534c7d9a2efb9465de931cd7055ffdb8879563ae98078d6d6d5")),
                s(:lvasgn, :sha256_a,
                  s(:str, "ca978112ca1bbdcafac231b39a23dc4da786eff8147c4e72b9807785afee48bb")),
                s(:lvasgn, :sha384_a,
                  s(:str, "54a59b9f22b0b80880d8427e548b7c23abd873486e1f035dce9cd697e85175033caa88e6d57bc35efae0b5afd3145f31")),
                s(:lvasgn, :sha512_a,
                  s(:str, "1f40fc92da241694750979ee6cf582f2d5d7d28e18335de05abc54d0560e0f5302860c652bf08d560252aa5e74210546f369fbbbce8c12cfc7957b2652fe9a75")),
                s(:send, nil, :assert_equal,
                  s(:lvar, :sha224_a),
                  s(:send,
                    s(:const,
                      s(:const,
                        s(:const, nil, :OpenSSL), :Digest), :SHA224), :hexdigest,
                    s(:str, "a"))),
                s(:send, nil, :assert_equal,
                  s(:lvar, :sha256_a),
                  s(:send,
                    s(:const,
                      s(:const,
                        s(:const, nil, :OpenSSL), :Digest), :SHA256), :hexdigest,
                    s(:str, "a"))),
                s(:send, nil, :assert_equal,
                  s(:lvar, :sha384_a),
                  s(:send,
                    s(:const,
                      s(:const,
                        s(:const, nil, :OpenSSL), :Digest), :SHA384), :hexdigest,
                    s(:str, "a"))),
                s(:send, nil, :assert_equal,
                  s(:lvar, :sha512_a),
                  s(:send,
                    s(:const,
                      s(:const,
                        s(:const, nil, :OpenSSL), :Digest), :SHA512), :hexdigest,
                    s(:str, "a"))),
                s(:send, nil, :assert_equal,
                  s(:lvar, :sha224_a),
                  s(:send, nil, :encode16,
                    s(:send,
                      s(:const,
                        s(:const,
                          s(:const, nil, :OpenSSL), :Digest), :SHA224), :digest,
                      s(:str, "a")))),
                s(:send, nil, :assert_equal,
                  s(:lvar, :sha256_a),
                  s(:send, nil, :encode16,
                    s(:send,
                      s(:const,
                        s(:const,
                          s(:const, nil, :OpenSSL), :Digest), :SHA256), :digest,
                      s(:str, "a")))),
                s(:send, nil, :assert_equal,
                  s(:lvar, :sha384_a),
                  s(:send, nil, :encode16,
                    s(:send,
                      s(:const,
                        s(:const,
                          s(:const, nil, :OpenSSL), :Digest), :SHA384), :digest,
                      s(:str, "a")))),
                s(:send, nil, :assert_equal,
                  s(:lvar, :sha512_a),
                  s(:send, nil, :encode16,
                    s(:send,
                      s(:const,
                        s(:const,
                          s(:const, nil, :OpenSSL), :Digest), :SHA512), :digest,
                      s(:str, "a")))))),
            s(:def, :test_digest_by_oid_and_name_sha2,
              s(:args),
              s(:begin,
                s(:send, nil, :check_digest,
                  s(:send,
                    s(:const,
                      s(:const,
                        s(:const, nil, :OpenSSL), :ASN1), :ObjectId), :new,
                    s(:str, "SHA224"))),
                s(:send, nil, :check_digest,
                  s(:send,
                    s(:const,
                      s(:const,
                        s(:const, nil, :OpenSSL), :ASN1), :ObjectId), :new,
                    s(:str, "SHA256"))),
                s(:send, nil, :check_digest,
                  s(:send,
                    s(:const,
                      s(:const,
                        s(:const, nil, :OpenSSL), :ASN1), :ObjectId), :new,
                    s(:str, "SHA384"))),
                s(:send, nil, :check_digest,
                  s(:send,
                    s(:const,
                      s(:const,
                        s(:const, nil, :OpenSSL), :ASN1), :ObjectId), :new,
                    s(:str, "SHA512")))))), nil),
        s(:def, :test_openssl_digest,
          s(:args),
          s(:begin,
            s(:send, nil, :assert_equal,
              s(:const,
                s(:const,
                  s(:const, nil, :OpenSSL), :Digest), :MD5),
              s(:send,
                s(:const, nil, :OpenSSL), :Digest,
                s(:str, "MD5"))),
            s(:block,
              s(:send, nil, :assert_raise,
                s(:const, nil, :NameError)),
              s(:args),
              s(:send,
                s(:const, nil, :OpenSSL), :Digest,
                s(:str, "no such digest"))))),
        s(:send, nil, :private),
        s(:def, :check_digest,
          s(:args,
            s(:arg, :oid)),
          s(:begin,
            s(:lvasgn, :d,
              s(:send,
                s(:const,
                  s(:const, nil, :OpenSSL), :Digest), :new,
                s(:send,
                  s(:lvar, :oid), :sn))),
            s(:send, nil, :assert_not_nil,
              s(:lvar, :d)),
            s(:lvasgn, :d,
              s(:send,
                s(:const,
                  s(:const, nil, :OpenSSL), :Digest), :new,
                s(:send,
                  s(:lvar, :oid), :ln))),
            s(:send, nil, :assert_not_nil,
              s(:lvar, :d)),
            s(:lvasgn, :d,
              s(:send,
                s(:const,
                  s(:const, nil, :OpenSSL), :Digest), :new,
                s(:send,
                  s(:lvar, :oid), :oid))),
            s(:send, nil, :assert_not_nil,
              s(:lvar, :d)))),
        s(:def, :libressl?,
          s(:args),
          s(:send,
            s(:const,
              s(:const, nil, :OpenSSL), :OPENSSL_VERSION), :include?,
            s(:str, "LibreSSL"))),
        s(:def, :version_since,
          s(:args,
            s(:arg, :verary)),
          s(:send,
            s(:begin,
              s(:send,
                s(:send,
                  s(:send,
                    s(:const,
                      s(:const, nil, :OpenSSL), :OPENSSL_LIBRARY_VERSION), :scan,
                    s(:regexp,
                      s(:str, "\\d+"),
                      s(:regopt))), :map,
                  s(:block_pass,
                    s(:sym, :to_i))), :<=>,
                s(:lvar, :verary))), :!=,
            s(:int, -1))))), nil))
