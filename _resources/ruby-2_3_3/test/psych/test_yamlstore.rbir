s(:begin,
  s(:send, nil, :require_relative,
    s(:str, "helper")),
  s(:send, nil, :require,
    s(:str, "yaml/store")),
  s(:send, nil, :require,
    s(:str, "tmpdir")),
  s(:if,
    s(:defined?,
      s(:const, nil, :Psych)),
    s(:module,
      s(:const, nil, :Psych),
      s(:begin,
        s(:if,
          s(:defined?,
            s(:const,
              s(:const, nil, :Psych), :Store)), nil,
          s(:casgn,
            s(:const, nil, :Psych), :Store,
            s(:const,
              s(:const, nil, :YAML), :Store))),
        s(:class,
          s(:const, nil, :YAMLStoreTest),
          s(:const, nil, :TestCase),
          s(:begin,
            s(:def, :setup,
              s(:args),
              s(:begin,
                s(:ivasgn, :@dir,
                  s(:send,
                    s(:const, nil, :Dir), :mktmpdir,
                    s(:str, "rubytest-file"))),
                s(:send,
                  s(:const, nil, :File), :chown,
                  s(:int, -1),
                  s(:send,
                    s(:const, nil, :Process), :gid),
                  s(:ivar, :@dir)),
                s(:ivasgn, :@yamlstore_file,
                  s(:send, nil, :make_tmp_filename,
                    s(:str, "yamlstore"))),
                s(:ivasgn, :@yamlstore,
                  s(:send,
                    s(:const,
                      s(:const, nil, :YAML), :Store), :new,
                    s(:ivar, :@yamlstore_file))))),
            s(:def, :teardown,
              s(:args),
              s(:send,
                s(:const, nil, :FileUtils), :remove_entry_secure,
                s(:ivar, :@dir))),
            s(:def, :make_tmp_filename,
              s(:args,
                s(:arg, :prefix)),
              s(:send,
                s(:send,
                  s(:send,
                    s(:send,
                      s(:ivar, :@dir), :+,
                      s(:str, "/")), :+,
                    s(:lvar, :prefix)), :+,
                  s(:send,
                    s(:const, nil, :File), :basename,
                    s(:str, "(string)"))), :+,
                s(:dstr,
                  s(:str, "."),
                  s(:begin,
                    s(:gvar, :$$)),
                  s(:str, ".test")))),
            s(:def, :test_opening_new_file_in_readonly_mode_should_result_in_empty_values,
              s(:args),
              s(:block,
                s(:send,
                  s(:ivar, :@yamlstore), :transaction,
                  s(:true)),
                s(:args),
                s(:begin,
                  s(:send, nil, :assert_nil,
                    s(:send,
                      s(:ivar, :@yamlstore), :[],
                      s(:sym, :foo))),
                  s(:send, nil, :assert_nil,
                    s(:send,
                      s(:ivar, :@yamlstore), :[],
                      s(:sym, :bar)))))),
            s(:def, :test_opening_new_file_in_readwrite_mode_should_result_in_empty_values,
              s(:args),
              s(:block,
                s(:send,
                  s(:ivar, :@yamlstore), :transaction),
                s(:args),
                s(:begin,
                  s(:send, nil, :assert_nil,
                    s(:send,
                      s(:ivar, :@yamlstore), :[],
                      s(:sym, :foo))),
                  s(:send, nil, :assert_nil,
                    s(:send,
                      s(:ivar, :@yamlstore), :[],
                      s(:sym, :bar)))))),
            s(:def, :test_data_should_be_loaded_correctly_when_in_readonly_mode,
              s(:args),
              s(:begin,
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction),
                  s(:args),
                  s(:send,
                    s(:ivar, :@yamlstore), :[]=,
                    s(:sym, :foo),
                    s(:str, "bar"))),
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction,
                    s(:true)),
                  s(:args),
                  s(:send, nil, :assert_equal,
                    s(:str, "bar"),
                    s(:send,
                      s(:ivar, :@yamlstore), :[],
                      s(:sym, :foo)))))),
            s(:def, :test_data_should_be_loaded_correctly_when_in_readwrite_mode,
              s(:args),
              s(:begin,
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction),
                  s(:args),
                  s(:send,
                    s(:ivar, :@yamlstore), :[]=,
                    s(:sym, :foo),
                    s(:str, "bar"))),
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction),
                  s(:args),
                  s(:send, nil, :assert_equal,
                    s(:str, "bar"),
                    s(:send,
                      s(:ivar, :@yamlstore), :[],
                      s(:sym, :foo)))))),
            s(:def, :test_changes_after_commit_are_discarded,
              s(:args),
              s(:begin,
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction),
                  s(:args),
                  s(:begin,
                    s(:send,
                      s(:ivar, :@yamlstore), :[]=,
                      s(:sym, :foo),
                      s(:str, "bar")),
                    s(:send,
                      s(:ivar, :@yamlstore), :commit),
                    s(:send,
                      s(:ivar, :@yamlstore), :[]=,
                      s(:sym, :foo),
                      s(:str, "baz")))),
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction,
                    s(:true)),
                  s(:args),
                  s(:send, nil, :assert_equal,
                    s(:str, "bar"),
                    s(:send,
                      s(:ivar, :@yamlstore), :[],
                      s(:sym, :foo)))))),
            s(:def, :test_changes_are_not_written_on_abort,
              s(:args),
              s(:begin,
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction),
                  s(:args),
                  s(:begin,
                    s(:send,
                      s(:ivar, :@yamlstore), :[]=,
                      s(:sym, :foo),
                      s(:str, "bar")),
                    s(:send,
                      s(:ivar, :@yamlstore), :abort))),
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction,
                    s(:true)),
                  s(:args),
                  s(:send, nil, :assert_nil,
                    s(:send,
                      s(:ivar, :@yamlstore), :[],
                      s(:sym, :foo)))))),
            s(:def, :test_writing_inside_readonly_transaction_raises_error,
              s(:args),
              s(:block,
                s(:send, nil, :assert_raises,
                  s(:const,
                    s(:const, nil, :PStore), :Error)),
                s(:args),
                s(:block,
                  s(:send,
                    s(:ivar, :@yamlstore), :transaction,
                    s(:true)),
                  s(:args),
                  s(:send,
                    s(:ivar, :@yamlstore), :[]=,
                    s(:sym, :foo),
                    s(:str, "bar"))))))))), nil))
