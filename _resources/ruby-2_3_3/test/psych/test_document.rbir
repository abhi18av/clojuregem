s(:begin,
  s(:send, nil, :require_relative,
    s(:str, "helper")),
  s(:module,
    s(:const, nil, :Psych),
    s(:class,
      s(:const, nil, :TestDocument),
      s(:const, nil, :TestCase),
      s(:begin,
        s(:def, :setup,
          s(:args),
          s(:begin,
            s(:zsuper),
            s(:ivasgn, :@stream,
              s(:send,
                s(:const, nil, :Psych), :parse_stream,
                s(:dstr,
                  s(:str, "%YAML 1.1\n"),
                  s(:str, "%TAG ! tag:tenderlovemaking.com,2009:\n"),
                  s(:str, "--- !fun\n")))),
            s(:ivasgn, :@doc,
              s(:send,
                s(:send,
                  s(:ivar, :@stream), :children), :first)))),
        s(:def, :test_parse_tag,
          s(:args),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:array,
                s(:str, "!"),
                s(:str, "tag:tenderlovemaking.com,2009:"))),
            s(:send,
              s(:ivar, :@doc), :tag_directives))),
        s(:def, :test_emit_tag,
          s(:args),
          s(:send, nil, :assert_match,
            s(:str, "%TAG ! tag:tenderlovemaking.com,2009:"),
            s(:send,
              s(:ivar, :@stream), :yaml))),
        s(:def, :test_emit_multitag,
          s(:args),
          s(:begin,
            s(:send,
              s(:send,
                s(:ivar, :@doc), :tag_directives), :<<,
              s(:array,
                s(:str, "!!"),
                s(:str, "foo.com,2009:"))),
            s(:lvasgn, :yaml,
              s(:send,
                s(:ivar, :@stream), :yaml)),
            s(:send, nil, :assert_match,
              s(:str, "%TAG ! tag:tenderlovemaking.com,2009:"),
              s(:lvar, :yaml)),
            s(:send, nil, :assert_match,
              s(:str, "%TAG !! foo.com,2009:"),
              s(:lvar, :yaml)))),
        s(:def, :test_emit_bad_tag,
          s(:args),
          s(:block,
            s(:send, nil, :assert_raises,
              s(:const, nil, :RuntimeError)),
            s(:args),
            s(:begin,
              s(:send,
                s(:ivar, :@doc), :tag_directives=,
                s(:array,
                  s(:array,
                    s(:str, "!")))),
              s(:send,
                s(:ivar, :@stream), :yaml)))),
        s(:def, :test_parse_version,
          s(:args),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:int, 1),
              s(:int, 1)),
            s(:send,
              s(:ivar, :@doc), :version))),
        s(:def, :test_emit_version,
          s(:args),
          s(:send, nil, :assert_match,
            s(:str, "%YAML 1.1"),
            s(:send,
              s(:ivar, :@stream), :yaml)))))))
