s(:begin,
  s(:send, nil, :require_relative,
    s(:str, "helper")),
  s(:send, nil, :require,
    s(:str, "delegate")),
  s(:module,
    s(:const, nil, :Psych),
    s(:class,
      s(:const, nil, :TestMarshalable),
      s(:const, nil, :TestCase),
      s(:begin,
        s(:def, :test_objects_defining_marshal_dump_and_marshal_load_can_be_dumped,
          s(:args),
          s(:begin,
            s(:lvasgn, :sd,
              s(:send,
                s(:const, nil, :SimpleDelegator), :new,
                s(:int, 1))),
            s(:lvasgn, :loaded,
              s(:send,
                s(:const, nil, :Psych), :load,
                s(:send,
                  s(:const, nil, :Psych), :dump,
                  s(:lvar, :sd)))),
            s(:send, nil, :assert_instance_of,
              s(:const, nil, :SimpleDelegator),
              s(:lvar, :loaded)),
            s(:send, nil, :assert_equal,
              s(:lvar, :sd),
              s(:lvar, :loaded)))),
        s(:class,
          s(:const, nil, :PsychCustomMarshalable),
          s(:const, nil, :BasicObject),
          s(:begin,
            s(:send, nil, :attr_reader,
              s(:sym, :foo)),
            s(:def, :initialize,
              s(:args,
                s(:arg, :foo)),
              s(:ivasgn, :@foo,
                s(:lvar, :foo))),
            s(:def, :marshal_dump,
              s(:args),
              s(:array,
                s(:send, nil, :foo))),
            s(:def, :mashal_load,
              s(:args,
                s(:arg, :data)),
              s(:ivasgn, :@foo,
                s(:send,
                  s(:lvar, :data), :[],
                  s(:int, 0)))),
            s(:def, :init_with,
              s(:args,
                s(:arg, :coder)),
              s(:ivasgn, :@foo,
                s(:send,
                  s(:lvar, :coder), :[],
                  s(:str, "foo")))),
            s(:def, :encode_with,
              s(:args,
                s(:arg, :coder)),
              s(:send,
                s(:lvar, :coder), :[]=,
                s(:str, "foo"),
                s(:int, 2))),
            s(:def, :respond_to?,
              s(:args,
                s(:arg, :method)),
              s(:send,
                s(:array,
                  s(:sym, :marshal_dump),
                  s(:sym, :marshal_load),
                  s(:sym, :init_with),
                  s(:sym, :encode_with)), :include?,
                s(:lvar, :method))),
            s(:def, :class,
              s(:args),
              s(:const, nil, :PsychCustomMarshalable)))),
        s(:def, :test_init_with_takes_priority_over_marshal_methods,
          s(:args),
          s(:begin,
            s(:lvasgn, :obj,
              s(:send,
                s(:const, nil, :PsychCustomMarshalable), :new,
                s(:int, 1))),
            s(:lvasgn, :loaded,
              s(:send,
                s(:const, nil, :Psych), :load,
                s(:send,
                  s(:const, nil, :Psych), :dump,
                  s(:lvar, :obj)))),
            s(:send, nil, :assert,
              s(:send,
                s(:const, nil, :PsychCustomMarshalable), :===,
                s(:lvar, :loaded))),
            s(:send, nil, :assert_equal,
              s(:int, 2),
              s(:send,
                s(:lvar, :loaded), :foo))))))))
