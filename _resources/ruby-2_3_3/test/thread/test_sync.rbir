s(:begin,
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:send, nil, :require,
    s(:str, "sync")),
  s(:send, nil, :require,
    s(:str, "timeout")),
  s(:class,
    s(:const, nil, :SyncTest),
    s(:const,
      s(:const,
        s(:const, nil, :Test), :Unit), :TestCase),
    s(:begin,
      s(:class,
        s(:const, nil, :Tester), nil,
        s(:send, nil, :include,
          s(:const, nil, :Sync_m))),
      s(:def, :test_sync_lock_and_wakeup,
        s(:args),
        s(:ensure,
          s(:begin,
            s(:lvasgn, :tester,
              s(:send,
                s(:const, nil, :Tester), :new)),
            s(:send,
              s(:lvar, :tester), :sync_lock,
              s(:sym, :EX)),
            s(:lvasgn, :t,
              s(:block,
                s(:send,
                  s(:const, nil, :Thread), :new),
                s(:args),
                s(:send,
                  s(:lvar, :tester), :sync_lock,
                  s(:sym, :EX)))),
            s(:until,
              s(:send,
                s(:lvar, :t), :stop?),
              s(:send, nil, :sleep,
                s(:float, 0.1))),
            s(:send,
              s(:lvar, :t), :wakeup),
            s(:until,
              s(:send,
                s(:lvar, :t), :stop?),
              s(:send, nil, :sleep,
                s(:float, 0.1))),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:send,
                  s(:lvar, :tester), :sync_waiting), :uniq),
              s(:send,
                s(:lvar, :tester), :sync_waiting))),
          s(:begin,
            s(:send,
              s(:lvar, :t), :kill),
            s(:send,
              s(:lvar, :t), :join)))),
      s(:def, :test_sync_upgrade_and_wakeup,
        s(:args),
        s(:ensure,
          s(:begin,
            s(:lvasgn, :tester,
              s(:send,
                s(:const, nil, :Tester), :new)),
            s(:send,
              s(:lvar, :tester), :sync_lock,
              s(:sym, :SH)),
            s(:lvasgn, :t,
              s(:block,
                s(:send,
                  s(:const, nil, :Thread), :new),
                s(:args),
                s(:begin,
                  s(:send,
                    s(:lvar, :tester), :sync_lock,
                    s(:sym, :SH)),
                  s(:send,
                    s(:lvar, :tester), :sync_lock,
                    s(:sym, :EX))))),
            s(:until,
              s(:send,
                s(:lvar, :t), :stop?),
              s(:send, nil, :sleep,
                s(:float, 0.1))),
            s(:send,
              s(:lvar, :t), :wakeup),
            s(:until,
              s(:send,
                s(:lvar, :t), :stop?),
              s(:send, nil, :sleep,
                s(:float, 0.1))),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :tester), :sync_upgrade_waiting), :each),
              s(:args,
                s(:arg, :ary)),
              s(:send, nil, :assert,
                s(:send,
                  s(:send,
                    s(:send,
                      s(:lvar, :tester), :sync_waiting), :include?,
                    s(:send,
                      s(:lvar, :ary), :[],
                      s(:int, 0))), :!))),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:send,
                  s(:lvar, :tester), :sync_waiting), :uniq),
              s(:send,
                s(:lvar, :tester), :sync_waiting)),
            s(:send, nil, :assert_equal,
              s(:send,
                s(:lvar, :tester), :sync_waiting),
              s(:array))),
          s(:begin,
            s(:send,
              s(:lvar, :t), :kill),
            s(:send,
              s(:lvar, :t), :join)))),
      s(:def, :test_sync_lock_and_raise,
        s(:args),
        s(:begin,
          s(:lvasgn, :tester,
            s(:send,
              s(:const, nil, :Tester), :new)),
          s(:send,
            s(:lvar, :tester), :sync_lock,
            s(:sym, :EX)),
          s(:lvasgn, :t,
            s(:block,
              s(:send,
                s(:const, nil, :Thread), :new),
              s(:args),
              s(:send,
                s(:lvar, :tester), :sync_lock,
                s(:sym, :EX)))),
          s(:until,
            s(:send,
              s(:lvar, :t), :stop?),
            s(:send, nil, :sleep,
              s(:float, 0.1))),
          s(:send,
            s(:lvar, :t), :raise),
          s(:while,
            s(:send,
              s(:lvar, :t), :alive?),
            s(:send, nil, :sleep,
              s(:float, 0.1))),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:send,
                s(:lvar, :tester), :sync_waiting), :uniq),
            s(:send,
              s(:lvar, :tester), :sync_waiting)),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:lvar, :tester), :sync_waiting),
            s(:array)))))))
