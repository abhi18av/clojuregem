s(:begin,
  s(:kwbegin,
    s(:rescue,
      s(:send, nil, :require,
        s(:str, "win32ole")),
      s(:resbody,
        s(:array,
          s(:const, nil, :LoadError)), nil, nil), nil)),
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:send, nil, :require,
    s(:str, "fileutils")),
  s(:def, :ado_csv_installed?,
    s(:args),
    s(:begin,
      s(:lvasgn, :installed,
        s(:false)),
      s(:if,
        s(:defined?,
          s(:const, nil, :WIN32OLE)),
        s(:begin,
          s(:lvasgn, :db,
            s(:nil)),
          s(:kwbegin,
            s(:rescue,
              s(:begin,
                s(:lvasgn, :db,
                  s(:send,
                    s(:const, nil, :WIN32OLE), :new,
                    s(:str, "ADODB.Connection"))),
                s(:send,
                  s(:lvar, :db), :connectionString=,
                  s(:str, "Driver={Microsoft Text Driver (*.txt; *.csv)};DefaultDir=.;")),
                s(:send,
                  s(:lvar, :db), :open),
                s(:send,
                  s(:lvar, :db), :close),
                s(:lvasgn, :db,
                  s(:nil)),
                s(:lvasgn, :installed,
                  s(:true))),
              s(:resbody, nil, nil, nil), nil))), nil),
      s(:lvar, :installed))),
  s(:if,
    s(:defined?,
      s(:const, nil, :WIN32OLE_VARIANT)),
    s(:class,
      s(:const, nil, :TestWIN32OLE_VARIANT_OUTARG),
      s(:const,
        s(:const,
          s(:const, nil, :Test), :Unit), :TestCase),
      s(:begin,
        s(:module,
          s(:const, nil, :ADO), nil),
        s(:casgn, nil, :CONNSTR,
          s(:str, "Driver={Microsoft Text Driver (*.txt; *.csv)};DefaultDir=.;")),
        s(:def, :setup,
          s(:args),
          s(:begin,
            s(:if,
              s(:send,
                s(:send, nil, :ado_csv_installed?), :!),
              s(:return), nil),
            s(:send,
              s(:const, nil, :FileUtils), :cp,
              s(:send,
                s(:send,
                  s(:const, nil, :File), :dirname,
                  s(:str, "(string)")), :+,
                s(:str, "/orig_data.csv")),
              s(:str, "./data.csv")),
            s(:ivasgn, :@db,
              s(:send,
                s(:const, nil, :WIN32OLE), :new,
                s(:str, "ADODB.Connection"))),
            s(:if,
              s(:send,
                s(:defined?,
                  s(:const,
                    s(:const, nil, :ADO), :AdStateOpen)), :!),
              s(:send,
                s(:const, nil, :WIN32OLE), :const_load,
                s(:ivar, :@db),
                s(:const, nil, :ADO)), nil),
            s(:send,
              s(:ivar, :@db), :connectionString=,
              s(:const, nil, :CONNSTR)),
            s(:send,
              s(:ivar, :@db), :open))),
        s(:def, :test_variant_ref_and_argv,
          s(:args),
          s(:begin,
            s(:if,
              s(:send,
                s(:send, nil, :ado_csv_installed?), :!),
              s(:send, nil, :skip,
                s(:str, "ActiveX Data Object Library not found")), nil),
            s(:lvasgn, :sql,
              s(:str, "INSERT INTO data.csv VALUES (5, 'E')")),
            s(:send,
              s(:ivar, :@db), :execute,
              s(:lvar, :sql),
              s(:int, -1)),
            s(:lvasgn, :c,
              s(:send,
                s(:const,
                  s(:const, nil, :WIN32OLE), :ARGV), :[],
                s(:int, 1))),
            s(:send, nil, :assert_equal,
              s(:int, 1),
              s(:lvar, :c)),
            s(:lvasgn, :obj,
              s(:send,
                s(:const, nil, :WIN32OLE_VARIANT), :new,
                s(:nil),
                s(:send,
                  s(:const,
                    s(:const,
                      s(:const, nil, :WIN32OLE), :VARIANT), :VT_VARIANT), :|,
                  s(:const,
                    s(:const,
                      s(:const, nil, :WIN32OLE), :VARIANT), :VT_BYREF)))),
            s(:send, nil, :assert_equal,
              s(:nil),
              s(:send,
                s(:lvar, :obj), :value)),
            s(:send,
              s(:ivar, :@db), :execute,
              s(:lvar, :sql),
              s(:lvar, :obj)),
            s(:send, nil, :assert_equal,
              s(:int, 1),
              s(:send,
                s(:lvar, :obj), :value)),
            s(:lvasgn, :obj,
              s(:send,
                s(:const, nil, :WIN32OLE_VARIANT), :new,
                s(:int, -100),
                s(:send,
                  s(:const,
                    s(:const,
                      s(:const, nil, :WIN32OLE), :VARIANT), :VT_VARIANT), :|,
                  s(:const,
                    s(:const,
                      s(:const, nil, :WIN32OLE), :VARIANT), :VT_BYREF)))),
            s(:send, nil, :assert_equal,
              s(:int, -100),
              s(:send,
                s(:lvar, :obj), :value)),
            s(:send,
              s(:ivar, :@db), :execute,
              s(:lvar, :sql),
              s(:lvar, :obj)),
            s(:send, nil, :assert_equal,
              s(:int, 1),
              s(:send,
                s(:lvar, :obj), :value)))),
        s(:def, :teardown,
          s(:args),
          s(:begin,
            s(:if,
              s(:send,
                s(:send, nil, :ado_csv_installed?), :!),
              s(:return), nil),
            s(:if,
              s(:and,
                s(:ivar, :@db),
                s(:send,
                  s(:send,
                    s(:ivar, :@db), :state), :==,
                  s(:const,
                    s(:const, nil, :ADO), :AdStateOpen))),
              s(:send,
                s(:ivar, :@db), :close), nil),
            s(:send,
              s(:const, nil, :File), :unlink,
              s(:str, "data.csv")))))), nil))
