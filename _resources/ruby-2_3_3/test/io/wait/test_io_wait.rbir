s(:begin,
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:send, nil, :require,
    s(:str, "timeout")),
  s(:send, nil, :require,
    s(:str, "socket")),
  s(:kwbegin,
    s(:rescue,
      s(:send, nil, :require,
        s(:str, "io/wait")),
      s(:resbody,
        s(:array,
          s(:const, nil, :LoadError)), nil, nil), nil)),
  s(:if,
    s(:send,
      s(:const, nil, :IO), :method_defined?,
      s(:sym, :wait)),
    s(:class,
      s(:const, nil, :TestIOWait),
      s(:const,
        s(:const,
          s(:const, nil, :Test), :Unit), :TestCase),
      s(:begin,
        s(:def, :setup,
          s(:args),
          s(:if,
            s(:match_with_lvasgn,
              s(:regexp,
                s(:str, "mswin|mingw"),
                s(:regopt)),
              s(:const, nil, :RUBY_PLATFORM)),
            s(:masgn,
              s(:mlhs,
                s(:ivasgn, :@r),
                s(:ivasgn, :@w)),
              s(:send,
                s(:const, nil, :Socket), :pair,
                s(:const,
                  s(:const, nil, :Socket), :AF_INET),
                s(:const,
                  s(:const, nil, :Socket), :SOCK_STREAM),
                s(:int, 0))),
            s(:masgn,
              s(:mlhs,
                s(:ivasgn, :@r),
                s(:ivasgn, :@w)),
              s(:send,
                s(:const, nil, :IO), :pipe)))),
        s(:def, :teardown,
          s(:args),
          s(:begin,
            s(:if,
              s(:send,
                s(:ivar, :@r), :closed?), nil,
              s(:send,
                s(:ivar, :@r), :close)),
            s(:if,
              s(:send,
                s(:ivar, :@w), :closed?), nil,
              s(:send,
                s(:ivar, :@w), :close)))),
        s(:def, :test_nread,
          s(:args),
          s(:begin,
            s(:send, nil, :assert_equal,
              s(:int, 0),
              s(:send,
                s(:ivar, :@r), :nread)),
            s(:send,
              s(:ivar, :@w), :syswrite,
              s(:str, ".")),
            s(:send, nil, :sleep,
              s(:float, 0.1)),
            s(:send, nil, :assert_equal,
              s(:int, 1),
              s(:send,
                s(:ivar, :@r), :nread)))),
        s(:def, :test_nread_buffered,
          s(:args),
          s(:begin,
            s(:send,
              s(:ivar, :@w), :syswrite,
              s(:str, ".\n!")),
            s(:send, nil, :assert_equal,
              s(:str, ".\n"),
              s(:send,
                s(:ivar, :@r), :gets)),
            s(:send, nil, :assert_equal,
              s(:int, 1),
              s(:send,
                s(:ivar, :@r), :nread)))),
        s(:def, :test_ready?,
          s(:args),
          s(:begin,
            s(:send, nil, :refute,
              s(:send,
                s(:ivar, :@r), :ready?),
              s(:str, "shouldn't ready, but ready")),
            s(:send,
              s(:ivar, :@w), :syswrite,
              s(:str, ".")),
            s(:send, nil, :sleep,
              s(:float, 0.1)),
            s(:send, nil, :assert,
              s(:send,
                s(:ivar, :@r), :ready?),
              s(:str, "should ready, but not")))),
        s(:def, :test_buffered_ready?,
          s(:args),
          s(:begin,
            s(:send,
              s(:ivar, :@w), :syswrite,
              s(:str, ".\n!")),
            s(:send, nil, :assert_equal,
              s(:str, ".\n"),
              s(:send,
                s(:ivar, :@r), :gets)),
            s(:send, nil, :assert,
              s(:send,
                s(:ivar, :@r), :ready?)))),
        s(:def, :test_wait,
          s(:args),
          s(:begin,
            s(:send, nil, :assert_nil,
              s(:send,
                s(:ivar, :@r), :wait,
                s(:int, 0))),
            s(:send,
              s(:ivar, :@w), :syswrite,
              s(:str, ".")),
            s(:send, nil, :sleep,
              s(:float, 0.1)),
            s(:send, nil, :assert_equal,
              s(:ivar, :@r),
              s(:send,
                s(:ivar, :@r), :wait,
                s(:int, 0))))),
        s(:def, :test_wait_buffered,
          s(:args),
          s(:begin,
            s(:send,
              s(:ivar, :@w), :syswrite,
              s(:str, ".\n!")),
            s(:send, nil, :assert_equal,
              s(:str, ".\n"),
              s(:send,
                s(:ivar, :@r), :gets)),
            s(:send, nil, :assert_equal,
              s(:true),
              s(:send,
                s(:ivar, :@r), :wait,
                s(:int, 0))))),
        s(:def, :test_wait_forever,
          s(:args),
          s(:ensure,
            s(:begin,
              s(:lvasgn, :th,
                s(:block,
                  s(:send,
                    s(:const, nil, :Thread), :new),
                  s(:args),
                  s(:begin,
                    s(:send, nil, :sleep,
                      s(:float, 0.01)),
                    s(:send,
                      s(:ivar, :@w), :syswrite,
                      s(:str, "."))))),
              s(:send, nil, :assert_equal,
                s(:ivar, :@r),
                s(:send,
                  s(:ivar, :@r), :wait))),
            s(:send,
              s(:lvar, :th), :join))),
        s(:def, :test_wait_eof,
          s(:args),
          s(:ensure,
            s(:begin,
              s(:lvasgn, :th,
                s(:block,
                  s(:send,
                    s(:const, nil, :Thread), :new),
                  s(:args),
                  s(:begin,
                    s(:send, nil, :sleep,
                      s(:float, 0.01)),
                    s(:send,
                      s(:ivar, :@w), :close)))),
              s(:lvasgn, :ret,
                s(:nil)),
              s(:block,
                s(:send, nil, :assert_nothing_raised,
                  s(:const,
                    s(:const, nil, :Timeout), :Error)),
                s(:args),
                s(:block,
                  s(:send,
                    s(:const, nil, :Timeout), :timeout,
                    s(:float, 0.1)),
                  s(:args),
                  s(:lvasgn, :ret,
                    s(:send,
                      s(:ivar, :@r), :wait)))),
              s(:send, nil, :assert_equal,
                s(:ivar, :@r),
                s(:lvar, :ret))),
            s(:send,
              s(:lvar, :th), :join))),
        s(:def, :test_wait_writable,
          s(:args),
          s(:send, nil, :assert_equal,
            s(:ivar, :@w),
            s(:send,
              s(:ivar, :@w), :wait_writable))),
        s(:def, :test_wait_writable_timeout,
          s(:args),
          s(:begin,
            s(:send, nil, :assert_equal,
              s(:ivar, :@w),
              s(:send,
                s(:ivar, :@w), :wait_writable,
                s(:float, 0.01))),
            s(:lvasgn, :written,
              s(:send, nil, :fill_pipe)),
            s(:send, nil, :assert_nil,
              s(:send,
                s(:ivar, :@w), :wait_writable,
                s(:float, 0.01))),
            s(:send,
              s(:ivar, :@r), :read,
              s(:lvar, :written)),
            s(:send, nil, :assert_equal,
              s(:ivar, :@w),
              s(:send,
                s(:ivar, :@w), :wait_writable,
                s(:float, 0.01))))),
        s(:def, :test_wait_writable_EPIPE,
          s(:args),
          s(:begin,
            s(:send, nil, :fill_pipe),
            s(:send,
              s(:ivar, :@r), :close),
            s(:send, nil, :assert_equal,
              s(:ivar, :@w),
              s(:send,
                s(:ivar, :@w), :wait_writable)))),
        s(:def, :test_wait_writable_closed,
          s(:args),
          s(:begin,
            s(:send,
              s(:ivar, :@w), :close),
            s(:block,
              s(:send, nil, :assert_raise,
                s(:const, nil, :IOError)),
              s(:args),
              s(:send,
                s(:ivar, :@w), :wait_writable)))),
        s(:send, nil, :private),
        s(:def, :fill_pipe,
          s(:args),
          s(:begin,
            s(:lvasgn, :written,
              s(:int, 0)),
            s(:lvasgn, :buf,
              s(:send,
                s(:str, " "), :*,
                s(:int, 4096))),
            s(:while_post,
              s(:true),
              s(:kwbegin,
                s(:rescue,
                  s(:op_asgn,
                    s(:lvasgn, :written), :+,
                    s(:send,
                      s(:ivar, :@w), :write_nonblock,
                      s(:lvar, :buf))),
                  s(:resbody,
                    s(:array,
                      s(:const,
                        s(:const, nil, :Errno), :EAGAIN),
                      s(:const,
                        s(:const, nil, :Errno), :EWOULDBLOCK)), nil,
                    s(:return,
                      s(:lvar, :written))), nil))))))), nil))
