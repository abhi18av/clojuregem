s(:begin,
  s(:send, nil, :require,
    s(:str, "test/unit")),
  s(:send, nil, :require,
    s(:str, "observer")),
  s(:class,
    s(:const, nil, :TestObserver),
    s(:const,
      s(:const,
        s(:const, nil, :Test), :Unit), :TestCase),
    s(:begin,
      s(:class,
        s(:const, nil, :TestObservable), nil,
        s(:begin,
          s(:send, nil, :include,
            s(:const, nil, :Observable)),
          s(:def, :notify,
            s(:args,
              s(:restarg, :args)),
            s(:begin,
              s(:send, nil, :changed),
              s(:send, nil, :notify_observers,
                s(:splat,
                  s(:lvar, :args))))))),
      s(:class,
        s(:const, nil, :TestWatcher), nil,
        s(:begin,
          s(:def, :initialize,
            s(:args,
              s(:arg, :observable)),
            s(:begin,
              s(:ivasgn, :@notifications,
                s(:array)),
              s(:send,
                s(:lvar, :observable), :add_observer,
                s(:self)))),
          s(:send, nil, :attr_reader,
            s(:sym, :notifications)),
          s(:def, :update,
            s(:args,
              s(:restarg, :args)),
            s(:send,
              s(:ivar, :@notifications), :<<,
              s(:lvar, :args))))),
      s(:def, :test_observers,
        s(:args),
        s(:begin,
          s(:lvasgn, :observable,
            s(:send,
              s(:const, nil, :TestObservable), :new)),
          s(:send, nil, :assert_equal,
            s(:int, 0),
            s(:send,
              s(:lvar, :observable), :count_observers)),
          s(:lvasgn, :watcher1,
            s(:send,
              s(:const, nil, :TestWatcher), :new,
              s(:lvar, :observable))),
          s(:send, nil, :assert_equal,
            s(:int, 1),
            s(:send,
              s(:lvar, :observable), :count_observers)),
          s(:send,
            s(:lvar, :observable), :notify,
            s(:str, "test"),
            s(:int, 123)),
          s(:lvasgn, :watcher2,
            s(:send,
              s(:const, nil, :TestWatcher), :new,
              s(:lvar, :observable))),
          s(:send, nil, :assert_equal,
            s(:int, 2),
            s(:send,
              s(:lvar, :observable), :count_observers)),
          s(:send,
            s(:lvar, :observable), :notify,
            s(:int, 42)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:array,
                s(:str, "test"),
                s(:int, 123)),
              s(:array,
                s(:int, 42))),
            s(:send,
              s(:lvar, :watcher1), :notifications)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:array,
                s(:int, 42))),
            s(:send,
              s(:lvar, :watcher2), :notifications)),
          s(:send,
            s(:lvar, :observable), :delete_observer,
            s(:lvar, :watcher1)),
          s(:send, nil, :assert_equal,
            s(:int, 1),
            s(:send,
              s(:lvar, :observable), :count_observers)),
          s(:send,
            s(:lvar, :observable), :notify,
            s(:sym, :cats)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:array,
                s(:str, "test"),
                s(:int, 123)),
              s(:array,
                s(:int, 42))),
            s(:send,
              s(:lvar, :watcher1), :notifications)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:array,
                s(:int, 42)),
              s(:array,
                s(:sym, :cats))),
            s(:send,
              s(:lvar, :watcher2), :notifications)),
          s(:send,
            s(:lvar, :observable), :delete_observers),
          s(:send, nil, :assert_equal,
            s(:int, 0),
            s(:send,
              s(:lvar, :observable), :count_observers)),
          s(:send,
            s(:lvar, :observable), :notify,
            s(:str, "nope")),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:array,
                s(:str, "test"),
                s(:int, 123)),
              s(:array,
                s(:int, 42))),
            s(:send,
              s(:lvar, :watcher1), :notifications)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:array,
                s(:int, 42)),
              s(:array,
                s(:sym, :cats))),
            s(:send,
              s(:lvar, :watcher2), :notifications)))))))
