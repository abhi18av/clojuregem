s(:begin,
  s(:send, nil, :require,
    s(:str, "webrick")),
  s(:kwbegin,
    s(:rescue,
      s(:send, nil, :require,
        s(:str, "webrick/https")),
      s(:resbody,
        s(:array,
          s(:const, nil, :LoadError)), nil, nil), nil)),
  s(:send, nil, :require,
    s(:str, "webrick/httpproxy")),
  s(:module,
    s(:const, nil, :TestWEBrick),
    s(:begin,
      s(:casgn, nil, :NullWriter,
        s(:send,
          s(:const, nil, :Object), :new)),
      s(:defs,
        s(:const, nil, :NullWriter), :<<,
        s(:args,
          s(:arg, :msg)),
        s(:begin,
          s(:if,
            s(:gvar, :$DEBUG),
            s(:send, nil, :puts,
              s(:lvar, :msg)), nil),
          s(:return,
            s(:self)))),
      s(:class,
        s(:const,
          s(:const,
            s(:const, nil, :WEBrick), :HTTPServlet), :CGIHandler), nil,
        s(:begin,
          s(:send, nil, :remove_const,
            s(:sym, :Ruby)),
          s(:casgn, nil, :Ruby,
            s(:send,
              s(:const, nil, :EnvUtil), :rubybin)),
          s(:send, nil, :remove_const,
            s(:sym, :CGIRunner)),
          s(:casgn, nil, :CGIRunner,
            s(:dstr,
              s(:str, "\""),
              s(:begin,
                s(:const, nil, :Ruby)),
              s(:str, "\" \""),
              s(:begin,
                s(:const,
                  s(:const,
                    s(:const, nil, :WEBrick), :Config), :LIBDIR)),
              s(:str, "/httpservlet/cgi_runner.rb\""))))),
      s(:casgn, nil, :RubyBin,
        s(:dstr,
          s(:str, "\""),
          s(:begin,
            s(:send,
              s(:const, nil, :EnvUtil), :rubybin)),
          s(:str, "\""))),
      s(:send,
        s(:const, nil, :RubyBin), :<<,
        s(:str, " --disable-gems")),
      s(:send,
        s(:const, nil, :RubyBin), :<<,
        s(:dstr,
          s(:str, " \"-I"),
          s(:begin,
            s(:send,
              s(:const, nil, :File), :expand_path,
              s(:str, "../.."),
              s(:send,
                s(:const, nil, :File), :dirname,
                s(:str, "(string)")))),
          s(:str, "/lib\""))),
      s(:send,
        s(:const, nil, :RubyBin), :<<,
        s(:dstr,
          s(:str, " \"-I"),
          s(:begin,
            s(:send,
              s(:const, nil, :File), :dirname,
              s(:send,
                s(:const, nil, :EnvUtil), :rubybin))),
          s(:str, "/.ext/common\""))),
      s(:send,
        s(:const, nil, :RubyBin), :<<,
        s(:dstr,
          s(:str, " \"-I"),
          s(:begin,
            s(:send,
              s(:const, nil, :File), :dirname,
              s(:send,
                s(:const, nil, :EnvUtil), :rubybin))),
          s(:str, "/.ext/"),
          s(:begin,
            s(:const, nil, :RUBY_PLATFORM)),
          s(:str, "\""))),
      s(:send, nil, :include,
        s(:const,
          s(:const,
            s(:const, nil, :Test), :Unit), :Assertions)),
      s(:send, nil, :extend,
        s(:const,
          s(:const,
            s(:const, nil, :Test), :Unit), :Assertions)),
      s(:send, nil, :module_function),
      s(:casgn, nil, :DefaultLogTester,
        s(:block,
          s(:send, nil, :lambda),
          s(:args,
            s(:arg, :log),
            s(:arg, :access_log)),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:lvar, :log)))),
      s(:def, :start_server,
        s(:args,
          s(:arg, :klass),
          s(:optarg, :config,
            s(:hash)),
          s(:optarg, :log_tester,
            s(:const, nil, :DefaultLogTester)),
          s(:blockarg, :block)),
        s(:begin,
          s(:lvasgn, :log_ary,
            s(:array)),
          s(:lvasgn, :access_log_ary,
            s(:array)),
          s(:lvasgn, :log,
            s(:block,
              s(:send, nil, :proc),
              s(:args),
              s(:send,
                s(:send,
                  s(:str, "webrick log start:\n"), :+,
                  s(:send,
                    s(:send,
                      s(:send,
                        s(:begin,
                          s(:send,
                            s(:lvar, :log_ary), :+,
                            s(:lvar, :access_log_ary))), :join), :gsub,
                      s(:regexp,
                        s(:str, "^"),
                        s(:regopt)),
                      s(:str, "  ")), :chomp)), :+,
                s(:str, "\nwebrick log end")))),
          s(:lvasgn, :server,
            s(:send,
              s(:lvar, :klass), :new,
              s(:send,
                s(:hash,
                  s(:pair,
                    s(:sym, :BindAddress),
                    s(:str, "127.0.0.1")),
                  s(:pair,
                    s(:sym, :Port),
                    s(:int, 0)),
                  s(:pair,
                    s(:sym, :ServerType),
                    s(:const, nil, :Thread)),
                  s(:pair,
                    s(:sym, :Logger),
                    s(:send,
                      s(:const,
                        s(:const, nil, :WEBrick), :Log), :new,
                      s(:lvar, :log_ary),
                      s(:const,
                        s(:const,
                          s(:const, nil, :WEBrick), :BasicLog), :WARN))),
                  s(:pair,
                    s(:sym, :AccessLog),
                    s(:array,
                      s(:array,
                        s(:lvar, :access_log_ary),
                        s(:str, ""))))), :update,
                s(:lvar, :config)))),
          s(:lvasgn, :server_thread,
            s(:send,
              s(:lvar, :server), :start)),
          s(:lvasgn, :server_thread2,
            s(:block,
              s(:send,
                s(:const, nil, :Thread), :new),
              s(:args),
              s(:begin,
                s(:send,
                  s(:lvar, :server_thread), :join),
                s(:if,
                  s(:lvar, :log_tester),
                  s(:send,
                    s(:lvar, :log_tester), :call,
                    s(:lvar, :log_ary),
                    s(:lvar, :access_log_ary)), nil)))),
          s(:lvasgn, :addr,
            s(:send,
              s(:send,
                s(:send,
                  s(:lvar, :server), :listeners), :[],
                s(:int, 0)), :addr)),
          s(:lvasgn, :client_thread,
            s(:block,
              s(:send,
                s(:const, nil, :Thread), :new),
              s(:args),
              s(:kwbegin,
                s(:ensure,
                  s(:send,
                    s(:lvar, :block), :yield,
                    s(:array,
                      s(:lvar, :server),
                      s(:send,
                        s(:lvar, :addr), :[],
                        s(:int, 3)),
                      s(:send,
                        s(:lvar, :addr), :[],
                        s(:int, 1)),
                      s(:lvar, :log))),
                  s(:send,
                    s(:lvar, :server), :shutdown))))),
          s(:send, nil, :assert_join_threads,
            s(:array,
              s(:lvar, :client_thread),
              s(:lvar, :server_thread2))))),
      s(:def, :start_httpserver,
        s(:args,
          s(:optarg, :config,
            s(:hash)),
          s(:optarg, :log_tester,
            s(:const, nil, :DefaultLogTester)),
          s(:blockarg, :block)),
        s(:send, nil, :start_server,
          s(:const,
            s(:const, nil, :WEBrick), :HTTPServer),
          s(:lvar, :config),
          s(:lvar, :log_tester),
          s(:block_pass,
            s(:lvar, :block)))),
      s(:def, :start_httpproxy,
        s(:args,
          s(:optarg, :config,
            s(:hash)),
          s(:optarg, :log_tester,
            s(:const, nil, :DefaultLogTester)),
          s(:blockarg, :block)),
        s(:send, nil, :start_server,
          s(:const,
            s(:const, nil, :WEBrick), :HTTPProxyServer),
          s(:lvar, :config),
          s(:lvar, :log_tester),
          s(:block_pass,
            s(:lvar, :block)))))))
