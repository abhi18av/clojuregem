s(:begin,
  s(:send, nil, :require,
    s(:str, "drb/drb")),
  s(:send, nil, :require,
    s(:str, "drb/extserv")),
  s(:send, nil, :require,
    s(:str, "timeout")),
  s(:module,
    s(:const, nil, :DRbTests),
    s(:begin,
      s(:class,
        s(:const, nil, :XArray),
        s(:const, nil, :Array),
        s(:def, :initialize,
          s(:args,
            s(:arg, :ary)),
          s(:block,
            s(:send,
              s(:lvar, :ary), :each),
            s(:args,
              s(:arg, :x)),
            s(:send,
              s(:self), :push,
              s(:lvar, :x))))),
      s(:class,
        s(:const, nil, :XArray2),
        s(:const, nil, :XArray),
        s(:send, nil, :include,
          s(:const, nil, :DRbUndumped))),
      s(:class,
        s(:const, nil, :Unknown2), nil,
        s(:def, :initialize,
          s(:args),
          s(:ivasgn, :@foo,
            s(:str, "unknown2")))),
      s(:class,
        s(:const, nil, :DRbEx), nil,
        s(:begin,
          s(:send, nil, :include,
            s(:const, nil, :DRbUndumped)),
          s(:class,
            s(:const, nil, :FooBar), nil,
            s(:def, :initialize,
              s(:args),
              s(:ivasgn, :@foo,
                s(:str, "bar")))),
          s(:class,
            s(:const, nil, :UError),
            s(:const, nil, :RuntimeError), nil),
          s(:def, :initialize,
            s(:args),
            s(:begin,
              s(:ivasgn, :@xary2_hash,
                s(:nil)),
              s(:ivasgn, :@hash,
                s(:nil)),
              s(:ivasgn, :@hello,
                s(:str, "hello")))),
          s(:send, nil, :attr_reader,
            s(:sym, :hello)),
          s(:def, :sample,
            s(:args,
              s(:arg, :a),
              s(:arg, :b),
              s(:arg, :c)),
            s(:send,
              s(:send,
                s(:send,
                  s(:lvar, :a), :to_i), :+,
                s(:send,
                  s(:lvar, :b), :to_i)), :+,
              s(:send,
                s(:lvar, :c), :to_i))),
          s(:def, :sum,
            s(:args,
              s(:restarg, :a)),
            s(:begin,
              s(:lvasgn, :s,
                s(:int, 0)),
              s(:block,
                s(:send,
                  s(:lvar, :a), :each),
                s(:args,
                  s(:arg, :e)),
                s(:op_asgn,
                  s(:lvasgn, :s), :+,
                  s(:send,
                    s(:lvar, :e), :to_i))),
              s(:lvar, :s))),
          s(:def, :do_timeout,
            s(:args,
              s(:arg, :n)),
            s(:block,
              s(:send,
                s(:const, nil, :Timeout), :timeout,
                s(:float, 0.1)),
              s(:args),
              s(:send,
                s(:lvar, :n), :sleep,
                s(:int, 2)))),
          s(:def, :unknown_module,
            s(:args),
            s(:send,
              s(:const, nil, :FooBar), :new)),
          s(:def, :unknown_class,
            s(:args),
            s(:send,
              s(:const, nil, :Unknown2), :new)),
          s(:def, :unknown_error,
            s(:args),
            s(:send, nil, :raise,
              s(:const, nil, :UError))),
          s(:def, :remote_no_method_error,
            s(:args),
            s(:send, nil, :invoke_no_method,
              s(:self))),
          s(:def, :test_yield,
            s(:args),
            s(:begin,
              s(:yield),
              s(:yield,
                s(:array)),
              s(:yield,
                s(:splat,
                  s(:array))))),
          s(:def, :echo_yield,
            s(:args,
              s(:restarg, :arg)),
            s(:begin,
              s(:yield,
                s(:splat,
                  s(:lvar, :arg))),
              s(:nil))),
          s(:def, :echo_yield_0,
            s(:args),
            s(:begin,
              s(:yield),
              s(:nil))),
          s(:def, :echo_yield_1,
            s(:args,
              s(:arg, :one)),
            s(:begin,
              s(:yield,
                s(:lvar, :one)),
              s(:nil))),
          s(:def, :echo_yield_2,
            s(:args,
              s(:arg, :one),
              s(:arg, :two)),
            s(:begin,
              s(:yield,
                s(:lvar, :one),
                s(:lvar, :two)),
              s(:nil))),
          s(:def, :xarray_each,
            s(:args),
            s(:begin,
              s(:lvasgn, :xary,
                s(:array,
                  s(:send,
                    s(:const, nil, :XArray), :new,
                    s(:array,
                      s(:int, 0))))),
              s(:block,
                s(:send,
                  s(:lvar, :xary), :each),
                s(:args,
                  s(:arg, :x)),
                s(:yield,
                  s(:lvar, :x))),
              s(:nil))),
          s(:def, :xarray2_hash,
            s(:args),
            s(:begin,
              s(:if,
                s(:ivar, :@xary2_hash), nil,
                s(:ivasgn, :@xary2_hash,
                  s(:hash,
                    s(:pair,
                      s(:str, "a"),
                      s(:send,
                        s(:const, nil, :XArray2), :new,
                        s(:array,
                          s(:int, 0)))),
                    s(:pair,
                      s(:str, "b"),
                      s(:send,
                        s(:const, nil, :XArray2), :new,
                        s(:array,
                          s(:int, 1))))))),
              s(:send,
                s(:const, nil, :DRbObject), :new,
                s(:ivar, :@xary2_hash)))),
          s(:def, :simple_hash,
            s(:args),
            s(:begin,
              s(:if,
                s(:ivar, :@hash), nil,
                s(:ivasgn, :@hash,
                  s(:hash,
                    s(:pair,
                      s(:str, "a"),
                      s(:sym, :a)),
                    s(:pair,
                      s(:str, "b"),
                      s(:sym, :b))))),
              s(:send,
                s(:const, nil, :DRbObject), :new,
                s(:ivar, :@hash)))),
          s(:def, :[],
            s(:args,
              s(:arg, :key)),
            s(:send,
              s(:lvar, :key), :to_s)),
          s(:def, :to_a,
            s(:args),
            s(:array,
              s(:self))),
          s(:def, :method_missing,
            s(:args,
              s(:arg, :msg),
              s(:restarg, :a),
              s(:blockarg, :b)),
            s(:if,
              s(:send,
                s(:lvar, :msg), :==,
                s(:sym, :missing)),
              s(:return,
                s(:true)),
              s(:super,
                s(:lvar, :msg),
                s(:splat,
                  s(:lvar, :a)),
                s(:block_pass,
                  s(:lvar, :b))))),
          s(:send, nil, :private),
          s(:def, :call_private_method,
            s(:args),
            s(:true)),
          s(:send, nil, :protected),
          s(:def, :call_protected_method,
            s(:args),
            s(:true)))))),
  s(:if,
    s(:send,
      s(:str, "(string)"), :==,
      s(:gvar, :$0)),
    s(:begin,
      s(:defs,
        s(:const, nil, :ARGV), :shift,
        s(:args),
        s(:begin,
          s(:lvasgn, :it,
            s(:super)),
          s(:if,
            s(:lvar, :it), nil,
            s(:send, nil, :raise,
              s(:dstr,
                s(:str, "usage: "),
                s(:begin,
                  s(:gvar, :$0)),
                s(:str, " <manager-uri> <name>")))),
          s(:lvar, :it))),
      s(:send,
        s(:const,
          s(:const, nil, :DRb), :DRbServer), :default_argc_limit,
        s(:int, 8)),
      s(:send,
        s(:const,
          s(:const, nil, :DRb), :DRbServer), :default_load_limit,
        s(:int, 4096)),
      s(:send,
        s(:const, nil, :DRb), :start_service,
        s(:str, "druby://localhost:0"),
        s(:send,
          s(:const,
            s(:const, nil, :DRbTests), :DRbEx), :new)),
      s(:lvasgn, :es,
        s(:send,
          s(:const,
            s(:const, nil, :DRb), :ExtServ), :new,
          s(:send,
            s(:const, nil, :ARGV), :shift),
          s(:send,
            s(:const, nil, :ARGV), :shift))),
      s(:send,
        s(:send,
          s(:const, nil, :DRb), :thread), :join),
      s(:if,
        s(:send,
          s(:lvar, :es), :alive?),
        s(:send,
          s(:lvar, :es), :stop_service), nil)), nil))
