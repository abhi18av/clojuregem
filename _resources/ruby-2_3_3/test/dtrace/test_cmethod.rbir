s(:begin,
  s(:send, nil, :require_relative,
    s(:str, "helper")),
  s(:if,
    s(:defined?,
      s(:const,
        s(:const, nil, :DTrace), :TestCase)),
    s(:module,
      s(:const, nil, :DTrace),
      s(:class,
        s(:const, nil, :TestCMethod),
        s(:const, nil, :TestCase),
        s(:begin,
          s(:def, :test_entry,
            s(:args),
            s(:begin,
              s(:lvasgn, :probe,
                s(:dstr,
                  s(:str, "ruby$target:::cmethod-entry\n"),
                  s(:str, "{\n"),
                  s(:str, "  printf(\"%s %s %s %d\\n\", copyinstr(arg0), copyinstr(arg1), copyinstr(arg2), arg3);\n"),
                  s(:str, "}\n"))),
              s(:block,
                s(:send, nil, :trap_probe,
                  s(:lvar, :probe),
                  s(:send, nil, :ruby_program)),
                s(:args,
                  s(:arg, :d_file),
                  s(:arg, :rb_file),
                  s(:arg, :probes)),
                s(:begin,
                  s(:lvasgn, :foo_calls,
                    s(:block,
                      s(:send,
                        s(:block,
                          s(:send,
                            s(:lvar, :probes), :map),
                          s(:args,
                            s(:arg, :line)),
                          s(:send,
                            s(:lvar, :line), :split)), :find_all),
                      s(:args,
                        s(:arg, :row)),
                      s(:send,
                        s(:send,
                          s(:lvar, :row), :[],
                          s(:int, 1)), :==,
                        s(:str, "times")))),
                  s(:send, nil, :assert_equal,
                    s(:int, 1),
                    s(:send,
                      s(:lvar, :foo_calls), :length)))))),
          s(:def, :test_exit,
            s(:args),
            s(:begin,
              s(:lvasgn, :probe,
                s(:dstr,
                  s(:str, "ruby$target:::cmethod-return\n"),
                  s(:str, "{\n"),
                  s(:str, "  printf(\"%s %s %s %d\\n\", copyinstr(arg0), copyinstr(arg1), copyinstr(arg2), arg3);\n"),
                  s(:str, "}\n"))),
              s(:block,
                s(:send, nil, :trap_probe,
                  s(:lvar, :probe),
                  s(:send, nil, :ruby_program)),
                s(:args,
                  s(:arg, :d_file),
                  s(:arg, :rb_file),
                  s(:arg, :probes)),
                s(:begin,
                  s(:lvasgn, :foo_calls,
                    s(:block,
                      s(:send,
                        s(:block,
                          s(:send,
                            s(:lvar, :probes), :map),
                          s(:args,
                            s(:arg, :line)),
                          s(:send,
                            s(:lvar, :line), :split)), :find_all),
                      s(:args,
                        s(:arg, :row)),
                      s(:send,
                        s(:send,
                          s(:lvar, :row), :[],
                          s(:int, 1)), :==,
                        s(:str, "times")))),
                  s(:send, nil, :assert_equal,
                    s(:int, 1),
                    s(:send,
                      s(:lvar, :foo_calls), :length)))))),
          s(:def, :ruby_program,
            s(:args),
            s(:dstr,
              s(:str, "      class Foo\n"),
              s(:str, "\tdef self.foo; end\n"),
              s(:str, "      end\n"),
              s(:str, "      10.times { Foo.foo }\n")))))), nil))
