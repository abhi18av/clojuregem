s(:begin,
  s(:send, nil, :require_relative,
    s(:str, "test_optparse")),
  s(:module,
    s(:const,
      s(:const, nil, :TestOptionParser), :NoArg),
    s(:begin,
      s(:class,
        s(:const, nil, :Def1),
        s(:const, nil, :TestOptionParser),
        s(:begin,
          s(:send, nil, :include,
            s(:const, nil, :NoArg)),
          s(:def, :setup,
            s(:args),
            s(:begin,
              s(:zsuper),
              s(:block,
                s(:send,
                  s(:ivar, :@opt), :def_option,
                  s(:str, "-x")),
                s(:args,
                  s(:arg, :x)),
                s(:ivasgn, :@flag,
                  s(:lvar, :x))),
              s(:block,
                s(:send,
                  s(:ivar, :@opt), :def_option,
                  s(:str, "--option")),
                s(:args,
                  s(:arg, :x)),
                s(:ivasgn, :@flag,
                  s(:lvar, :x))))))),
      s(:class,
        s(:const, nil, :Def2),
        s(:const, nil, :TestOptionParser),
        s(:begin,
          s(:send, nil, :include,
            s(:const, nil, :NoArg)),
          s(:def, :setup,
            s(:args),
            s(:begin,
              s(:zsuper),
              s(:block,
                s(:send,
                  s(:ivar, :@opt), :def_option,
                  s(:str, "-x"),
                  s(:str, "--option")),
                s(:args,
                  s(:arg, :x)),
                s(:ivasgn, :@flag,
                  s(:lvar, :x))))))),
      s(:def, :test_short,
        s(:args),
        s(:begin,
          s(:block,
            s(:send, nil, :assert_raise,
              s(:const,
                s(:const, nil, :OptionParser), :InvalidOption)),
            s(:args),
            s(:send,
              s(:ivar, :@opt), :parse!,
              s(:array,
                s(:str, "-xq")))),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:block,
              s(:send, nil, :no_error),
              s(:args),
              s(:send,
                s(:ivar, :@opt), :parse!,
                s(:array,
                  s(:str, "-x"))))),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:ivar, :@flag)),
          s(:ivasgn, :@flag,
            s(:nil)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "foo")),
            s(:block,
              s(:send, nil, :no_error),
              s(:args),
              s(:send,
                s(:ivar, :@opt), :parse!,
                s(:array,
                  s(:str, "-x"),
                  s(:str, "foo"))))),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:ivar, :@flag)))),
      s(:def, :test_abbrev,
        s(:args),
        s(:begin,
          s(:block,
            s(:send, nil, :assert_raise,
              s(:const,
                s(:const, nil, :OptionParser), :InvalidOption)),
            s(:args),
            s(:send,
              s(:ivar, :@opt), :parse!,
              s(:array,
                s(:str, "-oq")))),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:block,
              s(:send, nil, :no_error),
              s(:args),
              s(:send,
                s(:ivar, :@opt), :parse!,
                s(:array,
                  s(:str, "-o"))))),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:ivar, :@flag)),
          s(:ivasgn, :@flag,
            s(:nil)),
          s(:block,
            s(:send, nil, :assert_raise,
              s(:const,
                s(:const, nil, :OptionParser), :InvalidOption)),
            s(:args),
            s(:send,
              s(:ivar, :@opt), :parse!,
              s(:array,
                s(:str, "-O")))),
          s(:send, nil, :assert_nil,
            s(:ivar, :@flag)),
          s(:ivasgn, :@flag,
            s(:nil)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "foo")),
            s(:block,
              s(:send, nil, :no_error),
              s(:args),
              s(:send,
                s(:ivar, :@opt), :parse!,
                s(:array,
                  s(:str, "-o"),
                  s(:str, "foo"))))),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:ivar, :@flag)))),
      s(:def, :test_long,
        s(:args),
        s(:begin,
          s(:block,
            s(:send, nil, :assert_raise,
              s(:const,
                s(:const, nil, :OptionParser), :NeedlessArgument)),
            s(:args),
            s(:send,
              s(:ivar, :@opt), :parse!,
              s(:array,
                s(:str, "--option=x")))),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:block,
              s(:send, nil, :no_error),
              s(:args),
              s(:send,
                s(:ivar, :@opt), :parse!,
                s(:array,
                  s(:str, "--opt"))))),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:ivar, :@flag)),
          s(:ivasgn, :@flag,
            s(:nil)),
          s(:send, nil, :assert_equal,
            s(:array,
              s(:str, "foo")),
            s(:block,
              s(:send, nil, :no_error),
              s(:args),
              s(:send,
                s(:ivar, :@opt), :parse!,
                s(:array,
                  s(:str, "--opt"),
                  s(:str, "foo"))))),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:ivar, :@flag)))),
      s(:def, :test_ambiguous,
        s(:args),
        s(:begin,
          s(:block,
            s(:send,
              s(:ivar, :@opt), :def_option,
              s(:str, "--open")),
            s(:args,
              s(:arg, :x)), nil),
          s(:block,
            s(:send, nil, :assert_raise,
              s(:const,
                s(:const, nil, :OptionParser), :AmbiguousOption)),
            s(:args),
            s(:send,
              s(:ivar, :@opt), :parse!,
              s(:array,
                s(:str, "--op")))),
          s(:block,
            s(:send, nil, :assert_raise,
              s(:const,
                s(:const, nil, :OptionParser), :AmbiguousOption)),
            s(:args),
            s(:send,
              s(:ivar, :@opt), :parse!,
              s(:array,
                s(:str, "-o")))),
          s(:send, nil, :assert_equal,
            s(:array),
            s(:block,
              s(:send, nil, :no_error),
              s(:args),
              s(:send,
                s(:ivar, :@opt), :parse!,
                s(:array,
                  s(:str, "--opt"))))),
          s(:send, nil, :assert_equal,
            s(:true),
            s(:ivar, :@flag)))))))
