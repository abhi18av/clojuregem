s(:begin,
  s(:send, nil, :require,
    s(:str, "openssl")),
  s(:def, :crypt_by_password,
    s(:args,
      s(:arg, :alg),
      s(:arg, :pass),
      s(:arg, :salt),
      s(:arg, :text)),
    s(:begin,
      s(:send, nil, :puts,
        s(:str, "--Setup--")),
      s(:send, nil, :puts,
        s(:dstr,
          s(:str, "cipher alg:    \""),
          s(:begin,
            s(:lvar, :alg)),
          s(:str, "\""))),
      s(:send, nil, :puts,
        s(:dstr,
          s(:str, "plain text:    \""),
          s(:begin,
            s(:lvar, :text)),
          s(:str, "\""))),
      s(:send, nil, :puts,
        s(:dstr,
          s(:str, "password:      \""),
          s(:begin,
            s(:lvar, :pass)),
          s(:str, "\""))),
      s(:send, nil, :puts,
        s(:dstr,
          s(:str, "salt:          \""),
          s(:begin,
            s(:lvar, :salt)),
          s(:str, "\""))),
      s(:send, nil, :puts),
      s(:send, nil, :puts,
        s(:str, "--Encrypting--")),
      s(:lvasgn, :enc,
        s(:send,
          s(:const,
            s(:const,
              s(:const, nil, :OpenSSL), :Cipher), :Cipher), :new,
          s(:lvar, :alg))),
      s(:send,
        s(:lvar, :enc), :encrypt),
      s(:send,
        s(:lvar, :enc), :pkcs5_keyivgen,
        s(:lvar, :pass),
        s(:lvar, :salt)),
      s(:lvasgn, :cipher,
        s(:send,
          s(:lvar, :enc), :update,
          s(:lvar, :text))),
      s(:send,
        s(:lvar, :cipher), :<<,
        s(:send,
          s(:lvar, :enc), :final)),
      s(:send, nil, :puts,
        s(:dstr,
          s(:str, "encrypted text: "),
          s(:begin,
            s(:send,
              s(:lvar, :cipher), :inspect)))),
      s(:send, nil, :puts),
      s(:send, nil, :puts,
        s(:str, "--Decrypting--")),
      s(:lvasgn, :dec,
        s(:send,
          s(:const,
            s(:const,
              s(:const, nil, :OpenSSL), :Cipher), :Cipher), :new,
          s(:lvar, :alg))),
      s(:send,
        s(:lvar, :dec), :decrypt),
      s(:send,
        s(:lvar, :dec), :pkcs5_keyivgen,
        s(:lvar, :pass),
        s(:lvar, :salt)),
      s(:lvasgn, :plain,
        s(:send,
          s(:lvar, :dec), :update,
          s(:lvar, :cipher))),
      s(:send,
        s(:lvar, :plain), :<<,
        s(:send,
          s(:lvar, :dec), :final)),
      s(:send, nil, :puts,
        s(:dstr,
          s(:str, "decrypted text: \""),
          s(:begin,
            s(:lvar, :plain)),
          s(:str, "\""))),
      s(:send, nil, :puts))),
  s(:def, :ciphers,
    s(:args),
    s(:begin,
      s(:lvasgn, :ciphers,
        s(:send,
          s(:send,
            s(:const,
              s(:const, nil, :OpenSSL), :Cipher), :ciphers), :sort)),
      s(:block,
        s(:send,
          s(:lvar, :ciphers), :each),
        s(:args,
          s(:arg, :i)),
        s(:if,
          s(:and,
            s(:send,
              s(:send,
                s(:lvar, :i), :upcase), :!=,
              s(:lvar, :i)),
            s(:send,
              s(:lvar, :ciphers), :include?,
              s(:send,
                s(:lvar, :i), :upcase))),
          s(:send,
            s(:lvar, :ciphers), :delete,
            s(:lvar, :i)), nil)),
      s(:return,
        s(:lvar, :ciphers)))),
  s(:send, nil, :puts,
    s(:dstr,
      s(:str, "Supported ciphers in "),
      s(:begin,
        s(:const,
          s(:const, nil, :OpenSSL), :OPENSSL_VERSION)),
      s(:str, ":"))),
  s(:block,
    s(:send,
      s(:send, nil, :ciphers), :each_with_index),
    s(:args,
      s(:arg, :name),
      s(:arg, :i)),
    s(:begin,
      s(:send, nil, :printf,
        s(:str, "%-15s"),
        s(:lvar, :name)),
      s(:if,
        s(:send,
          s(:send,
            s(:begin,
              s(:send,
                s(:lvar, :i), :+,
                s(:int, 1))), :%,
            s(:int, 5)), :==,
          s(:int, 0)),
        s(:send, nil, :puts), nil))),
  s(:send, nil, :puts),
  s(:send, nil, :puts),
  s(:lvasgn, :alg,
    s(:or,
      s(:send,
        s(:const, nil, :ARGV), :shift),
      s(:send,
        s(:send, nil, :ciphers), :first))),
  s(:lvasgn, :pass,
    s(:str, "secret password")),
  s(:lvasgn, :salt,
    s(:str, "8 octets")),
  s(:lvasgn, :text,
    s(:str, "abcdefghijklmnopqrstuvwxyz")),
  s(:send, nil, :crypt_by_password,
    s(:lvar, :alg),
    s(:lvar, :pass),
    s(:lvar, :salt),
    s(:lvar, :text)))
