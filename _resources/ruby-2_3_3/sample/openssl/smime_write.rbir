s(:begin,
  s(:send, nil, :require,
    s(:str, "openssl")),
  s(:send, nil, :require,
    s(:str, "optparse")),
  s(:send, nil, :include,
    s(:const, nil, :OpenSSL)),
  s(:lvasgn, :options,
    s(:send,
      s(:const, nil, :ARGV), :getopts,
      s(:str, "c:k:r:"))),
  s(:lvasgn, :cert_file,
    s(:send,
      s(:lvar, :options), :[],
      s(:str, "c"))),
  s(:lvasgn, :key_file,
    s(:send,
      s(:lvar, :options), :[],
      s(:str, "k"))),
  s(:lvasgn, :rcpt_file,
    s(:send,
      s(:lvar, :options), :[],
      s(:str, "r"))),
  s(:lvasgn, :cert,
    s(:send,
      s(:const,
        s(:const, nil, :X509), :Certificate), :new,
      s(:send,
        s(:const, nil, :File), :read,
        s(:lvar, :cert_file)))),
  s(:lvasgn, :key,
    s(:send,
      s(:const,
        s(:const, nil, :PKey), :RSA), :new,
      s(:send,
        s(:const, nil, :File), :read,
        s(:lvar, :key_file)))),
  s(:lvasgn, :data,
    s(:str, "Content-Type: text/plain\r\n")),
  s(:send,
    s(:lvar, :data), :<<,
    s(:str, "\r\n")),
  s(:send,
    s(:lvar, :data), :<<,
    s(:str, "This is a clear-signed message.\r\n")),
  s(:lvasgn, :p7sig,
    s(:send,
      s(:const, nil, :PKCS7), :sign,
      s(:lvar, :cert),
      s(:lvar, :key),
      s(:lvar, :data),
      s(:array),
      s(:const,
        s(:const, nil, :PKCS7), :DETACHED))),
  s(:lvasgn, :smime0,
    s(:send,
      s(:const, nil, :PKCS7), :write_smime,
      s(:lvar, :p7sig))),
  s(:lvasgn, :rcpt,
    s(:send,
      s(:const,
        s(:const, nil, :X509), :Certificate), :new,
      s(:send,
        s(:const, nil, :File), :read,
        s(:lvar, :rcpt_file)))),
  s(:lvasgn, :p7enc,
    s(:send,
      s(:const, nil, :PKCS7), :encrypt,
      s(:array,
        s(:lvar, :rcpt)),
      s(:lvar, :smime0))),
  s(:send, nil, :print,
    s(:send,
      s(:const, nil, :PKCS7), :write_smime,
      s(:lvar, :p7enc))))
