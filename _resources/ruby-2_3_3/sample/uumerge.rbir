s(:begin,
  s(:if,
    s(:send,
      s(:send,
        s(:const, nil, :ARGV), :[],
        s(:int, 0)), :==,
      s(:str, "-c")),
    s(:begin,
      s(:lvasgn, :out_stdout,
        s(:int, 1)),
      s(:send,
        s(:const, nil, :ARGV), :shift)), nil),
  s(:gvasgn, :$sawbegin,
    s(:int, 0)),
  s(:gvasgn, :$sawend,
    s(:int, 0)),
  s(:while,
    s(:lvasgn, :line,
      s(:send, nil, :gets)),
    s(:if,
      s(:match_with_lvasgn,
        s(:regexp,
          s(:str, "^begin\\s*(\\d*)\\s*(\\S*)"),
          s(:regopt)),
        s(:lvar, :line)),
      s(:begin,
        s(:masgn,
          s(:mlhs,
            s(:gvasgn, :$mode),
            s(:gvasgn, :$file)),
          s(:array,
            s(:nth_ref, 1),
            s(:nth_ref, 2))),
        s(:op_asgn,
          s(:gvasgn, :$sawbegin), :+,
          s(:int, 1)),
        s(:if,
          s(:lvar, :out_stdout),
          s(:lvasgn, :out,
            s(:const, nil, :STDOUT)),
          s(:if,
            s(:send,
              s(:gvar, :$file), :!=,
              s(:str, "")),
            s(:lvasgn, :out,
              s(:send, nil, :open,
                s(:gvar, :$file),
                s(:str, "w"))), nil)),
        s(:send,
          s(:lvar, :out), :binmode),
        s(:break)), nil)),
  s(:if,
    s(:gvar, :$sawbegin), nil,
    s(:send, nil, :raise,
      s(:str, "missing begin"))),
  s(:send,
    s(:lvar, :out), :binmode),
  s(:while,
    s(:lvasgn, :line,
      s(:send, nil, :gets)),
    s(:begin,
      s(:if,
        s(:match_with_lvasgn,
          s(:regexp,
            s(:str, "^end"),
            s(:regopt)),
          s(:lvar, :line)),
        s(:begin,
          s(:op_asgn,
            s(:gvasgn, :$sawend), :+,
            s(:int, 1)),
          s(:if,
            s(:lvar, :out_stdout), nil,
            s(:send,
              s(:lvar, :out), :close)),
          s(:if,
            s(:lvar, :out_stdout), nil,
            s(:send,
              s(:const, nil, :File), :chmod,
              s(:send,
                s(:gvar, :$mode), :oct),
              s(:gvar, :$file))),
          s(:next)), nil),
      s(:send,
        s(:lvar, :line), :sub!,
        s(:regexp,
          s(:str, "[a-z]+$"),
          s(:regopt)),
        s(:str, "")),
      s(:if,
        s(:match_with_lvasgn,
          s(:regexp,
            s(:str, "[a-z]"),
            s(:regopt)),
          s(:lvar, :line)),
        s(:next), nil),
      s(:if,
        s(:send,
          s(:begin,
            s(:send,
              s(:send,
                s(:begin,
                  s(:send,
                    s(:begin,
                      s(:send,
                        s(:begin,
                          s(:send,
                            s(:send,
                              s(:gvar, :$_), :[],
                              s(:int, 0)), :-,
                            s(:int, 32))), :&,
                        s(:int, 63))), :+,
                    s(:int, 2))), :/,
                s(:int, 3)), :==,
              s(:send,
                s(:send,
                  s(:gvar, :$_), :length), :/,
                s(:int, 4)))), :!),
        s(:next), nil),
      s(:if,
        s(:send,
          s(:gvar, :$sawbegin), :>,
          s(:gvar, :$sawend)),
        s(:send,
          s(:lvar, :out), :<<,
          s(:send,
            s(:gvar, :$_), :unpack,
            s(:str, "u"))), nil))),
  s(:if,
    s(:send,
      s(:gvar, :$sawbegin), :>,
      s(:gvar, :$sawend)),
    s(:send, nil, :raise,
      s(:str, "missing end")), nil),
  s(:if,
    s(:send,
      s(:gvar, :$sawbegin), :!),
    s(:send, nil, :raise,
      s(:str, "missing begin")), nil),
  s(:send, nil, :exit,
    s(:int, 0)))
