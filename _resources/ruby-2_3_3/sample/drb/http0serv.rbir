s(:begin,
  s(:send, nil, :require,
    s(:str, "webrick")),
  s(:send, nil, :require,
    s(:str, "drb/drb")),
  s(:send, nil, :require,
    s(:str, "drb/http0")),
  s(:send, nil, :require,
    s(:str, "thread")),
  s(:module,
    s(:const, nil, :DRb),
    s(:module,
      s(:const, nil, :HTTP0),
      s(:begin,
        s(:defs,
          s(:self), :open_server,
          s(:args,
            s(:arg, :uri),
            s(:arg, :config)),
          s(:begin,
            s(:if,
              s(:match_with_lvasgn,
                s(:regexp,
                  s(:str, "^http:"),
                  s(:regopt)),
                s(:lvar, :uri)), nil,
              s(:begin,
                s(:if,
                  s(:send,
                    s(:lvar, :uri), :=~,
                    s(:regexp,
                      s(:str, "^http:"),
                      s(:regopt))), nil,
                  s(:send, nil, :raise,
                    s(:const, nil, :DRbBadScheme),
                    s(:lvar, :uri))),
                s(:send, nil, :raise,
                  s(:const, nil, :DRbBadURI),
                  s(:send,
                    s(:str, "can't parse uri:"), :+,
                    s(:lvar, :uri))))),
            s(:send,
              s(:const, nil, :Server), :new,
              s(:lvar, :uri),
              s(:lvar, :config)))),
        s(:class,
          s(:const, nil, :Callback),
          s(:const,
            s(:const,
              s(:const, nil, :WEBrick), :HTTPServlet), :AbstractServlet),
          s(:begin,
            s(:def, :initialize,
              s(:args,
                s(:arg, :config),
                s(:arg, :drb)),
              s(:begin,
                s(:ivasgn, :@config,
                  s(:lvar, :config)),
                s(:ivasgn, :@drb,
                  s(:lvar, :drb)),
                s(:ivasgn, :@queue,
                  s(:send,
                    s(:const, nil, :Queue), :new)))),
            s(:def, :do_POST,
              s(:args,
                s(:arg, :req),
                s(:arg, :res)),
              s(:begin,
                s(:ivasgn, :@req,
                  s(:lvar, :req)),
                s(:ivasgn, :@res,
                  s(:lvar, :res)),
                s(:send,
                  s(:ivar, :@drb), :push,
                  s(:self)),
                s(:send,
                  s(:ivar, :@res), :body=,
                  s(:send,
                    s(:ivar, :@queue), :pop)),
                s(:send,
                  s(:ivar, :@res), :[]=,
                  s(:str, "content-type"),
                  s(:str, "application/octet-stream;")))),
            s(:def, :req_body,
              s(:args),
              s(:send,
                s(:ivar, :@req), :body)),
            s(:def, :reply,
              s(:args,
                s(:arg, :body)),
              s(:send,
                s(:ivar, :@queue), :push,
                s(:lvar, :body))),
            s(:def, :close,
              s(:args),
              s(:send,
                s(:ivar, :@queue), :push,
                s(:str, ""))))),
        s(:class,
          s(:const, nil, :Server), nil,
          s(:begin,
            s(:def, :initialize,
              s(:args,
                s(:arg, :uri),
                s(:arg, :config)),
              s(:begin,
                s(:ivasgn, :@uri,
                  s(:lvar, :uri)),
                s(:ivasgn, :@config,
                  s(:lvar, :config)),
                s(:ivasgn, :@queue,
                  s(:send,
                    s(:const, nil, :Queue), :new)),
                s(:send, nil, :setup_webrick,
                  s(:lvar, :uri)))),
            s(:send, nil, :attr_reader,
              s(:sym, :uri)),
            s(:def, :close,
              s(:args),
              s(:begin,
                s(:if,
                  s(:ivar, :@server),
                  s(:send,
                    s(:ivar, :@server), :shutdown), nil),
                s(:ivasgn, :@server,
                  s(:nil)))),
            s(:def, :push,
              s(:args,
                s(:arg, :callback)),
              s(:send,
                s(:ivar, :@queue), :push,
                s(:lvar, :callback))),
            s(:def, :accept,
              s(:args),
              s(:begin,
                s(:lvasgn, :client,
                  s(:send,
                    s(:ivar, :@queue), :pop)),
                s(:send,
                  s(:const, nil, :ServerSide), :new,
                  s(:lvar, :client),
                  s(:ivar, :@config)))),
            s(:def, :setup_webrick,
              s(:args,
                s(:arg, :uri)),
              s(:begin,
                s(:lvasgn, :logger,
                  s(:send,
                    s(:const,
                      s(:const, nil, :WEBrick), :Log), :new,
                    s(:gvar, :$stderr),
                    s(:const,
                      s(:const,
                        s(:const, nil, :WEBrick), :Log), :FATAL))),
                s(:lvasgn, :u,
                  s(:send,
                    s(:const, nil, :URI), :parse,
                    s(:lvar, :uri))),
                s(:lvasgn, :s,
                  s(:send,
                    s(:const,
                      s(:const, nil, :WEBrick), :HTTPServer), :new,
                    s(:hash,
                      s(:pair,
                        s(:sym, :Port),
                        s(:send,
                          s(:lvar, :u), :port)),
                      s(:pair,
                        s(:sym, :AddressFamily),
                        s(:const,
                          s(:const, nil, :Socket), :AF_INET)),
                      s(:pair,
                        s(:sym, :BindAddress),
                        s(:send,
                          s(:lvar, :u), :host)),
                      s(:pair,
                        s(:sym, :Logger),
                        s(:lvar, :logger)),
                      s(:pair,
                        s(:sym, :ServerType),
                        s(:const, nil, :Thread))))),
                s(:send,
                  s(:lvar, :s), :mount,
                  s(:send,
                    s(:lvar, :u), :path),
                  s(:const, nil, :Callback),
                  s(:self)),
                s(:ivasgn, :@server,
                  s(:lvar, :s)),
                s(:send,
                  s(:lvar, :s), :start))))),
        s(:class,
          s(:const, nil, :ServerSide), nil,
          s(:begin,
            s(:def, :initialize,
              s(:args,
                s(:arg, :callback),
                s(:arg, :config)),
              s(:begin,
                s(:ivasgn, :@callback,
                  s(:lvar, :callback)),
                s(:ivasgn, :@config,
                  s(:lvar, :config)),
                s(:ivasgn, :@msg,
                  s(:send,
                    s(:const, nil, :DRbMessage), :new,
                    s(:ivar, :@config))),
                s(:ivasgn, :@req_stream,
                  s(:send,
                    s(:const, nil, :StrStream), :new,
                    s(:send,
                      s(:ivar, :@callback), :req_body))))),
            s(:def, :close,
              s(:args),
              s(:begin,
                s(:if,
                  s(:ivar, :@callback),
                  s(:send,
                    s(:ivar, :@callback), :close), nil),
                s(:ivasgn, :@callback,
                  s(:nil)))),
            s(:def, :alive?,
              s(:args),
              s(:false)),
            s(:def, :recv_request,
              s(:args),
              s(:kwbegin,
                s(:rescue,
                  s(:send,
                    s(:ivar, :@msg), :recv_request,
                    s(:ivar, :@req_stream)),
                  s(:resbody, nil, nil,
                    s(:begin,
                      s(:send, nil, :close),
                      s(:send, nil, :raise,
                        s(:gvar, :$!)))), nil))),
            s(:def, :send_reply,
              s(:args,
                s(:arg, :succ),
                s(:arg, :result)),
              s(:kwbegin,
                s(:rescue,
                  s(:begin,
                    s(:if,
                      s(:ivar, :@callback), nil,
                      s(:return)),
                    s(:lvasgn, :stream,
                      s(:send,
                        s(:const, nil, :StrStream), :new)),
                    s(:send,
                      s(:ivar, :@msg), :send_reply,
                      s(:lvar, :stream),
                      s(:lvar, :succ),
                      s(:lvar, :result)),
                    s(:send,
                      s(:ivar, :@callback), :reply,
                      s(:send,
                        s(:lvar, :stream), :buf))),
                  s(:resbody, nil, nil,
                    s(:begin,
                      s(:send, nil, :close),
                      s(:send, nil, :raise,
                        s(:gvar, :$!)))), nil)))))))))
