s(:begin,
  s(:casgn, nil, :CBREAK,
    s(:int, 2)),
  s(:casgn, nil, :ECHO,
    s(:int, 8)),
  s(:casgn, nil, :TIOCGETP,
    s(:int, 1074164744)),
  s(:casgn, nil, :TIOCSETP,
    s(:int, 2147906569)),
  s(:def, :cbreak,
    s(:args),
    s(:send, nil, :set_cbreak,
      s(:true))),
  s(:def, :cooked,
    s(:args),
    s(:send, nil, :set_cbreak,
      s(:false))),
  s(:def, :set_cbreak,
    s(:args,
      s(:arg, :on)),
    s(:begin,
      s(:lvasgn, :tty,
        s(:send,
          s(:str, "\u0000"), :*,
          s(:int, 256))),
      s(:send,
        s(:const, nil, :STDIN), :ioctl,
        s(:const, nil, :TIOCGETP),
        s(:lvar, :tty)),
      s(:lvasgn, :ttys,
        s(:send,
          s(:lvar, :tty), :unpack,
          s(:str, "C4 S"))),
      s(:if,
        s(:lvar, :on),
        s(:begin,
          s(:op_asgn,
            s(:send,
              s(:lvar, :ttys), :[],
              s(:int, 4)), :|,
            s(:const, nil, :CBREAK)),
          s(:op_asgn,
            s(:send,
              s(:lvar, :ttys), :[],
              s(:int, 4)), :&,
            s(:send,
              s(:const, nil, :ECHO), :~))),
        s(:begin,
          s(:op_asgn,
            s(:send,
              s(:lvar, :ttys), :[],
              s(:int, 4)), :&,
            s(:send,
              s(:const, nil, :CBREAK), :~)),
          s(:op_asgn,
            s(:send,
              s(:lvar, :ttys), :[],
              s(:int, 4)), :|,
            s(:const, nil, :ECHO)))),
      s(:lvasgn, :tty,
        s(:send,
          s(:lvar, :ttys), :pack,
          s(:str, "C4 S"))),
      s(:send,
        s(:const, nil, :STDIN), :ioctl,
        s(:const, nil, :TIOCSETP),
        s(:lvar, :tty)))),
  s(:send, nil, :cbreak),
  s(:send, nil, :print,
    s(:str, "this is no-echo line: ")),
  s(:send,
    s(:send, nil, :readline), :print),
  s(:send, nil, :cooked),
  s(:send, nil, :print,
    s(:str, "this is echo line: ")),
  s(:send, nil, :readline))
