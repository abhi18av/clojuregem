s(:class,
  s(:const, nil, :Shell), nil,
  s(:class,
    s(:const, nil, :Filter), nil,
    s(:begin,
      s(:send, nil, :include,
        s(:const, nil, :Enumerable)),
      s(:def, :initialize,
        s(:args,
          s(:arg, :sh)),
        s(:begin,
          s(:ivasgn, :@shell,
            s(:lvar, :sh)),
          s(:ivasgn, :@input,
            s(:nil)))),
      s(:send, nil, :attr_reader,
        s(:sym, :input)),
      s(:def, :input=,
        s(:args,
          s(:arg, :filter)),
        s(:ivasgn, :@input,
          s(:lvar, :filter))),
      s(:def, :each,
        s(:args,
          s(:optarg, :rs,
            s(:nil))),
        s(:begin,
          s(:if,
            s(:lvar, :rs), nil,
            s(:lvasgn, :rs,
              s(:send,
                s(:ivar, :@shell), :record_separator))),
          s(:if,
            s(:ivar, :@input),
            s(:block,
              s(:send,
                s(:ivar, :@input), :each,
                s(:lvar, :rs)),
              s(:args,
                s(:arg, :l)),
              s(:yield,
                s(:lvar, :l))), nil))),
      s(:def, :<,
        s(:args,
          s(:arg, :src)),
        s(:case,
          s(:lvar, :src),
          s(:when,
            s(:const, nil, :String),
            s(:begin,
              s(:lvasgn, :cat,
                s(:send,
                  s(:const, nil, :Cat), :new,
                  s(:ivar, :@shell),
                  s(:lvar, :src))),
              s(:send,
                s(:lvar, :cat), :|,
                s(:self)))),
          s(:when,
            s(:const, nil, :IO),
            s(:begin,
              s(:send,
                s(:self), :input=,
                s(:lvar, :src)),
              s(:self))),
          s(:send,
            s(:const, nil, :Shell), :Fail,
            s(:const,
              s(:const, nil, :Error), :CantApplyMethod),
            s(:str, "<"),
            s(:send,
              s(:send, nil, :to), :class)))),
      s(:def, :>,
        s(:args,
          s(:arg, :to)),
        s(:begin,
          s(:case,
            s(:lvar, :to),
            s(:when,
              s(:const, nil, :String),
              s(:begin,
                s(:lvasgn, :dst,
                  s(:send,
                    s(:ivar, :@shell), :open,
                    s(:lvar, :to),
                    s(:str, "w"))),
                s(:kwbegin,
                  s(:ensure,
                    s(:block,
                      s(:send, nil, :each),
                      s(:args,
                        s(:arg, :l)),
                      s(:send,
                        s(:lvar, :dst), :<<,
                        s(:lvar, :l))),
                    s(:send,
                      s(:lvar, :dst), :close))))),
            s(:when,
              s(:const, nil, :IO),
              s(:block,
                s(:send, nil, :each),
                s(:args,
                  s(:arg, :l)),
                s(:send,
                  s(:lvar, :to), :<<,
                  s(:lvar, :l)))),
            s(:send,
              s(:const, nil, :Shell), :Fail,
              s(:const,
                s(:const, nil, :Error), :CantApplyMethod),
              s(:str, ">"),
              s(:send,
                s(:lvar, :to), :class))),
          s(:self))),
      s(:def, :>>,
        s(:args,
          s(:arg, :to)),
        s(:kwbegin,
          s(:rescue,
            s(:send,
              s(:send,
                s(:const, nil, :Shell), :cd,
                s(:send,
                  s(:ivar, :@shell), :pwd)), :append,
              s(:lvar, :to),
              s(:self)),
            s(:resbody,
              s(:array,
                s(:const, nil, :CantApplyMethod)), nil,
              s(:send,
                s(:const, nil, :Shell), :Fail,
                s(:const,
                  s(:const, nil, :Error), :CantApplyMethod),
                s(:str, ">>"),
                s(:send,
                  s(:lvar, :to), :class))), nil))),
      s(:def, :|,
        s(:args,
          s(:arg, :filter)),
        s(:begin,
          s(:send,
            s(:lvar, :filter), :input=,
            s(:self)),
          s(:if,
            s(:send, nil, :active?),
            s(:send,
              s(:send,
                s(:ivar, :@shell), :process_controller), :start_job,
              s(:lvar, :filter)), nil),
          s(:lvar, :filter))),
      s(:def, :+,
        s(:args,
          s(:arg, :filter)),
        s(:send,
          s(:const, nil, :Join), :new,
          s(:ivar, :@shell),
          s(:self),
          s(:lvar, :filter))),
      s(:def, :to_a,
        s(:args),
        s(:begin,
          s(:lvasgn, :ary,
            s(:array)),
          s(:block,
            s(:send, nil, :each),
            s(:args,
              s(:arg, :l)),
            s(:send,
              s(:lvar, :ary), :push,
              s(:lvar, :l))),
          s(:lvar, :ary))),
      s(:def, :to_s,
        s(:args),
        s(:begin,
          s(:lvasgn, :str,
            s(:str, "")),
          s(:block,
            s(:send, nil, :each),
            s(:args,
              s(:arg, :l)),
            s(:send,
              s(:lvar, :str), :concat,
              s(:lvar, :l))),
          s(:lvar, :str))),
      s(:def, :inspect,
        s(:args),
        s(:if,
          s(:and,
            s(:send,
              s(:send,
                s(:ivar, :@shell), :debug), :kind_of?,
              s(:const, nil, :Integer)),
            s(:send,
              s(:send,
                s(:ivar, :@shell), :debug), :>,
              s(:int, 2))),
          s(:zsuper),
          s(:send, nil, :to_s))))))
