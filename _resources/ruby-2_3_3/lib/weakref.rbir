s(:begin,
  s(:send, nil, :require,
    s(:str, "delegate")),
  s(:class,
    s(:const, nil, :WeakRef),
    s(:const, nil, :Delegator),
    s(:begin,
      s(:class,
        s(:const, nil, :RefError),
        s(:const, nil, :StandardError), nil),
      s(:cvasgn, :@@__map,
        s(:send,
          s(:const,
            s(:const,
              s(:cbase), :ObjectSpace), :WeakMap), :new)),
      s(:def, :initialize,
        s(:args,
          s(:arg, :orig)),
        s(:begin,
          s(:case,
            s(:lvar, :orig),
            s(:when,
              s(:true),
              s(:false),
              s(:nil),
              s(:ivasgn, :@delegate_sd_obj,
                s(:lvar, :orig))),
            s(:send,
              s(:cvar, :@@__map), :[]=,
              s(:self),
              s(:lvar, :orig))),
          s(:zsuper))),
      s(:def, :__getobj__,
        s(:args),
        s(:or,
          s(:send,
            s(:cvar, :@@__map), :[],
            s(:self)),
          s(:if,
            s(:defined?,
              s(:ivar, :@delegate_sd_obj)),
            s(:ivar, :@delegate_sd_obj),
            s(:send,
              s(:const, nil, :Kernel), :raise,
              s(:const, nil, :RefError),
              s(:str, "Invalid Reference - probably recycled"),
              s(:send,
                s(:const, nil, :Kernel), :caller,
                s(:int, 2)))))),
      s(:def, :__setobj__,
        s(:args,
          s(:arg, :obj)), nil),
      s(:def, :weakref_alive?,
        s(:args),
        s(:or,
          s(:send,
            s(:cvar, :@@__map), :key?,
            s(:self)),
          s(:defined?,
            s(:ivar, :@delegate_sd_obj)))))))
