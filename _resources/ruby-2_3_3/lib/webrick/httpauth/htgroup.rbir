s(:begin,
  s(:send, nil, :require,
    s(:str, "tempfile")),
  s(:module,
    s(:const, nil, :WEBrick),
    s(:module,
      s(:const, nil, :HTTPAuth),
      s(:class,
        s(:const, nil, :Htgroup), nil,
        s(:begin,
          s(:def, :initialize,
            s(:args,
              s(:arg, :path)),
            s(:begin,
              s(:ivasgn, :@path,
                s(:lvar, :path)),
              s(:ivasgn, :@mtime,
                s(:send,
                  s(:const, nil, :Time), :at,
                  s(:int, 0))),
              s(:ivasgn, :@group,
                s(:send,
                  s(:const, nil, :Hash), :new)),
              s(:if,
                s(:send,
                  s(:const, nil, :File), :exist?,
                  s(:ivar, :@path)), nil,
                s(:send,
                  s(:send, nil, :open,
                    s(:ivar, :@path),
                    s(:str, "a")), :close)),
              s(:send, nil, :reload))),
          s(:def, :reload,
            s(:args),
            s(:if,
              s(:send,
                s(:begin,
                  s(:lvasgn, :mtime,
                    s(:send,
                      s(:const, nil, :File), :mtime,
                      s(:ivar, :@path)))), :>,
                s(:ivar, :@mtime)),
              s(:begin,
                s(:send,
                  s(:ivar, :@group), :clear),
                s(:block,
                  s(:send, nil, :open,
                    s(:ivar, :@path)),
                  s(:args,
                    s(:arg, :io)),
                  s(:while,
                    s(:lvasgn, :line,
                      s(:send,
                        s(:lvar, :io), :gets)),
                    s(:begin,
                      s(:send,
                        s(:lvar, :line), :chomp!),
                      s(:masgn,
                        s(:mlhs,
                          s(:lvasgn, :group),
                          s(:lvasgn, :members)),
                        s(:send,
                          s(:lvar, :line), :split,
                          s(:regexp,
                            s(:str, ":\\s*"),
                            s(:regopt)))),
                      s(:send,
                        s(:ivar, :@group), :[]=,
                        s(:lvar, :group),
                        s(:send,
                          s(:lvar, :members), :split,
                          s(:regexp,
                            s(:str, "\\s+"),
                            s(:regopt))))))),
                s(:ivasgn, :@mtime,
                  s(:lvar, :mtime))), nil)),
          s(:def, :flush,
            s(:args,
              s(:optarg, :output,
                s(:nil))),
            s(:begin,
              s(:or_asgn,
                s(:lvasgn, :output),
                s(:ivar, :@path)),
              s(:lvasgn, :tmp,
                s(:send,
                  s(:const, nil, :Tempfile), :new,
                  s(:str, "htgroup"),
                  s(:send,
                    s(:const, nil, :File), :dirname,
                    s(:lvar, :output)))),
              s(:kwbegin,
                s(:rescue,
                  s(:begin,
                    s(:block,
                      s(:send,
                        s(:send,
                          s(:send,
                            s(:ivar, :@group), :keys), :sort), :each),
                      s(:args,
                        s(:arg, :group)),
                      s(:send,
                        s(:lvar, :tmp), :puts,
                        s(:send, nil, :format,
                          s(:str, "%s: %s"),
                          s(:lvar, :group),
                          s(:send,
                            s(:send,
                              s(:self), :members,
                              s(:lvar, :group)), :join,
                            s(:str, " "))))),
                    s(:send,
                      s(:lvar, :tmp), :close),
                    s(:send,
                      s(:const, nil, :File), :rename,
                      s(:send,
                        s(:lvar, :tmp), :path),
                      s(:lvar, :output))),
                  s(:resbody, nil, nil,
                    s(:send,
                      s(:lvar, :tmp), :close,
                      s(:true))), nil)))),
          s(:def, :members,
            s(:args,
              s(:arg, :group)),
            s(:begin,
              s(:send, nil, :reload),
              s(:or,
                s(:send,
                  s(:ivar, :@group), :[],
                  s(:lvar, :group)),
                s(:array)))),
          s(:def, :add,
            s(:args,
              s(:arg, :group),
              s(:arg, :members)),
            s(:send,
              s(:ivar, :@group), :[]=,
              s(:lvar, :group),
              s(:send,
                s(:send, nil, :members,
                  s(:lvar, :group)), :|,
                s(:lvar, :members)))))))))
