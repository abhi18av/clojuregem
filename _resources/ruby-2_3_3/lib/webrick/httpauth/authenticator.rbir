s(:module,
  s(:const, nil, :WEBrick),
  s(:module,
    s(:const, nil, :HTTPAuth),
    s(:begin,
      s(:module,
        s(:const, nil, :Authenticator),
        s(:begin,
          s(:casgn, nil, :RequestField,
            s(:str, "Authorization")),
          s(:casgn, nil, :ResponseField,
            s(:str, "WWW-Authenticate")),
          s(:casgn, nil, :ResponseInfoField,
            s(:str, "Authentication-Info")),
          s(:casgn, nil, :AuthException,
            s(:const,
              s(:const, nil, :HTTPStatus), :Unauthorized)),
          s(:casgn, nil, :AuthScheme,
            s(:nil)),
          s(:send, nil, :attr_reader,
            s(:sym, :realm)),
          s(:send, nil, :attr_reader,
            s(:sym, :userdb)),
          s(:send, nil, :attr_reader,
            s(:sym, :logger)),
          s(:send, nil, :private),
          s(:def, :check_init,
            s(:args,
              s(:arg, :config)),
            s(:begin,
              s(:block,
                s(:send,
                  s(:array,
                    s(:sym, :UserDB),
                    s(:sym, :Realm)), :each),
                s(:args,
                  s(:arg, :sym)),
                s(:if,
                  s(:send,
                    s(:lvar, :config), :[],
                    s(:lvar, :sym)), nil,
                  s(:send, nil, :raise,
                    s(:const, nil, :ArgumentError),
                    s(:dstr,
                      s(:str, "Argument "),
                      s(:begin,
                        s(:send,
                          s(:lvar, :sym), :inspect)),
                      s(:str, " missing."))))),
              s(:ivasgn, :@realm,
                s(:send,
                  s(:lvar, :config), :[],
                  s(:sym, :Realm))),
              s(:ivasgn, :@userdb,
                s(:send,
                  s(:lvar, :config), :[],
                  s(:sym, :UserDB))),
              s(:ivasgn, :@logger,
                s(:or,
                  s(:send,
                    s(:lvar, :config), :[],
                    s(:sym, :Logger)),
                  s(:send,
                    s(:const, nil, :Log), :new,
                    s(:gvar, :$stderr)))),
              s(:ivasgn, :@reload_db,
                s(:send,
                  s(:lvar, :config), :[],
                  s(:sym, :AutoReloadUserDB))),
              s(:ivasgn, :@request_field,
                s(:const,
                  s(:send,
                    s(:self), :class), :RequestField)),
              s(:ivasgn, :@response_field,
                s(:const,
                  s(:send,
                    s(:self), :class), :ResponseField)),
              s(:ivasgn, :@resp_info_field,
                s(:const,
                  s(:send,
                    s(:self), :class), :ResponseInfoField)),
              s(:ivasgn, :@auth_exception,
                s(:const,
                  s(:send,
                    s(:self), :class), :AuthException)),
              s(:ivasgn, :@auth_scheme,
                s(:const,
                  s(:send,
                    s(:self), :class), :AuthScheme)))),
          s(:def, :check_scheme,
            s(:args,
              s(:arg, :req)),
            s(:begin,
              s(:if,
                s(:lvasgn, :credentials,
                  s(:send,
                    s(:lvar, :req), :[],
                    s(:ivar, :@request_field))), nil,
                s(:begin,
                  s(:send, nil, :error,
                    s(:str, "no credentials in the request.")),
                  s(:return,
                    s(:nil)))),
              s(:if,
                s(:lvasgn, :match,
                  s(:send,
                    s(:regexp,
                      s(:str, "^"),
                      s(:begin,
                        s(:ivar, :@auth_scheme)),
                      s(:str, "\\s+"),
                      s(:regopt, :i)), :match,
                    s(:lvar, :credentials))), nil,
                s(:begin,
                  s(:send, nil, :error,
                    s(:str, "invalid scheme in %s."),
                    s(:lvar, :credentials)),
                  s(:if,
                    s(:gvar, :$DEBUG),
                    s(:send, nil, :info,
                      s(:str, "%s: %s"),
                      s(:ivar, :@request_field),
                      s(:lvar, :credentials)), nil),
                  s(:return,
                    s(:nil)))),
              s(:return,
                s(:send,
                  s(:lvar, :match), :post_match)))),
          s(:def, :log,
            s(:args,
              s(:arg, :meth),
              s(:arg, :fmt),
              s(:restarg, :args)),
            s(:begin,
              s(:lvasgn, :msg,
                s(:send, nil, :format,
                  s(:str, "%s %s: "),
                  s(:ivar, :@auth_scheme),
                  s(:ivar, :@realm))),
              s(:send,
                s(:lvar, :msg), :<<,
                s(:send,
                  s(:lvar, :fmt), :%,
                  s(:lvar, :args))),
              s(:send,
                s(:ivar, :@logger), :send,
                s(:lvar, :meth),
                s(:lvar, :msg)))),
          s(:def, :error,
            s(:args,
              s(:arg, :fmt),
              s(:restarg, :args)),
            s(:if,
              s(:send,
                s(:ivar, :@logger), :error?),
              s(:send, nil, :log,
                s(:sym, :error),
                s(:lvar, :fmt),
                s(:splat,
                  s(:lvar, :args))), nil)),
          s(:def, :info,
            s(:args,
              s(:arg, :fmt),
              s(:restarg, :args)),
            s(:if,
              s(:send,
                s(:ivar, :@logger), :info?),
              s(:send, nil, :log,
                s(:sym, :info),
                s(:lvar, :fmt),
                s(:splat,
                  s(:lvar, :args))), nil)))),
      s(:module,
        s(:const, nil, :ProxyAuthenticator),
        s(:begin,
          s(:casgn, nil, :RequestField,
            s(:str, "Proxy-Authorization")),
          s(:casgn, nil, :ResponseField,
            s(:str, "Proxy-Authenticate")),
          s(:casgn, nil, :InfoField,
            s(:str, "Proxy-Authentication-Info")),
          s(:casgn, nil, :AuthException,
            s(:const,
              s(:const, nil, :HTTPStatus), :ProxyAuthenticationRequired)))))))
