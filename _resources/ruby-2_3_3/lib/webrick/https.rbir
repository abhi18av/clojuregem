s(:begin,
  s(:send, nil, :require,
    s(:str, "webrick/ssl")),
  s(:module,
    s(:const, nil, :WEBrick),
    s(:begin,
      s(:module,
        s(:const, nil, :Config),
        s(:send,
          s(:const, nil, :HTTP), :update,
          s(:const, nil, :SSL))),
      s(:class,
        s(:const, nil, :HTTPRequest), nil,
        s(:begin,
          s(:send, nil, :attr_reader,
            s(:sym, :cipher)),
          s(:send, nil, :attr_reader,
            s(:sym, :server_cert)),
          s(:send, nil, :attr_reader,
            s(:sym, :client_cert)),
          s(:alias,
            s(:sym, :orig_parse),
            s(:sym, :parse)),
          s(:def, :parse,
            s(:args,
              s(:optarg, :socket,
                s(:nil))),
            s(:begin,
              s(:if,
                s(:send,
                  s(:lvar, :socket), :respond_to?,
                  s(:sym, :cert)),
                s(:begin,
                  s(:ivasgn, :@server_cert,
                    s(:or,
                      s(:send,
                        s(:lvar, :socket), :cert),
                      s(:send,
                        s(:ivar, :@config), :[],
                        s(:sym, :SSLCertificate)))),
                  s(:ivasgn, :@client_cert,
                    s(:send,
                      s(:lvar, :socket), :peer_cert)),
                  s(:ivasgn, :@client_cert_chain,
                    s(:send,
                      s(:lvar, :socket), :peer_cert_chain)),
                  s(:ivasgn, :@cipher,
                    s(:send,
                      s(:lvar, :socket), :cipher))), nil),
              s(:send, nil, :orig_parse,
                s(:lvar, :socket)))),
          s(:alias,
            s(:sym, :orig_parse_uri),
            s(:sym, :parse_uri)),
          s(:def, :parse_uri,
            s(:args,
              s(:arg, :str),
              s(:optarg, :scheme,
                s(:str, "https"))),
            s(:begin,
              s(:if,
                s(:send, nil, :server_cert),
                s(:return,
                  s(:send, nil, :orig_parse_uri,
                    s(:lvar, :str),
                    s(:lvar, :scheme))), nil),
              s(:return,
                s(:send, nil, :orig_parse_uri,
                  s(:lvar, :str))))),
          s(:send, nil, :private,
            s(:sym, :parse_uri)),
          s(:alias,
            s(:sym, :orig_meta_vars),
            s(:sym, :meta_vars)),
          s(:def, :meta_vars,
            s(:args),
            s(:begin,
              s(:lvasgn, :meta,
                s(:send, nil, :orig_meta_vars)),
              s(:if,
                s(:send, nil, :server_cert),
                s(:begin,
                  s(:send,
                    s(:lvar, :meta), :[]=,
                    s(:str, "HTTPS"),
                    s(:str, "on")),
                  s(:send,
                    s(:lvar, :meta), :[]=,
                    s(:str, "SSL_SERVER_CERT"),
                    s(:send,
                      s(:ivar, :@server_cert), :to_pem)),
                  s(:send,
                    s(:lvar, :meta), :[]=,
                    s(:str, "SSL_CLIENT_CERT"),
                    s(:if,
                      s(:ivar, :@client_cert),
                      s(:send,
                        s(:ivar, :@client_cert), :to_pem),
                      s(:str, ""))),
                  s(:if,
                    s(:ivar, :@client_cert_chain),
                    s(:block,
                      s(:send,
                        s(:ivar, :@client_cert_chain), :each_with_index),
                      s(:args,
                        s(:arg, :cert),
                        s(:arg, :i)),
                      s(:send,
                        s(:lvar, :meta), :[]=,
                        s(:dstr,
                          s(:str, "SSL_CLIENT_CERT_CHAIN_"),
                          s(:begin,
                            s(:lvar, :i))),
                        s(:send,
                          s(:lvar, :cert), :to_pem))), nil),
                  s(:send,
                    s(:lvar, :meta), :[]=,
                    s(:str, "SSL_CIPHER"),
                    s(:send,
                      s(:ivar, :@cipher), :[],
                      s(:int, 0))),
                  s(:send,
                    s(:lvar, :meta), :[]=,
                    s(:str, "SSL_PROTOCOL"),
                    s(:send,
                      s(:ivar, :@cipher), :[],
                      s(:int, 1))),
                  s(:send,
                    s(:lvar, :meta), :[]=,
                    s(:str, "SSL_CIPHER_USEKEYSIZE"),
                    s(:send,
                      s(:send,
                        s(:ivar, :@cipher), :[],
                        s(:int, 2)), :to_s)),
                  s(:send,
                    s(:lvar, :meta), :[]=,
                    s(:str, "SSL_CIPHER_ALGKEYSIZE"),
                    s(:send,
                      s(:send,
                        s(:ivar, :@cipher), :[],
                        s(:int, 3)), :to_s))), nil),
              s(:lvar, :meta))))))))
