s(:begin,
  s(:send, nil, :require,
    s(:str, "webrick/httpauth/basicauth")),
  s(:send, nil, :require,
    s(:str, "webrick/httpauth/digestauth")),
  s(:send, nil, :require,
    s(:str, "webrick/httpauth/htpasswd")),
  s(:send, nil, :require,
    s(:str, "webrick/httpauth/htdigest")),
  s(:send, nil, :require,
    s(:str, "webrick/httpauth/htgroup")),
  s(:module,
    s(:const, nil, :WEBrick),
    s(:module,
      s(:const, nil, :HTTPAuth),
      s(:begin,
        s(:send, nil, :module_function),
        s(:def, :_basic_auth,
          s(:args,
            s(:arg, :req),
            s(:arg, :res),
            s(:arg, :realm),
            s(:arg, :req_field),
            s(:arg, :res_field),
            s(:arg, :err_type),
            s(:arg, :block)),
          s(:begin,
            s(:lvasgn, :user,
              s(:lvasgn, :pass,
                s(:nil))),
            s(:if,
              s(:match_with_lvasgn,
                s(:regexp,
                  s(:str, "^Basic\\s+(.*)"),
                  s(:regopt, :o)),
                s(:send,
                  s(:lvar, :req), :[],
                  s(:lvar, :req_field))),
              s(:begin,
                s(:lvasgn, :userpass,
                  s(:nth_ref, 1)),
                s(:masgn,
                  s(:mlhs,
                    s(:lvasgn, :user),
                    s(:lvasgn, :pass)),
                  s(:send,
                    s(:send,
                      s(:send,
                        s(:lvar, :userpass), :unpack,
                        s(:str, "m*")), :[],
                      s(:int, 0)), :split,
                    s(:str, ":"),
                    s(:int, 2)))), nil),
            s(:if,
              s(:send,
                s(:lvar, :block), :call,
                s(:lvar, :user),
                s(:lvar, :pass)),
              s(:begin,
                s(:send,
                  s(:lvar, :req), :user=,
                  s(:lvar, :user)),
                s(:return)), nil),
            s(:send,
              s(:lvar, :res), :[]=,
              s(:lvar, :res_field),
              s(:dstr,
                s(:str, "Basic realm=\""),
                s(:begin,
                  s(:lvar, :realm)),
                s(:str, "\""))),
            s(:send, nil, :raise,
              s(:lvar, :err_type)))),
        s(:def, :basic_auth,
          s(:args,
            s(:arg, :req),
            s(:arg, :res),
            s(:arg, :realm),
            s(:blockarg, :block)),
          s(:send, nil, :_basic_auth,
            s(:lvar, :req),
            s(:lvar, :res),
            s(:lvar, :realm),
            s(:str, "Authorization"),
            s(:str, "WWW-Authenticate"),
            s(:const,
              s(:const, nil, :HTTPStatus), :Unauthorized),
            s(:lvar, :block))),
        s(:def, :proxy_basic_auth,
          s(:args,
            s(:arg, :req),
            s(:arg, :res),
            s(:arg, :realm),
            s(:blockarg, :block)),
          s(:send, nil, :_basic_auth,
            s(:lvar, :req),
            s(:lvar, :res),
            s(:lvar, :realm),
            s(:str, "Proxy-Authorization"),
            s(:str, "Proxy-Authenticate"),
            s(:const,
              s(:const, nil, :HTTPStatus), :ProxyAuthenticationRequired),
            s(:lvar, :block)))))))
