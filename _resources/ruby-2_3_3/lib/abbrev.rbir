s(:begin,
  s(:module,
    s(:const, nil, :Abbrev),
    s(:begin,
      s(:def, :abbrev,
        s(:args,
          s(:arg, :words),
          s(:optarg, :pattern,
            s(:nil))),
        s(:begin,
          s(:lvasgn, :table,
            s(:hash)),
          s(:lvasgn, :seen,
            s(:send,
              s(:const, nil, :Hash), :new,
              s(:int, 0))),
          s(:if,
            s(:send,
              s(:lvar, :pattern), :is_a?,
              s(:const, nil, :String)),
            s(:lvasgn, :pattern,
              s(:regexp,
                s(:str, "\\A"),
                s(:begin,
                  s(:send,
                    s(:const, nil, :Regexp), :quote,
                    s(:lvar, :pattern))),
                s(:regopt))), nil),
          s(:block,
            s(:send,
              s(:lvar, :words), :each),
            s(:args,
              s(:arg, :word)),
            s(:begin,
              s(:if,
                s(:send,
                  s(:lvar, :word), :empty?),
                s(:next), nil),
              s(:block,
                s(:send,
                  s(:send,
                    s(:lvar, :word), :size), :downto,
                  s(:int, 1)),
                s(:args,
                  s(:arg, :len)),
                s(:begin,
                  s(:lvasgn, :abbrev,
                    s(:send,
                      s(:lvar, :word), :[],
                      s(:erange,
                        s(:int, 0),
                        s(:lvar, :len)))),
                  s(:if,
                    s(:and,
                      s(:lvar, :pattern),
                      s(:send,
                        s(:lvar, :pattern), :!~,
                        s(:lvar, :abbrev))),
                    s(:next), nil),
                  s(:case,
                    s(:op_asgn,
                      s(:send,
                        s(:lvar, :seen), :[],
                        s(:lvar, :abbrev)), :+,
                      s(:int, 1)),
                    s(:when,
                      s(:int, 1),
                      s(:send,
                        s(:lvar, :table), :[]=,
                        s(:lvar, :abbrev),
                        s(:lvar, :word))),
                    s(:when,
                      s(:int, 2),
                      s(:send,
                        s(:lvar, :table), :delete,
                        s(:lvar, :abbrev))),
                    s(:break)))))),
          s(:block,
            s(:send,
              s(:lvar, :words), :each),
            s(:args,
              s(:arg, :word)),
            s(:begin,
              s(:if,
                s(:and,
                  s(:lvar, :pattern),
                  s(:send,
                    s(:lvar, :pattern), :!~,
                    s(:lvar, :word))),
                s(:next), nil),
              s(:send,
                s(:lvar, :table), :[]=,
                s(:lvar, :word),
                s(:lvar, :word)))),
          s(:lvar, :table))),
      s(:send, nil, :module_function,
        s(:sym, :abbrev)))),
  s(:class,
    s(:const, nil, :Array), nil,
    s(:def, :abbrev,
      s(:args,
        s(:optarg, :pattern,
          s(:nil))),
      s(:send,
        s(:const, nil, :Abbrev), :abbrev,
        s(:self),
        s(:lvar, :pattern)))))
