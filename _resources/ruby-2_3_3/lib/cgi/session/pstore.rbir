s(:begin,
  s(:send, nil, :require,
    s(:str, "cgi/session")),
  s(:send, nil, :require,
    s(:str, "pstore")),
  s(:class,
    s(:const, nil, :CGI), nil,
    s(:class,
      s(:const, nil, :Session), nil,
      s(:class,
        s(:const, nil, :PStore), nil,
        s(:begin,
          s(:def, :initialize,
            s(:args,
              s(:arg, :session),
              s(:optarg, :option,
                s(:hash))),
            s(:begin,
              s(:lvasgn, :dir,
                s(:or,
                  s(:send,
                    s(:lvar, :option), :[],
                    s(:str, "tmpdir")),
                  s(:send,
                    s(:const, nil, :Dir), :tmpdir))),
              s(:lvasgn, :prefix,
                s(:or,
                  s(:send,
                    s(:lvar, :option), :[],
                    s(:str, "prefix")),
                  s(:str, ""))),
              s(:lvasgn, :id,
                s(:send,
                  s(:lvar, :session), :session_id)),
              s(:send, nil, :require,
                s(:str, "digest/md5")),
              s(:lvasgn, :md5,
                s(:send,
                  s(:send,
                    s(:const,
                      s(:const, nil, :Digest), :MD5), :hexdigest,
                    s(:lvar, :id)), :[],
                  s(:int, 0),
                  s(:int, 16))),
              s(:lvasgn, :path,
                s(:send,
                  s(:send,
                    s(:send,
                      s(:lvar, :dir), :+,
                      s(:str, "/")), :+,
                    s(:lvar, :prefix)), :+,
                  s(:lvar, :md5))),
              s(:send,
                s(:lvar, :path), :untaint),
              s(:if,
                s(:send,
                  s(:const, nil, :File), :exist?,
                  s(:lvar, :path)),
                s(:ivasgn, :@hash,
                  s(:nil)),
                s(:begin,
                  s(:if,
                    s(:send,
                      s(:lvar, :session), :new_session), nil,
                    s(:send, nil, :raise,
                      s(:const,
                        s(:const,
                          s(:const, nil, :CGI), :Session), :NoSession),
                      s(:str, "uninitialized session"))),
                  s(:ivasgn, :@hash,
                    s(:hash)))),
              s(:ivasgn, :@p,
                s(:send,
                  s(:const,
                    s(:cbase), :PStore), :new,
                  s(:lvar, :path))),
              s(:block,
                s(:send,
                  s(:ivar, :@p), :transaction),
                s(:args,
                  s(:arg, :p)),
                s(:send,
                  s(:const, nil, :File), :chmod,
                  s(:int, 384),
                  s(:send,
                    s(:lvar, :p), :path))))),
          s(:def, :restore,
            s(:args),
            s(:begin,
              s(:if,
                s(:ivar, :@hash), nil,
                s(:block,
                  s(:send,
                    s(:ivar, :@p), :transaction),
                  s(:args),
                  s(:ivasgn, :@hash,
                    s(:or,
                      s(:send,
                        s(:ivar, :@p), :[],
                        s(:str, "hash")),
                      s(:hash))))),
              s(:ivar, :@hash))),
          s(:def, :update,
            s(:args),
            s(:block,
              s(:send,
                s(:ivar, :@p), :transaction),
              s(:args),
              s(:send,
                s(:ivar, :@p), :[]=,
                s(:str, "hash"),
                s(:ivar, :@hash)))),
          s(:def, :close,
            s(:args),
            s(:send, nil, :update)),
          s(:def, :delete,
            s(:args),
            s(:begin,
              s(:lvasgn, :path,
                s(:send,
                  s(:ivar, :@p), :path)),
              s(:send,
                s(:const, nil, :File), :unlink,
                s(:lvar, :path)))))))))
