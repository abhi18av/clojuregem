s(:begin,
  s(:send, nil, :require,
    s(:str, "monitor")),
  s(:module,
    s(:const, nil, :Kernel),
    s(:begin,
      s(:casgn, nil, :RUBYGEMS_ACTIVATION_MONITOR,
        s(:send,
          s(:const, nil, :Monitor), :new)),
      s(:if,
        s(:defined?,
          s(:send, nil, :gem_original_require)),
        s(:send, nil, :remove_method,
          s(:sym, :require)),
        s(:begin,
          s(:alias,
            s(:sym, :gem_original_require),
            s(:sym, :require)),
          s(:send, nil, :private,
            s(:sym, :gem_original_require)))),
      s(:def, :require,
        s(:args,
          s(:arg, :path)),
        s(:rescue,
          s(:begin,
            s(:send,
              s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :enter),
            s(:if,
              s(:send,
                s(:lvar, :path), :respond_to?,
                s(:sym, :to_path)),
              s(:lvasgn, :path,
                s(:send,
                  s(:lvar, :path), :to_path)), nil),
            s(:lvasgn, :spec,
              s(:send,
                s(:const, nil, :Gem), :find_unresolved_default_spec,
                s(:lvar, :path))),
            s(:if,
              s(:lvar, :spec),
              s(:begin,
                s(:send,
                  s(:const, nil, :Gem), :remove_unresolved_default_spec,
                  s(:lvar, :spec)),
                s(:send, nil, :gem,
                  s(:send,
                    s(:lvar, :spec), :name))), nil),
            s(:if,
              s(:send,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Specification), :unresolved_deps), :empty?),
              s(:begin,
                s(:send,
                  s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :exit),
                s(:return,
                  s(:send, nil, :gem_original_require,
                    s(:lvar, :path)))), nil),
            s(:lvasgn, :spec,
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Specification), :find_active_stub_by_path,
                s(:lvar, :path))),
            s(:if,
              s(:lvar, :spec),
              s(:kwbegin,
                s(:send,
                  s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :exit),
                s(:return,
                  s(:send, nil, :gem_original_require,
                    s(:lvar, :path)))), nil),
            s(:lvasgn, :found_specs,
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Specification), :find_in_unresolved,
                s(:lvar, :path))),
            s(:if,
              s(:send,
                s(:lvar, :found_specs), :empty?),
              s(:begin,
                s(:lvasgn, :found_specs,
                  s(:send,
                    s(:const,
                      s(:const, nil, :Gem), :Specification), :find_in_unresolved_tree,
                    s(:lvar, :path))),
                s(:block,
                  s(:send,
                    s(:lvar, :found_specs), :each),
                  s(:args,
                    s(:arg, :found_spec)),
                  s(:send,
                    s(:lvar, :found_spec), :activate))),
              s(:begin,
                s(:lvasgn, :names,
                  s(:send,
                    s(:send,
                      s(:lvar, :found_specs), :map,
                      s(:block_pass,
                        s(:sym, :name))), :uniq)),
                s(:if,
                  s(:send,
                    s(:send,
                      s(:lvar, :names), :size), :>,
                    s(:int, 1)),
                  s(:begin,
                    s(:send,
                      s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :exit),
                    s(:send, nil, :raise,
                      s(:const,
                        s(:const, nil, :Gem), :LoadError),
                      s(:dstr,
                        s(:begin,
                          s(:lvar, :path)),
                        s(:str, " found in multiple gems: "),
                        s(:begin,
                          s(:send,
                            s(:lvar, :names), :join,
                            s(:str, ", ")))))), nil),
                s(:lvasgn, :valid,
                  s(:send,
                    s(:block,
                      s(:send,
                        s(:lvar, :found_specs), :reject),
                      s(:args,
                        s(:arg, :s)),
                      s(:send,
                        s(:lvar, :s), :has_conflicts?)), :last)),
                s(:if,
                  s(:lvar, :valid), nil,
                  s(:begin,
                    s(:lvasgn, :le,
                      s(:send,
                        s(:const,
                          s(:const, nil, :Gem), :LoadError), :new,
                        s(:dstr,
                          s(:str, "unable to find a version of '"),
                          s(:begin,
                            s(:send,
                              s(:lvar, :names), :first)),
                          s(:str, "' to activate")))),
                    s(:send,
                      s(:lvar, :le), :name=,
                      s(:send,
                        s(:lvar, :names), :first)),
                    s(:send,
                      s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :exit),
                    s(:send, nil, :raise,
                      s(:lvar, :le)))),
                s(:send,
                  s(:lvar, :valid), :activate))),
            s(:send,
              s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :exit),
            s(:return,
              s(:send, nil, :gem_original_require,
                s(:lvar, :path)))),
          s(:resbody,
            s(:array,
              s(:const, nil, :LoadError)),
            s(:lvasgn, :load_error),
            s(:begin,
              s(:send,
                s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :enter),
              s(:if,
                s(:or,
                  s(:send,
                    s(:send,
                      s(:lvar, :load_error), :message), :start_with?,
                    s(:str, "Could not find")),
                  s(:begin,
                    s(:and,
                      s(:send,
                        s(:send,
                          s(:lvar, :load_error), :message), :end_with?,
                        s(:lvar, :path)),
                      s(:send,
                        s(:const, nil, :Gem), :try_activate,
                        s(:lvar, :path))))),
                s(:begin,
                  s(:send,
                    s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :exit),
                  s(:return,
                    s(:send, nil, :gem_original_require,
                      s(:lvar, :path)))),
                s(:send,
                  s(:const, nil, :RUBYGEMS_ACTIVATION_MONITOR), :exit)),
              s(:send, nil, :raise,
                s(:lvar, :load_error)))), nil)),
      s(:send, nil, :private,
        s(:sym, :require)))))
