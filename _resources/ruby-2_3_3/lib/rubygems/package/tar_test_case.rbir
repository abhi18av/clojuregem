s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/test_case")),
  s(:send, nil, :require,
    s(:str, "rubygems/package")),
  s(:class,
    s(:const,
      s(:const,
        s(:const, nil, :Gem), :Package), :TarTestCase),
    s(:const,
      s(:const, nil, :Gem), :TestCase),
    s(:begin,
      s(:def, :ASCIIZ,
        s(:args,
          s(:arg, :str),
          s(:arg, :length)),
        s(:send,
          s(:lvar, :str), :+,
          s(:send,
            s(:str, "\u0000"), :*,
            s(:begin,
              s(:send,
                s(:lvar, :length), :-,
                s(:send,
                  s(:lvar, :str), :length)))))),
      s(:def, :SP,
        s(:args,
          s(:arg, :s)),
        s(:send,
          s(:lvar, :s), :+,
          s(:str, " "))),
      s(:def, :SP_Z,
        s(:args,
          s(:arg, :s)),
        s(:send,
          s(:lvar, :s), :+,
          s(:str, " \u0000"))),
      s(:def, :Z,
        s(:args,
          s(:arg, :s)),
        s(:send,
          s(:lvar, :s), :+,
          s(:str, "\u0000"))),
      s(:def, :assert_headers_equal,
        s(:args,
          s(:arg, :expected),
          s(:arg, :actual)),
        s(:begin,
          s(:if,
            s(:send,
              s(:const, nil, :String), :===,
              s(:lvar, :expected)), nil,
            s(:lvasgn, :expected,
              s(:send,
                s(:lvar, :expected), :to_s))),
          s(:if,
            s(:send,
              s(:const, nil, :String), :===,
              s(:lvar, :actual)), nil,
            s(:lvasgn, :actual,
              s(:send,
                s(:lvar, :actual), :to_s))),
          s(:lvasgn, :fields,
            s(:array,
              s(:str, "name"),
              s(:str, "100"),
              s(:str, "mode"),
              s(:str, "8"),
              s(:str, "uid"),
              s(:str, "8"),
              s(:str, "gid"),
              s(:str, "8"),
              s(:str, "size"),
              s(:str, "12"),
              s(:str, "mtime"),
              s(:str, "12"),
              s(:str, "checksum"),
              s(:str, "8"),
              s(:str, "typeflag"),
              s(:str, "1"),
              s(:str, "linkname"),
              s(:str, "100"),
              s(:str, "magic"),
              s(:str, "6"),
              s(:str, "version"),
              s(:str, "2"),
              s(:str, "uname"),
              s(:str, "32"),
              s(:str, "gname"),
              s(:str, "32"),
              s(:str, "devmajor"),
              s(:str, "8"),
              s(:str, "devminor"),
              s(:str, "8"),
              s(:str, "prefix"),
              s(:str, "155"))),
          s(:lvasgn, :offset,
            s(:int, 0)),
          s(:until,
            s(:send,
              s(:lvar, :fields), :empty?),
            s(:begin,
              s(:lvasgn, :name,
                s(:send,
                  s(:lvar, :fields), :shift)),
              s(:lvasgn, :length,
                s(:send,
                  s(:send,
                    s(:lvar, :fields), :shift), :to_i)),
              s(:if,
                s(:send,
                  s(:lvar, :name), :==,
                  s(:str, "checksum")),
                s(:begin,
                  s(:lvasgn, :chksum_off,
                    s(:lvar, :offset)),
                  s(:op_asgn,
                    s(:lvasgn, :offset), :+,
                    s(:lvar, :length)),
                  s(:next)), nil),
              s(:send, nil, :assert_equal,
                s(:send,
                  s(:lvar, :expected), :[],
                  s(:lvar, :offset),
                  s(:lvar, :length)),
                s(:send,
                  s(:lvar, :actual), :[],
                  s(:lvar, :offset),
                  s(:lvar, :length)),
                s(:dstr,
                  s(:str, "Field "),
                  s(:begin,
                    s(:lvar, :name)),
                  s(:str, " of the tar header differs."))),
              s(:op_asgn,
                s(:lvasgn, :offset), :+,
                s(:lvar, :length)))),
          s(:send, nil, :assert_equal,
            s(:send,
              s(:lvar, :expected), :[],
              s(:lvar, :chksum_off),
              s(:int, 8)),
            s(:send,
              s(:lvar, :actual), :[],
              s(:lvar, :chksum_off),
              s(:int, 8))))),
      s(:def, :calc_checksum,
        s(:args,
          s(:arg, :header)),
        s(:begin,
          s(:lvasgn, :sum,
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :header), :unpack,
                  s(:str, "C*")), :inject),
              s(:args,
                s(:arg, :s),
                s(:arg, :a)),
              s(:send,
                s(:lvar, :s), :+,
                s(:lvar, :a)))),
          s(:send, nil, :SP,
            s(:send, nil, :Z,
              s(:send, nil, :to_oct,
                s(:lvar, :sum),
                s(:int, 6)))))),
      s(:def, :header,
        s(:args,
          s(:arg, :type),
          s(:arg, :fname),
          s(:arg, :dname),
          s(:arg, :length),
          s(:arg, :mode),
          s(:arg, :mtime),
          s(:optarg, :checksum,
            s(:nil)),
          s(:optarg, :linkname,
            s(:str, ""))),
        s(:begin,
          s(:or_asgn,
            s(:lvasgn, :checksum),
            s(:send,
              s(:str, " "), :*,
              s(:int, 8))),
          s(:lvasgn, :arr,
            s(:array,
              s(:send, nil, :ASCIIZ,
                s(:lvar, :fname),
                s(:int, 100)),
              s(:send, nil, :Z,
                s(:send, nil, :to_oct,
                  s(:lvar, :mode),
                  s(:int, 7))),
              s(:send, nil, :Z,
                s(:send, nil, :to_oct,
                  s(:int, 0),
                  s(:int, 7))),
              s(:send, nil, :Z,
                s(:send, nil, :to_oct,
                  s(:int, 0),
                  s(:int, 7))),
              s(:send, nil, :Z,
                s(:send, nil, :to_oct,
                  s(:lvar, :length),
                  s(:int, 11))),
              s(:send, nil, :Z,
                s(:send, nil, :to_oct,
                  s(:lvar, :mtime),
                  s(:int, 11))),
              s(:lvar, :checksum),
              s(:lvar, :type),
              s(:send, nil, :ASCIIZ,
                s(:lvar, :linkname),
                s(:int, 100)),
              s(:str, "ustar\u0000"),
              s(:str, "00"),
              s(:send, nil, :ASCIIZ,
                s(:str, "wheel"),
                s(:int, 32)),
              s(:send, nil, :ASCIIZ,
                s(:str, "wheel"),
                s(:int, 32)),
              s(:send, nil, :Z,
                s(:send, nil, :to_oct,
                  s(:int, 0),
                  s(:int, 7))),
              s(:send, nil, :Z,
                s(:send, nil, :to_oct,
                  s(:int, 0),
                  s(:int, 7))),
              s(:send, nil, :ASCIIZ,
                s(:lvar, :dname),
                s(:int, 155)))),
          s(:lvasgn, :format,
            s(:str, "C100C8C8C8C12C12C8CC100C6C2C32C32C8C8C155")),
          s(:lvasgn, :h,
            s(:if,
              s(:send,
                s(:const, nil, :RUBY_VERSION), :>=,
                s(:str, "1.9")),
              s(:send,
                s(:lvar, :arr), :join),
              s(:begin,
                s(:lvasgn, :arr,
                  s(:block,
                    s(:send,
                      s(:send,
                        s(:send,
                          s(:lvar, :arr), :join,
                          s(:str, "")), :split,
                        s(:regexp,
                          s(:regopt))), :map),
                    s(:args,
                      s(:arg, :x)),
                    s(:send,
                      s(:lvar, :x), :[],
                      s(:int, 0)))),
                s(:send,
                  s(:lvar, :arr), :pack,
                  s(:lvar, :format))))),
          s(:lvasgn, :ret,
            s(:send,
              s(:lvar, :h), :+,
              s(:send,
                s(:str, "\u0000"), :*,
                s(:begin,
                  s(:send,
                    s(:int, 512), :-,
                    s(:send,
                      s(:lvar, :h), :size)))))),
          s(:send, nil, :assert_equal,
            s(:int, 512),
            s(:send,
              s(:lvar, :ret), :size)),
          s(:lvar, :ret))),
      s(:def, :tar_dir_header,
        s(:args,
          s(:arg, :name),
          s(:arg, :prefix),
          s(:arg, :mode),
          s(:arg, :mtime)),
        s(:begin,
          s(:lvasgn, :h,
            s(:send, nil, :header,
              s(:str, "5"),
              s(:lvar, :name),
              s(:lvar, :prefix),
              s(:int, 0),
              s(:lvar, :mode),
              s(:lvar, :mtime))),
          s(:lvasgn, :checksum,
            s(:send, nil, :calc_checksum,
              s(:lvar, :h))),
          s(:send, nil, :header,
            s(:str, "5"),
            s(:lvar, :name),
            s(:lvar, :prefix),
            s(:int, 0),
            s(:lvar, :mode),
            s(:lvar, :mtime),
            s(:lvar, :checksum)))),
      s(:def, :tar_file_header,
        s(:args,
          s(:arg, :fname),
          s(:arg, :dname),
          s(:arg, :mode),
          s(:arg, :length),
          s(:arg, :mtime)),
        s(:begin,
          s(:lvasgn, :h,
            s(:send, nil, :header,
              s(:str, "0"),
              s(:lvar, :fname),
              s(:lvar, :dname),
              s(:lvar, :length),
              s(:lvar, :mode),
              s(:lvar, :mtime))),
          s(:lvasgn, :checksum,
            s(:send, nil, :calc_checksum,
              s(:lvar, :h))),
          s(:send, nil, :header,
            s(:str, "0"),
            s(:lvar, :fname),
            s(:lvar, :dname),
            s(:lvar, :length),
            s(:lvar, :mode),
            s(:lvar, :mtime),
            s(:lvar, :checksum)))),
      s(:def, :tar_symlink_header,
        s(:args,
          s(:arg, :fname),
          s(:arg, :prefix),
          s(:arg, :mode),
          s(:arg, :mtime),
          s(:arg, :linkname)),
        s(:begin,
          s(:lvasgn, :h,
            s(:send, nil, :header,
              s(:str, "2"),
              s(:lvar, :fname),
              s(:lvar, :prefix),
              s(:int, 0),
              s(:lvar, :mode),
              s(:lvar, :mtime),
              s(:nil),
              s(:lvar, :linkname))),
          s(:lvasgn, :checksum,
            s(:send, nil, :calc_checksum,
              s(:lvar, :h))),
          s(:send, nil, :header,
            s(:str, "2"),
            s(:lvar, :fname),
            s(:lvar, :prefix),
            s(:int, 0),
            s(:lvar, :mode),
            s(:lvar, :mtime),
            s(:lvar, :checksum),
            s(:lvar, :linkname)))),
      s(:def, :to_oct,
        s(:args,
          s(:arg, :n),
          s(:arg, :pad_size)),
        s(:send,
          s(:dstr,
            s(:str, "%0"),
            s(:begin,
              s(:lvar, :pad_size)),
            s(:str, "o")), :%,
          s(:lvar, :n))),
      s(:def, :util_entry,
        s(:args,
          s(:arg, :tar)),
        s(:begin,
          s(:lvasgn, :io,
            s(:send,
              s(:const, nil, :TempIO), :new,
              s(:lvar, :tar))),
          s(:lvasgn, :header,
            s(:send,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :Package), :TarHeader), :from,
              s(:lvar, :io))),
          s(:send,
            s(:const,
              s(:const,
                s(:const,
                  s(:const, nil, :Gem), :Package), :TarReader), :Entry), :new,
            s(:lvar, :header),
            s(:lvar, :io)))),
      s(:def, :util_dir_entry,
        s(:args),
        s(:send, nil, :util_entry,
          s(:send, nil, :tar_dir_header,
            s(:str, "foo"),
            s(:str, "bar"),
            s(:int, 0),
            s(:send,
              s(:const, nil, :Time), :now)))),
      s(:def, :util_symlink_entry,
        s(:args),
        s(:send, nil, :util_entry,
          s(:send, nil, :tar_symlink_header,
            s(:str, "foo"),
            s(:str, "bar"),
            s(:int, 0),
            s(:send,
              s(:const, nil, :Time), :now),
            s(:str, "link")))))))
