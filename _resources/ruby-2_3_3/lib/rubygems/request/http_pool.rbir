s(:class,
  s(:const,
    s(:const,
      s(:const, nil, :Gem), :Request), :HTTPPool), nil,
  s(:begin,
    s(:send, nil, :attr_reader,
      s(:sym, :cert_files),
      s(:sym, :proxy_uri)),
    s(:def, :initialize,
      s(:args,
        s(:arg, :http_args),
        s(:arg, :cert_files),
        s(:arg, :proxy_uri)),
      s(:begin,
        s(:ivasgn, :@http_args,
          s(:lvar, :http_args)),
        s(:ivasgn, :@cert_files,
          s(:lvar, :cert_files)),
        s(:ivasgn, :@proxy_uri,
          s(:lvar, :proxy_uri)),
        s(:ivasgn, :@queue,
          s(:send,
            s(:const, nil, :SizedQueue), :new,
            s(:int, 1))),
        s(:send,
          s(:ivar, :@queue), :<<,
          s(:nil)))),
    s(:def, :checkout,
      s(:args),
      s(:or,
        s(:send,
          s(:ivar, :@queue), :pop),
        s(:send, nil, :make_connection))),
    s(:def, :checkin,
      s(:args,
        s(:arg, :connection)),
      s(:send,
        s(:ivar, :@queue), :push,
        s(:lvar, :connection))),
    s(:def, :close_all,
      s(:args),
      s(:begin,
        s(:until,
          s(:send,
            s(:ivar, :@queue), :empty?),
          s(:if,
            s(:and,
              s(:lvasgn, :connection,
                s(:send,
                  s(:ivar, :@queue), :pop,
                  s(:true))),
              s(:send,
                s(:lvar, :connection), :started?)),
            s(:send,
              s(:lvar, :connection), :finish), nil)),
        s(:send,
          s(:ivar, :@queue), :push,
          s(:nil)))),
    s(:send, nil, :private),
    s(:def, :make_connection,
      s(:args),
      s(:send, nil, :setup_connection,
        s(:send,
          s(:send,
            s(:const,
              s(:const,
                s(:const, nil, :Gem), :Request), :ConnectionPools), :client), :new,
          s(:splat,
            s(:ivar, :@http_args))))),
    s(:def, :setup_connection,
      s(:args,
        s(:arg, :connection)),
      s(:begin,
        s(:send,
          s(:lvar, :connection), :start),
        s(:lvar, :connection)))))
