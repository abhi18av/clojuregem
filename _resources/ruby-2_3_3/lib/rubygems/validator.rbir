s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/package")),
  s(:send, nil, :require,
    s(:str, "rubygems/installer")),
  s(:class,
    s(:const,
      s(:const, nil, :Gem), :Validator), nil,
    s(:begin,
      s(:send, nil, :include,
        s(:const,
          s(:const, nil, :Gem), :UserInteraction)),
      s(:def, :initialize,
        s(:args),
        s(:send, nil, :require,
          s(:str, "find"))),
      s(:def, :verify_gem,
        s(:args,
          s(:arg, :gem_data)), nil),
      s(:def, :verify_gem_file,
        s(:args,
          s(:arg, :gem_path)),
        s(:rescue,
          s(:block,
            s(:send, nil, :open,
              s(:lvar, :gem_path),
              s(:send,
                s(:const, nil, :Gem), :binary_mode)),
            s(:args,
              s(:arg, :file)),
            s(:begin,
              s(:lvasgn, :gem_data,
                s(:send,
                  s(:lvar, :file), :read)),
              s(:send, nil, :verify_gem,
                s(:lvar, :gem_data)))),
          s(:resbody,
            s(:array,
              s(:const,
                s(:const, nil, :Errno), :ENOENT),
              s(:const,
                s(:const, nil, :Errno), :EINVAL)), nil,
            s(:send, nil, :raise,
              s(:const,
                s(:const, nil, :Gem), :VerificationError),
              s(:dstr,
                s(:str, "missing gem file "),
                s(:begin,
                  s(:lvar, :gem_path))))), nil)),
      s(:send, nil, :private),
      s(:def, :find_files_for_gem,
        s(:args,
          s(:arg, :gem_directory)),
        s(:begin,
          s(:lvasgn, :installed_files,
            s(:array)),
          s(:block,
            s(:send,
              s(:const, nil, :Find), :find,
              s(:lvar, :gem_directory)),
            s(:args,
              s(:arg, :file_name)),
            s(:begin,
              s(:lvasgn, :fn,
                s(:send,
                  s(:send,
                    s(:lvar, :file_name), :[],
                    s(:irange,
                      s(:send,
                        s(:lvar, :gem_directory), :size),
                      s(:send,
                        s(:send,
                          s(:lvar, :file_name), :size), :-,
                        s(:int, 1)))), :sub,
                  s(:regexp,
                    s(:str, "^/"),
                    s(:regopt)),
                  s(:str, ""))),
              s(:if,
                s(:or,
                  s(:or,
                    s(:send,
                      s(:lvar, :fn), :=~,
                      s(:regexp,
                        s(:str, "CVS"),
                        s(:regopt))),
                    s(:send,
                      s(:lvar, :fn), :empty?)),
                  s(:send,
                    s(:const, nil, :File), :directory?,
                    s(:lvar, :file_name))), nil,
                s(:send,
                  s(:lvar, :installed_files), :<<,
                  s(:lvar, :fn))))),
          s(:lvar, :installed_files))),
      s(:send, nil, :public),
      s(:casgn, nil, :ErrorData,
        s(:block,
          s(:send,
            s(:const, nil, :Struct), :new,
            s(:sym, :path),
            s(:sym, :problem)),
          s(:args),
          s(:def, :<=>,
            s(:args,
              s(:arg, :other)),
            s(:begin,
              s(:if,
                s(:send,
                  s(:send,
                    s(:self), :class), :===,
                  s(:lvar, :other)), nil,
                s(:return,
                  s(:nil))),
              s(:send,
                s(:array,
                  s(:send, nil, :path),
                  s(:send, nil, :problem)), :<=>,
                s(:array,
                  s(:send,
                    s(:lvar, :other), :path),
                  s(:send,
                    s(:lvar, :other), :problem))))))),
      s(:def, :alien,
        s(:args,
          s(:optarg, :gems,
            s(:array))),
        s(:begin,
          s(:lvasgn, :errors,
            s(:block,
              s(:send,
                s(:const, nil, :Hash), :new),
              s(:args,
                s(:arg, :h),
                s(:arg, :k)),
              s(:send,
                s(:lvar, :h), :[]=,
                s(:lvar, :k),
                s(:hash)))),
          s(:block,
            s(:send,
              s(:const,
                s(:const, nil, :Gem), :Specification), :each),
            s(:args,
              s(:arg, :spec)),
            s(:begin,
              s(:if,
                s(:send,
                  s(:lvar, :gems), :empty?), nil,
                s(:if,
                  s(:send,
                    s(:lvar, :gems), :include?,
                    s(:send,
                      s(:lvar, :spec), :name)), nil,
                  s(:next))),
              s(:if,
                s(:send,
                  s(:lvar, :spec), :default_gem?),
                s(:next), nil),
              s(:lvasgn, :gem_name,
                s(:send,
                  s(:lvar, :spec), :file_name)),
              s(:lvasgn, :gem_path,
                s(:send,
                  s(:lvar, :spec), :cache_file)),
              s(:lvasgn, :spec_path,
                s(:send,
                  s(:lvar, :spec), :spec_file)),
              s(:lvasgn, :gem_directory,
                s(:send,
                  s(:lvar, :spec), :full_gem_path)),
              s(:if,
                s(:send,
                  s(:const, nil, :File), :directory?,
                  s(:lvar, :gem_directory)), nil,
                s(:begin,
                  s(:send,
                    s(:send,
                      s(:lvar, :errors), :[],
                      s(:lvar, :gem_name)), :[]=,
                    s(:send,
                      s(:lvar, :spec), :full_name),
                    s(:dstr,
                      s(:str, "Gem registered but doesn't exist at "),
                      s(:begin,
                        s(:lvar, :gem_directory)))),
                  s(:next))),
              s(:if,
                s(:send,
                  s(:const, nil, :File), :exist?,
                  s(:lvar, :spec_path)), nil,
                s(:send,
                  s(:send,
                    s(:lvar, :errors), :[],
                    s(:lvar, :gem_name)), :[]=,
                  s(:lvar, :spec_path),
                  s(:str, "Spec file missing for installed gem"))),
              s(:kwbegin,
                s(:rescue,
                  s(:begin,
                    s(:send, nil, :verify_gem_file,
                      s(:lvar, :gem_path)),
                    s(:masgn,
                      s(:mlhs,
                        s(:lvasgn, :good),
                        s(:lvasgn, :gone),
                        s(:lvasgn, :unreadable)),
                      s(:array,
                        s(:nil),
                        s(:nil),
                        s(:nil),
                        s(:nil))),
                    s(:block,
                      s(:send, nil, :open,
                        s(:lvar, :gem_path),
                        s(:send,
                          s(:const, nil, :Gem), :binary_mode)),
                      s(:args,
                        s(:arg, :file)),
                      s(:begin,
                        s(:lvasgn, :package,
                          s(:send,
                            s(:const,
                              s(:const, nil, :Gem), :Package), :new,
                            s(:lvar, :gem_path))),
                        s(:masgn,
                          s(:mlhs,
                            s(:lvasgn, :good),
                            s(:lvasgn, :gone)),
                          s(:block,
                            s(:send,
                              s(:send,
                                s(:lvar, :package), :contents), :partition),
                            s(:args,
                              s(:arg, :file_name)),
                            s(:send,
                              s(:const, nil, :File), :exist?,
                              s(:send,
                                s(:const, nil, :File), :join,
                                s(:lvar, :gem_directory),
                                s(:lvar, :file_name))))),
                        s(:block,
                          s(:send,
                            s(:send,
                              s(:lvar, :gone), :sort), :each),
                          s(:args,
                            s(:arg, :path)),
                          s(:send,
                            s(:send,
                              s(:lvar, :errors), :[],
                              s(:lvar, :gem_name)), :[]=,
                            s(:lvar, :path),
                            s(:str, "Missing file"))),
                        s(:masgn,
                          s(:mlhs,
                            s(:lvasgn, :good),
                            s(:lvasgn, :unreadable)),
                          s(:block,
                            s(:send,
                              s(:lvar, :good), :partition),
                            s(:args,
                              s(:arg, :file_name)),
                            s(:send,
                              s(:const, nil, :File), :readable?,
                              s(:send,
                                s(:const, nil, :File), :join,
                                s(:lvar, :gem_directory),
                                s(:lvar, :file_name))))),
                        s(:block,
                          s(:send,
                            s(:send,
                              s(:lvar, :unreadable), :sort), :each),
                          s(:args,
                            s(:arg, :path)),
                          s(:send,
                            s(:send,
                              s(:lvar, :errors), :[],
                              s(:lvar, :gem_name)), :[]=,
                            s(:lvar, :path),
                            s(:str, "Unreadable file"))),
                        s(:block,
                          s(:send,
                            s(:lvar, :good), :each),
                          s(:args,
                            s(:arg, :entry),
                            s(:arg, :data)),
                          s(:kwbegin,
                            s(:if,
                              s(:lvar, :data), nil,
                              s(:next)),
                            s(:lvasgn, :source,
                              s(:send,
                                s(:const, nil, :File), :join,
                                s(:lvar, :gem_directory),
                                s(:send,
                                  s(:lvar, :entry), :[],
                                  s(:str, "path")))),
                            s(:block,
                              s(:send, nil, :open,
                                s(:lvar, :source),
                                s(:send,
                                  s(:const, nil, :Gem), :binary_mode)),
                              s(:args,
                                s(:arg, :f)),
                              s(:if,
                                s(:send,
                                  s(:send,
                                    s(:lvar, :f), :read), :==,
                                  s(:lvar, :data)), nil,
                                s(:send,
                                  s(:send,
                                    s(:lvar, :errors), :[],
                                    s(:lvar, :gem_name)), :[]=,
                                  s(:send,
                                    s(:lvar, :entry), :[],
                                    s(:str, "path")),
                                  s(:str, "Modified from original")))))))),
                    s(:lvasgn, :installed_files,
                      s(:send, nil, :find_files_for_gem,
                        s(:lvar, :gem_directory))),
                    s(:lvasgn, :extras,
                      s(:send,
                        s(:send,
                          s(:lvar, :installed_files), :-,
                          s(:lvar, :good)), :-,
                        s(:lvar, :unreadable))),
                    s(:block,
                      s(:send,
                        s(:lvar, :extras), :each),
                      s(:args,
                        s(:arg, :extra)),
                      s(:send,
                        s(:send,
                          s(:lvar, :errors), :[],
                          s(:lvar, :gem_name)), :[]=,
                        s(:lvar, :extra),
                        s(:str, "Extra file")))),
                  s(:resbody,
                    s(:array,
                      s(:const,
                        s(:const, nil, :Gem), :VerificationError)),
                    s(:lvasgn, :e),
                    s(:send,
                      s(:send,
                        s(:lvar, :errors), :[],
                        s(:lvar, :gem_name)), :[]=,
                      s(:lvar, :gem_path),
                      s(:send,
                        s(:lvar, :e), :message))), nil)))),
          s(:block,
            s(:send,
              s(:lvar, :errors), :each),
            s(:args,
              s(:arg, :name),
              s(:arg, :subhash)),
            s(:send,
              s(:lvar, :errors), :[]=,
              s(:lvar, :name),
              s(:send,
                s(:block,
                  s(:send,
                    s(:lvar, :subhash), :map),
                  s(:args,
                    s(:arg, :path),
                    s(:arg, :msg)),
                  s(:send,
                    s(:const, nil, :ErrorData), :new,
                    s(:lvar, :path),
                    s(:lvar, :msg))), :sort))),
          s(:lvar, :errors))))))
