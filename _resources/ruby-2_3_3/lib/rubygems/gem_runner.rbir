s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems")),
  s(:send, nil, :require,
    s(:str, "rubygems/command_manager")),
  s(:send, nil, :require,
    s(:str, "rubygems/config_file")),
  s(:rescue,
    s(:send,
      s(:const, nil, :Gem), :load_env_plugins),
    s(:resbody, nil, nil,
      s(:nil)), nil),
  s(:class,
    s(:const,
      s(:const, nil, :Gem), :GemRunner), nil,
    s(:begin,
      s(:def, :initialize,
        s(:args,
          s(:optarg, :options,
            s(:hash))),
        s(:begin,
          s(:ivasgn, :@command_manager_class,
            s(:or,
              s(:send,
                s(:lvar, :options), :[],
                s(:sym, :command_manager)),
              s(:const,
                s(:const, nil, :Gem), :CommandManager))),
          s(:ivasgn, :@config_file_class,
            s(:or,
              s(:send,
                s(:lvar, :options), :[],
                s(:sym, :config_file)),
              s(:const,
                s(:const, nil, :Gem), :ConfigFile))))),
      s(:def, :run,
        s(:args,
          s(:arg, :args)),
        s(:begin,
          s(:lvasgn, :build_args,
            s(:send, nil, :extract_build_args,
              s(:lvar, :args))),
          s(:send, nil, :do_configuration,
            s(:lvar, :args)),
          s(:lvasgn, :cmd,
            s(:send,
              s(:ivar, :@command_manager_class), :instance)),
          s(:block,
            s(:send,
              s(:send,
                s(:lvar, :cmd), :command_names), :each),
            s(:args,
              s(:arg, :command_name)),
            s(:begin,
              s(:lvasgn, :config_args,
                s(:send,
                  s(:send,
                    s(:const, nil, :Gem), :configuration), :[],
                  s(:lvar, :command_name))),
              s(:lvasgn, :config_args,
                s(:case,
                  s(:lvar, :config_args),
                  s(:when,
                    s(:const, nil, :String),
                    s(:send,
                      s(:lvar, :config_args), :split,
                      s(:str, " "))),
                  s(:send, nil, :Array,
                    s(:lvar, :config_args)))),
              s(:send,
                s(:const,
                  s(:const, nil, :Gem), :Command), :add_specific_extra_args,
                s(:lvar, :command_name),
                s(:lvar, :config_args)))),
          s(:send,
            s(:lvar, :cmd), :run,
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :configuration), :args),
            s(:lvar, :build_args)))),
      s(:def, :extract_build_args,
        s(:args,
          s(:arg, :args)),
        s(:begin,
          s(:if,
            s(:lvasgn, :offset,
              s(:send,
                s(:lvar, :args), :index,
                s(:str, "--"))), nil,
            s(:return,
              s(:array))),
          s(:lvasgn, :build_args,
            s(:send,
              s(:lvar, :args), :slice!,
              s(:erange,
                s(:lvar, :offset),
                s(:send,
                  s(:lvar, :args), :length)))),
          s(:send,
            s(:lvar, :build_args), :shift),
          s(:lvar, :build_args))),
      s(:send, nil, :private),
      s(:def, :do_configuration,
        s(:args,
          s(:arg, :args)),
        s(:begin,
          s(:send,
            s(:const, nil, :Gem), :configuration=,
            s(:send,
              s(:ivar, :@config_file_class), :new,
              s(:lvar, :args))),
          s(:send,
            s(:const, nil, :Gem), :use_paths,
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :configuration), :[],
              s(:sym, :gemhome)),
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :configuration), :[],
              s(:sym, :gempath))),
          s(:send,
            s(:const,
              s(:const, nil, :Gem), :Command), :extra_args=,
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :configuration), :[],
              s(:sym, :gem))))))),
  s(:send,
    s(:const, nil, :Gem), :load_plugins))
