s(:class,
  s(:const,
    s(:const,
      s(:const, nil, :Gem), :Ext), :RakeBuilder),
  s(:const,
    s(:const,
      s(:const, nil, :Gem), :Ext), :Builder),
  s(:defs,
    s(:self), :build,
    s(:args,
      s(:arg, :extension),
      s(:arg, :directory),
      s(:arg, :dest_path),
      s(:arg, :results),
      s(:optarg, :args,
        s(:array)),
      s(:optarg, :lib_dir,
        s(:nil))),
    s(:begin,
      s(:if,
        s(:send,
          s(:send,
            s(:const, nil, :File), :basename,
            s(:lvar, :extension)), :=~,
          s(:regexp,
            s(:str, "mkrf_conf"),
            s(:regopt, :i))),
        s(:begin,
          s(:lvasgn, :cmd,
            s(:dstr,
              s(:begin,
                s(:send,
                  s(:const, nil, :Gem), :ruby)),
              s(:str, " "),
              s(:begin,
                s(:send,
                  s(:const, nil, :File), :basename,
                  s(:lvar, :extension))))),
          s(:if,
            s(:send,
              s(:lvar, :args), :empty?), nil,
            s(:send,
              s(:lvar, :cmd), :<<,
              s(:dstr,
                s(:str, " "),
                s(:begin,
                  s(:send,
                    s(:lvar, :args), :join,
                    s(:str, " ")))))),
          s(:send, nil, :run,
            s(:lvar, :cmd),
            s(:lvar, :results))), nil),
      s(:if,
        s(:send,
          s(:send,
            s(:lvar, :dest_path), :to_s), :include?,
          s(:str, " ")),
        s(:lvasgn, :dest_path,
          s(:send,
            s(:send,
              s(:str, "\""), :+,
              s(:send,
                s(:lvar, :dest_path), :to_s)), :+,
            s(:str, "\""))), nil),
      s(:lvasgn, :rake,
        s(:send,
          s(:const, nil, :ENV), :[],
          s(:str, "rake"))),
      s(:or_asgn,
        s(:lvasgn, :rake),
        s(:kwbegin,
          s(:rescue,
            s(:dstr,
              s(:begin,
                s(:send,
                  s(:const, nil, :Gem), :ruby)),
              s(:str, " -rubygems "),
              s(:begin,
                s(:send,
                  s(:const, nil, :Gem), :bin_path,
                  s(:str, "rake"),
                  s(:str, "rake")))),
            s(:resbody,
              s(:array,
                s(:const,
                  s(:const, nil, :Gem), :Exception)), nil, nil), nil))),
      s(:or_asgn,
        s(:lvasgn, :rake),
        s(:send,
          s(:send,
            s(:const, nil, :Gem), :default_exec_format), :%,
          s(:str, "rake"))),
      s(:lvasgn, :cmd,
        s(:dstr,
          s(:begin,
            s(:lvar, :rake)),
          s(:str, " RUBYARCHDIR="),
          s(:begin,
            s(:lvar, :dest_path)),
          s(:str, " RUBYLIBDIR="),
          s(:begin,
            s(:lvar, :dest_path)))),
      s(:send, nil, :run,
        s(:lvar, :cmd),
        s(:lvar, :results)),
      s(:lvar, :results))))
