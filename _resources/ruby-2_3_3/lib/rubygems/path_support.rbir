s(:class,
  s(:const,
    s(:const, nil, :Gem), :PathSupport), nil,
  s(:begin,
    s(:send, nil, :attr_reader,
      s(:sym, :home)),
    s(:send, nil, :attr_reader,
      s(:sym, :path)),
    s(:send, nil, :attr_reader,
      s(:sym, :spec_cache_dir)),
    s(:def, :initialize,
      s(:args,
        s(:optarg, :env,
          s(:const, nil, :ENV))),
      s(:begin,
        s(:ivasgn, :@env,
          s(:lvar, :env)),
        s(:ivasgn, :@home,
          s(:or,
            s(:or,
              s(:send,
                s(:lvar, :env), :[],
                s(:str, "GEM_HOME")),
              s(:send,
                s(:const, nil, :ENV), :[],
                s(:str, "GEM_HOME"))),
            s(:send,
              s(:const, nil, :Gem), :default_dir))),
        s(:if,
          s(:const,
            s(:const, nil, :File), :ALT_SEPARATOR),
          s(:ivasgn, :@home,
            s(:send,
              s(:ivar, :@home), :gsub,
              s(:const,
                s(:const, nil, :File), :ALT_SEPARATOR),
              s(:const,
                s(:const, nil, :File), :SEPARATOR))), nil),
        s(:send,
          s(:self), :path=,
          s(:or,
            s(:send,
              s(:lvar, :env), :[],
              s(:str, "GEM_PATH")),
            s(:send,
              s(:const, nil, :ENV), :[],
              s(:str, "GEM_PATH")))),
        s(:ivasgn, :@spec_cache_dir,
          s(:or,
            s(:or,
              s(:send,
                s(:lvar, :env), :[],
                s(:str, "GEM_SPEC_CACHE")),
              s(:send,
                s(:const, nil, :ENV), :[],
                s(:str, "GEM_SPEC_CACHE"))),
            s(:send,
              s(:const, nil, :Gem), :default_spec_cache_dir))),
        s(:ivasgn, :@spec_cache_dir,
          s(:send,
            s(:send,
              s(:ivar, :@spec_cache_dir), :dup), :untaint)))),
    s(:send, nil, :private),
    s(:def, :path=,
      s(:args,
        s(:arg, :gpaths)),
      s(:begin,
        s(:lvasgn, :gem_path,
          s(:array)),
        s(:or_asgn,
          s(:lvasgn, :gpaths),
          s(:if,
            s(:send,
              s(:begin,
                s(:or,
                  s(:send,
                    s(:const, nil, :ENV), :[],
                    s(:str, "GEM_PATH")),
                  s(:str, ""))), :empty?),
            s(:nil),
            s(:send,
              s(:const, nil, :ENV), :[],
              s(:str, "GEM_PATH")))),
        s(:if,
          s(:lvar, :gpaths),
          s(:begin,
            s(:if,
              s(:send,
                s(:lvar, :gpaths), :kind_of?,
                s(:const, nil, :Array)),
              s(:lvasgn, :gem_path,
                s(:send,
                  s(:lvar, :gpaths), :dup)),
              s(:begin,
                s(:lvasgn, :gem_path,
                  s(:send,
                    s(:lvar, :gpaths), :split,
                    s(:send,
                      s(:const, nil, :Gem), :path_separator))),
                s(:if,
                  s(:send,
                    s(:lvar, :gpaths), :end_with?,
                    s(:send,
                      s(:const, nil, :Gem), :path_separator)),
                  s(:op_asgn,
                    s(:lvasgn, :gem_path), :+,
                    s(:send, nil, :default_path)), nil))),
            s(:if,
              s(:const,
                s(:const, nil, :File), :ALT_SEPARATOR),
              s(:block,
                s(:send,
                  s(:lvar, :gem_path), :map!),
                s(:args,
                  s(:arg, :this_path)),
                s(:send,
                  s(:lvar, :this_path), :gsub,
                  s(:const,
                    s(:const, nil, :File), :ALT_SEPARATOR),
                  s(:const,
                    s(:const, nil, :File), :SEPARATOR))), nil),
            s(:send,
              s(:lvar, :gem_path), :<<,
              s(:ivar, :@home))),
          s(:lvasgn, :gem_path,
            s(:send, nil, :default_path))),
        s(:ivasgn, :@path,
          s(:send,
            s(:lvar, :gem_path), :uniq)))),
    s(:def, :default_path,
      s(:args),
      s(:begin,
        s(:lvasgn, :gem_path,
          s(:send,
            s(:send,
              s(:const, nil, :Gem), :default_path), :+,
            s(:array,
              s(:ivar, :@home)))),
        s(:if,
          s(:defined?,
            s(:const, nil, :APPLE_GEM_HOME)),
          s(:send,
            s(:lvar, :gem_path), :<<,
            s(:const, nil, :APPLE_GEM_HOME)), nil),
        s(:lvar, :gem_path)))))
