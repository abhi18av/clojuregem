s(:begin,
  s(:send, nil, :require,
    s(:str, "rubygems/command")),
  s(:send, nil, :require,
    s(:str, "rubygems/version_option")),
  s(:send, nil, :require,
    s(:str, "rubygems/validator")),
  s(:send, nil, :require,
    s(:str, "rubygems/doctor")),
  s(:class,
    s(:const,
      s(:const,
        s(:const, nil, :Gem), :Commands), :CheckCommand),
    s(:const,
      s(:const, nil, :Gem), :Command),
    s(:begin,
      s(:send, nil, :include,
        s(:const,
          s(:const, nil, :Gem), :VersionOption)),
      s(:def, :initialize,
        s(:args),
        s(:begin,
          s(:super,
            s(:str, "check"),
            s(:str, "Check a gem repository for added or missing files"),
            s(:hash,
              s(:pair,
                s(:sym, :alien),
                s(:true)),
              s(:pair,
                s(:sym, :doctor),
                s(:false)),
              s(:pair,
                s(:sym, :dry_run),
                s(:false)),
              s(:pair,
                s(:sym, :gems),
                s(:true)))),
          s(:block,
            s(:send, nil, :add_option,
              s(:str, "-a"),
              s(:str, "--[no-]alien"),
              s(:str, "Report \"unmanaged\" or rogue files in the"),
              s(:str, "gem repository")),
            s(:args,
              s(:arg, :value),
              s(:arg, :options)),
            s(:send,
              s(:lvar, :options), :[]=,
              s(:sym, :alien),
              s(:lvar, :value))),
          s(:block,
            s(:send, nil, :add_option,
              s(:str, "--[no-]doctor"),
              s(:str, "Clean up uninstalled gems and broken"),
              s(:str, "specifications")),
            s(:args,
              s(:arg, :value),
              s(:arg, :options)),
            s(:send,
              s(:lvar, :options), :[]=,
              s(:sym, :doctor),
              s(:lvar, :value))),
          s(:block,
            s(:send, nil, :add_option,
              s(:str, "--[no-]dry-run"),
              s(:str, "Do not remove files, only report what"),
              s(:str, "would be removed")),
            s(:args,
              s(:arg, :value),
              s(:arg, :options)),
            s(:send,
              s(:lvar, :options), :[]=,
              s(:sym, :dry_run),
              s(:lvar, :value))),
          s(:block,
            s(:send, nil, :add_option,
              s(:str, "--[no-]gems"),
              s(:str, "Check installed gems for problems")),
            s(:args,
              s(:arg, :value),
              s(:arg, :options)),
            s(:send,
              s(:lvar, :options), :[]=,
              s(:sym, :gems),
              s(:lvar, :value))),
          s(:send, nil, :add_version_option,
            s(:str, "check")))),
      s(:def, :check_gems,
        s(:args),
        s(:begin,
          s(:send, nil, :say,
            s(:str, "Checking gems...")),
          s(:send, nil, :say),
          s(:lvasgn, :gems,
            s(:rescue,
              s(:send, nil, :get_all_gem_names),
              s(:resbody, nil, nil,
                s(:array)), nil)),
          s(:block,
            s(:send,
              s(:send,
                s(:send,
                  s(:send,
                    s(:const,
                      s(:const, nil, :Gem), :Validator), :new), :alien,
                  s(:lvar, :gems)), :sort), :each),
            s(:args,
              s(:arg, :key),
              s(:arg, :val)),
            s(:begin,
              s(:if,
                s(:send,
                  s(:lvar, :val), :empty?),
                s(:if,
                  s(:send,
                    s(:send,
                      s(:const, nil, :Gem), :configuration), :verbose),
                  s(:send, nil, :say,
                    s(:dstr,
                      s(:begin,
                        s(:lvar, :key)),
                      s(:str, " is error-free"))), nil),
                s(:begin,
                  s(:send, nil, :say,
                    s(:dstr,
                      s(:begin,
                        s(:lvar, :key)),
                      s(:str, " has "),
                      s(:begin,
                        s(:send,
                          s(:lvar, :val), :size)),
                      s(:str, " problems"))),
                  s(:block,
                    s(:send,
                      s(:lvar, :val), :each),
                    s(:args,
                      s(:arg, :error_entry)),
                    s(:begin,
                      s(:send, nil, :say,
                        s(:dstr,
                          s(:str, "  "),
                          s(:begin,
                            s(:send,
                              s(:lvar, :error_entry), :path)),
                          s(:str, ":"))),
                      s(:send, nil, :say,
                        s(:dstr,
                          s(:str, "    "),
                          s(:begin,
                            s(:send,
                              s(:lvar, :error_entry), :problem)))))))),
              s(:send, nil, :say))))),
      s(:def, :doctor,
        s(:args),
        s(:begin,
          s(:send, nil, :say,
            s(:str, "Checking for files from uninstalled gems...")),
          s(:send, nil, :say),
          s(:block,
            s(:send,
              s(:send,
                s(:const, nil, :Gem), :path), :each),
            s(:args,
              s(:arg, :gem_repo)),
            s(:begin,
              s(:lvasgn, :doctor,
                s(:send,
                  s(:const,
                    s(:const, nil, :Gem), :Doctor), :new,
                  s(:lvar, :gem_repo),
                  s(:send,
                    s(:send, nil, :options), :[],
                    s(:sym, :dry_run)))),
              s(:send,
                s(:lvar, :doctor), :doctor))))),
      s(:def, :execute,
        s(:args),
        s(:begin,
          s(:if,
            s(:send,
              s(:send, nil, :options), :[],
              s(:sym, :gems)),
            s(:send, nil, :check_gems), nil),
          s(:if,
            s(:send,
              s(:send, nil, :options), :[],
              s(:sym, :doctor)),
            s(:send, nil, :doctor), nil))),
      s(:def, :arguments,
        s(:args),
        s(:str, "GEMNAME       name of gem to check")),
      s(:def, :defaults_str,
        s(:args),
        s(:str, "--gems --alien")),
      s(:def, :description,
        s(:args),
        s(:dstr,
          s(:str, "The check command can list and repair problems with installed gems and\n"),
          s(:str, "specifications and will clean up gems that have been partially uninstalled.\n"))),
      s(:def, :usage,
        s(:args),
        s(:dstr,
          s(:begin,
            s(:send, nil, :program_name)),
          s(:str, " [OPTIONS] [GEMNAME ...]"))))))
