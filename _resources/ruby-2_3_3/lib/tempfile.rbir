s(:begin,
  s(:send, nil, :require,
    s(:str, "delegate")),
  s(:send, nil, :require,
    s(:str, "tmpdir")),
  s(:class,
    s(:const, nil, :Tempfile),
    s(:send, nil, :DelegateClass,
      s(:const, nil, :File)),
    s(:begin,
      s(:def, :initialize,
        s(:args,
          s(:optarg, :basename,
            s(:str, "")),
          s(:optarg, :tmpdir,
            s(:nil)),
          s(:kwoptarg, :mode,
            s(:int, 0)),
          s(:kwrestarg, :options)),
        s(:begin,
          s(:if,
            s(:send, nil, :block_given?),
            s(:send, nil, :warn,
              s(:str, "Tempfile.new doesn't call the given block.")), nil),
          s(:ivasgn, :@unlinked,
            s(:false)),
          s(:ivasgn, :@mode,
            s(:send,
              s(:send,
                s(:send,
                  s(:lvar, :mode), :|,
                  s(:const,
                    s(:const, nil, :File), :RDWR)), :|,
                s(:const,
                  s(:const, nil, :File), :CREAT)), :|,
              s(:const,
                s(:const, nil, :File), :EXCL))),
          s(:block,
            s(:send,
              s(:const,
                s(:const,
                  s(:cbase), :Dir), :Tmpname), :create,
              s(:lvar, :basename),
              s(:lvar, :tmpdir),
              s(:lvar, :options)),
            s(:args,
              s(:arg, :tmpname),
              s(:arg, :n),
              s(:arg, :opts)),
            s(:begin,
              s(:send,
                s(:lvar, :opts), :[]=,
                s(:sym, :perm),
                s(:int, 384)),
              s(:ivasgn, :@tmpfile,
                s(:send,
                  s(:const, nil, :File), :open,
                  s(:lvar, :tmpname),
                  s(:ivar, :@mode),
                  s(:lvar, :opts))),
              s(:ivasgn, :@opts,
                s(:send,
                  s(:lvar, :opts), :freeze)))),
          s(:send,
            s(:const, nil, :ObjectSpace), :define_finalizer,
            s(:self),
            s(:send,
              s(:const, nil, :Remover), :new,
              s(:ivar, :@tmpfile))),
          s(:super,
            s(:ivar, :@tmpfile)))),
      s(:def, :open,
        s(:args),
        s(:begin,
          s(:send, nil, :_close),
          s(:lvasgn, :mode,
            s(:send,
              s(:ivar, :@mode), :&,
              s(:send,
                s(:begin,
                  s(:send,
                    s(:const,
                      s(:const, nil, :File), :CREAT), :|,
                    s(:const,
                      s(:const, nil, :File), :EXCL))), :~))),
          s(:ivasgn, :@tmpfile,
            s(:send,
              s(:const, nil, :File), :open,
              s(:send,
                s(:ivar, :@tmpfile), :path),
              s(:lvar, :mode),
              s(:ivar, :@opts))),
          s(:send, nil, :__setobj__,
            s(:ivar, :@tmpfile)))),
      s(:def, :_close,
        s(:args),
        s(:if,
          s(:send,
            s(:ivar, :@tmpfile), :closed?), nil,
          s(:send,
            s(:ivar, :@tmpfile), :close))),
      s(:send, nil, :protected,
        s(:sym, :_close)),
      s(:def, :close,
        s(:args,
          s(:optarg, :unlink_now,
            s(:false))),
        s(:begin,
          s(:send, nil, :_close),
          s(:if,
            s(:lvar, :unlink_now),
            s(:send, nil, :unlink), nil))),
      s(:def, :close!,
        s(:args),
        s(:send, nil, :close,
          s(:true))),
      s(:def, :unlink,
        s(:args),
        s(:begin,
          s(:if,
            s(:ivar, :@unlinked),
            s(:return), nil),
          s(:kwbegin,
            s(:rescue,
              s(:send,
                s(:const, nil, :File), :unlink,
                s(:send,
                  s(:ivar, :@tmpfile), :path)),
              s(:resbody,
                s(:array,
                  s(:const,
                    s(:const, nil, :Errno), :ENOENT)), nil, nil),
              s(:resbody,
                s(:array,
                  s(:const,
                    s(:const, nil, :Errno), :EACCES)), nil,
                s(:return)), nil)),
          s(:send,
            s(:const, nil, :ObjectSpace), :undefine_finalizer,
            s(:self)),
          s(:ivasgn, :@unlinked,
            s(:true)))),
      s(:alias,
        s(:sym, :delete),
        s(:sym, :unlink)),
      s(:def, :path,
        s(:args),
        s(:if,
          s(:ivar, :@unlinked),
          s(:nil),
          s(:send,
            s(:ivar, :@tmpfile), :path))),
      s(:def, :size,
        s(:args),
        s(:if,
          s(:send,
            s(:send,
              s(:ivar, :@tmpfile), :closed?), :!),
          s(:send,
            s(:ivar, :@tmpfile), :size),
          s(:send,
            s(:const, nil, :File), :size?,
            s(:send,
              s(:ivar, :@tmpfile), :path)))),
      s(:alias,
        s(:sym, :length),
        s(:sym, :size)),
      s(:def, :inspect,
        s(:args),
        s(:if,
          s(:send, nil, :closed?),
          s(:dstr,
            s(:str, "#<"),
            s(:begin,
              s(:send,
                s(:self), :class)),
            s(:str, ":"),
            s(:begin,
              s(:send, nil, :path)),
            s(:str, " (closed)>")),
          s(:dstr,
            s(:str, "#<"),
            s(:begin,
              s(:send,
                s(:self), :class)),
            s(:str, ":"),
            s(:begin,
              s(:send, nil, :path)),
            s(:str, ">")))),
      s(:class,
        s(:const, nil, :Remover), nil,
        s(:begin,
          s(:def, :initialize,
            s(:args,
              s(:arg, :tmpfile)),
            s(:begin,
              s(:ivasgn, :@pid,
                s(:send,
                  s(:const, nil, :Process), :pid)),
              s(:ivasgn, :@tmpfile,
                s(:lvar, :tmpfile)))),
          s(:def, :call,
            s(:args,
              s(:restarg, :args)),
            s(:begin,
              s(:if,
                s(:send,
                  s(:ivar, :@pid), :!=,
                  s(:send,
                    s(:const, nil, :Process), :pid)),
                s(:return), nil),
              s(:if,
                s(:gvar, :$DEBUG),
                s(:send, nil, :warn,
                  s(:dstr,
                    s(:str, "removing "),
                    s(:begin,
                      s(:send,
                        s(:ivar, :@tmpfile), :path)),
                    s(:str, "..."))), nil),
              s(:if,
                s(:send,
                  s(:ivar, :@tmpfile), :closed?), nil,
                s(:send,
                  s(:ivar, :@tmpfile), :close)),
              s(:kwbegin,
                s(:rescue,
                  s(:send,
                    s(:const, nil, :File), :unlink,
                    s(:send,
                      s(:ivar, :@tmpfile), :path)),
                  s(:resbody,
                    s(:array,
                      s(:const,
                        s(:const, nil, :Errno), :ENOENT)), nil, nil), nil)),
              s(:if,
                s(:gvar, :$DEBUG),
                s(:send, nil, :warn,
                  s(:str, "done")), nil))))),
      s(:sclass,
        s(:self),
        s(:def, :open,
          s(:args,
            s(:restarg, :args)),
          s(:begin,
            s(:lvasgn, :tempfile,
              s(:send, nil, :new,
                s(:splat,
                  s(:lvar, :args)))),
            s(:if,
              s(:send, nil, :block_given?),
              s(:kwbegin,
                s(:ensure,
                  s(:yield,
                    s(:lvar, :tempfile)),
                  s(:send,
                    s(:lvar, :tempfile), :close))),
              s(:lvar, :tempfile))))))),
  s(:defs,
    s(:const, nil, :Tempfile), :create,
    s(:args,
      s(:arg, :basename),
      s(:optarg, :tmpdir,
        s(:nil)),
      s(:kwoptarg, :mode,
        s(:int, 0)),
      s(:kwrestarg, :options)),
    s(:begin,
      s(:lvasgn, :tmpfile,
        s(:nil)),
      s(:block,
        s(:send,
          s(:const,
            s(:const, nil, :Dir), :Tmpname), :create,
          s(:lvar, :basename),
          s(:lvar, :tmpdir),
          s(:lvar, :options)),
        s(:args,
          s(:arg, :tmpname),
          s(:arg, :n),
          s(:arg, :opts)),
        s(:begin,
          s(:op_asgn,
            s(:lvasgn, :mode), :|,
            s(:send,
              s(:send,
                s(:const,
                  s(:const, nil, :File), :RDWR), :|,
                s(:const,
                  s(:const, nil, :File), :CREAT)), :|,
              s(:const,
                s(:const, nil, :File), :EXCL))),
          s(:send,
            s(:lvar, :opts), :[]=,
            s(:sym, :perm),
            s(:int, 384)),
          s(:lvasgn, :tmpfile,
            s(:send,
              s(:const, nil, :File), :open,
              s(:lvar, :tmpname),
              s(:lvar, :mode),
              s(:lvar, :opts))))),
      s(:if,
        s(:send, nil, :block_given?),
        s(:kwbegin,
          s(:ensure,
            s(:yield,
              s(:lvar, :tmpfile)),
            s(:begin,
              s(:if,
                s(:send,
                  s(:send,
                    s(:lvar, :tmpfile), :closed?), :!),
                s(:send,
                  s(:lvar, :tmpfile), :close), nil),
              s(:send,
                s(:const, nil, :File), :unlink,
                s(:lvar, :tmpfile))))),
        s(:lvar, :tmpfile)))))
