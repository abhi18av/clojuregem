s(:module,
  s(:const, nil, :Observable),
  s(:begin,
    s(:def, :add_observer,
      s(:args,
        s(:arg, :observer),
        s(:optarg, :func,
          s(:sym, :update))),
      s(:begin,
        s(:if,
          s(:defined?,
            s(:ivar, :@observer_peers)), nil,
          s(:ivasgn, :@observer_peers,
            s(:hash))),
        s(:if,
          s(:send,
            s(:lvar, :observer), :respond_to?,
            s(:lvar, :func)), nil,
          s(:send, nil, :raise,
            s(:const, nil, :NoMethodError),
            s(:dstr,
              s(:str, "observer does not respond to `"),
              s(:begin,
                s(:lvar, :func)),
              s(:str, "'")))),
        s(:send,
          s(:ivar, :@observer_peers), :[]=,
          s(:lvar, :observer),
          s(:lvar, :func)))),
    s(:def, :delete_observer,
      s(:args,
        s(:arg, :observer)),
      s(:if,
        s(:defined?,
          s(:ivar, :@observer_peers)),
        s(:send,
          s(:ivar, :@observer_peers), :delete,
          s(:lvar, :observer)), nil)),
    s(:def, :delete_observers,
      s(:args),
      s(:if,
        s(:defined?,
          s(:ivar, :@observer_peers)),
        s(:send,
          s(:ivar, :@observer_peers), :clear), nil)),
    s(:def, :count_observers,
      s(:args),
      s(:if,
        s(:defined?,
          s(:ivar, :@observer_peers)),
        s(:send,
          s(:ivar, :@observer_peers), :size),
        s(:int, 0))),
    s(:def, :changed,
      s(:args,
        s(:optarg, :state,
          s(:true))),
      s(:ivasgn, :@observer_state,
        s(:lvar, :state))),
    s(:def, :changed?,
      s(:args),
      s(:if,
        s(:and,
          s(:defined?,
            s(:ivar, :@observer_state)),
          s(:ivar, :@observer_state)),
        s(:true),
        s(:false))),
    s(:def, :notify_observers,
      s(:args,
        s(:restarg, :arg)),
      s(:if,
        s(:and,
          s(:defined?,
            s(:ivar, :@observer_state)),
          s(:ivar, :@observer_state)),
        s(:begin,
          s(:if,
            s(:defined?,
              s(:ivar, :@observer_peers)),
            s(:block,
              s(:send,
                s(:ivar, :@observer_peers), :each),
              s(:args,
                s(:arg, :k),
                s(:arg, :v)),
              s(:send,
                s(:lvar, :k), :send,
                s(:lvar, :v),
                s(:splat,
                  s(:lvar, :arg)))), nil),
          s(:ivasgn, :@observer_state,
            s(:false))), nil))))
