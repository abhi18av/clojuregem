s(:begin,
  s(:send, nil, :require,
    s(:str, "mathn")),
  s(:module,
    s(:const, nil, :IRB),
    s(:class,
      s(:const, nil, :Context), nil,
      s(:begin,
        s(:send, nil, :attr_reader,
          s(:sym, :math_mode)),
        s(:alias,
          s(:sym, :math?),
          s(:sym, :math_mode)),
        s(:def, :math_mode=,
          s(:args,
            s(:arg, :opt)),
          s(:begin,
            s(:if,
              s(:and,
                s(:send,
                  s(:ivar, :@math_mode), :==,
                  s(:true)),
                s(:send,
                  s(:lvar, :opt), :!)),
              s(:begin,
                s(:send,
                  s(:const, nil, :IRB), :fail,
                  s(:const, nil, :CantReturnToNormalMode)),
                s(:return)), nil),
            s(:ivasgn, :@math_mode,
              s(:lvar, :opt)),
            s(:if,
              s(:send, nil, :math_mode),
              s(:begin,
                s(:send,
                  s(:send, nil, :main), :extend,
                  s(:const, nil, :Math)),
                s(:if,
                  s(:send, nil, :verbose?),
                  s(:send, nil, :print,
                    s(:str, "start math mode\n")), nil)), nil))),
        s(:def, :inspect?,
          s(:args),
          s(:or,
            s(:and,
              s(:send,
                s(:ivar, :@inspect_mode), :nil?),
              s(:send,
                s(:ivar, :@math_mode), :!)),
            s(:ivar, :@inspect_mode)))))))
