s(:begin,
  s(:send, nil, :require,
    s(:str, "irb/cmd/load")),
  s(:send, nil, :require,
    s(:str, "irb/ext/loader")),
  s(:class,
    s(:const, nil, :Object), nil,
    s(:begin,
      s(:alias,
        s(:sym, :__original__load__IRB_use_loader__),
        s(:sym, :load)),
      s(:alias,
        s(:sym, :__original__require__IRB_use_loader__),
        s(:sym, :require)))),
  s(:module,
    s(:const, nil, :IRB),
    s(:begin,
      s(:module,
        s(:const, nil, :ExtendCommandBundle),
        s(:begin,
          s(:def, :irb_load,
            s(:args,
              s(:restarg, :opts),
              s(:blockarg, :b)),
            s(:send,
              s(:const,
                s(:const, nil, :ExtendCommand), :Load), :execute,
              s(:send, nil, :irb_context),
              s(:splat,
                s(:lvar, :opts)),
              s(:block_pass,
                s(:lvar, :b)))),
          s(:def, :irb_require,
            s(:args,
              s(:restarg, :opts),
              s(:blockarg, :b)),
            s(:send,
              s(:const,
                s(:const, nil, :ExtendCommand), :Require), :execute,
              s(:send, nil, :irb_context),
              s(:splat,
                s(:lvar, :opts)),
              s(:block_pass,
                s(:lvar, :b)))))),
      s(:class,
        s(:const, nil, :Context), nil,
        s(:begin,
          s(:send,
            s(:send,
              s(:const, nil, :IRB), :conf), :[]=,
            s(:sym, :USE_LOADER),
            s(:false)),
          s(:def, :use_loader,
            s(:args),
            s(:send,
              s(:send,
                s(:const, nil, :IRB), :conf), :[],
              s(:sym, :USE_LOADER))),
          s(:alias,
            s(:sym, :use_loader?),
            s(:sym, :use_loader)),
          s(:def, :use_loader=,
            s(:args,
              s(:arg, :opt)),
            s(:begin,
              s(:if,
                s(:send,
                  s(:send,
                    s(:send,
                      s(:const, nil, :IRB), :conf), :[],
                    s(:sym, :USE_LOADER)), :!=,
                  s(:lvar, :opt)),
                s(:begin,
                  s(:send,
                    s(:send,
                      s(:const, nil, :IRB), :conf), :[]=,
                    s(:sym, :USE_LOADER),
                    s(:lvar, :opt)),
                  s(:if,
                    s(:lvar, :opt),
                    s(:begin,
                      s(:if,
                        s(:send,
                          s(:send,
                            s(:gvar, :$"), :include?,
                            s(:str, "irb/cmd/load")), :!), nil, nil),
                      s(:block,
                        s(:send,
                          s(:begin,
                            s(:sclass,
                              s(:send,
                                s(:ivar, :@workspace), :main),
                              s(:self))), :instance_eval),
                        s(:args),
                        s(:begin,
                          s(:send, nil, :alias_method,
                            s(:sym, :load),
                            s(:sym, :irb_load)),
                          s(:send, nil, :alias_method,
                            s(:sym, :require),
                            s(:sym, :irb_require))))),
                    s(:block,
                      s(:send,
                        s(:begin,
                          s(:sclass,
                            s(:send,
                              s(:ivar, :@workspace), :main),
                            s(:self))), :instance_eval),
                      s(:args),
                      s(:begin,
                        s(:send, nil, :alias_method,
                          s(:sym, :load),
                          s(:sym, :__original__load__IRB_use_loader__)),
                        s(:send, nil, :alias_method,
                          s(:sym, :require),
                          s(:sym, :__original__require__IRB_use_loader__)))))), nil),
              s(:if,
                s(:send, nil, :verbose?),
                s(:send, nil, :print,
                  s(:dstr,
                    s(:str, "Switch to load/require"),
                    s(:begin,
                      s(:if,
                        s(:send, nil, :use_loader), nil,
                        s(:str, " non"))),
                    s(:str, " trace mode.\n"))), nil),
              s(:lvar, :opt))))))))
