s(:module,
  s(:const, nil, :IRB),
  s(:module,
    s(:const, nil, :ExtendCommand),
    s(:class,
      s(:const, nil, :Fork),
      s(:const, nil, :Nop),
      s(:def, :execute,
        s(:args),
        s(:begin,
          s(:lvasgn, :pid,
            s(:send, nil, :send,
              s(:send,
                s(:const, nil, :ExtendCommand), :irb_original_method_name,
                s(:str, "fork")))),
          s(:if,
            s(:lvar, :pid), nil,
            s(:begin,
              s(:sclass,
                s(:self),
                s(:send, nil, :alias_method,
                  s(:sym, :exit),
                  s(:send,
                    s(:const, nil, :ExtendCommand), :irb_original_method_name,
                    s(:str, "exit")))),
              s(:if,
                s(:send, nil, :iterator?),
                s(:kwbegin,
                  s(:ensure,
                    s(:yield),
                    s(:send, nil, :exit))), nil))),
          s(:lvar, :pid))))))
