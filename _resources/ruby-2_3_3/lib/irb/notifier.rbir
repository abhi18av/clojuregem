s(:begin,
  s(:send, nil, :require,
    s(:str, "e2mmap")),
  s(:send, nil, :require,
    s(:str, "irb/output-method")),
  s(:module,
    s(:const, nil, :IRB),
    s(:module,
      s(:const, nil, :Notifier),
      s(:begin,
        s(:send, nil, :extend,
          s(:const, nil, :Exception2MessageMapper)),
        s(:send, nil, :def_exception,
          s(:sym, :ErrUndefinedNotifier),
          s(:str, "undefined notifier level: %d is specified")),
        s(:send, nil, :def_exception,
          s(:sym, :ErrUnrecognizedLevel),
          s(:str, "unrecognized notifier level: %s is specified")),
        s(:def, :def_notifier,
          s(:args,
            s(:optarg, :prefix,
              s(:str, "")),
            s(:optarg, :output_method,
              s(:send,
                s(:const, nil, :StdioOutputMethod), :new))),
          s(:send,
            s(:const, nil, :CompositeNotifier), :new,
            s(:lvar, :prefix),
            s(:lvar, :output_method))),
        s(:send, nil, :module_function,
          s(:sym, :def_notifier)),
        s(:class,
          s(:const, nil, :AbstractNotifier), nil,
          s(:begin,
            s(:def, :initialize,
              s(:args,
                s(:arg, :prefix),
                s(:arg, :base_notifier)),
              s(:begin,
                s(:ivasgn, :@prefix,
                  s(:lvar, :prefix)),
                s(:ivasgn, :@base_notifier,
                  s(:lvar, :base_notifier)))),
            s(:send, nil, :attr_reader,
              s(:sym, :prefix)),
            s(:def, :notify?,
              s(:args),
              s(:true)),
            s(:def, :print,
              s(:args,
                s(:restarg, :opts)),
              s(:if,
                s(:send, nil, :notify?),
                s(:send,
                  s(:ivar, :@base_notifier), :print,
                  s(:send, nil, :prefix),
                  s(:splat,
                    s(:lvar, :opts))), nil)),
            s(:def, :printn,
              s(:args,
                s(:restarg, :opts)),
              s(:if,
                s(:send, nil, :notify?),
                s(:send,
                  s(:ivar, :@base_notifier), :printn,
                  s(:send, nil, :prefix),
                  s(:splat,
                    s(:lvar, :opts))), nil)),
            s(:def, :printf,
              s(:args,
                s(:arg, :format),
                s(:restarg, :opts)),
              s(:if,
                s(:send, nil, :notify?),
                s(:send,
                  s(:ivar, :@base_notifier), :printf,
                  s(:send,
                    s(:send, nil, :prefix), :+,
                    s(:lvar, :format)),
                  s(:splat,
                    s(:lvar, :opts))), nil)),
            s(:def, :puts,
              s(:args,
                s(:restarg, :objs)),
              s(:if,
                s(:send, nil, :notify?),
                s(:send,
                  s(:ivar, :@base_notifier), :puts,
                  s(:splat,
                    s(:block,
                      s(:send,
                        s(:lvar, :objs), :collect),
                      s(:args,
                        s(:arg, :obj)),
                      s(:send,
                        s(:send, nil, :prefix), :+,
                        s(:send,
                          s(:lvar, :obj), :to_s))))), nil)),
            s(:def, :pp,
              s(:args,
                s(:restarg, :objs)),
              s(:if,
                s(:send, nil, :notify?),
                s(:send,
                  s(:ivar, :@base_notifier), :ppx,
                  s(:ivar, :@prefix),
                  s(:splat,
                    s(:lvar, :objs))), nil)),
            s(:def, :ppx,
              s(:args,
                s(:arg, :prefix),
                s(:restarg, :objs)),
              s(:if,
                s(:send, nil, :notify?),
                s(:send,
                  s(:ivar, :@base_notifier), :ppx,
                  s(:send,
                    s(:ivar, :@prefix), :+,
                    s(:lvar, :prefix)),
                  s(:splat,
                    s(:lvar, :objs))), nil)),
            s(:def, :exec_if,
              s(:args),
              s(:if,
                s(:send, nil, :notify?),
                s(:yield,
                  s(:ivar, :@base_notifier)), nil)))),
        s(:class,
          s(:const, nil, :CompositeNotifier),
          s(:const, nil, :AbstractNotifier),
          s(:begin,
            s(:def, :initialize,
              s(:args,
                s(:arg, :prefix),
                s(:arg, :base_notifier)),
              s(:begin,
                s(:zsuper),
                s(:ivasgn, :@notifiers,
                  s(:array,
                    s(:const, nil, :D_NOMSG))),
                s(:ivasgn, :@level_notifier,
                  s(:const, nil, :D_NOMSG)))),
            s(:send, nil, :attr_reader,
              s(:sym, :notifiers)),
            s(:def, :def_notifier,
              s(:args,
                s(:arg, :level),
                s(:optarg, :prefix,
                  s(:str, ""))),
              s(:begin,
                s(:lvasgn, :notifier,
                  s(:send,
                    s(:const, nil, :LeveledNotifier), :new,
                    s(:self),
                    s(:lvar, :level),
                    s(:lvar, :prefix))),
                s(:send,
                  s(:ivar, :@notifiers), :[]=,
                  s(:lvar, :level),
                  s(:lvar, :notifier)),
                s(:lvar, :notifier))),
            s(:send, nil, :attr_reader,
              s(:sym, :level_notifier)),
            s(:alias,
              s(:sym, :level),
              s(:sym, :level_notifier)),
            s(:def, :level_notifier=,
              s(:args,
                s(:arg, :value)),
              s(:case,
                s(:lvar, :value),
                s(:when,
                  s(:const, nil, :AbstractNotifier),
                  s(:ivasgn, :@level_notifier,
                    s(:lvar, :value))),
                s(:when,
                  s(:const, nil, :Integer),
                  s(:begin,
                    s(:lvasgn, :l,
                      s(:send,
                        s(:ivar, :@notifiers), :[],
                        s(:lvar, :value))),
                    s(:if,
                      s(:lvar, :l), nil,
                      s(:send,
                        s(:const, nil, :Notifier), :Raise,
                        s(:const, nil, :ErrUndefinedNotifier),
                        s(:lvar, :value))),
                    s(:ivasgn, :@level_notifier,
                      s(:lvar, :l)))),
                s(:if,
                  s(:lvar, :l), nil,
                  s(:send,
                    s(:const, nil, :Notifier), :Raise,
                    s(:const, nil, :ErrUnrecognizedLevel),
                    s(:lvar, :value))))),
            s(:alias,
              s(:sym, :level=),
              s(:sym, :level_notifier=)))),
        s(:class,
          s(:const, nil, :LeveledNotifier),
          s(:const, nil, :AbstractNotifier),
          s(:begin,
            s(:send, nil, :include,
              s(:const, nil, :Comparable)),
            s(:def, :initialize,
              s(:args,
                s(:arg, :base),
                s(:arg, :level),
                s(:arg, :prefix)),
              s(:begin,
                s(:super,
                  s(:lvar, :prefix),
                  s(:lvar, :base)),
                s(:ivasgn, :@level,
                  s(:lvar, :level)))),
            s(:send, nil, :attr_reader,
              s(:sym, :level)),
            s(:def, :<=>,
              s(:args,
                s(:arg, :other)),
              s(:send,
                s(:ivar, :@level), :<=>,
                s(:send,
                  s(:lvar, :other), :level))),
            s(:def, :notify?,
              s(:args),
              s(:send,
                s(:send,
                  s(:ivar, :@base_notifier), :level), :>=,
                s(:self))))),
        s(:class,
          s(:const, nil, :NoMsgNotifier),
          s(:const, nil, :LeveledNotifier),
          s(:begin,
            s(:def, :initialize,
              s(:args),
              s(:begin,
                s(:ivasgn, :@base_notifier,
                  s(:nil)),
                s(:ivasgn, :@level,
                  s(:int, 0)),
                s(:ivasgn, :@prefix,
                  s(:str, "")))),
            s(:def, :notify?,
              s(:args),
              s(:false)))),
        s(:casgn, nil, :D_NOMSG,
          s(:send,
            s(:const, nil, :NoMsgNotifier), :new))))))
