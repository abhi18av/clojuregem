s(:class,
  s(:const,
    s(:const, nil, :RDoc), :TopLevel),
  s(:const,
    s(:const, nil, :RDoc), :Context),
  s(:begin,
    s(:casgn, nil, :MARSHAL_VERSION,
      s(:int, 0)),
    s(:send, nil, :attr_accessor,
      s(:sym, :file_stat)),
    s(:send, nil, :attr_accessor,
      s(:sym, :relative_name)),
    s(:send, nil, :attr_accessor,
      s(:sym, :absolute_name)),
    s(:send, nil, :attr_reader,
      s(:sym, :classes_or_modules)),
    s(:send, nil, :attr_accessor,
      s(:sym, :diagram)),
    s(:send, nil, :attr_accessor,
      s(:sym, :parser)),
    s(:def, :initialize,
      s(:args,
        s(:arg, :absolute_name),
        s(:optarg, :relative_name,
          s(:lvar, :absolute_name))),
      s(:begin,
        s(:super),
        s(:ivasgn, :@name,
          s(:nil)),
        s(:ivasgn, :@absolute_name,
          s(:lvar, :absolute_name)),
        s(:ivasgn, :@relative_name,
          s(:lvar, :relative_name)),
        s(:ivasgn, :@file_stat,
          s(:rescue,
            s(:send,
              s(:const, nil, :File), :stat,
              s(:lvar, :absolute_name)),
            s(:resbody, nil, nil,
              s(:nil)), nil)),
        s(:ivasgn, :@diagram,
          s(:nil)),
        s(:ivasgn, :@parser,
          s(:nil)),
        s(:ivasgn, :@classes_or_modules,
          s(:array)))),
    s(:def, :==,
      s(:args,
        s(:arg, :other)),
      s(:and,
        s(:send,
          s(:send,
            s(:self), :class), :===,
          s(:lvar, :other)),
        s(:send,
          s(:ivar, :@relative_name), :==,
          s(:send,
            s(:lvar, :other), :relative_name)))),
    s(:alias,
      s(:sym, :eql?),
      s(:sym, :==)),
    s(:def, :add_alias,
      s(:args,
        s(:arg, :an_alias)),
      s(:begin,
        s(:send,
          s(:send, nil, :object_class), :record_location,
          s(:self)),
        s(:if,
          s(:ivar, :@document_self), nil,
          s(:return,
            s(:lvar, :an_alias))),
        s(:send,
          s(:send, nil, :object_class), :add_alias,
          s(:lvar, :an_alias)))),
    s(:def, :add_constant,
      s(:args,
        s(:arg, :constant)),
      s(:begin,
        s(:send,
          s(:send, nil, :object_class), :record_location,
          s(:self)),
        s(:if,
          s(:ivar, :@document_self), nil,
          s(:return,
            s(:lvar, :constant))),
        s(:send,
          s(:send, nil, :object_class), :add_constant,
          s(:lvar, :constant)))),
    s(:def, :add_include,
      s(:args,
        s(:arg, :include)),
      s(:begin,
        s(:send,
          s(:send, nil, :object_class), :record_location,
          s(:self)),
        s(:if,
          s(:ivar, :@document_self), nil,
          s(:return,
            s(:lvar, :include))),
        s(:send,
          s(:send, nil, :object_class), :add_include,
          s(:lvar, :include)))),
    s(:def, :add_method,
      s(:args,
        s(:arg, :method)),
      s(:begin,
        s(:send,
          s(:send, nil, :object_class), :record_location,
          s(:self)),
        s(:if,
          s(:ivar, :@document_self), nil,
          s(:return,
            s(:lvar, :method))),
        s(:send,
          s(:send, nil, :object_class), :add_method,
          s(:lvar, :method)))),
    s(:def, :add_to_classes_or_modules,
      s(:args,
        s(:arg, :mod)),
      s(:send,
        s(:ivar, :@classes_or_modules), :<<,
        s(:lvar, :mod))),
    s(:def, :base_name,
      s(:args),
      s(:send,
        s(:const, nil, :File), :basename,
        s(:ivar, :@relative_name))),
    s(:alias,
      s(:sym, :name),
      s(:sym, :base_name)),
    s(:def, :display?,
      s(:args),
      s(:and,
        s(:send, nil, :text?),
        s(:zsuper))),
    s(:def, :find_class_or_module,
      s(:args,
        s(:arg, :name)),
      s(:send,
        s(:ivar, :@store), :find_class_or_module,
        s(:lvar, :name))),
    s(:def, :find_local_symbol,
      s(:args,
        s(:arg, :symbol)),
      s(:or,
        s(:send, nil, :find_class_or_module,
          s(:lvar, :symbol)),
        s(:zsuper))),
    s(:def, :find_module_named,
      s(:args,
        s(:arg, :name)),
      s(:send, nil, :find_class_or_module,
        s(:lvar, :name))),
    s(:def, :full_name,
      s(:args),
      s(:ivar, :@relative_name)),
    s(:def, :hash,
      s(:args),
      s(:send,
        s(:ivar, :@relative_name), :hash)),
    s(:def, :http_url,
      s(:args,
        s(:arg, :prefix)),
      s(:begin,
        s(:lvasgn, :path,
          s(:array,
            s(:lvar, :prefix),
            s(:send,
              s(:ivar, :@relative_name), :tr,
              s(:str, "."),
              s(:str, "_")))),
        s(:send,
          s(:send,
            s(:const, nil, :File), :join,
            s(:splat,
              s(:send,
                s(:lvar, :path), :compact))), :+,
          s(:str, ".html")))),
    s(:def, :inspect,
      s(:args),
      s(:send,
        s(:str, "#<%s:0x%x %p modules: %p classes: %p>"), :%,
        s(:array,
          s(:send,
            s(:self), :class),
          s(:send, nil, :object_id),
          s(:send, nil, :base_name),
          s(:block,
            s(:send,
              s(:ivar, :@modules), :map),
            s(:args,
              s(:arg, :n),
              s(:arg, :m)),
            s(:lvar, :m)),
          s(:block,
            s(:send,
              s(:ivar, :@classes), :map),
            s(:args,
              s(:arg, :n),
              s(:arg, :c)),
            s(:lvar, :c))))),
    s(:def, :last_modified,
      s(:args),
      s(:if,
        s(:ivar, :@file_stat),
        s(:send,
          s(:send, nil, :file_stat), :mtime),
        s(:nil))),
    s(:def, :marshal_dump,
      s(:args),
      s(:array,
        s(:const, nil, :MARSHAL_VERSION),
        s(:ivar, :@relative_name),
        s(:ivar, :@parser),
        s(:send, nil, :parse,
          s(:ivar, :@comment)))),
    s(:def, :marshal_load,
      s(:args,
        s(:arg, :array)),
      s(:begin,
        s(:send, nil, :initialize,
          s(:send,
            s(:lvar, :array), :[],
            s(:int, 1))),
        s(:ivasgn, :@parser,
          s(:send,
            s(:lvar, :array), :[],
            s(:int, 2))),
        s(:ivasgn, :@comment,
          s(:send,
            s(:lvar, :array), :[],
            s(:int, 3))),
        s(:ivasgn, :@file_stat,
          s(:nil)))),
    s(:def, :object_class,
      s(:args),
      s(:or_asgn,
        s(:ivasgn, :@object_class),
        s(:kwbegin,
          s(:lvasgn, :oc,
            s(:or,
              s(:send,
                s(:ivar, :@store), :find_class_named,
                s(:str, "Object")),
              s(:send, nil, :add_class,
                s(:const,
                  s(:const, nil, :RDoc), :NormalClass),
                s(:str, "Object")))),
          s(:send,
            s(:lvar, :oc), :record_location,
            s(:self)),
          s(:lvar, :oc)))),
    s(:def, :page_name,
      s(:args),
      s(:begin,
        s(:lvasgn, :basename,
          s(:send,
            s(:const, nil, :File), :basename,
            s(:ivar, :@relative_name))),
        s(:send,
          s(:lvar, :basename), :=~,
          s(:regexp,
            s(:str, "\\.(rb|rdoc|txt|md)$"),
            s(:regopt, :i))),
        s(:or,
          s(:back_ref, :$`),
          s(:lvar, :basename)))),
    s(:def, :path,
      s(:args),
      s(:send, nil, :http_url,
        s(:send,
          s(:send,
            s(:send,
              s(:ivar, :@store), :rdoc), :generator), :file_dir))),
    s(:def, :pretty_print,
      s(:args,
        s(:arg, :q)),
      s(:block,
        s(:send,
          s(:lvar, :q), :group,
          s(:int, 2),
          s(:dstr,
            s(:str, "["),
            s(:begin,
              s(:send,
                s(:self), :class)),
            s(:str, ": ")),
          s(:str, "]")),
        s(:args),
        s(:begin,
          s(:send,
            s(:lvar, :q), :text,
            s(:dstr,
              s(:str, "base name: "),
              s(:begin,
                s(:send,
                  s(:send, nil, :base_name), :inspect)))),
          s(:send,
            s(:lvar, :q), :breakable),
          s(:lvasgn, :items,
            s(:block,
              s(:send,
                s(:ivar, :@modules), :map),
              s(:args,
                s(:arg, :n),
                s(:arg, :m)),
              s(:lvar, :m))),
          s(:send,
            s(:lvar, :items), :concat,
            s(:block,
              s(:send,
                s(:ivar, :@modules), :map),
              s(:args,
                s(:arg, :n),
                s(:arg, :c)),
              s(:lvar, :c))),
          s(:block,
            s(:send,
              s(:lvar, :q), :seplist,
              s(:lvar, :items)),
            s(:args,
              s(:arg, :mod)),
            s(:send,
              s(:lvar, :q), :pp,
              s(:lvar, :mod)))))),
    s(:def, :search_record,
      s(:args),
      s(:begin,
        s(:if,
          s(:send,
            s(:ivar, :@parser), :<,
            s(:const,
              s(:const,
                s(:const, nil, :RDoc), :Parser), :Text)), nil,
          s(:return)),
        s(:array,
          s(:send, nil, :page_name),
          s(:str, ""),
          s(:send, nil, :page_name),
          s(:str, ""),
          s(:send, nil, :path),
          s(:str, ""),
          s(:send, nil, :snippet,
            s(:ivar, :@comment))))),
    s(:def, :text?,
      s(:args),
      s(:and,
        s(:ivar, :@parser),
        s(:send,
          s(:send,
            s(:ivar, :@parser), :ancestors), :include?,
          s(:const,
            s(:const,
              s(:const, nil, :RDoc), :Parser), :Text)))),
    s(:def, :to_s,
      s(:args),
      s(:dstr,
        s(:str, "file "),
        s(:begin,
          s(:send, nil, :full_name))))))
