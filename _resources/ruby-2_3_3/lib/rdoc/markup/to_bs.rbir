s(:class,
  s(:const,
    s(:const,
      s(:const, nil, :RDoc), :Markup), :ToBs),
  s(:const,
    s(:const,
      s(:const, nil, :RDoc), :Markup), :ToRdoc),
  s(:begin,
    s(:def, :initialize,
      s(:args,
        s(:optarg, :markup,
          s(:nil))),
      s(:begin,
        s(:zsuper),
        s(:ivasgn, :@in_b,
          s(:false)),
        s(:ivasgn, :@in_em,
          s(:false)))),
    s(:def, :init_tags,
      s(:args),
      s(:begin,
        s(:send, nil, :add_tag,
          s(:sym, :BOLD),
          s(:str, "+b"),
          s(:str, "-b")),
        s(:send, nil, :add_tag,
          s(:sym, :EM),
          s(:str, "+_"),
          s(:str, "-_")),
        s(:send, nil, :add_tag,
          s(:sym, :TT),
          s(:str, ""),
          s(:str, "")))),
    s(:def, :accept_heading,
      s(:args,
        s(:arg, :heading)),
      s(:begin,
        s(:or,
          s(:send, nil, :use_prefix),
          s(:send,
            s(:ivar, :@res), :<<,
            s(:send,
              s(:str, " "), :*,
              s(:ivar, :@indent)))),
        s(:send,
          s(:ivar, :@res), :<<,
          s(:send,
            s(:send,
              s(:ivar, :@headings), :[],
              s(:send,
                s(:lvar, :heading), :level)), :[],
            s(:int, 0))),
        s(:ivasgn, :@in_b,
          s(:true)),
        s(:send,
          s(:ivar, :@res), :<<,
          s(:send, nil, :attributes,
            s(:send,
              s(:lvar, :heading), :text))),
        s(:ivasgn, :@in_b,
          s(:false)),
        s(:send,
          s(:ivar, :@res), :<<,
          s(:send,
            s(:send,
              s(:ivar, :@headings), :[],
              s(:send,
                s(:lvar, :heading), :level)), :[],
            s(:int, 1))),
        s(:send,
          s(:ivar, :@res), :<<,
          s(:str, "\n")))),
    s(:def, :annotate,
      s(:args,
        s(:arg, :tag)),
      s(:begin,
        s(:case,
          s(:lvar, :tag),
          s(:when,
            s(:str, "+b"),
            s(:ivasgn, :@in_b,
              s(:true))),
          s(:when,
            s(:str, "-b"),
            s(:ivasgn, :@in_b,
              s(:false))),
          s(:when,
            s(:str, "+_"),
            s(:ivasgn, :@in_em,
              s(:true))),
          s(:when,
            s(:str, "-_"),
            s(:ivasgn, :@in_em,
              s(:false))), nil),
        s(:str, ""))),
    s(:def, :convert_special,
      s(:args,
        s(:arg, :special)),
      s(:send, nil, :convert_string,
        s(:zsuper))),
    s(:def, :convert_string,
      s(:args,
        s(:arg, :string)),
      s(:begin,
        s(:if,
          s(:send,
            s(:lvar, :string), :respond_to?,
            s(:sym, :chars)), nil,
          s(:return,
            s(:lvar, :string))),
        s(:if,
          s(:or,
            s(:ivar, :@in_b),
            s(:ivar, :@in_em)), nil,
          s(:return,
            s(:lvar, :string))),
        s(:lvasgn, :chars,
          s(:if,
            s(:ivar, :@in_b),
            s(:block,
              s(:send,
                s(:send,
                  s(:lvar, :string), :chars), :map),
              s(:args,
                s(:arg, :char)),
              s(:dstr,
                s(:begin,
                  s(:lvar, :char)),
                s(:str, "\b"),
                s(:begin,
                  s(:lvar, :char)))),
            s(:if,
              s(:ivar, :@in_em),
              s(:block,
                s(:send,
                  s(:send,
                    s(:lvar, :string), :chars), :map),
                s(:args,
                  s(:arg, :char)),
                s(:dstr,
                  s(:str, "_\b"),
                  s(:begin,
                    s(:lvar, :char)))), nil))),
        s(:send,
          s(:lvar, :chars), :join)))))
