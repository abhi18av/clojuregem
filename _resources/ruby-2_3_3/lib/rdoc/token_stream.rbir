s(:module,
  s(:const,
    s(:const, nil, :RDoc), :TokenStream),
  s(:begin,
    s(:defs,
      s(:self), :to_html,
      s(:args,
        s(:arg, :token_stream)),
      s(:send,
        s(:block,
          s(:send,
            s(:lvar, :token_stream), :map),
          s(:args,
            s(:arg, :t)),
          s(:begin,
            s(:if,
              s(:lvar, :t), nil,
              s(:next)),
            s(:lvasgn, :style,
              s(:case,
                s(:lvar, :t),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkCONSTANT),
                  s(:str, "ruby-constant")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkKW),
                  s(:str, "ruby-keyword")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkIVAR),
                  s(:str, "ruby-ivar")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkOp),
                  s(:str, "ruby-operator")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkId),
                  s(:str, "ruby-identifier")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkNode),
                  s(:str, "ruby-node")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkCOMMENT),
                  s(:str, "ruby-comment")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkREGEXP),
                  s(:str, "ruby-regexp")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkSTRING),
                  s(:str, "ruby-string")),
                s(:when,
                  s(:const,
                    s(:const,
                      s(:const, nil, :RDoc), :RubyToken), :TkVal),
                  s(:str, "ruby-value")), nil)),
            s(:lvasgn, :text,
              s(:send,
                s(:const, nil, :CGI), :escapeHTML,
                s(:send,
                  s(:lvar, :t), :text))),
            s(:if,
              s(:lvar, :style),
              s(:dstr,
                s(:str, "<span class=\""),
                s(:begin,
                  s(:lvar, :style)),
                s(:str, "\">"),
                s(:begin,
                  s(:lvar, :text)),
                s(:str, "</span>")),
              s(:lvar, :text)))), :join)),
    s(:def, :add_tokens,
      s(:args,
        s(:restarg, :tokens)),
      s(:block,
        s(:send,
          s(:send,
            s(:lvar, :tokens), :flatten), :each),
        s(:args,
          s(:arg, :token)),
        s(:send,
          s(:ivar, :@token_stream), :<<,
          s(:lvar, :token)))),
    s(:alias,
      s(:sym, :add_token),
      s(:sym, :add_tokens)),
    s(:def, :collect_tokens,
      s(:args),
      s(:ivasgn, :@token_stream,
        s(:array))),
    s(:alias,
      s(:sym, :start_collecting_tokens),
      s(:sym, :collect_tokens)),
    s(:def, :pop_token,
      s(:args),
      s(:send,
        s(:ivar, :@token_stream), :pop)),
    s(:def, :token_stream,
      s(:args),
      s(:ivar, :@token_stream)),
    s(:def, :tokens_to_s,
      s(:args),
      s(:send,
        s(:block,
          s(:send,
            s(:send,
              s(:send, nil, :token_stream), :compact), :map),
          s(:args,
            s(:arg, :token)),
          s(:send,
            s(:lvar, :token), :text)), :join,
        s(:str, "")))))
