s(:begin,
  s(:lvasgn, :nr,
    s(:int, 1000000)),
  s(:lvasgn, :i,
    s(:int, 0)),
  s(:lvasgn, :msg,
    s(:str, ".")),
  s(:lvasgn, :buf,
    s(:str, ".")),
  s(:kwbegin,
    s(:ensure,
      s(:rescue,
        s(:begin,
          s(:masgn,
            s(:mlhs,
              s(:lvasgn, :r),
              s(:lvasgn, :w)),
            s(:send,
              s(:const, nil, :IO), :pipe)),
          s(:while,
            s(:send,
              s(:lvar, :i), :<,
              s(:lvar, :nr)),
            s(:begin,
              s(:op_asgn,
                s(:lvasgn, :i), :+,
                s(:int, 1)),
              s(:send,
                s(:lvar, :w), :write_nonblock,
                s(:lvar, :msg),
                s(:hash,
                  s(:pair,
                    s(:sym, :exception),
                    s(:false)))),
              s(:send,
                s(:lvar, :r), :read_nonblock,
                s(:int, 1),
                s(:lvar, :buf),
                s(:hash,
                  s(:pair,
                    s(:sym, :exception),
                    s(:false))))))),
        s(:resbody,
          s(:array,
            s(:const, nil, :ArgumentError)), nil,
          s(:while,
            s(:send,
              s(:lvar, :i), :<,
              s(:lvar, :nr)),
            s(:begin,
              s(:op_asgn,
                s(:lvasgn, :i), :+,
                s(:int, 1)),
              s(:send,
                s(:lvar, :w), :write_nonblock,
                s(:lvar, :msg)),
              s(:send,
                s(:lvar, :r), :read_nonblock,
                s(:int, 1),
                s(:lvar, :buf))))), nil),
      s(:begin,
        s(:send,
          s(:lvar, :r), :close),
        s(:send,
          s(:lvar, :w), :close)))))
